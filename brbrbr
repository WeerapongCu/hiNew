-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'WillowCrystalDawn', 'VortexDrift2007', 'XxChill_SkyxX2018', 'PulseUltra74', 'N0ah_Thunder24',
                     'XxFoxStealthxX23', 'Oliv3rRiftBlizzard', 'XxSparkHaz3KingxX', 'FuryEpicHero',
                     'Chas3Build3rZap2002', 'CraftMinerStream', 'PowerNeonHero2009', 'StarBaconHunter59',
                     'XxAddis0nJellyxXYT', 'OrofentiNtin', 'Dani3lBl0ck2008', 'Victoria_V3nom81YT',
                     'XxTurboLightxX2006', 'PixelatedDriftBladeY', 'EntantaSharo', 'Fusi0nSaberSlime', 'MiaMin3rN30n10',
                     'UneatothaRer', 'DriftVortex40', 'AriaBuilderDancer_YT', 'HyperGamer47_YT', 'ErengeneRisa',
                     'SonicNinjaSt3alth', 'iithengeRite', 'Ice_Fusion2015', 'Skater_Drift68', 'AlexanderAqua23',
                     'LUCAS_Magic200843', 'BrooklynnDuckQu33n', 'Oliver_Ace2004YT', 'Xx_SparklyGalaxyKing',
                     'Circuit_Raven2002', 'SamuelLight54', 'Eli_Spark2011YT', 'HawkJellyMystic', 'DancerSparklyPixel',
                     'Br00klynnThunderJell', 'HyperSilver201925', 'MaxBlock201021', 'XxRider_FuryxX201848',
                     'PixelPandaPrimal2015', 'SonicSlimeNova2012', 'Jacks0nB3arBl0ck', 'XxHazeShadowDawnxX',
                     'EllaAlphaHero2018', 'Al3xand3rStarryChas3', 'EthanBlock69', 'CyberMagic200343',
                     'SophiaArrowStream91', 'TigerZapDrag0n', 'XxArr0wShad0wxX15', 'RileyTigerSpark', 'Ow3nSparklyLava',
                     'MysticR0cket79', 'XxLucas_UltraxX2002', 'GabrielPhoenix93', 'XxMagicStormJellyxX2',
                     'AngofateSast', 'Thund3r_Cooki351', 'Blad3Flick2016', 'WilliamSt0rmyFlame', 'DarkM00nVen0m2020',
                     'XxMasonSaberHeroxX', 'XxChaseLionxX85', 'ToxicUltra2009', 'XxStormyUltraRavenxX',
                     'Levi_MYSTIC2020', 'ElliePlayzStealth', 'LightPrismLegend', 'HondindeDish', 'XxLegendProxX2022',
                     'HathanseRaii', 'XxPrismSkaterxX2007', 'G0ldenStealthR0cket2', 'Skat3r_Max2010',
                     'XxVortexPixelatedFus', 'XXHERO_SilverxX2003Y', 'S0nicGalaxy24', 'Ow3nShadowClaw', 'AvaNightDrift',
                     'OwenPower202126', 'ViperDrift32YT', 'Ril3yZ3roFlam3', 'C0d3Ech0Star96', 'PulseHunter19',
                     'XxDawnWolfRoguexX202', 'HitouseNguse', 'PixelSpark2015YT', 'FlashNinjaSab3r2002',
                     'CodeClaw200986', 'LI0N_Thund3r2023', 'JacksonRiftShadow201', 'AlphaGhost2024_YT', 'EsteseaNguto',
                     'SebastianPandaSaber3', 'Grayson_Duck96YT', 'XxJulianBuild3rZ00mx', 'iitousoFerin', 'HyperLava39',
                     'MinerCyber200219', 'SEBASTIAN_Infern0YT', 'Victoria_Dark2017', 'LOGAN_Sonic52',
                     'XxJulianBlastTurboxX', 'intathoNtere', 'BaneZapFusion', 'XxNightLionZeroxX', 'OwenPrism201599',
                     'Dani3lSparkArrow2006', 'Echo_HUNTER12', 'Chloe_Bane202219', 'DanielStarryHer0',
                     'GlitchOmegaViper33', 'NovaMysticCyb3r', 'PrismFury56', 'PlayzSkaterCraft', 'XxSparkly_TigerxX201',
                     'RengofiTenga', 'NightHer0Fr0st15', 'MateoBladeFury98', 'DragonInfernoLegend',
                     'RiderStormyPower2011', 'Ph03nixCha0s14', 'Br00klynG0ldenHer013', 'TersowoRered', 'iusheriNenor',
                     'Isaac_Rider200848', 'J3llyPow3r2002', 'HenryDawnChill', 'EllaChase55', 'Lucky_Eagle32',
                     'GIGAMAGICRIDER_YT', 'SparkL3g3ndB3ar', 'Samu3l_Sparkly2024', 'Ellie_Wraith201466',
                     'XxB3astH3roxX2022', 'XxHyperQueenxX2008', 'ZERO_Builder41', 'NinjaMysticQueen',
                     'Haz3lMysticVip3r2013', 'XxAceLightxX2011', 'EthanSkyFlame2014', 'EdarintaTout', 'Mast3rChaos2019',
                     'Chlo3Rock3tFox2009', 'Cyber_Chill2005', 'LeviClawPanda', 'BlazeInferno82_YT',
                     'Xx_G0ldenBlastCrysta', 'RiderPowerGolden', 'Bl0ckFr0stSpark2003', 'St3althNovaShadow',
                     'Wraith_Cod312', 'HazeDragonRift', 'WyattGoldenHero2004', 'XxGabri3lLuckyxX2019',
                     'FrostHaz3201727', 'XxFireLionxX2016', 'IsabellaBeastViper', 'EnountaiTofo', 'Hyper_Craft12',
                     'XxHeroStormMagicxX', 'Infern0Ne0n95', 'Toxic_Max201877', 'Aid3nBaconDrift35', 'V3n0mQu33n200950',
                     'XxMaster_GIGAXX2004', 'MagicHawk2019_YT', 'RavenGolden201151', 'ArrowStarry201764_YT',
                     'L0gan_TIG3R41', 'XxBladeZoomxX2010YT', 'Eli_R0ck3t2020', 'JulianN3on_YT', 'PlayzRoguePixelated',
                     'XxElli3Inf3rnoxXYT', 'EndustuCensi', 'Jax0nRider74', 'JulianBuilderMystic2', 'XxDawnSlimexX2014',
                     'XxOwenCyberxX200352', 'Aqua_Fury200939', 'AddisonNightBeast202', 'QU33N_Dawn2007', 'Pr0Gh0stBear',
                     'VortexSkaterWolf', 'Olivia_Byte201374', 'XxClawH3roxX2017', 'CodeStream86', 'XxAquaPixelxX2014',
                     'Paisl3yN3on49', 'XxNoraGlitchBlastxX2', 'Mast3rAlphaPro2013YT', 'XxStarrySilverGlitch',
                     'Rav3nEagl32018', 'WyattCrazeStream', 'FrostZoomSparkly', 'FlashCrystal200680',
                     'XxQueenLightLuckyxX2', 'ZAP_Omega200820', 'AroursiNdang', 'XxHannahHeroMoonxX', 'Layla_Fury64',
                     'HyperIceMaster', 'EliPandaDancer2015', 'ChloeBane200745', 'ShadowViper201424',
                     'Xx_PulseThunderFrost', 'GoldenNovaFusion64', 'Grac3Inf3rn02004', 'PrimalHawkMast3r',
                     'Paisl3yRogu32008', 'SathatoRisha', 'EagleChaseShadow', 'XxNoraEchoxX82', 'BuilderPandaBeast201',
                     'Knight_Chase26', 'Paisl3yMast3r23', 'EvelynBuilder202028', 'Xx_CraftChaosBuilder', 'UterouthaNge',
                     'HarperBlizzard201318', 'MATE0_Ne0n2022', 'Xx_StormyGold3nLight', 'XxM00nDuckC00kiexX',
                     'SenentiSiien', 'OferitheRiso', 'Pixelated_Pro2019', 'iitendoFrind', 'RocketChaseKnight',
                     'YonesantaRou', 'CrazeV0idMiner', 'iorsutruNene', 'EagleBearCrystal48', 'LUK3_Fox39',
                     'CircuitInf3rnoSpark2', 'BladeUltraGiga', 'ZapSkaterChill', 'Ellie_R0GUE66', 'EchoStar202338',
                     'MinerHunterSky', 'OliviaAlphaJ3lly', 'Charlott3Max2016', 'HawkPowerLava', 'Her0GlitchM00n',
                     'EthanRiderStealth', 'Luk3EpicSkat3r', 'ChloePandaFlame', 'RimisashoFan', 'Arr0wHawk2004',
                     'XxJam3sPuls3xX', 'XxBan3BlastEchoxX', 'EshofontaNte', 'EpicZoomChaos14', 'FuryEcho95',
                     'ViperRider40', 'XxWyattZoomBuilderxX', 'NightHaz3V3nom', 'PaisleyCircuit50', 'TengiowaRson',
                     'Storm_St3alth2019', 'Ic3_Min3r2016', 'Max_Ph03nix92', 'JaydenSaberC00kie', 'XxCrazeMasterxX2015',
                     'Mas0nGamerBuilder201', 'JacksonPrism95', 'XxAubreyStormyHeroxX', 'LightBuilder60',
                     'Hannah_Om3ga33', 'HARPER_Sky26', 'AidenBlizzardMystic', 'LaylaKingRift2011', 'Craz3Drift2017',
                     'PulseHyperZap2017', 'TIGER_Glitch2015', 'XxCodeClawxX63', 'XxOrbitHazeCyberxX',
                     'Str3amN3on2007_YT', 'ChloeBuilder202167', 'XxMasonBlad3xX84_YT', 'Xx_Isab3llaPuls3Fir3',
                     'IsabellaIce84', 'XxAvaThund3rCraftxX', 'StormyPixelated52', 'FrostPrismDark2012',
                     'XxPrimalGigaxX2003', 'HannahBuilderSparkly', 'LionGalaxy60', 'XxSparkBytexX65', 'Chlo3Rid3rFury',
                     'N0raSt0rm2008', 'Max_Fir32023', 'TigerPh0enix99', 'Ril3yPix3lCooki32012', 'AlexanderStreamBlade',
                     'Al3xand3rZ3roToxic20', 'MinerEpic44', 'BlastInfern0Her0', 'GABRIEL_Moon63', 'LeviMagic2022YT',
                     'LionVoidSaber', 'EllaMoonNova', 'SamuelFrost41', 'XxLukeGhostxX2015', 'Xx_SPARKLYRIFTLEGEND',
                     'StormDriftZ3ro', 'BladeSonic75', 'StarryGh0st2017', 'AlphaStr3am39', 'LukeFusion2015_YT',
                     'SparkToxicQu33n', 'KNIGHT_Rav3n2021', 'PixelFlameStormy2003', 'JacksonRogueAlpha201',
                     'LionJellyGalaxy2020', 'XxBac0nDrag0nSlim3xX', 'SuiacersouTe', 'XxCircuitPrimalxX99',
                     'GigaBaneInferno37', 'GoldenOrbitBacon', 'TedontaRatou', 'NinjaPandaThunder201', 'TigerKingCraze',
                     'Xx_PowerBuilderEagle', 'Z0eC0deP0wer', 'XxZoeArrowxXYT', 'XxBlastLightDarkxX',
                     'HunterFlameSonic19', 'LionNovaCircuit20193', 'LegendOrbit201613', 'Xx_AbigailMagicPuls3',
                     'RiftPlayzWraith2012', 'NinjaShad0wUltra', 'T0xic_Shad0w2005', 'BeastGlitchGamer', 'Zer0Star2015',
                     'Craze_Stealth200851', 'BlastEchoHero2019', 'XxEllaPh0enixxX20205', 'Hero_Stormy200386',
                     'LaylaUltraStealthYT', 'KnightCircuit2017_YT', 'LunaLightBl0ck', 'EmmaInfern0Byte',
                     'XxRock3tRav3nThund3r', 'Pr0Claw202285', 'AbigailNinja95', 'MysticBlizzardSlime2',
                     'InfernoAceToxic', 'FireHer0G0lden72', 'Max_Mast3r99', 'MiaR0gu379', 'TOXIC_Fusion2008',
                     'XX_MysticStr3amPuls3', 'Dancer_CLAW12', 'XxCrystal_GalaxyxX94', 'DRAG0N_Cyber2018',
                     'RendarsiTath', 'Aiden_SABER43', 'HoreashaSori', 'Silv3rGlitch2016YT', 'PesiiitoFiss',
                     'SareaneDeast', 'SavannahBearRogue200', 'AquaCircuitLion', 'Oliv3rHawk2021', 'BearPhoenix15',
                     'Skater_W0lf2023', 'BeastFlame19', 'ACE_Echo67', 'XxAva_FlashxX30', 'NinjaEchoHero62',
                     'Isab3llaZoom78', 'CarterSilverZap2005', 'S3bastianTurbo201466', 'Harp3rBlad3201920',
                     'Hunt3rLucky45', 'HyperSlime202367', 'StormTurboStormy2008', 'DancerSlime200282', 'ithistoNdede',
                     'WOLF_Drift2021', 'Hyp3rBan3202155', 'XxDarkLavaL3g3ndxX', 'ZeroQueen202139',
                     'EliCrazeCrystal2011', 'JulianCrazeFox61', 'HunterGamerSilver82', 'SkaterMax27',
                     'MinerEpicGolden49', 'Ph03nixPr0B3ar62', 'PaisleyLava95', 'SaberP0werChase2024', 'B3ast_J3lly2022',
                     'PaisleyZ00mJelly81', 'LuckyKingPrism', 'Will0wBearOrbit2023', 'XxEchoFusionxX46',
                     'LavaStarryRogue2013', 'NovaViper71', 'VoidChas3Lion', 'SparkStarry30', 'N3onFox90',
                     'XxAsherPrimalMoonxX', 'Build3rSab3r37', 'XxGalaxy_SaberxX2023', 'PixelMinerDrift',
                     'Ech0_BANE200671', 'PlayzLegendAqua76', 'Lava_Rider2015', 'Chill_Cyber85', 'Hero_Pulse201880',
                     'JulianPandaGam3r', 'Circuit_S0nic2012', 'IsabellaHer0Lucky', 'UngedouRares',
                     'BrooklynnSilv3rNight', 'Xx_CarterBeastFusion', 'IsabellaBlaze87', 'PrimalHero201754',
                     'FlickRogue', 'Jax0nSaberBl0ck2002', 'RocketZoomOmega2021', 'HyperMax200433', 'Ultra_Stealth99',
                     'NoraCyberPro', 'Tig3r_Ic368', 'Oliv3rBl0ckDrift', 'ClawP0w3r2017', 'ChaseCircuitLi0n',
                     'Pix3lStarStormy2002', 'Stormy_Miner46', 'HazelHunterPro', 'OfesimoRengu', 'Light_Silv3r2020',
                     'AsherSlimeGamer93', 'AriaBlade94', 'XxAriaMysticSparklyx', 'StarryLion200345',
                     'XXEPIC_VortexxX71', 'Ash3rPrismCraft', 'TesestoRonge', 'Flam3BlizzardBac0n', 'XxSky_ZapxX26',
                     'AidenCyberPro', 'SophiaPixel2004YT', 'GraceDawnFusion', 'PowerClaw84', 'CraftInferno96',
                     'STR3AM_Epic70', 'SparklyBuild3rInf3rn', 'Blade_N0va2017', 'HunterNe0nPh0enix95',
                     'XxDuck_EchoxX2007', 'PandaF0x16', 'MinerPrimalFusi0n200', 'LionEchoFox2004', 'NightChase59',
                     'SlimeStormyLion2018', 'Wyatt_Turbo53', 'B3astRock3t85', 'BuilderArrowLion2003', 'ToxicGoldenStar',
                     'HazePrismDark2023', 'Hazel_ICE83', 'Thunder_Legend79YT', 'RogueWolfBuilder', 'ThunderFrostArrow',
                     'ProBan3Circuit', 'AlexanderZero99', 'OrerindeRero', 'FusionQu33n25', 'XxAvaLegendViperxX20',
                     'ierimyaiNeds', 'LavaHyperLight', 'St0rmAlphaViper', 'KnightBlockRocket_YT', 'SebastianBlastRider',
                     'Xx_DragonVenomBuilde', 'MAT30_Pix3l58', 'HazelPixelated202314', 'idaroungoNde',
                     'DuckEch0Danc3r2016', 'XxSamuelFoxxX2019', 'XxCircuitFir3V0rt3xx', 'Mat3oSonic73',
                     'NovaZapPulse201662', 'VoidFuryStream', 'RiiyiiduRash', 'LavaHero2018YT', 'XxWill0wSlimeSt0rmyx',
                     'XxBlockLightBlizzard', 'V0id_SABER2011', 'Pix3lShadowBan32021', 'VenomEchoPlayz', 'Owen_Zap65',
                     'ArersisioNes', 'XxChlo3Ban3RiftxX', 'ZapLegend201718', 'XxShad0wSkyxX2002', 'StarryBaneHero',
                     'Neon_Hero89', 'HenryMysticLava2012', 'DawnDriftGlitch', 'SavannahV3nomBlock_Y', 'XxVoid_TurboxX',
                     'Will0wPrismR0cket', 'C00kie_HYPER2006', 'EagleCraze2016_YT', 'CYBER_Blast52',
                     'CrystalProHawk2002', 'ieneduroRous', 'VenomCodeFlame', 'Ph03nixChillRid3r', 'VictoriaFlick2023',
                     'VenomCrystalWraith43', 'PrismSparkGolden', 'DragonBaneBuilder', 'Ace_Haze54', 'JackWraithDuck',
                     'EmmaRock3tCircuit', 'OrofestiTore', 'FireNightSt0rm', 'Charl0tteLight2002',
                     'Jam3sV3n0mSt0rmy2005', 'RiftArrowZoom', 'N0raAlphaBuilder', 'SebastianOmegaFrostY',
                     'XxFir3CraftxX201539', 'GraceBeastDrift20192', 'RileyDuckIce2002', 'XXSPARKLYPLAYZDRIFTX',
                     'ArrowHawk2010YT', 'Isab3lla_Nova99', 'Samuel_Viper68YT', 'Am3lia_Wraith37',
                     'SaberBuilderStormy20', 'MichaelDragonDancer2', 'Bl0ckZ00mV0rtex', 'RILEY_Ultra2003',
                     'XxEllaToxicSonicxX20', 'JamesZer02015', 'Xx_WraithMysticMagic', 'N0vaGh0stMystic',
                     'GalaxyRid3r35', 'GlitchH3roMast3r', 'Tig3r_Starry2004', 'Magic_Raven201884', 'XxBlade_LionxX2009',
                     'ThunderHeroQueen', 'AbigailGlitchBeast', 'ChaosOmegaCraze', 'Li0nOmegaFire', 'OndisatouTon',
                     'XXVOID_PixelxX2019', 'Chl0e_Prism47', 'DarkPlayzHer055', 'Zayden_Craft76', 'HazeEagle200674',
                     'Fusi0nGamer2011', 'LeviGhost2024YT', 'FrostRiftRocket', 'AsherPowerInferno', 'GRACE_Ultra17',
                     'Flam3Echo2020', 'FlashJ3lly92', 'JulianSt0rmy2020', 'MagicGam3r2004', 'Sab3rMin3rIc3',
                     'EmmaSkat3rNinja96', 'SlimeToxicKingYT', 'XxDani3l_ProxX2020', 'Puls3Eagl3Z00m',
                     'AlphaBlastSparkly200', 'Gabri3l_Ninja64', 'Xx_SophiaDragonGalax', 'StormyMax14', 'VenomCyber37',
                     'BaneEcho2014YT', 'MiaAc32004YT', 'CraftShad0w2009', 'FlashMast3rZ3ro', 'XxAsherCircuitxX_YT',
                     'WYATTHUNT3R2003_YT', 'XxChaseGamerCrystalx', 'FrostHyperSonic2002', 'C00ki3Star_YT',
                     'XX_GraceGoldenDragon', 'Grac3H3ro80', 'SilverAqua89', 'XxStreamGamerZapxX20', 'StreamNovaChill34',
                     'XxByteBeastxX15', 'Sab3rNightSky', 'BladeStormGiga200338', 'AlexanderVoidRocket',
                     'Zo3_Inf3rno201163', 'LaylaShadowByte', 'XxBlazeRavenxX71', 'XxAsherRiftDriftxX',
                     'Xx_BlizzardByt3Puls3', 'Jayd3nInf3rno28', 'VoidMagicPixel2008', 'InfernoBlastChase201',
                     'Ac3Sonic2003', 'Br00klynV0id57', 'XxOliviaBytexX51', 'Kaylee_Magic99', 'S0nic_HER093',
                     'XxWraithMaxNovaxX', 'OliverDawnThunder200', 'EneradeDiofi', 'Ghost_Storm45', 'StealthStarry34',
                     'LucasUltraEch080', 'StarryChillBlaze_YT', 'XXNOAH_CraftxX2010', 'BlazeBl0ckN0va',
                     'Silv3rLight2004YT', 'RavenR0cketC0de20055', 'PixelIceBlizzard2024', 'Xx_WilliamGlitchKing',
                     'ToxicKnightDrift2002', 'JamesVenomWraith2011', 'Slim3KnightThund3r', 'GraysonSab3rEcho94',
                     'Inf3rn0UltraVip3r', 'RoguePowerTurbo2020', 'PixelHeroEagle2018', 'Turbo_Arrow201289',
                     'OliviaFire200864', 'XxStealthFusionLegen', 'AbigailCod3Blad368', 'Ghost_Alpha201562',
                     'AuroraCraftPix3lat3d', 'WyattClaw54', 'Her0Ech0Skater', 'XxAubreyMinerxX63', 'EroutathoRin',
                     'Samu3lCyb3rPow3r', 'Jacks0nFlashAqua', 'PixelatedNovaMystic2', 'XxWyattGalaxyNinjaxX',
                     'WilliamLucky72', 'HarperRiderFlame51', 'L3g3nd_Blaz340', 'FireGigaHyper', 'MAGICGIGA79_YT',
                     'EagleJellyAce', 'XxIsaacGlitchVen0mxX', 'SkaterByteTurbo', 'XxCyberTurboHyperxX',
                     'MichaelStorm86', 'LaylaBlizzardRav3n', 'Lava_Ace2007', 'SebastianWolf77', 'Rock3tThund3rSilv3r',
                     'Layla_Flam32007', 'B3astOrbitHawk', 'ErengouStoro', 'XxQueenVortexWraithx', 'XxVoidDawnxX60',
                     'HenryStorm200779', 'CarterCircuitFox2016', 'OrbitDuckDrift2024', 'XXLOGAN_SonicxX85',
                     'EmmaMaxArrow2012', 'PerengeDoust', 'DanielPixelFrost', 'ElijahPh0enix201180',
                     'XxStreamNovaTigerxX2', 'PixelatedProDuck', 'SebastianSkater81YT', 'GraceHazeSky',
                     'EpicDanc3r2007', 'P0w3r_LAVA2011', 'OliverBearHunter2007', 'Str3amGlitchBlaz3YT', 'RistiseRoris',
                     'Ev3lynEch02004', 'ChillR0ck3t34', 'XxRavenPrimalxX96YT', 'ElijahNinjaRock3t202',
                     'NeonBlizzardCraze200', 'V3nomCooki32020', 'MoonLegendAlpha', 'TurboRiftSlime',
                     'MinerJellyEagle2013', 'EchoLionDancer', 'Xx_MinerStealthToxic', 'iasofedaThit',
                     'TurboViperToxic2007', 'XxSparkLightxX2003', 'ToxicDawnLight', 'GalaxySt3alth2016',
                     'Pho3nix_Moon69', 'XxNova_ZapxX2011', 'NovaPowerBlast2019', 'Xx_S3bastianChillBla', 'GigaOmega41',
                     'Ultra_Eagle81', 'MateoStreamRift2020', 'XxWyatt_SparkxX2019', 'XxL3viGold3nPrimalxX',
                     'XxLi0nPixelFr0stxX', 'Pixelated_Dark201291', 'J3llySilv3r2008', 'Julian_Z3r02019',
                     'XxSkat3rF0xChillxX20', 'S3bastianPix3l200663', 'Z00M_S0nic2013', 'XxArrowSonicBlad3xX',
                     'HENRY_Omega2017', 'XxEliRoguexX12', 'FoxBaneToxic', 'Max_Duck2019', 'CodeOrbitVortex',
                     'XxPanda_RiftxX202039', 'StormKnight200256', 'SparkByte201198', 'SaindasoNdim', 'HyperBear202169',
                     'RiftDawnUltra67', 'Aqua_Str3am64', 'Rogu3CrystalDuck2022', 'XxRider_HYPERXX65',
                     'Zayd3n_Puls32003', 'NovaNightSilver2010', 'EmmaJ3llyMin3r37', 'Zayd3nDanc3r2023',
                     'Pixelated_Pr02016', 'XxChloeGlitchMoonxX', 'UltraSlimeInferno', 'Giga_Rocket16',
                     'Legend_Stealth57', 'WillowLionGlitch2022', 'XxLaylaRiderEchoxX', 'AceMinerStarry2016',
                     'XxHarp3rNovaxX2004', 'XxJamesBuilderHer0xX', 'Al3xand3r_Z3ro2011', 'Mystic_Zap44',
                     'XxBr00klyn_KNIGHTXX6', 'WillowRiftPlayz2023', 'Blizzard_Pix3l34', 'LeviHero73',
                     'DanielBladePlayz2012', 'Pix3l_Night44', 'FuryJ3llyTurbo', 'DriftDarkShad0w', 'KnightSlimeZoom',
                     'Stealth_Rift202063', 'iinofaiiSone', 'MichaelFr0st91', 'VortexLegendNight', 'ELIJAH_Dawn85',
                     'ToxicUltraBane', 'ZapBlizzardRift', 'Vip3rStarMast3r', 'DoferintoFer', 'XxKayleeZeroChillxX',
                     'ChaosBaconSlim3', 'BladeToxicMiner2020', 'Her0_Flash201737', 'WilliamHeroUltraYT',
                     'SkaterClaw200465', 'RiftIceStealth2014YT', 'MateoToxic202377', 'Skater_Ph0enix63',
                     'SaberStormNova2005', 'OredandaSton', 'StarSonicPlayz', 'BlizzardAceShadow', 'VortexSparklyFury',
                     'XxEchoSlimeMaxxX', 'B3astVip3r2013', 'HarperClawCraze', 'RoustiteNder', 'AterindaRese',
                     'XxRileyKnightxX2023', 'CharlotteMagic2017', 'WilliamEagleFox', 'MateoBlizzard36',
                     'CraftPow3rPrism2017', 'LionPowerBlast', 'EllaPulseFlame2018_Y', 'Flam3_Glitch2006YT',
                     'FireShad0w64', 'JacksonFuryEpic2019', 'XxPlayz_BlockxX2015', 'XxBearGlitchGalaxyxX',
                     'ChaseNinja95', 'Lucky_LIGHT200539', 'XxDragonBeastxX2003', 'XxViperKingxX201929', 'ingentiiiiur',
                     'PANDA_Z00m23', 'EshaneaRorio', 'ErofienoNore', 'BlazeMoonKing', 'XxVortex_ProxX85',
                     'HenryLegend75', 'ChaosGamerBane', 'Build3r_Giga2012', 'GHOST_Orbit91', 'XxPhoenixHazeHawkxX',
                     'XxDaniel_PandaxXYT', 'Grac3_Flick', 'Xx_StarryPhoenixThun', 'HyperBuilderCookie21',
                     'SavannahCooki314', 'RiftSonicHaze2023', 'JulianNinjaViper2010', 'Shad0wStar2024',
                     'XxHannahHeroChaosxX', 'RileyInferno2003', 'Playz_Drift97', 'BeastHazeDrag0n',
                     'StreamStormSilver_YT', 'iiinsaraNeii', 'FuryCookieChase2021', 'XxBanePandaxX2010',
                     'ZaydenEpicDrift', 'Tig3rKnight2015', 'WyattAceZap87', 'DriftPixelRaven20244',
                     'SavannahHunterSonic', 'XxSpark_KingxX85', 'H3roWolf202359', 'RocketFire2005YT', 'Max_Dawn46',
                     'SebastianQueen67', 'XxLightOrbitM00nxX20', 'FuryV0rtexPr057', 'Hunt3rPix3lM00n', 'TutoutoNited',
                     'OtederaRsuth', 'Xx_OliverToxicFusion', 'OLIVIA_Inferno30', 'Ril3yBuild3rChill',
                     'DawnEpicChill200618Y', 'KingBan32016', 'SaberBlazeGhost20116', 'WraithMoon2024YT',
                     'TurboRiderPixel39', 'B3astLuckyFlam3', 'NererasheNti', 'inediseNdous', 'Skat3rHawkRav3n17',
                     'Mat3oSlim3Z3ro', 'AbigailMinerSilver20', 'B3AST_N3on201986', 'YofoutoRithe', 'M00nFlameP0wer',
                     'GraysonHyp3r61', 'EvelynBlastDuck', 'LaylaWraithChase', 'DANIEL_Lava51', 'VenomOrbitNeon2022_Y',
                     'XxPixelClawViperxX', 'XxBuilderStealthShad', 'HawkRocket201340', 'UrororiNdous',
                     'Viper_Star202438', 'EllaStarMiner', 'ZoeFireMax2017', 'FlameChase55', 'ShadowGigaBlock',
                     'VoidStorm74YT', 'WyattCircuitJelly', 'ElijahLava2018YT', 'DancerUltra42', 'StarSt0rmRift',
                     'Nora_CLAW2008', 'Xx_JulianShadowDrift', 'Chlo3_Ac3202485', 'RocketCrazeSlime2023',
                     'Ghost_Wraith64', 'EagleArrowStealth201', 'Chill_Gh0st77', 'Drag0nBearBlast', 'LoganCyber55',
                     'Ech0_Saber75', 'XxCraftPlayzxXYT', 'ZeroCircuit24', 'FireRiftG0lden', 'XxN30nKnightxX',
                     'Puls3B3astStar202493', 'XXMATEO_ZoomxXYT', 'Charlotte_Bacon2013', 'EllaStarryPix3l2022',
                     'Crystal_Blast201652', 'WolfPixelEpic_YT', 'Ev3lynOrbit2019', 'ZeroDrift2017_YT',
                     'UltraBuilderZap2015', 'Savannah_Pow3r37', 'BeastR0cket95', 'Shad0wR0cketPlayz', 'ViperBytePrism',
                     'SkaterNinja2013YT', 'BLAZ3_Fusion31', 'UltraBuilderLight201', 'HisiorioCari', 'Rid3rDawnQu33nYT',
                     'EnenereDingo', 'Xx_GabrielRiftHunter', 'HyperNinjaCookie38', 'AbigailLavaFire', 'GamerOmega38',
                     'Xx_STEALTHGOLDENBANE', 'CookieJellyAce', 'OneaiittaThi', 'ElijahKingJelly97', 'itofaroFener',
                     'EllaArrow40', 'Br00klynSt0rmyBear', 'XxPrismBlazePowerxX', 'XxM00nClawxX46', 'Kaylee_Star41YT',
                     'MinerSkater33YT', 'LionHunterCookie', 'Mia_Knight73', 'XxMateoWolfxX17', 'XxAl3xand3rFuryxX72',
                     'AquaDriftChaos', 'VenomFire200649', 'PandaSt0rmyLava', 'XxGhost_PixelxX2014', 'Z3roRift200830',
                     'XxVortexCrazeSonicxX', 'NorendaRerin', 'ZapGh0st2004', 'ChaseVen0mGalaxy', 'NovaGlitchSonic',
                     'EdoroustoRit', 'NendofreNton', 'Z00m_Blizzard45', 'Xx_Rock3tPix3lVort3x', 'BaneStormUltra',
                     'PutendeNdero', 'SlimePlayz92', 'Alpha_Vortex201441', 'Cyb3rSt0rmPanda2021', 'AidenRiftMax',
                     'AndoriteRori', 'WolfProRocket', 'Zer0DawnBuilder65', 'JulianZapPr049YT', 'Ev3lyn_Min3r61',
                     'SuthadiShess', 'SaberUltraKing', 'XxMasonThunderxX2017', 'XxGlitchChaseNightxX', 'LionCooki32017',
                     'Grays0nOrbitLucky202', 'XxRavenPlayzxX2007', 'Elijah_Pixel76', 'Xx_HannahMysticOmega',
                     'EdereneNgede', 'Wolf_Cod3201544', 'UsorofraRint', 'HyperDarkBear', 'Jacks0nStream12',
                     'ViperStarryPro2024', 'ELLI3_Lava2020', 'FusionStarRaven2018', 'Blaz3N3onRav3n',
                     'HannahVortexStream', 'Arr0wSlimePulse', 'LunaEcho70', 'XxWraith_ChillxX2005', 'XxSkaterNeonxX94',
                     'SoureroFesit', 'Blad3Inf3rno23', 'ChillEagleToxic2015', 'H3nryN30nYT', 'Flame_M00n2020',
                     'ELLA_Starry70', 'ByteGalaxyZoom', 'Rid3rCrystalPuls3200', 'XxSamu3lToxicxX2017',
                     'Gam3rGhostUltra2022', 'BANE_Master14', 'AiiioneSesta', 'GRACETHUNDERNEON20_Y',
                     'Skat3rB3astAc32023_Y', 'AbigailW0lfByte2017', 'MysticQueenPulse', 'AstingoFrisi',
                     'Br00klynn_Ech02018', 'AriaWraithH3r02019', 'FitititiNgas', 'EliJellyChaos', 'VictoriaDawnH3ro',
                     'EsanderaRaro', 'PLAYZC00KIERIFT_YT', 'Cha0sFury2015_YT', 'Oratasiierse', 'HawkCookie85',
                     'HunterDarkArr0w', 'OndinouSanor', 'OmouiyeDantu', 'Lucas_Rocket20', 'OmioresouRin',
                     'XxSparklyHyperxX79', 'CookieShadowMiner45', 'WilliamLucky201850', 'ChillRiftFlash2021',
                     'ieareroFiemo', 'BeastLucky202482', 'H3nryCraftTig3r', 'ZaydenLuckyUltra11',
                     'PrimalPix3lPow3r2024', 'XxSkyBlizzardMasterx', 'XXPRIMAL_PlayzxX2022', 'AsherVoidBlast',
                     'XxAiden_MagicxX2003', 'SamuelBuilderSilver', 'Ethan_Omega67', 'Mas0nEch0Pr0', 'EVELYNPR0_YT',
                     'DuckStream47', 'XxCyb3r_StarxX2007', 'Byte_Craft15', 'Ninja_MYSTIC47', 'EliFlick2012',
                     'LuckyRock3tGhost54', 'idishideDout', 'icousheRedis', 'B3astIc3Magic', 'BlizzardArrowHawk40',
                     'ElijahFireEcho2006', 'L3viMast3r201637', 'RimidoneaSof', 'S0phiaChillBlizzard', 'MidnatoFitha',
                     'XxJ3lly_ArrowxX84'}
local RECEIVER_LIST = {'SkyStreamZoom14', 'Xx_MICHAELCHILLNINJA', 'N0raFury2008', 'Jax0nVen0m33', 'Hyp3rSilv3rByt3',
                       'Hunter_BLIZZARD26', 'Rogu3N3onMagic2013', 'Night_BLAST66', 'Xx_Ph03nixSlim3Vip3r',
                       'Addis0nDriftW0lf', 'UsedistouTha', 'OfontunguSsu', 'VenomMax201183', 'Lucky_NINJA2003',
                       'AndiiengaTen', 'AiiatriNturo', 'XxTurboCod3xX14', 'VoidSilv3rRift', 'SaberIceSlime2015',
                       'WyattByteCraft50', 'XxFireBlazeDriftxX', 'XxAubr3ySparkKnightx', 'AmeliaCrystalKing',
                       'BlastMysticQueen2011', 'XxNovaQueenxX2003', 'NoahQu33nUltra2018', 'OwenKingFrost2011',
                       'ElijahChillFox2024', 'XxPaisleyBearSonicxX', 'Hyp3r_Ninja56', 'KayleeSlimeLucky33',
                       'JellyWraith201486', 'AURORA_Night13', 'XxDuckProxXYT', 'JacksonSilver202143', 'Elijah_Dragon46',
                       'RileyCha0s42', 'R0cketZap2013', 'EllieM00nPr0', 'XxSaberSkyMysticxX', 'CircuitPix3l96',
                       'EmmaOrbitThunder2022', 'XxDawnFr0stxX2019', 'XxEllieEagleCookiexX', 'AmeliaNe0n202448',
                       'VoidNova40'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
