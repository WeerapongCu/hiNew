-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'Lambenajwa913', 'Wintwylds4642', 'Kringzitko305', 'Highispas349', 'Oloweditti3070',
                     'Talicdruen740', 'Erykalorz9721', 'Pillidyles363', 'Bunalkiess7486', 'Nipermiech1077',
                     'Enidstdon149', 'Guntzouk85396', 'Jeckaull86173', 'Wileszakir714', 'Madllitt65540',
                     'Blaziginni8090', 'Opherkenna085', 'Crokegenz185', 'Jursshamar4861', 'Akivapayan1084',
                     'Bentzfatih847', 'Pranorecca66368', 'Demasvolek874', 'Rantzaber8933', 'Asonbei1158',
                     'Sacreciuba30060', 'Matyityne2754', 'Kaiusreis50614', 'Waddalton35518', 'Homblen431',
                     'Tupaoprea7511', 'Palshamet519', 'Loewesidie284', 'Egoreidt88254', 'Gemzadoutt0017',
                     'Agelkohs8816', 'Eibsnide73557', 'Luksokula945', 'Forbybarci172', 'Keamononog150', 'Htaylisle100',
                     'Uferploof0483', 'Basekiper848', 'Duahmolli077', 'Brtekkahle6175', 'Kehreura0807', 'Sydesrudd0692',
                     'Bumbwilie588', 'Smookthu506', 'Birdakre649', 'Hefelbozik327', 'Banarnula816', 'Sanicfejes767',
                     'Mehdiricho848', 'Ticasbigot35350', 'Ryalleth5603', 'Oltzsrp3731', 'Roleytropp47752',
                     'Talatsye376', 'Denillabak962', 'Rajabhigle1260', 'Nangcham230', 'Pishqutub121', 'Trollkeils321',
                     'Evvywysk86362', 'Woskasuzy932', 'Belvadajer733', 'Abulciera64231', 'Milusmeany25845',
                     'Dainsbyker4323', 'Ohmanpaci64071', 'Ducatkleps37656', 'Trelaluntz7901', 'Oppersenan57102',
                     'Fnudero5419', 'Mciehafey5038', 'Xenosaneka96904', 'Chrinnagib76199', 'Faltololl52374',
                     'Toalebayrd389', 'Benoshaut1062', 'Delsosides706', 'Wojtkrahe6442', 'Kuruplivvy63651',
                     'Bokerbelan84304', 'Rosezakas752', 'Seppidagon03897', 'Rixmeitl5455', 'Kharitighe39279',
                     'Foggogossi7031', 'Altomwendi348', 'Brendfloro5440', 'Ruckskarin728', 'Opokubero5840',
                     'Rechjau93367', 'Sansdeh8038', 'Nothruona28904', 'Haqlup542', 'Molaypila9412', 'Peskaangen90073',
                     'Kobinziva953', 'Pekjesso53026', 'Kellgolen120', 'Rexerlintz85138', 'Zofiarito6686',
                     'Easumehrle45785', 'Janeyyore01773', 'Morelvork6136', 'Agniprose274', 'Harbyghant2532',
                     'Kroghsonke234', 'Behmehrab05954', 'Taycolosie00837', 'Rusiebateh536', 'Parydaria467',
                     'Colawkempa699', 'Zopfgast6623', 'Horryyark8678', 'Rinkaosle5968', 'Gutecke643', 'Akeoranck687',
                     'Takulotze17816', 'Sonjupopov89135', 'Bobikziler6469', 'Bleeslual33667', 'Dosetudon63272',
                     'Sensdorso941', 'Pensorobe7578', 'Mellioseth45558', 'Naipofoman20634', 'Mckoyyulee32386',
                     'Perekset4859', 'Veliunisba4755', 'Obataemard0569', 'Bayarjatta5750', 'Hanaayadao1014',
                     'Twohybatke93751', 'Prinatti39100', 'Tonnrhea503', 'Zolotshern993', 'Trupekonan99661',
                     'Teemsirena83390', 'Burkalakes90011', 'Woomedas5426', 'Dzibfulp931', 'Alayraehl918',
                     'Davitthad663', 'Ashbadoom81883', 'Hizarsusco343', 'Jaxxrach23997', 'Xyongbaab253',
                     'Gohilryou68629', 'Mewisjopp50968', 'Kucikaria70551', 'Denetfong56466', 'Ihlikuzin66582',
                     'Clowndahan300', 'Preyduwel5162', 'Shalekrysa732', 'Avizarufin49421', 'Okubowatte13911',
                     'Boglealge430', 'Geroubilla584', 'Oddiproto56764', 'Guzanshai6700', 'Huskchatt76631',
                     'Radlsusek60545', 'Cardyjonna017', 'Trutebyrd6412', 'Osakirubyn529', 'Yeuutegg62639',
                     'Usedatopi5868', 'Ulhaqareen0213', 'Faystarn75797', 'Lacnyarjin722', 'Croatharpe7886',
                     'Sallibeska480', 'Woldemelve33321', 'Babijsoape914', 'Geninneda3816', 'Stakeoffer56723',
                     'Audustyer90860', 'Andiaanke791', 'Didarpluss737', 'Sedeyliest1639', 'Susorfehr0929',
                     'Haderjelke525', 'Carioliss651', 'Eagystan56185', 'Flytemyat459', 'Avrarekuc042', 'Fynesdutka2484',
                     'Oroanima1348', 'Ricergesch96748', 'Ocranskow38535', 'Mrsnysmits74458', 'Zillahalda7185',
                     'Tollareems105', 'Williblong97478', 'Curtyjalal80786', 'Lesodage537', 'Summelelia4477',
                     'Kocrahib395', 'Belustag772', 'Gnatmondt4267', 'Causamosso06136', 'Horiegwin05940',
                     'Heralkoban83911', 'Zoncahute0995', 'Byanvinti67152', 'Zelinzalud890', 'Khieudiab469',
                     'Navezsharl8921', 'Bozinbus773', 'Bedorlat1652', 'Muttyveek074', 'Rinnaped436', 'Klasegeare1947',
                     'Huppcardo289', 'Dutanaqui034', 'Rilyarzu467', 'Altypabey810', 'Boneethio3242', 'Tullyvoner624',
                     'Baelesyta5592', 'Kawzaidi720', 'Darondvir95448', 'Diveldujon9580', 'Toynibeh59850',
                     'Choekerce86548', 'Okelspiry83944', 'Oemigrodr0703', 'Reerchary36032', 'Caponair9659',
                     'Roldell77448', 'Daubybleu3181', 'Rexeszompa936', 'Okesbeliz8970', 'Zimneft44194', 'Amianlady344',
                     'Cruteayze80700', 'Peedstuut078', 'Feithshara6678', 'Zupoemich62884', 'Browntorna5891',
                     'Andrylippy887', 'Antalimad210', 'Bularuka743', 'Evynpirre9931', 'Croixtervo3882', 'Wiantgeho5121',
                     'Calfaraish132', 'Boviajonke0080', 'Ewensfaatz2714', 'Feigdede6332', 'Kausemonz630',
                     'Duchirahn83275', 'Brustgresh1332', 'Burryshoy00529', 'Lagebence80299', 'Leakisaia03738',
                     'Lapernuon544', 'Swettbran5026', 'Maireremmy20667', 'Adwayarno968', 'Spiakaly1001',
                     'Laskydunno638', 'Cianikogut39326', 'Boardboula5619', 'Pinntabdel0711', 'Phaupfote2501',
                     'Badyhampl9775', 'Kateeeich203', 'Skorlule167', 'Trippragno58584', 'Kuneypezzi7399',
                     'Boadofaile77265', 'Okalapt7427', 'Taftsigda28956', 'Krichjar1542', 'Countgonka5587',
                     'Wingtanks340', 'Adoravoas5300', 'Rozicpapoi897', 'Batlamoges023', 'Azuayorn54641',
                     'Hinchwalus732', 'Tatkoching1894', 'Plisrub94726', 'Uhribrue63419', 'Jaglaganir29929',
                     'Kosoamplo84444', 'Ankiekerby8820', 'Tweedgildo5300', 'Raunkimp319', 'Bilikceran911',
                     'Tahirsprik41839', 'Keunggathe71381', 'Zinzikoja49282', 'Miechfaso875', 'Shueyjoury34190',
                     'Saeidogles716', 'Kiratikzda26538', 'Caragturk5704', 'Plesszalta007', 'Salsaetris5326',
                     'Hudektom319', 'Okanosolas8644', 'Elejaski9912', 'Larahtasi140', 'Tamjohs730', 'Rintapeggi296',
                     'Ribisgueye0549', 'Gigaxmouro67328', 'Alffilluch3304', 'Redalzinna245', 'Dyjakbraca989',
                     'Koivuhally824', 'Dassopoy7700', 'Pecheems568', 'Richebica588', 'Bobinvitt0795', 'Omrannyron333',
                     'Wragebipat651', 'Barkodubon5080', 'Bulesbath4589', 'Feistaleen5570', 'Moatzohm466',
                     'Bizekbeula1102', 'Seinoyusof76136', 'Forrychuey4100', 'Barsalisco733', 'Oylercare609',
                     'Narelwyse794', 'Rolfsorama764', 'Solarufty6729', 'Sierkrybak646', 'Grecksapp30248',
                     'Topicbory2311', 'Ortylkeala772', 'Kluthsymms1052', 'Laizarvai092', 'Lineaflaws755',
                     'Gadowtakac40895', 'Poquearios2496', 'Yaurisater2548', 'Foitwry677', 'Opettaray50844',
                     'Panadrain3108', 'Dulacmocny3341', 'Moneskelpe98219', 'Roushcain90241', 'Demasozee349',
                     'Vokesmaty2724', 'Altopfaigy983', 'Leutygiere661', 'Pentoliwia249', 'Mesutkieta851',
                     'Neitzbeggs8446', 'Pratodimou26098', 'Ahannanke9155', 'Eigeanays8388', 'Kimanknous355',
                     'Nilsowney894', 'Coppmule4872', 'Dastiayyub6377', 'Kostyklump692', 'Macismicca4107',
                     'Nunagserda5185', 'Kytecaney559', 'Loanshir857', 'Shutzpater20747', 'Keanykuzia75298',
                     'Berryzehms814', 'Feenylicup32459', 'Caskaalafa953', 'Greattal6422', 'Cookerova36519',
                     'Mosakxinyi1091', 'Emirghyll137', 'Eadontyga2563', 'Holumriki575', 'Haasljuly2042', 'Merazinzi478',
                     'Faziohelyn157', 'Naquibyman509', 'Gardaducey909', 'Vazthies022', 'Keurstyx40979', 'Auksester4720',
                     'Anvidalla2217', 'Alcosshuja0075', 'Chuteryes0159', 'Ollysaake9421', 'Bizerhales12066',
                     'Kukormapu7834', 'Saullreham4603', 'Broodviets0050', 'Daveydomer04621', 'Hugarhulen736',
                     'Daffizopfi7626', 'Gaudefazil981', 'Ruedeenlli74302', 'Munazsnee15823', 'Pickiehl563',
                     'Remmyloque4945', 'Shaumcruit0106', 'Aumhosoi6161', 'Lexinorn844', 'Zemladatte742', 'Odemkludy147',
                     'Joofwatry885', 'Tysonhaly735', 'Kobbeeffie571', 'Woogotte171', 'Fircherena1252', 'Aoaygroze1090',
                     'Shonghouey03479', 'Ayrantison8905', 'Sagessesco693', 'Loykogolby7966', 'Lortsdua606',
                     'Duankirra35172', 'Kompfiggs6221', 'Muhmhing830', 'Kaylewadas00690', 'Touzefrech99775',
                     'Arinaboryk6026', 'Wutzatter239', 'Gosiksoso2457', 'Gilbovirgo347', 'Zabiktysor54943',
                     'Troubflomo25075', 'Abeaale648', 'Byesfermo81559', 'Wairsowry885', 'Bacebiles89595',
                     'Rinckkeiss2696', 'Hadihiba0611', 'Celievon969', 'Brummletto76218', 'Serakbagin8854',
                     'Foldijio3983', 'Novbisom97147', 'Elksbulau401', 'Fieadyan46187', 'Bruhnvizzi94967',
                     'Cymanyukna93301', 'Soareami62994', 'Norsewalji47019', 'Remmyfoord35377', 'Emlynlekic0571',
                     'Boopfahl20551', 'Dassyakow990', 'Buntest2211', 'Wrasemikle8084', 'Lassikandy01200',
                     'Hougemungo05148', 'Fronfyle25332', 'Orwiglotta550', 'Nuurfurey89098', 'Ekeyradev4882',
                     'Joppyjoves8987', 'Voteponze6750', 'Yagerbeets008', 'Kruljanov36365', 'Ostbyaerin839',
                     'Osethhally718', 'Zilmmotti0539', 'Mazasbeber9502', 'Wirtakee7596', 'Badukoval812',
                     'Tigueahart912', 'Froshtovo8124', 'Heramelow59515', 'Moiniasad511', 'Fluteauda148', 'Houryorek177',
                     'Henjope521', 'Nollafling705', 'Anishbugg001', 'Dobinkui511', 'Hulkaetue3014', 'Leveaishan3100',
                     'Gladddomon0338', 'Handeelewa30478', 'Marekneiva4658', 'Rawzais96671', 'Zabatraena909',
                     'Egleremly787', 'Consliepa33851', 'Ohlegerr8111', 'Raishpaska820', 'Hogelmolen557', 'Ruggazore025',
                     'Kotomemic628', 'Sapraahana99837', 'Bibikluyo715', 'Amoriagwu5462', 'Sitzemera9556',
                     'Monzbaich1560', 'Enmonsuah6161', 'Heidpesa61230', 'Trillnijem861', 'Roblenoj739', 'Irmakvolek972',
                     'Vaalleat619', 'Bencibasso6189', 'Hyzerflo42235', 'Samoyfekri316', 'Pelenkeast866',
                     'Aokisainz58318', 'Hawkmotal1921', 'Yakowkoen766', 'Niyattakao2282', 'Rekrung24798',
                     'Ponttamie250', 'Yentepilny9557', 'Riobewerry0480', 'Langareyna825', 'Naserglaus959',
                     'Cadoyspeth34761', 'Iriskeser98040', 'Vonowehde169', 'Kocaooley648', 'Begghanly6219',
                     'Ollisneace8946', 'Ozoacoady872', 'Dursoyeigh934', 'Boreyobhof544', 'Bahrsbebko6397',
                     'Nannkorr74238', 'Dimesusi28817', 'Rattuabud15221', 'Hakzold615', 'Adkinmes182', 'Noferputh22884',
                     'Gnozakapur416', 'Aststaci96404', 'Ankekatic59094', 'Hidedario11548', 'Ivoshad59092',
                     'Stiermetin4000', 'Afromkiman959', 'Idrisluich826', 'Pfahlolder6378', 'Ramesrey0098',
                     'Qaderisern858', 'Reduswegge45096', 'Fellyoral86424', 'Brackibara904', 'Pashofleet322',
                     'Iglervolo3307', 'Jonieulak69122', 'Meahlampo7577', 'Zullikresh50514', 'Udeotta03862',
                     'Lahmgraby69081', 'Vespoghane6937', 'Lelkolute6159', 'Munkotahe068', 'Artytomsa1204',
                     'Coakuibel68418', 'Hudedunaj6733', 'Prushoit331', 'Halemhalyk59225', 'Skucekolar3965',
                     'Vieuxsmtih3828', 'Besltahir8997', 'Minasusan165', 'Fratzeppel7303', 'Amianrouly9658',
                     'Pulectray5799', 'Morgamarit035', 'Ghanianiko0989', 'Sagisilfa676', 'Bargeslabe232',
                     'Fowlssirgo298', 'Munozkran4083', 'Ortenpui94457', 'Jericbrier8625', 'Elekizaac3461',
                     'Puaaulch66540', 'Daisiypina378', 'Fizzleus2122', 'Sedodrach756', 'Eulacoe0703', 'Rogelthate68906',
                     'Flynthaftl079', 'Osoydrage36459', 'Daturehm338', 'Klughjuri1928', 'Rohlfbucy0188',
                     'Rheadyre93600', 'Ileysop358', 'Saoudandoe0269', 'Matarkovan932', 'Doppfahey62961', 'Vedromay6676',
                     'Patkakumro614', 'Irvinolivi639', 'Bordyelzey097', 'Fierynuman18674', 'Honnsholk148',
                     'Fixelvalda9616', 'Soziobould91204', 'Brocanappe716', 'Garkroh862', 'Gerotohlin5952',
                     'Leekswendy3908', 'Hurynniara452', 'Yellelidey63002', 'Yurozwaan53129', 'Punkedeion067',
                     'Votemangi6762', 'Fingcomin06127', 'Weidtayrah476', 'Byrdkalib61353', 'Tewesimrie740',
                     'Vedroti443', 'Emausgerez9202', 'Clutspoux96091', 'Kontymarre213', 'Diannthole37292',
                     'Deienrocke96829', 'Zickworn7848', 'Hencytitas921', 'Baideribau3855', 'Doliorigot904',
                     'Feelaforee507', 'Jumbomoric80299', 'Belikneece736', 'Brabobretl409', 'Rigosclise37752',
                     'Brysbeahm075', 'Tebbsvotta476', 'Bialkkeown555', 'Fiegedlugi36352', 'Dainskorry818',
                     'Wadlearhin5120', 'Rosarusie63098', 'Kuppadanan9899', 'Juleelsa57905', 'Ahyankasey1705',
                     'Gupteawale22979', 'Douteshudy7847', 'Wagorkiest662', 'Okaimucaj0069', 'Ryghehab65320',
                     'Jullhoa73488', 'Aleramus17804', 'Kuksnerby7230', 'Ragarhider953', 'Susekerica99941',
                     'Babaserter157', 'Laskoatkin016', 'Reenaketay32870', 'Ellzysabaj4608', 'Eulerbonet4328',
                     'Stdonakbar340', 'Metinlaro92607', 'Osdenemlet87087', 'Sudanbeyke294', 'Pennread701',
                     'Grecucops88192', 'Deazakouji1450', 'Voorsnagy0491', 'Bogelkeogh0761', 'Kyawmeans412',
                     'Renesmahre3939', 'Tuurarunte8871', 'Olaizamper7717', 'Yepamuthu470', 'Vanamtrum4711',
                     'Koscoboun84583', 'Foustcarl7425', 'Salmomyrup2288', 'Mikslanka39582', 'Nortecasey524',
                     'Besukaron3671', 'Cirrimolea360', 'Karhugalya710', 'Breanlemon115', 'Hultzselen8617',
                     'Ahnenbizek0271', 'Ledecashu76223', 'Proopaige06686', 'Nayabbowle7982', 'Bryertagle8336',
                     'Jinamarot79921', 'Winigust3665', 'Rojaniorio5092', 'Hellfeuer8264', 'Hehblint957',
                     'Dekenconna9595', 'Zaromyong7316', 'Ibanaruts67957', 'Chackjanz4188', 'Amorewares628',
                     'Devitsat0183', 'Yankekrylo483', 'Klymose449', 'Camatogeen18270', 'Byresmatin779', 'Logascuz073',
                     'Ersinsoufi15669', 'Laygorima28200', 'Nadarhowes021', 'Zartibe29151', 'Waserfejes37023',
                     'Papiaecret000', 'Kaiwifeuss3223', 'Pruimfloro6574', 'Buobioli58513', 'Yettaorgel3751',
                     'Delkelehl69163', 'Karasglas3290', 'Sorinlabak2905', 'Scankeligh7241', 'Thuekuo12242',
                     'Pattdefur333', 'Yasinbintz1614', 'Seniaviter9802', 'Badiahavel306', 'Blondcarr8263',
                     'Galdaroun55384', 'Punoderse31748', 'Galerosian708', 'Lochbadi6248', 'Boltgolat1950',
                     'Bekiblagg067', 'Kalattamra8932', 'Baciurenz5756', 'Didiaberz403', 'Funchkertz21119',
                     'Allingentz56056', 'Ogierdelta096', 'Ugoketan139', 'Riakdupre83571', 'Dupingorry505',
                     'Cieraguidi8328', 'Janeytashi916', 'Spaaneabha325', 'Roryilano415', 'Raddbawa962',
                     'Hovensysol20429', 'Teertames0775', 'Sayerschur7924', 'Fohtsoo1989', 'Bagaifra18840',
                     'Sankaquell38891', 'Nayerrob87421', 'Rinzeleen6560', 'Okurese004', 'Chenebood26846',
                     'Kearnstuck2609', 'Dryeangad29087', 'Soonkoya908', 'Legaschoo1982', 'Oteyguled951',
                     'Luomarandy22820', 'Barcofife0756', 'Hajekfaina903', 'Shaumkamin5282', 'Deemantz37642',
                     'Gottszsiga97909', 'Breeeryn6098', 'Bredebeans39680', 'Leitalacko306', 'Bedenislar18084',
                     'Maruonder692', 'Onessanso557', 'Sairaklass7976', 'Kandnnadi003', 'Malamploeg166', 'Wynerbont8565',
                     'Wyseperea2967', 'Lesianyen87941', 'Wianpyant360', 'Toweygenua436', 'Chaeleija3226',
                     'Orlowelges81616', 'Cichynenno13067', 'Stylelunde81622', 'Gazzomcann839', 'Nehalperon102',
                     'Mulatfoell382', 'Tracpriam15630', 'Laidorri226', 'Davieluh525', 'Kolccanoy6681', 'Brugzaeem0485',
                     'Amousgaile685', 'Carlyjent783', 'Godduzoie915', 'Lesejovie2886', 'Nimasayeg5598', 'Georgnjos292',
                     'Polkkahrs6456', 'Yuenbadin517', 'Tostfirle037', 'Impeyerol7763', 'Fueluriah604',
                     'Pavisserry65191', 'Mulchschy241', 'Koostrilt214', 'Aldyjafek872', 'Prullpolit3379',
                     'Flucklyken66701', 'Levykwesi68763', 'Kruzsprai09852', 'Amdormcvay38431', 'Dimovpeacy382',
                     'Coynegampp0603', 'Sionadarb42784', 'Walshbracy689', 'Cahuesaula436', 'Arzojason238',
                     'Mihasrisso610', 'Avinoigor0724', 'Ganlybeyah9952', 'Mauckdunne662', 'Cudangudel259',
                     'Mataajit133', 'Vaghntoupe1960', 'Odeapeele55879', 'Girienmon22325', 'Gicakeala10628',
                     'Zaunlekas56250', 'Cawreim9117', 'Doatydoub173', 'Knochknoke14277', 'Yakubevatt91766',
                     'Utschihli84264', 'Tassobudy693', 'Wachalmon854', 'Orferooke419', 'Yorroerler4424',
                     'Toomspendo66681', 'Cloyklop147', 'Sionabruun5886', 'Dutzkohns85825', 'Spitzeriza8780',
                     'Mihalbacik93365', 'Zarelubke854', 'Maboupujol0501', 'Oshayami236', 'Lubasmark954', 'Eppsbowls785',
                     'Goraknick2471', 'Dukaskurle666', 'Tarbylajqi985', 'Taneurmos8479', 'Selbedahne5419',
                     'Douttkerg750', 'Mammodim2447', 'Knapmond616', 'Garynchap5263', 'Sierakupau1686', 'Erionworm6308',
                     'Loewknosp42128', 'Ekeshauth7688', 'Mitanspahr70321', 'Verenfabor2834', 'Talassaff4923',
                     'Eplerteer0635', 'Sassiovard261', 'Lubancasby3463', 'Werchkise0163', 'Heppeosoro3406',
                     'Mcdayaqsa38059', 'Howrygigl71662', 'Moterzulma041', 'Koryfru959', 'Kraghlohn69329',
                     'Dixeyhynds17427', 'Mentablado210', 'Lutybider2956', 'Claxdrahn710', 'Lomaxpurta6850',
                     'Oquinducy9983', 'Jamisserna002', 'Loueystoer529', 'Emlynlefko7960', 'Opelahour59343',
                     'Marrebarze292', 'Sossbrinn40356', 'Nivensegan026', 'Shaleczirr3358', 'Reseromori266',
                     'Avnerlaky26238', 'Tuschjinez16520', 'Glaseiram189', 'Deitzillas87686', 'Corvomulik03851',
                     'Rankltunzi36340', 'Awelcrush283', 'Tadkoos92113', 'Wanoheery02917', 'Ovacora567', 'Doxbeith84153',
                     'Kardraheb319', 'Helvylevee200', 'Zankofamke01408', 'Jovankramm631', 'Weuvekiwak119',
                     'Chetbon66385', 'Bezydalaq5487', 'Jesussophi28008', 'Hueyhinal155', 'Grauedelos0998',
                     'Abhisara13922', 'Razekromm859', 'Ardenbeene27098', 'Oomssesto92577', 'Grownpizza7412',
                     'Getsydayna5740', 'Sannypepin0187', 'Tanjiguzy696', 'Galmdraft778', 'Jyleshald015',
                     'Cluneguzak69203', 'Beerypinar244', 'Adjeiraffi388', 'Deruehulit4678', 'Hombmcvay152',
                     'Sleettuala600', 'Vakilcuri8180', 'Gutkeverso5948', 'Poppveltz9468', 'Feigelif8569',
                     'Jeskigeter6889', 'Denhawentz9398', 'Huhtanigel5408', 'Kinnkelli56254', 'Klugebakun303',
                     'Avanivadas8536', 'Fraseagius9635', 'Allintange686', 'Pecotevola44346', 'Bibeekarro02455',
                     'Grillsanad2272', 'Madaybesic743', 'Lerumeh98796', 'Caseychima552', 'Agindua56870',
                     'Rialealker574', 'Dibluse0037', 'Boodyrabey6446', 'Celoourso854', 'Spryleong84505', 'Roohrfuh128',
                     'Danlyprey447', 'Boadoliter22381', 'Kyeyambo1034', 'Kontzvolny1220', 'Masiflyn66409',
                     'Beithklin9181', 'Mayseklear872', 'Beahndio204', 'Rupeyanno029', 'Ketaywaack802', 'Lauebobbe13069',
                     'Khyanzent50090', 'Gigondowd105', 'Ajaxomo239', 'Toxeyistre86114', 'Camykraft871',
                     'Rubaslarna68839', 'Lowieboesl96210', 'Viviaaka07790', 'Olzakfahie2738', 'Roessbosel1545',
                     'Arnaspidde251', 'Enginfehr7236', 'Zabasuehs21979', 'Tundokioko0576', 'Netthase5902',
                     'Settygloss41277', 'Tolliruys69072', 'Naccaamodo022', 'Sabetomar27758', 'Agnerthich3984',
                     'Granoteo70038', 'Shafiely128', 'Hydukgaudi627', 'Buyceyebba72973', 'Dolcilett2817',
                     'Cenaruwe94229', 'Saycejoyce376', 'Reuellaci54291', 'Uhrinlera1016', 'Jankycahra4346',
                     'Kittolua35427', 'Seilsaddo130', 'Rowanpetel00100', 'Houinajoku852', 'Brownchew5278',
                     'Stairvaron532', 'Chadahenak5871', 'Giesebinks2561', 'Buiskugle4013', 'Fargodirzo214',
                     'Aksakafer51075', 'Ragooguard5487', 'Bigbyrenea1720', 'Roudagaur4216', 'Arnotcly60469',
                     'Butorirfa523', 'Ekeschhen05592', 'Smidime3754', 'Zatarnandi5242', 'Vaimahd9163', 'Okohmalyk415',
                     'Monkahora14713', 'Nilsmusi28596', 'Minckbrik930', 'Arnotsaga7096', 'Cepasbulko7432',
                     'Bessojoyne76072', 'Ingowencl511', 'Kannesusin4062', 'Hungbohol440', 'Dorphcammy130',
                     'Ugalearkle7093', 'Leedylecce1889', 'Aamotthiry700', 'Yantativ02587', 'Bolarelvin34298',
                     'Meerehicks12550', 'Arsonzelle0627', 'Eurygmur0371', 'Aubrywiss71520', 'Vaaniaddam2531',
                     'Seroganz58909', 'Goutbazin56865', 'Ruferrote281', 'Sallsdeol93945', 'Bauzokempf458',
                     'Imbohoush90261', 'Doinoramah5175', 'Oriassiry5771', 'Theesteng13646', 'Sipkohekel307',
                     'Borismaida95851', 'Morakberta639', 'Stadenyby88187', 'Colomfugle1866', 'Biardabreu93398',
                     'Loeakbem5012', 'Behnwecht0948', 'Lomaybelle27728', 'Chimahaja01625', 'Maohunysa4542',
                     'Lehtiwayte582', 'Nnadiorio851', 'Heiliwagar67176', 'Azizagroza9689', 'Cheffstoel45541',
                     'Cadomaslo109', 'Kowissuesz73846', 'Parumcast79113', 'Knoeryerry337', 'Hoppajappa70036',
                     'Librachih33796', 'Ikutalimp671', 'Gaskakosen41611', 'Neicemclay8075', 'Tanvigopar69483',
                     'Aabeasly9600', 'Gloverema13530', 'Canasenver0788', 'Reppcarry88995', 'Exelfreek543',
                     'Gortidahen7536', 'Dolchkapke20523', 'Sadowohl2395', 'Uzanstaat568', 'Brusedane57906',
                     'Bakelkira706', 'Boiseroaa5694', 'Habibbunk67917', 'Barawseely06920', 'Legayguyn81826',
                     'Lallielif124', 'Posinpeery5907', 'Kleckhesla9851', 'Tunarugel088', 'Hazlekees89673',
                     'Ngugaton5289', 'Surymelki126', 'Agergarbo806', 'Quinkmagel7388', 'Sawhnonez94054',
                     'Loayseer12871', 'Benchgivin291', 'Weidtmanon66568', 'Suttverch06451', 'Dameshance865',
                     'Burokabir981', 'Folckcosay14201', 'Canugrav101', 'Darynallah58631', 'Ohdebevis7788',
                     'Kesbybrohm6226', 'Lettydeloa42663', 'Bondakehne04604', 'Dobbkoyl2988', 'Borziehren39448',
                     'Tabatsayed6960', 'Geilelor095', 'Kovenjeffs64670', 'Fisclarnon8626', 'Mockoegawa08303',
                     'Crytscimon24255', 'Sormodean27647', 'Gragglenh002', 'Pokeramen404', 'Sminybasil61454',
                     'Jayonmoine19063', 'Eroszoma7184', 'Sohngiora1286', 'Frainkoong0731', 'Raasskuga94062',
                     'Styckleia83305', 'Synlucea00063', 'Akunakesar773', 'Graenhalik7323', 'Miskakemen932',
                     'Schafgrass50531', 'Suzorclem8362', 'Guziguler22935', 'Sojdaturro4698', 'Gadusquon7770',
                     'Dohmwahi4441', 'Fullfuchs2122', 'Coonsalt537', 'Satzklau20312', 'Spatagayle9585',
                     'Gedgeuetz88886', 'Dearszonis29974', 'Burialeab17976', 'Meccanilsa2078', 'Iuchskolz25317',
                     'Clemdroze750', 'Valdatyron214', 'Spinotkac571', 'Sansveri6365', 'Liffnewey849', 'Enaesau715',
                     'Walnyyaney345', 'Adibaakam42756', 'Dibzelal31011', 'Merkttrehy817', 'Casiepozo1184',
                     'Tawaponcy6707', 'Gereagel87508', 'Caglehizey1132', 'Goobylindl5662', 'Muinotripi6055',
                     'Lingogabb82069', 'Perkyrebe923', 'Oriaannas41630', 'Lubsalms625', 'Essayrasso5416',
                     'Cassireott1589', 'Barelotz383', 'Munocjupe03432', 'Oltzaila7712', 'Sainghumes110',
                     'Broksroewe266', 'Olmoshanks1104', 'Clukacacia365', 'Viscaamrik437', 'Setttrau48668',
                     'Otzoyzaken455', 'Eymangusky2483', 'Okanegunty607', 'Wringwaitt831', 'Fazilprows49482',
                     'Drnekeggli881', 'Zajcdhyey910', 'Mawkoja7158', 'Libangenel0168', 'Hoptaaesha84218',
                     'Kozolaiono36583', 'Safabural0330', 'Cracesait4707', 'Nallswiers333', 'Koopsjara11268',
                     'Useryscala535', 'Hwonghaner3029', 'Kringnikki47438', 'Maarxfalen59039', 'Ruperturk102',
                     'Sewerhaufe17272', 'Kodaouma423', 'Zentzbeyal99616', 'Bessogell85181', 'Slickobina073',
                     'Filipit317', 'Pexsalempa68982'}
local RECEIVER_LIST = {'Chuhszasz60502', 'Dahermotl41456', 'Lanikkerth8869', 'Huretyaiva06481', 'Radiskjome50411',
                       'Zupoidil02573', 'Haneljarr461', 'Prahlbokor8894', 'Crestsiske6673', 'Dhimazaic6084',
                       'Waipastady29407', 'Kotikriehs882', 'Pharrlekan00762', 'Foellvoll0723', 'Resigsenyk14802',
                       'Yeanytysor572', 'Periswasem04221', 'Darcymagno216', 'Beebycosca8760', 'Curiomarto05224',
                       'Corframee32687', 'Didimyton97441', 'Sighjaggi7517', 'Kamrafefer870', 'Odalycrovo227',
                       'Urmoshemmi08506', 'Guoanviv518', 'Knipsronco85073', 'Zhengzani51352', 'Sweepguy62632',
                       'Mcveyeskaf46790', 'Lipkayang99815', 'Oethmasko374', 'Reatyosel394', 'Creascheg369',
                       'Rieksperch99708', 'Siskcrush187', 'Cladybien6583', 'Newazshaak93244', 'Beginpono5961',
                       'Niolaalice5019', 'Lewielupul56601', 'Resaolari208', 'Prinzsamit604', 'Orvikswaim25353',
                       'Mealyfosu81640', 'Tutajlizzy073', 'Jharock56106', 'Fudymlauze3602', 'Gainehero39612',
                       'Naspyke2508', 'Claasrota36297', 'Cadezlulek811', 'Truaxheely7952', 'Chinnerror638',
                       'Dogantront34996', 'Mitlokenne61387', 'Bajickytta897'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ตัวแปรสำหรับ timeout การรอเริ่มเทรดหลังส่งคำขอหา receiver
local SENDER_REQUEST_TIMEOUT = 200 -- วินาที
local lastSentTargetName = nil
local lastSentTargetIsReceiver = false
local lastSentTime = 0

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันหาผู้เล่น sender ที่ว่าง (ค้นหาเฉพาะ sender)
local function FindAvailableSender()
    local result = nil
    local success, error = pcall(function()
        print("🔍 กำลังค้นหา sender ที่ว่าง...")

        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                        tradingValue = player.Settings.Trading.Value
                        isAvailable = (tradingValue == false)
                    else
                        isAvailable = true
                        tradingValue = "unknown"
                    end
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " .. tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print("❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบ sender ที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindAvailableSender: " .. tostring(error))
    end
    return result
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    -- Sender สามารถรับ trade request จาก sender อื่นได้
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Sender พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            -- รีเซ็ตสถานะการส่งคำขอค้าง
            lastSentTargetName = nil
            lastSentTargetIsReceiver = false
            lastSentTime = 0
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            -- ถ้าส่งหา receiver ค้างไว้นานเกินกำหนด ให้ลองหา sender ที่ว่างแทน
            if lastSentTargetIsReceiver and lastSentTime > 0 then
                local elapsed = tick() - lastSentTime
                if elapsed >= SENDER_REQUEST_TIMEOUT then
                    print("⚠️ รอเริ่มเทรดกับ receiver (" .. tostring(lastSentTargetName) .. ") นานเกิน " .. SENDER_REQUEST_TIMEOUT .. " วินาที กำลังหา sender แทน...")
                    local fallbackSender = FindAvailableSender()
                    if fallbackSender then
                        SendTradeRequest(fallbackSender.Name)
                        lastSentTargetName = fallbackSender.Name
                        lastSentTargetIsReceiver = false
                        lastSentTime = tick()
                        return 0
                    else
                        -- ปรับเวลาเพื่อหลีกเลี่ยงการ spam ตรวจซ้ำทันที
                        lastSentTime = tick()
                    end
                end
            end

            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
                -- บันทึกสถานะเป้าหมายล่าสุดที่ส่งคำขอ
                lastSentTargetName = validPartner.Name
                lastSentTargetIsReceiver = IsInList(validPartner.Name, RECEIVER_LIST)
                lastSentTime = tick()
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        -- เคลียร์สถานะการส่งคำขอค้างเมื่อเข้าสู่หน้าต่าง Trade จริง
        lastSentTargetName = nil
        lastSentTargetIsReceiver = false
        lastSentTime = 0
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- Coroutine ปิดหน้าต่าง CreatureInventoryFrame อัตโนมัติ (ทำงานเบื้องหลังตลอดเวลา)
local function InventoryCloserCoroutine()
    spawn(function()
        while true do
            local success, error = pcall(function()
                local playerGui = LocalPlayer and LocalPlayer.PlayerGui
                if not playerGui then return end

                local tradeHudGui = playerGui:FindFirstChild("TradeHUDGui")
                if not tradeHudGui then return end

                local bottomFrame = tradeHudGui:FindFirstChild("BottomFrame")
                if not bottomFrame then return end

                local creatureInventoryFrame = bottomFrame:FindFirstChild("CreatureInventoryFrame")
                if not creatureInventoryFrame then return end

                if creatureInventoryFrame.Visible == true then
                    local closeButton = creatureInventoryFrame:FindFirstChild("CloseButton")
                    local upperLabel = closeButton and closeButton:FindFirstChild("UpperLabel")
                    if upperLabel then
                        local safetyCounter = 0
                        while creatureInventoryFrame.Visible == true and safetyCounter < 30 do
                            Clicked_Ui(upperLabel)
                            task.wait(0.1)
                            Click_NOW()
                            task.wait(0.2)
                            safetyCounter = safetyCounter + 1
                        end
                    end
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน InventoryCloserCoroutine: " .. tostring(error))
            end
            wait(0.5)
        end
    end)
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- เริ่ม coroutine ปิด CreatureInventoryFrame อัตโนมัติ
        InventoryCloserCoroutine()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
