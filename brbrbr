-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'MJESKNPw4363', 'sZiMTLBT2206', 'JKKwGPlR3404', 'eyCHSNks9897', 'dlkiyzYh7325', 'juiYkpni4045',
                     'qKcJCGBU5076', 'JmKEoKQe2712', 'QviZRlqm9815', 'mOYRwvYT1676', 'aMuFpruz4894', 'NVLbLyHe4418',
                     'qWSYbYKM4730', 'jQyFtNsq8170', 'hxzWuGPF5331', 'QWGQoRMO1962', 'OQYaZEiS5516', 'NcWGcRuk1129',
                     'IJMKVUNP3013', 'PaDuvnmB7325', 'gZLJcfhy0419', 'yIdsydMB2950', 'vBjuokSf3153', 'LRNINLwI7912',
                     'YMfBLulV6058', 'ZTmMYxwc0697', 'sprAweSS2302', 'HIgQcTvH0678', 'sjLedgbu4632', 'zicgmsUD7976',
                     'xzeGrXBA8346', 'iHZLpPog6392', 'pMOpEtuT1727', 'YMsBsZBN4285', 'miEljkTD1450', 'fPPiMFyA3548',
                     'lApmLJwT8974', 'KCQiKlDv1217', 'dMAGFhdu5390', 'HOboLcIa3210', 'ezFTjHNm8271', 'pRkbbTPk3001',
                     'KGytpUyC0435', 'pGIADkwM4168', 'ZeLZhFGL8172', 'VmtDxdHT5754', 'ygBwxwlP0933', 'fgpHwgVq0162',
                     'PyPAzeHP9670', 'zJCMqASN6816', 'NQmbRQZu9217', 'DtPOIoKx8478', 'FmIVxPAJ3369', 'ogIGMCLj2916',
                     'mKwQAwvE7553', 'jeuZuJhu7551', 'GmAlIgoY3280', 'RUkTlFRL3053', 'VrsXBrFD5386', 'MkOqmXPc2116',
                     'jFyyvhNs5701', 'cONCUFyW6514', 'jIrTdgMK8363', 'KoztQbgM2052', 'AmwLIcBc9854', 'oqnwhDqa4803',
                     'QpQFyZRN1469', 'njzcUByS9195', 'CxKiqoKQ6863', 'LwJJoVcR3517', 'NdNjmEVM1237', 'tLTbQTiM2850',
                     'dEADfdvC9755', 'WGotTkiW9709', 'lWjsecsl2412', 'BjBIZizp9018', 'GseILNmC0577', 'fmJQEwut2786',
                     'yZyZHfYM1601', 'OaoZlAwk7557', 'MiPLWUUo4029', 'xwsqoeXH3725', 'nRQjhTeD7411', 'sXMIYJUd2315',
                     'sYIdUEmg0768', 'mYnONkay6090', 'VncmnXvD6014', 'FVdRcVzP3117', 'WOwirryg9308', 'ZehQLhWi2931',
                     'lahceygn3624', 'NywvWzUt5590', 'WnDzHZKi1389', 'vcnRosjC7535', 'FBoDyicM8867', 'srUzalOn5163',
                     'tPPfgLMr9651', 'HCDqUWQS1715', 'XpVjMLaj4590', 'qVYSOsbJ1768', 'uSqsdoqE2031', 'qHSOTGGN8484',
                     'XyfSVTRa8881', 'CAuWiTLL2406', 'hSmSpDnG6123', 'ODqlzRwk9545', 'zWbkaMEs2257', 'KyWmISow2689',
                     'SKMfKzCa7257', 'rqFdAwLT1359', 'yfFvMHqD4092', 'YXSznPVs7278', 'HGBQNkRq1986', 'dDGWDtIC4042',
                     'QytKygmp5598', 'JNbzXZaC6592', 'udwykVSC7969', 'TMyfbdGk4629', 'ezDgURxv0222', 'ZAAdoIpi8875',
                     'XlecmXPb3191', 'ucDjSyPP1059', 'EGjTjEMB7527', 'DlvUUoLM4313', 'ktwysOGk3735', 'PdXsNLVg0912',
                     'dWkpeBgo6484', 'vJRAdRmZ8281', 'uGutlygF4053', 'eMQkQNet3528', 'HQYKGYeR8636', 'HquWFtRx2079',
                     'eZGAMdvt1852', 'nGGnKyny7820', 'HEVpLITI0458', 'xGxsKSYE9036', 'gmCVrzGm9716', 'ysCypDfB5794',
                     'IxTuRxnL0594', 'XGOnVatJ6885', 'OvOGxbni6328', 'RQcimAVL7297', 'aNkIkYff9093', 'aZwsQpoE5335',
                     'LUneUmOM3967', 'PhwItdRX3549', 'LQOwLKCX4704', 'OGhwxsII1312', 'UQzRIyWL6944', 'IZWAaODi3494',
                     'fjnRSeCc5817', 'xPsqxmYV9231', 'MejcpmYy6866', 'CgCVDVvM6096', 'shjQkjrY7247', 'DwUBNXRg2804',
                     'xDJLtjlx2630', 'FakUDfal2963', 'spCFVaKx8737', 'UOtOQfME8798', 'mEzcYnOs5795', 'ofsybsAa8007',
                     'BhFLxzLl4174', 'yspeIByp4906', 'JUMVjATo2092', 'wbvyNOtB9190', 'XaJMDoDV0704', 'YkouvVEf7020',
                     'SPDsYZww1226', 'uSXuQwOc5253', 'xzsQPbrr0977', 'BpHNMBzD0756', 'vRybcnKk3675', 'QUdUtCka6638',
                     'RdULKfMc5273', 'acQqRnJK4811', 'LGjNVoSc8646', 'yussoVuR8795', 'CqFVnjDy6973', 'VvInOtWB2315',
                     'GzfawUYD3987', 'qGAhlmYZ0082', 'XSHxZZYF5332', 'PYPWFgni2538', 'FZJURBQg8548', 'sFdqkkNr7402',
                     'rgWRLVWF4907', 'fMRMRSaN0960', 'WFNNuocU7650', 'fWSrMdUk8092', 'kwKdFQvU8784', 'rqFycXtb7011',
                     'RibgsyuC3746', 'BvuFaNdP5580', 'VFByQvTN4125', 'AfwBbwFf1218', 'KgKIxDGC8014', 'uLiZmqfa4606',
                     'wYSdtRym2964', 'GRKjrteI8403', 'LcErkzhv0142', 'FNsKxgWp2783', 'SXMCKXfY7167', 'YUiqaYAu8684',
                     'enLLSFej4148', 'HTleYtrV3180', 'uxubjYpw3429', 'SNzcFOPr8376', 'fKbmelkY0618', 'MkfrXNOV8776',
                     'kYEBKHix3201', 'woHmJRRs8970', 'sGKULJUm1108', 'hcxVfJsp5954', 'xdtnyUhK7676', 'rZprLNdu7900',
                     'CitrxxrJ3228', 'ZdQhXimB7529', 'AiflnJDh9298', 'jwSDuYIk1548', 'ALyrxfmh0492', 'xdtCBJPp1781',
                     'fEhkCfJw4230', 'khPipDjG3934', 'QmUHxNrB4078', 'IrejzPsB2185', 'ebacvAbq4064', 'ItaaeMkB2697',
                     'ENwwaOBN7311', 'EgvYnWyg3284', 'DOwNvjTv4794', 'WHwBpqUp4328', 'IWuVSRWU3473', 'LLDEhwHc8417',
                     'aDEVIRZg3945', 'kurBFecZ9559', 'bZKoFvGW1444', 'NVESxRPE2586', 'RvPyHvCv3816', 'bPMVVyuL7667',
                     'HuBKkYtn0237', 'eEPGiXyl3053', 'OTnaCEZY1369', 'fYjeAOIB7725', 'kLbueLQn3663', 'fZHMXgOL9282',
                     'yLjbETKX3383', 'ZmdtkBaX3405', 'xvDtDGiM3771', 'JjnRjuLX3456', 'yxyGDyyb5142', 'lyagImoU2500',
                     'ceJduPCl5730', 'dKCpAABY2193', 'qRUPwfaz6759', 'isZByAVB9869', 'bQucRuGD7992', 'ymFvBswV6631',
                     'QJhcMmlK5566', 'PqUIwtXl0198', 'TJMyhqLK2493', 'LOFAeoJg4794', 'HNiTkrBT1267', 'rCDgRFMO0684',
                     'XyrRyznU1811', 'HBAnkCbd8420', 'jbMuRpZO3581', 'ZLKgUXoX9423', 'QgUJxkFZ6759', 'chwEqbba6934',
                     'YGMLtsTN6723', 'vDzaPdMY3542', 'qCPjOjZJ2941', 'hOZCkKEF3613', 'txcbzxYE0733', 'aFcOWRzI8959',
                     'PNheaFXS4926', 'DCEGEdfN6927', 'nEDiTztD2825', 'xEPWIiDK3818', 'BMjxaRIP4244', 'uPedOyCe0740',
                     'qyZWpKWj2690', 'gqnNcsti5038', 'xMSMohQx9330', 'RSEnyeFX8714', 'kNeXlWmb0286', 'ffeTtbQs1949',
                     'UfPKJWGZ6101', 'jrtrPShw6659', 'akeTOhIS7445', 'uwCKnYio9059', 'aFGHNRXH4787', 'NlrkPyfe1773',
                     'OXOOCymZ6427', 'iaqqJonu4257', 'SQtaDOBR1480', 'yZGqHxtW4570', 'AQzifXyD9565', 'pjVzKPol5294',
                     'DdjsBGFi5933', 'zfTJNcIL8964', 'kAmBDmuq8251', 'KKhZsaVt1440', 'avVnmsSM8082', 'ghnNmfbf0920',
                     'JonNsksh5429', 'aURePBRB9408', 'POgwSdLi8294', 'BYsgsrjQ2280', 'CaRNBKuJ6345', 'fWVlykUT0543',
                     'eDxKdMGH0170', 'zZFMYvYr3633', 'pWdnskCR4289', 'ZVUcmlLw7915', 'BDtliape9998', 'ZBfdIMYh3291',
                     'TyqgFdzM2216', 'FwwVKQlN1516', 'RdSdUqMp9063', 'ZSUXmvhL8966', 'YYnLwUTz9485', 'FRSOpwxf5606',
                     'qwmodGTa6233', 'bIsUgbke8882', 'KtMhxHho7734', 'ChvMkhuN4614', 'pEBReApu7018', 'fZQiDCdF9673',
                     'iUPMjBYE0189', 'LfXNrrOe4304', 'RDmeitLj9813', 'eXdPBzmz6955', 'lbbTnMMI9761', 'lNhAkzWV2023',
                     'WcTaxzmb5974', 'whDSksKp1611', 'DBrPqyPV1768', 'LRoGxxsQ6117', 'djDiKcXx6120', 'UsJraTaq4343',
                     'dOBBbzIO8839', 'saKIGcfW1735', 'kwWYBntP4747', 'NOTqrvtg6546', 'ysyqZZMK3679', 'jcbbfkKD6944',
                     'HEaFhKmw8512', 'YVKPtvhu5205', 'DPJZfNiz5101', 'NRomtqKk2885', 'KWdRgJLO6801', 'MZLgtgUf1930',
                     'dYNhBsEw4010', 'AJsarjrg1838', 'FEAGGBJF5170', 'ekeuMpsa5875', 'XWdsSjbM5743', 'KQtukwgc6231',
                     'YBTlJheq5918', 'MhEebAIT6348', 'bmNABDax9893', 'IigSqVJy0194', 'iUgiRoID0163', 'QfgFCtsM7446',
                     'AnILhMAo5931', 'aVSePDQx1180', 'uPyGrvWD2845', 'VVEoWsdq2927', 'WpaRJHTf5896', 'LWRpksoK2157',
                     'aBSbhIxi3674', 'zqQXRkZD0200', 'lcDjMuuc8988', 'fxwDBvkR3428', 'mbqdkSUe5577', 'EHYXoviS2983',
                     'RgtgdQWX7008', 'rqBvZWqI7703', 'bjxZyFUB3051', 'ypRyVNKi7685', 'wTBvjSqy6373', 'jMtCLooe7443',
                     'brsVMHYX3860', 'BuKVglTi2716', 'QmyFtwly2885', 'LYwWpppZ9004', 'gUloNBiV2230', 'SdDSWkJa2216',
                     'AYHGdGjh6679', 'maWemOIm9416', 'eFZqmplL7893', 'DaTcFBbI2312', 'ZSfzCvlH2807', 'HLZbfdOj4033',
                     'hJzefveD5552', 'ZCaKdgqP5132', 'mygiTXPG4007', 'LvDiefBG4632', 'KZvMDLZw2105', 'izRGfUON8318',
                     'jHTxqWuQ1362', 'mfQjRjlm8839', 'aXMTiuvb2992', 'gNYDrEgj8392', 'ugrwadbe8779', 'YGAsLsNx7925',
                     'nzUtBSMk5223', 'JfwTyvlF5501', 'MkGbPPQq0469', 'pNyrGATz7914', 'VYaHWrDi7042', 'uKMVMwwk7503',
                     'dQtaidCC4963', 'NMartAhT9865', 'DWWbjajQ6281', 'HUPpBzfU8719', 'WUZBzklu2898', 'dUCdFhWo7915',
                     'rMtZxTDh6161', 'EwbpkLSW3944', 'dVTHPrgw3014', 'PCCZpLRh8794', 'sPryHNFL6682', 'MYdLZrpH3923',
                     'ZRTMojec4096', 'KKpzqcsl9492', 'bevupvQR3775', 'YYRlGidr8657', 'TqdvHMWj6288', 'cKWckIRL2496',
                     'CwOXttHg6646', 'meTrixXV1067', 'rzqjgulm0314', 'PuLNAJCo6119', 'qTMEQdpe2780', 'ckrIlKyX1558',
                     'cXOKPGeZ3162', 'RVXhIqaX5433', 'RWENdiXX4950', 'TenWzhEN1188', 'ykUtuBla1603', 'AbjyrUGa0950',
                     'nfGPtjYV6388', 'rEYRnKxX3302', 'rMegtXSn9695', 'mgPQpNBo1027', 'mCdsPoOn2819', 'RnSeUMGt4968',
                     'CrSjilic2157', 'orolGKgL6377', 'sbxIfrob4441', 'aZGiwkfu8225', 'CHEUKOKm9943', 'sXhsRGqD9320',
                     'vDKUhKoS3909', 'efcDZihq5965', 'gfQNTqfx7507', 'RaBmEoqr0741', 'GcXgfgKb9616', 'NhlMxZcA2273',
                     'anMIPHOV6577', 'ORFRMPdk1692', 'wlFtwWVK1594', 'teZqATkt6509', 'QDWgRKHZ5878', 'xTAGvyKu5471',
                     'fUlZafdl3236', 'MmskrbKW9753', 'WiSnGvpU5776', 'vwBhtvPy8304', 'pcZdocgF6608', 'hnWYJItn0087',
                     'ZzdLUiuN8094', 'YyCNnAhu7340', 'dNWBgVGX7827', 'MvAnUOSS4531', 'qHixgBLt1597', 'bmQRIomq4742',
                     'ifsUqwhP4193', 'zEvvxAfU3234', 'EclmygrI2707', 'UunCrEcn1274', 'jYBrjLFL3198', 'iCEuFwiH9123',
                     'QFnbIcbt8634', 'MkYIdHLp6669', 'NYNszIoq7359', 'tMxzxHQv8155', 'KNdDueCm8508', 'URbZDflV1105',
                     'nhyUzyfB9102', 'JEDOJVli0081', 'ZqFvtAdG1017', 'OkqxjvSy4120', 'sTBBTwnO2667', 'ZAnxKnzz5350',
                     'VUMmWQYV0485', 'lXVNAzHS5678', 'QhihUQWX6222', 'QCldTtcv7063', 'YdAhhysJ9939', 'TFmPKhRx5193',
                     'KMWUqBpP2797', 'IBbQQfjZ8393', 'MPSOHhFh4294', 'bhuTLSLl4840', 'NPaxhbag7163', 'OvMgeMGX9162',
                     'PqhQbtSI5979', 'kSwqyxZB5783', 'CUPcMOGo6028', 'yxtQSxch9783', 'QyBoTNqq3842', 'uxVmxkTe8326',
                     'YBuzyPVt8482', 'MDRcoTNE6464', 'PRwuPNzl9950', 'xcibfOSM3564', 'EVEuYZsQ8091', 'lZrwbjEE6840',
                     'HrpwurJq2763', 'itAGlTUz3085', 'nPcBKLYV4045', 'bQbRceul0016', 'RLPWvZIn3315', 'zHIQbNMs2872',
                     'QnOCQfCD8118', 'WXnLSEfY2751', 'cNjBmANt2008', 'BHaJOhVF6077', 'IUceyrFY0141', 'CBBEbmYu6329',
                     'lEfrBJHH2116', 'JorSHbuh8172', 'MgpXJvQb4570', 'hpmFBxvG1096', 'qmLYPfyI6825', 'qdQiAtgW1511',
                     'fOKEJIzd2610', 'qRGJvtXO3687', 'DQuknZLq0660', 'bPQlBXoa2928', 'ObszdlQI3187', 'WzzfoLob8557',
                     'rBAGqnPU4897', 'YlmEXsIc7612', 'UbzJSZMw5372', 'jlbnEZyM1147', 'DOVLYrRs1094', 'UrYrnclR5813',
                     'GhDgwCcq8628', 'wdUFehfn0630', 'eWrmhzWV7513', 'EfZUwkAM2289', 'sqeBJGou8305', 'RDXeqaZB5975',
                     'DfqaGihy7246', 'JHnuCEpS4656', 'SzdYTkYB2566', 'sRNJkOUZ9893', 'SluKLyjg0773', 'JJsDpAbH2331',
                     'oIOQiDSn1588', 'nfbvYFcR9334', 'rqDuZVzX3306', 'yTHwQSTM7789', 'SWxcrHoY3813', 'ienxNQIN4418',
                     'wsCzzXzb5335', 'aAkqHEAP3005', 'BBAPDXOj0121', 'ieaStwqw2081', 'ZTyKyFxk2977', 'LMhvSxOE5452',
                     'ANRwgZZT7692', 'vOWUkWkw3289', 'YMhutssR5063', 'oyMVQfuU3435', 'llUNRNYD3583', 'QtxKPjmS0880',
                     'OBwMKJaz5684', 'VRLCtBuo0712', 'boWMIvkH3552', 'WwOUbloV5976', 'zhVdSFIJ5145', 'MjNfPJCl6421',
                     'lIJOpgPB6346', 'EoOXJVMi1817', 'wXWFVNTr6805', 'sNMJOIGN1732', 'RyvpjgXt3712', 'AiAicDbm5210',
                     'SilBUCjf3658', 'TPHEjuIy1748', 'ZebkJinv9531', 'oVZGtoZX9813', 'TIghgBRV0531', 'HMiEomrY8090',
                     'SYdNrXDM5716', 'oKkvGRjK2917', 'coPyLcwY2767', 'VNWEskVG4329', 'XVeGOYcN4406', 'fTRvOrFQ3978',
                     'NpinouXZ6558', 'qwbJQcac4672', 'bdPIhKGq9913', 'xoBQaKLA4603', 'gLiyexqo3489', 'IfYdhBxZ2081',
                     'alRPQxih0754', 'IFGpCkSi6614', 'JQIgDMed1312', 'jmRoqECT8699', 'piaGZiif8284', 'KbEEFWuW8616',
                     'qsLOsnnM7042', 'LksmHmxu3976', 'yVgCiTtc2400', 'WfIpHXxU5698', 'UlQSWcAi1967', 'BJRtZeKy5829',
                     'Oijcvybz3161', 'hQKMuLGB0783', 'vwNhrqjA4492', 'wOTEfRfu2078', 'LossBbgj9337', 'yccgzPkF3582',
                     'HnILMNlH9286', 'crLyvpdV9815', 'mhIFXAHm9221', 'IdbJvjSH6567', 'MYOkzYRi1603', 'eVbcKJkC9091',
                     'lXdRVCBP0041', 'YcrwcbtN5089', 'AlqxFLDN9321', 'UbwTxrJH9518', 'KRRJNzXj4275', 'KJtAmvjl4316',
                     'ZDJwHmoz9026', 'gNLyiEyk6084', 'mZKwTkuS1537', 'fdtoOMQy7956', 'kPBWwSSl1405', 'iJpfuJtD8757',
                     'MhMZNBec9835', 'zPfHszTo8543', 'MefYpxiA6444', 'cHjbQonO2283', 'wMrexMaP3406', 'pRKAVeWL2515',
                     'mGHvCqRn6215', 'JSVlmXHs5758', 'yNXTCWPg4893', 'cmxTfbkn6289', 'dNwuQaUi5468', 'fcnGkVyF6629',
                     'pHKksnhb7203', 'eRLbdOWg9686', 'fjjHRQOF1591', 'YOYsPaCp7051', 'tPuOmrwq6284', 'LGgdPkdu3011',
                     'qFHBphiX4444', 'qWnmlosk7592', 'rYXuNRmv8933', 'xnxtYyBJ2880', 'QXetlEmo9187', 'lvmndfOy2253',
                     'bHMPGSJB2405', 'eUxMTIxN1517', 'JEjDLmSu9235', 'uRGKyCnB1982', 'nZMuNfJF9934', 'ThSthvpM3858',
                     'nEtXMxeX7276', 'UpnPkcXm8563', 'tmtJkCee2695', 'DTkuZzMS4743', 'XJkFXvTI5134', 'McDlSnbR3025',
                     'vGpOjfEb0384', 'UOKqaAHh6523', 'dkJkKzHv4243', 'SOzxQceh3705', 'BCBOqgGG1551', 'pmAmXXUg7244',
                     'uIeHSMho5794', 'CcKJfgeB8734', 'aGIEldOC5310', 'BwwyiblI9135', 'mwVkmbsc3424', 'vPsNsgEw0017',
                     'KeOgbNUU6467', 'DSRheKyg5378', 'jnJMHKhy4437', 'CEWypJhF1235', 'MxtjEyRe4649', 'uRYjWvMU3825',
                     'KWYdoiUT0790', 'OEoCLAHu3458', 'LyjerqlB7435', 'ufquXnYD3470', 'oCFvbxeA9987', 'hGlEKQtv6735',
                     'LZWcfyBr3019', 'eqbNYPrQ4498', 'HpTJxFpB3035', 'kyRJclns2716', 'OlyyrPLX4630', 'vqbHKIYr2151',
                     'myDOknzl2923', 'jNYhaggi9062', 'vQwLKsrV1228', 'NinZXDpk5835', 'gUReMCPf8619', 'JBVzCyhH2970',
                     'STauIxMd8730', 'mVkXgXcw5083', 'OFxyIeJm3551', 'OUDSebbG3683', 'jsYoqQDZ6067', 'jadGvflB3490',
                     'oACQrYgJ4588', 'eVWjjNNm7286', 'qXtECVLv4886', 'CDedCvVl2133', 'wqIXQTyo3549', 'OfTwGTsV7422',
                     'mHrPSesJ5353', 'zfWaNRpR7733', 'aIpOFksO2991', 'HCnbDPHm1580', 'HLJWXFID1964', 'YDBLxiLx5618',
                     'grlMkLFk0024', 'nbhjlssc1764', 'VEQUkQOO6977', 'nzUnErcP6870', 'XgmXMPxY0026', 'OeLWBcyp1564',
                     'iVctwmmv4241', 'bwnvxYFL1185', 'uCTYVktC3723', 'mwVRsOcg5815', 'HsCLvdii3612', 'KohzbxSB6074',
                     'OtGWUpmd9281', 'VGgmpUtd8746', 'fVLcNqMR3938', 'musTrINA9044', 'IjAMsIEA5151', 'seOQqvSt9116',
                     'RBiQkGTh6221', 'gTqOiFpQ1550', 'ehSPSSqo9844', 'RaikTXyG1048', 'iJSwYFlo0526', 'OSdgDJdg1884',
                     'dRyRukWq8970', 'PBvnScKS5624', 'HYDHyVRd1361', 'WMBsZwBG5027', 'LIHRfovD7473', 'LaPmZRjS1241',
                     'VzsjPxws9692', 'OKfcUyjE6399', 'OyDpGbvw0865', 'NQpzHYFV2357', 'QvAxKdEh2618', 'DFkISaWl3814',
                     'dTEzXejn8628', 'XjqOWeaT4368', 'VDWgJmvQ9974', 'bIsYbskt5209', 'NFRryiqk8271', 'wXtLhjsF8926',
                     'rToUobGH5666', 'eHbpFqkF8995', 'VHiTxGRW6486', 'YXlZieSf4870', 'xLziGhpF5907', 'jIggWUbz4911',
                     'oMmkTBVq4921', 'pbCqjuME9408', 'dnbzERTb1665', 'VDPkezkM3722', 'AzoOKvlm9723', 'zyfbQWBH6304',
                     'lPmtbIzV1353', 'TrVRJjpO5669', 'XoOFPvbJ2573', 'AgWKsmOf8627', 'HtQkDnBy4002', 'nwFuNLxE1078',
                     'YBkVNLtH3298', 'hzIvLMfO9013', 'iolNfMif4063', 'uRKWOdDr3009', 'ArzFGQMs2537', 'RFTuKaIj4892',
                     'saDpfNFm9592', 'tIKlunqw2907', 'dKgZEgwZ8666', 'HVHaegBC0115', 'nCxspQQe5805', 'VzFSzrym7556',
                     'icORjWfM7812', 'RRJZzYdi1969', 'DVdMJiUz9824', 'oOBnWBRC6434', 'FIaSnHPf0108', 'hGhIkuPP4535',
                     'zatVGHLg1409', 'KmFKKCgt3512', 'jlREWNMT4567', 'qCpPXven1382', 'NNaqpQNx3150', 'rsMWYIdw3871',
                     'sgYSlgVV4196', 'BllNFxZH7838', 'kMKCNMcb0941', 'HnXKfRBF5145', 'LQbatNgp2637', 'rIUikjiA9017',
                     'xLwSFnPl8609', 'kFjsuUlj5763', 'vZnkydxJ7250', 'MNnujIWl4470', 'NqmQKAqZ5626', 'uAXEfpac6111',
                     'VeazEpwI1525', 'UDqYBPIj6687', 'BOfueEVg3565', 'tPXbNkKo0822', 'zQXRzMLv1033', 'KLAbqhja8760',
                     'HSotBCSS5377', 'mTFyAIbl2960', 'NfLVkdWX1159', 'DlCliqfl1434', 'rNSBBQey5759', 'ckXCDCUR4693',
                     'GNtBAGzX6498', 'wteawfIl3053', 'UskayVSa2397', 'lrOQQKjj3312', 'qTnXliOP7631', 'dYaYZpTT9630',
                     'NQLQmTdn1735', 'wxNpiiNU2179', 'hTgxSckH6866', 'iBZFgtNQ6116', 'oGZRtWRJ1368', 'AiOYrdSt3818',
                     'tWaUfzjU7135', 'PCXxOwqX1107', 'pBoyUXfx8360', 'kGhqdcoX0808', 'GpjYClAj3000', 'VNbQBcBh2798',
                     'cAfVgiVD0735', 'ahCFHPrz8479', 'BeOGpeGk8491', 'YlMlvCAa1367', 'iNMltfZX9026', 'nqZkMuLI8121',
                     'bqwIgMNE8824', 'TYwuXCBY1227', 'gJMpGUYN3389', 'NxNbaxmB4638', 'ZXjGHGOh7233', 'TXtGgmWh0267',
                     'BSBoPfMw0795', 'ptWaPPwc2947', 'DjkThPFj5743', 'goTuleIG2257', 'LRWukYMT9441', 'qPZwFYmk6953',
                     'uNkVLmAT2454', 'ocseQkxz0433', 'mPadlpjT0428', 'PVzwqkAI4458', 'BJSRMOAD2768', 'zAzIOCXW3268',
                     'mxpcUhBj2586', 'SJrfmlTn5164', 'VTwvSyaq0494', 'GAjAfAff1534', 'PGLxJcPb3252', 'bgVIwJTH0643',
                     'sBQMrypi9343', 'hQWrbgtB2248', 'VUCFcEGx2962', 'MhfqTpKb6051', 'BnYJszoO5069', 'wUotgUDK0733',
                     'wRvmhcBW4525', 'dHFObamE9607', 'kzHWYKmY1466', 'RkuLMAOx8440', 'qNBiPKIZ6742', 'eSShBGeO1653',
                     'dVvFUctn9264', 'WWssfCrK3793', 'NuroeVNM9675', 'BnfIORuB2247', 'VJAusrrh0432', 'zUPvrEvr7782',
                     'dcpFbzbp0217', 'PaLCiMrx8759', 'DLunreHa8744', 'OafxhIZf3766', 'gDSczrrG0166', 'aZqWxIcc6966',
                     'CoxcDHGg7885', 'hKFKWZrG4041', 'PwldlFiO7663', 'LTqCNmxu7011', 'baOXEKHX9534', 'ZVKVRFcq3948',
                     'bzfQGJAb5413', 'SnhSYGBJ4960', 'HJFRiKgs7298', 'WylVyobW1321', 'pSJZyagC1921', 'dSCOfeiu9257',
                     'SAQBCbBo6213', 'wOjkqBCc3081', 'FBGtkkZx5059', 'bvHEBmrp8095', 'lgkVkoDA4292', 'JZYKQwfM1558',
                     'HuJwXSAR3103', 'PiZIbSJF5284', 'KAeMFwBS4944', 'dsVZoxdD4548', 'XYUTPwsz5329', 'LzcNjVDG7660',
                     'fErWVTQq7213', 'bfQUlSHP6408', 'qIzvKivp2459', 'lWaIpuRU1093', 'LNmAZkaJ8678', 'twNbJqFu3697',
                     'JKigQIzz2525', 'mVggMUvs3019', 'MVQpTpqw6299', 'HYSaPUbS4259', 'tyTGgmnz7836', 'QkYqhdMk3233',
                     'spFYcrUW4776', 'nKanuygE5007', 'zFlUUMCi7621', 'xFiSyPMg4620', 'qoLIXtiu6026', 'AFQxYLmo9422',
                     'beqKQRqF7570', 'nKeEqilS4694', 'FGiCrtMC2055', 'wgkojNfj3250', 'FCHGCkzQ1810', 'RxFBRbgY1418',
                     'lLJqJTTu1043', 'giZdhZpZ8234', 'sdUXxAeO3771', 'WLJQwsTM3351', 'GcDlTJWn7953', 'wzIWjltk8853',
                     'kwSDwDXu2453', 'qwHEWboO1027', 'eWFSCNUk2695', 'XEzJAUDb4549', 'TDVpOrUm1350', 'dZVXaLeX3479',
                     'XxDODKvE5670', 'riFgFIrk9092', 'LfFgpukA6602', 'oLpAWAPS5003', 'ZOiVpAha0774', 'JXgwURyE9417',
                     'jgKvANea6076', 'ywKmWHwp3243', 'LpfKVtgS8338', 'XYEyQJbQ7521', 'pnygbXNg8884', 'RDLonKio6641',
                     'APjqTvpx0390', 'mmQYwvEr7489', 'rxSLDhMF3546', 'DTQutKfc1572', 'tNlyCbeV3395', 'LspxCTMm0292',
                     'rWQWJFfr8604', 'LcQigzWz1405', 'VqOGNylC5642', 'qmeAmerK4922', 'CaZePfgd0181', 'rTYffpBs5502',
                     'CDJiFpZg6687', 'eAVQtnWw8579', 'NKYWtLtt9019', 'yYbNXDkM7794', 'aRDbqYhZ7882', 'SDpLVzIV7507',
                     'qblXLzUh6768', 'vqbHmrYy0871', 'IwpuetFk9877', 'gdPSYXpj4165', 'QtbgWPqR8503', 'oKHOVZEt9779',
                     'EXmFVyKx5486', 'knZIipoR0984', 'BFBypTSx6391', 'QhTQmaWI2600', 'NPuBWjXI9067', 'hzCteVRo0131',
                     'pzDoGpcm1344', 'vfyyfhmH2797', 'lDXjRIil2060', 'TLxaCkwQ0322', 'BwhwfVKz5192', 'yRNIlbyP4952'}
local RECEIVER_LIST = {'tkiklziZ5881', 'WLoTWcaP6043', 'ezBRywsA3633', 'WqqsenvJ3542', 'xmYGWZgq4978', 'VvdHaLCY1026',
                       'JzZJitXj4622', 'jsXJrekZ3417', 'jhbtCjCW6382', 'ORspQgrv2146', 'vSPaUZXY5926', 'NtzkOCbH4779',
                       'LiIKknZa5317', 'cpNpDtJA1222', 'rasCxvsw6644', 'UvSZxzoH7059', 'wFWqCrEB3797', 'TxTKzlBt2863',
                       'HHtBdiIx0281', 'nOolKUba5158', 'BTVhldGa6678', 'NptHtKAC0734', 'LvBlfUtc4749', 'LVEaxVDd7248',
                       'oFyLldFv2977', 'mDPvcXYa1676', 'TXCWpbgn5760', 'TQHnNAvY3483', 'hPMZbebv1091', 'QAqccAaN3091',
                       'EMqXAqNp5012', 'GTRvmDtF5095', 'qClWhiFL6338', 'XDnRuoWs7536', 'vUwTtrBS0754', 'iWOEZYrp8843',
                       'enWbsuEG0640', 'CjdxjTru1293', 'HQnVEvZB3738', 'lBMmauxZ4185', 'xBDGXAqf1360', 'RSPyqeCc1831',
                       'EFsWQTpK5617', 'BjfCcfRi4251', 'XQchOoHq8420', 'zglyYxOC1839', 'bRaoeKoO6125', 'AopfyPqe0922'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ตัวแปรสำหรับ timeout การรอเริ่มเทรดหลังส่งคำขอหา receiver
local SENDER_REQUEST_TIMEOUT = 200 -- วินาที
local lastSentTargetName = nil
local lastSentTargetIsReceiver = false
local lastSentTime = 0

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันหาผู้เล่น sender ที่ว่าง (ค้นหาเฉพาะ sender)
local function FindAvailableSender()
    local result = nil
    local success, error = pcall(function()
        print("🔍 กำลังค้นหา sender ที่ว่าง...")

        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                        tradingValue = player.Settings.Trading.Value
                        isAvailable = (tradingValue == false)
                    else
                        isAvailable = true
                        tradingValue = "unknown"
                    end
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " .. tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print("❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบ sender ที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindAvailableSender: " .. tostring(error))
    end
    return result
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender (รองรับ auto-accept จาก sender list)
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " (อยู่ใน SENDER_LIST) กำลัง auto-accept และเปลี่ยนเป็น receiver ชั่วคราว...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request
                    lastTradeRequestTime = tick()

                    -- พยายามยอมรับผ่าน Remote ก่อน ถ้าไม่สำเร็จ ค่อย fallback เป็น UI
                    local remoteAccepted = AcceptTradeByRemote(senderName)
                    if remoteAccepted then
                        print("✅ Auto-accept ผ่าน Remote สำเร็จ - กำลังเปลี่ยนเป็น receiver mode ชั่วคราว")
                        -- หยุดการทำงานของ main sender loop
                        isSenderMainActive = false
                        -- เปิดใช้งาน receiver mode ชั่วคราว
                        isSenderReceiverActive = true
                        return true
                    else
                        print("⚠️ Remote accept ล้มเหลว กำลังใช้ UI แทน...")
                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        print("✅ Auto-accept ผ่าน UI สำเร็จ - กำลังเปลี่ยนเป็น receiver mode ชั่วคราว")
                        -- หยุดการทำงานของ main sender loop
                        isSenderMainActive = false
                        -- เปิดใช้งาน receiver mode ชั่วคราว
                        isSenderReceiverActive = true
                        return true
                    end
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันยอมรับ trade request ผ่าน Remote โดยใช้ชื่อผู้ส่ง (รองรับหลายรูปแบบจาก remote spy)
local function AcceptTradeByRemote(senderName)
    local success, err = pcall(function()
        local args = {"AcceptRequest"}
        game:GetService("Players"):WaitForChild(senderName):WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(unpack(args))
    end)
    if success then
        print("✅ ยอมรับ trade request ของ " .. tostring(senderName) .. " ผ่าน Remote สำเร็จ (รูปแบบ remote spy)")
        return true
    else
        warn("❌ ยอมรับ trade request ผ่าน Remote ไม่สำเร็จ: " .. tostring(err))
        return false
    end
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept ผ่าน Remote...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    -- พยายามยอมรับผ่าน Remote ก่อน ถ้าไม่สำเร็จ ค่อย fallback เป็น UI
                    local remoteAccepted = AcceptTradeByRemote(senderName)
                    if remoteAccepted then
                        return true
                    else
                        print("⚠️ Remote accept ล้มเหลว กำลังใช้ UI แทน...")
                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    end
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept ผ่าน Remote...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    -- พยายามยอมรับผ่าน Remote ก่อน ถ้าไม่สำเร็จ ค่อย fallback เป็น UI
                    local remoteAccepted = AcceptTradeByRemote(senderName)
                    if remoteAccepted then
                        return true
                    else
                        print("⚠️ Remote accept ล้มเหลว กำลังใช้ UI แทน...")
                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    end
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request และ auto-accept จาก sender อื่น
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender และตรวจสอบ auto-accept
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                    
                    -- ตรวจสอบและ auto-accept trade request จาก sender อื่นใน SENDER_LIST
                    AcceptTradeRequestForSender()
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver ชั่วคราว - Auto-accept จาก Sender อื่น)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver ชั่วคราว)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver ชั่วคราว - กลับสู่โหมด Sender ปกติ)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            -- รีเซ็ตสถานะการส่งคำขอค้าง
            lastSentTargetName = nil
            lastSentTargetIsReceiver = false
            lastSentTime = 0
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่ (โหมด receiver ชั่วคราว)
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ (โหมด receiver ชั่วคราว) Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            -- ถ้าส่งหา receiver ค้างไว้นานเกินกำหนด ให้ลองหา sender ที่ว่างแทน
            if lastSentTargetIsReceiver and lastSentTime > 0 then
                local elapsed = tick() - lastSentTime
                if elapsed >= SENDER_REQUEST_TIMEOUT then
                    print("⚠️ รอเริ่มเทรดกับ receiver (" .. tostring(lastSentTargetName) .. ") นานเกิน " .. SENDER_REQUEST_TIMEOUT .. " วินาที กำลังหา sender แทน...")
                    local fallbackSender = FindAvailableSender()
                    if fallbackSender then
                        SendTradeRequest(fallbackSender.Name)
                        lastSentTargetName = fallbackSender.Name
                        lastSentTargetIsReceiver = false
                        lastSentTime = tick()
                        return 0
                    else
                        -- ปรับเวลาเพื่อหลีกเลี่ยงการ spam ตรวจซ้ำทันที
                        lastSentTime = tick()
                    end
                end
            end

            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
                -- บันทึกสถานะเป้าหมายล่าสุดที่ส่งคำขอ
                lastSentTargetName = validPartner.Name
                lastSentTargetIsReceiver = IsInList(validPartner.Name, RECEIVER_LIST)
                lastSentTime = tick()
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        -- เคลียร์สถานะการส่งคำขอค้างเมื่อเข้าสู่หน้าต่าง Trade จริง
        lastSentTargetName = nil
        lastSentTargetIsReceiver = false
        lastSentTime = 0
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- Coroutine ปิดหน้าต่าง CreatureInventoryFrame อัตโนมัติ (ทำงานเบื้องหลังตลอดเวลา)
local function InventoryCloserCoroutine()
    spawn(function()
        while true do
            local success, error = pcall(function()
                local playerGui = LocalPlayer and LocalPlayer.PlayerGui
                if not playerGui then return end

                local tradeHudGui = playerGui:FindFirstChild("TradeHUDGui")
                if not tradeHudGui then return end

                local bottomFrame = tradeHudGui:FindFirstChild("BottomFrame")
                if not bottomFrame then return end

                local creatureInventoryFrame = bottomFrame:FindFirstChild("CreatureInventoryFrame")
                if not creatureInventoryFrame then return end

                if creatureInventoryFrame.Visible == true then
                    local closeButton = creatureInventoryFrame:FindFirstChild("CloseButton")
                    local upperLabel = closeButton and closeButton:FindFirstChild("UpperLabel")
                    if upperLabel then
                        local safetyCounter = 0
                        while creatureInventoryFrame.Visible == true and safetyCounter < 30 do
                            Clicked_Ui(upperLabel)
                            task.wait(0.1)
                            Click_NOW()
                            task.wait(0.2)
                            safetyCounter = safetyCounter + 1
                        end
                    end
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน InventoryCloserCoroutine: " .. tostring(error))
            end
            wait(0.5)
        end
    end)
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- เริ่ม coroutine ปิด CreatureInventoryFrame อัตโนมัติ
        InventoryCloserCoroutine()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
