-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'CharlotteWolf2974', 'SepidehSpell2895', 'KaoriTomato6191', 'AkalaRoyal1471', 'CerenRust3102',
                     'HildaHeart6332', 'GuadalupeOwl4741', 'EstherValkyrie7389', 'PersephoneSteel8595',
                     'ArtemisMetallic0507', 'CristinaArcher6526', 'SofieRed7494', 'EsraFox6911', 'DianaOwl0163',
                     'LindaGoldenrod0397', 'StefanaWeaver8089', 'AmiraArctic4626', 'PersephoneSteel7832',
                     'HazelMoss0827', 'JoyMage9558', 'IsabelaWitch4773', 'ChayaCantaloupe6196', 'KiraMauve6340',
                     'ScarlettScarlet5176', 'ChloeForest9955', 'AinoWeaver1675', 'AndromedaGoddess2258',
                     'MaileMetallic3370', 'SaoirseReaper4976', 'HildaFlame4330', 'MaryHuntress6670', 'VictoriaWolf1102',
                     'ClaireHoney4583', 'VioletScarlet5956', 'JarrahHawk1213', 'FarahForge2332', 'AlmaGreen5624',
                     'RadhaGray6330', 'NovaRoyal1287', 'CamilleMage0040', 'SeleneGuardian5956', 'AikoCantaloupe1475',
                     'HildaYellow5810', 'CourageMage2154', 'StefaniaMustard4952', 'MabelDark8524', 'ChenBlaze6980',
                     'ChenPhantom7289', 'HelgaOrange3666', 'AliceTomato5911', 'StefanaTeal6805', 'ChiaraCopper5248',
                     'PenelopeRider8916', 'MarinaSpell1517', 'JanaIvory8398', 'MaileRider4296', 'DeepaBolt0915',
                     'KiraWind6367', 'AthenaKhaki2379', 'AoifeKnight7670', 'AnyaHawk9599', 'NienkeForge4684',
                     'MilicaForge4569', 'AmiraHeart0871', 'SofiaOlive9606', 'KatarzynaBolt1963', 'AinoSpell7131',
                     'MahinaRider6795', 'TaliaTomato5554', 'AntoniaTiger4135', 'EliseArrow2930', 'WillowCrimson4304',
                     'BravePrincess3567', 'JulietGuardian7094', 'WaratahMauve0591', 'LaniSepia9743', 'ShirinArcher5912',
                     'SierraMoss3818', 'EvelynStrike4410', 'GiuliaOrange4883', 'MartinaYellow7624',
                     'AleksandraSpell3655', 'PromiseVermilion4172', 'DeryaSpell6602', 'SebnemViper4043',
                     'OfeliaWind4206', 'MarieFlame1375', 'SofieSpirit2711', 'VeraSpirit1596', 'ShirinHuntress6326',
                     'LingYellow9261', 'SkyTerra4660', 'PatriciaCrimson8508', 'IsabelaNavy8062', 'DvaMustard1911',
                     'AnjaSepia6626', 'HyejinWind3071', 'ScarlettHawk4347', 'ChayaWitch2437', 'AstridBlade1019',
                     'AlinaCopper8249', 'ZofiaRider2566', 'AliceElectric3461', 'LiGoddess5470', 'FemkeWind6297',
                     'LakshmiTurquoise8290', 'MiriamVixen6067', 'MelikeNinja6279', 'MahsaQueen8512', 'AutumnSlate2971',
                     'KenyaCerise9028', 'GabrielaSpirit8294', 'SaritaArcher0994', 'YasminOwl5892', 'CamilleArcher2057',
                     'IrinaOrange2932', 'EsperanzaBlush2066', 'EmeraldMoss6402', 'WillowVermilion5393',
                     'StormSlate3910', 'DaeunHuntress1594', 'NaomiVermilion7118', 'JoyArcher0274', 'OliviaHunter6862',
                     'ZarliBurnt9760', 'HeidiLilac5765', 'NinaSteel3678', 'LeaOchre7273', 'AmaraTerra2747',
                     'EdenSpark1691', 'DaisyHuntress0004', 'JaneEggplant3967', 'RachelSalmon6067', 'AgnieszkaWitch1100',
                     'KristinaValkyrie9097', 'NeaRust3654', 'RebelChartreuse8468', 'MatildaTiger2632',
                     'PriyaKnight5161', 'FatimaBlush8754', 'HermioneQueen9936', 'SeleneQueen7923', 'HeidiMage3231',
                     'AlinaSapphire8111', 'MaeveSpell6083', 'FreedomBolt0183', 'MahsaBlue0569', 'JanaJade6060',
                     'AkalaGoddess8402', 'MihaelaRider4007', 'AlmaWind0610', 'AntoniaCerise9788', 'AoifeMaiden9394',
                     'GertrudBlue3814', 'HopeSapphire0132', 'WaratahFox8614', 'YanaraMahogany2396', 'EilishOrchid0297',
                     'IsabellaSiren3685', 'LakshmiVixen7047', 'HildaBolt5794', 'KenyaSiren0570', 'ZuriRust8663',
                     'ElenaOrange7978', 'JulietNinja1874', 'PriyaPowder4058', 'NasrinPink0125', 'JuliaPrincess8573',
                     'AnastasiaKnight6528', 'HildaValkyrie1169', 'SophieDye1083', 'ChenRed0838', 'HazelTiger3729',
                     'ChayaRider1632', 'NasrinSlate4477', 'SepidehCerise6002', 'DreamViper8693', 'CharlotteMage6686',
                     'HalaMaiden1391', 'KalenaCrimson8369', 'YoonahBolt8131', 'AinoHunter1016', 'ElinaGoddess6207',
                     'HanaFang6115', 'NaomiFuchsia7709', 'RadhaWind6127', 'ParvanehHeart8252', 'VictoriaWeaver7999',
                     'NiloufarSlate2158', 'HelgaReaper7614', 'VeraTerracotta2220', 'RhiannonMaroon0734',
                     'SeleneWeaver1039', 'JiaRider9810', 'HyejinDancer5536', 'JulianaDye2666', 'CerenDark5317',
                     'LuanaGold4376', 'KiraFlame4227', 'LilyGuardian2763', 'YanaraMoss9127', 'IreneBurnt7323',
                     'AnikaBrown4757', 'WeiForest8579', 'NovaWine3438', 'KatarinaHeart2630', 'MeiSpark6861',
                     'JinahCerulean7309', 'JaneTiger7078', 'SierraDye6630', 'NaomiLilac7499', 'CarolinaTerra8490',
                     'HecateOwl6218', 'ZarliNavy6421', 'RubySpirit3973', 'StellaTeal7652', 'TerezaSiren2151',
                     'SeleneViper2631', 'RinOrchid9802', 'HyejinOchre2413', 'SkyElectric5875', 'FemkeQueen8992',
                     'PreetiWitch8545', 'HildaHunter4496', 'TerezaHeart8882', 'AlinaKnight0686', 'ZarliMage3900',
                     'KylieTiger1995', 'UrsulaMaiden1525', 'AgnesSlate5579', 'ElenaGoddess0861', 'AmeliaBlaze5551',
                     'LilyGuardian2683', 'RaniaTiger0226', 'GuadalupeLilac1768', 'CoralDancer0046', 'LiBrown0185',
                     'SofieIvory8305', 'BrielleHuntress8101', 'ChayaBlade9556', 'ZarliMahogany5703',
                     'KaterinaKnight2233', 'BrielleMustard1667', 'HermioneBlush2944', 'NishaWeaver3763',
                     'AbigailDark3872', 'SarahWine9395', 'NiaViper3149', 'WarriorChartreus4356', 'JiaOwl3049',
                     'HeidiGuardian7998', 'MiriamOchre0967', 'GretaNinja2643', 'PhoenixTan3666', 'BrunhildeHuntres1092',
                     'BarbaraPrincess9011', 'VanessaPeach0380', 'NiloufarFox6994', 'MinaOrchid3770',
                     'AnikaLavender6943', 'MiaArrow7551', 'LucieGuardian7935', 'OlgaApricot7351', 'AlexandraWolf9632',
                     'RiverForge6993', 'ParvanehPurple5666', 'MidoriWind9676', 'AlmaCopper3922', 'NadiaPale6959',
                     'AmelieWitch1280', 'LinneaSpell9984', 'YukiHunter3839', 'AmaraMetallic0577', 'AbigailWolf1653',
                     'AgnesFlame1871', 'MeiLilac6298', 'SofieFang5757', 'EwaReaper9438', 'NoorArrow1854',
                     'AnjaSpell9720', 'IreneRust0297', 'HelenaValkyrie2698', 'JuniperArrow1195', 'HelenTiger0417',
                     'AnnaOwl4253', 'LakshmiBlush1138', 'MoanaPeriwinkle5971', 'LauraHawk2342', 'LindaAquamarine4788',
                     'NasrinKnight8540', 'HermioneFuchsia7885', 'ImaniBlush5590', 'IsabellaViper6915', 'MarijaBolt7956',
                     'NataliaViper5509', 'JaneReaper3878', 'VictoriaHuntress8496', 'AkalaWind9275', 'MiriamCerise2782',
                     'LyraTurquoise3137', 'GraceReaper2778', 'KaisaTurquoise2254', 'KaoriMahogany7925',
                     'YukiArcher5297', 'AntonijaArcher9389', 'AnyaMagenta3991', 'PetraFlame0745', 'FarahArrow3508',
                     'MahinaPale7501', 'BraveHeart0362', 'IvyCotta0562', 'AnaisNinja0582', 'AnnekeBuff1106',
                     'SaraPowder2761', 'LindaSpirit1012', 'AntoniaWeaver1849', 'ElizabethTiger3523', 'KaisaQueen5017',
                     'AriadneGoddess3966', 'NienkeTerracotta0229', 'JanaGold1415', 'EliseSpell1800',
                     'DeryaElectric7416', 'HyejinWeaver8255', 'AugustaSpirit5239', 'KaisaGray1320',
                     'DottyAquamarine6553', 'VictoryOchre5560', 'SannaNavy3243', 'LenaFang0216', 'AkalaBurnt0261',
                     'EsperanzaEggplan9516', 'DianaDark5781', 'JiaWind9160', 'MelikeSteel7197', 'LeahHawk3465',
                     'SaraGuardian7208', 'CelesteCantaloup5416', 'DaeunSpell2727', 'MihaelaDye6363',
                     'JusticeMetallic4180', 'HeraDark0980', 'ZhenPale3153', 'ScoutGreen0628', 'EdenHuntress5475',
                     'MaileAubergine4742', 'JanaSiren8648', 'DeepaPhantom9732', 'DeepaMage5232', 'JuniperNavy5229',
                     'HarmonyPale6639', 'UrsulaWitch0839', 'AkalaHunter2779', 'MarketaOwl6775', 'WillowCornflower9405',
                     'AmaraArcher7234', 'ChayaDye8224', 'HeraAquamarine9046', 'FreyaSapphire6145', 'MahsaBlush1642',
                     'RubyRoyal0601', 'KavyaCotta8191', 'HarmonyArctic6955', 'HeidiViper2673', 'SofiaFlame5842',
                     'BarbaraMage9326', 'AnikaVermilion4227', 'ZehraPurple8610', 'SakuraPeriwinkle6776',
                     'FaithTiger8289', 'ScoutPlum7461', 'MedeaGuardian3175', 'EmmaMaiden0837', 'KaisaGuardian5179',
                     'ViolaValkyrie5135', 'AlinaPhantom4348', 'IndigoGoddess8089', 'PetraFang0003', 'YasminTiger8601',
                     'WillowSiren6066', 'PersephoneMaiden4589', 'KenyaCobalt9637', 'SofiaBlade9306', 'HalaElectric6447',
                     'SaoirseFlame7166', 'LucijaForest6405', 'VictoryMagenta3309', 'SageNavy1096', 'RoseSpell1721',
                     'AmberCopper5631', 'AndromedaMagenta8245', 'NinaPhantom8631', 'CharlotteSpirit4784',
                     'GertrudForge1673', 'LucijaMaiden4321', 'HyejinGuardian6845', 'EunjiSpark2107', 'SaritaNinja8666',
                     'IoanaHoney8618', 'SageSpirit9719', 'AlmaQueen9547', 'MargritSiren0530', 'PreetiVixen7011',
                     'IvyRed0949', 'DeirdreMaroon0467', 'FaithPurple8537', 'KinsleyDark0339', 'KavyaSpell6364',
                     'PersephoneCerule7830', 'MagdalenaCrimson8061', 'NasrinLavender0151', 'ChayaArctic0656',
                     'KaoriMaroon0847', 'LaniSteel2471', 'EkaterinaBlue6969', 'WeiSapphire0381', 'EvaOrange3403',
                     'AnnaMustard1111', 'FatimaNinja3736', 'SaaraHawk6803', 'AmberMaroon0005', 'WeiWolf4469',
                     'AndreeaTurquoise0254', 'CarolinaPhantom9502', 'AnjaMoss7469', 'LucijaForge1741',
                     'CirceValkyrie0973', 'MilaFang9687', 'DaphneTeal0171', 'AlinaMahogany1479', 'LindaIvory4588',
                     'AdelheidGuardian1730', 'KaoriVermilion1603', 'OlgaStrike4294', 'GuadalupeNinja8264',
                     'DaeunBlush8504', 'TamsinViper2229', 'AnnaBlush9099', 'ChayaLavender6657', 'JieunCopper2727',
                     'SaaraBurgundy7367', 'AnaisFuchsia1305', 'DeryaTiger5613', 'AryaDark3122', 'LilyPhantom0955',
                     'StormBlush0938', 'GretaGoldenrod3305', 'NiaGoddess2816', 'VictoriaSpell2990', 'MaileHeart4153',
                     'LucijaCrimson5526', 'AmberJade1921', 'EmiliaHuntress4237', 'AgnesReaper4030', 'AnastasiaWolf8704',
                     'RaniaMage5110', 'EdithTangerine7017', 'LeaPeach1644', 'CassandraPrinces3039', 'JusticePale1733',
                     'SusanWind5571', 'LailaNinja7706', 'ZhenMage8593', 'MilicaWine8065', 'LeaForge3336',
                     'CourageKhaki3364', 'SakuraMetallic8328', 'CamilaLilac6536', 'CerenSpark5355', 'EwaPlum6266',
                     'AnnaSpell7507', 'FaithSalmon7365', 'JanaOrchid4999', 'EvelynLilac2559', 'LisaLilac5131',
                     'SeleneElectric1305', 'YasminOrange4873', 'DeryaReaper4811', 'CamilleRed6723', 'IrinaSpirit1354',
                     'RoisinBlade0783', 'ValentinaTiger7053', 'SkyNavy4793', 'MakedaCornflower8553',
                     'BrielleReaper6163', 'DaeunEggplant4013', 'DorothySiren2050', 'AriaSteel7744', 'DottyFang4034',
                     'DottyMaroon5717', 'NiloufarHuntress5943', 'XimenaGreen1921', 'MartinaPrincess9825',
                     'KianaMetallic4357', 'GizemMagenta1829', 'NataliaArcher4709', 'RoisinPrincess1291',
                     'TeodoraOwl0137', 'MaryamSapphire3083', 'AnikaDusty5982', 'BeatriceHunter8052', 'HelenaFlame3956',
                     'SeoyeonBuff3354', 'DoloresEggplant4491', 'VictoriaWolf3287', 'HermioneSpell2829',
                     'MiriamMage8791', 'KylieFang8545', 'RebelBlade2870', 'PreetiRoyal4191', 'BrunhildeCerise1953',
                     'NovaKnight0639', 'FaithAubergine8035', 'AuroraHuntress2755', 'EdenBurgundy9333', 'LyraMage4159',
                     'EmeryOlive4291', 'ClaudiaFang6972', 'OlgaArcher0086', 'NeaMagenta0148', 'HazelSiren1012',
                     'YanSapphire5580', 'MargritPeach8937', 'NishaYellow4072', 'LingBlue6628', 'AndreeaForest9521',
                     'DaphneBlush9707', 'MelikeRider4648', 'HeidiSpirit6880', 'LeilaPhantom1894', 'RoisinBlush3412',
                     'QuinnHawk9292', 'LenaRider7998', 'AnjaNinja8925', 'DvaOlive1529', 'OrlaSalmon1267',
                     'PhoenixHunter7457', 'MatildaQueen7596', 'AkalaArcher1051', 'DeirdreChartreus0745',
                     'CristinaPurple3266', 'EsperanzaElectri1674', 'JasmineForest8781', 'AmberForge1567',
                     'XimenaRider5680', 'RachelLilac9366', 'PreetiGreen1257', 'SeleneForge9296', 'CerenBurgundy9487',
                     'AnnekeFang4091', 'MargritViper5355', 'RoseTangerine2326', 'SophiaRider7487', 'SageFlame5606',
                     'ElifBlade3994', 'AnitaHeart8350', 'CourageElectric2941', 'RinMahogany8858', 'JasmineArcher5484',
                     'CamilleSpell8827', 'NiamhPurple7435', 'JusticeOchre0963', 'EvelynSpark4499', 'DeryaFlame4356',
                     'SkyWine9592', 'KaisaDusty2791', 'AmeliePlum1626', 'RadhaSpell5059', 'RubyPhantom1401',
                     'NeaApricot8490', 'ShirinRider1899', 'XimenaValkyrie9881', 'SagePeach2086', 'DanielaEggplant6756',
                     'AyseMage6550', 'SepidehSalmon4292', 'WaratahTurquoise6521', 'AnastasiaHuntres9518',
                     'ClaraStrike7233', 'RhiannonGoddess5191', 'RadhaSpirit3207', 'BeatricePurple0398',
                     'DaphneOchre2314', 'SeoyeonOwl4696', 'KaiaMustard1732', 'LailaMage7991', 'KenyaSpark5292',
                     'StefanaSpark8899', 'DaeunVermilion2915', 'KavyaSiren6479', 'QuinnOrange2240', 'JanePink5680',
                     'AbigailStrike9644', 'LeilaniVixen0010', 'HyejinKhaki7501', 'DvaHuntress8331',
                     'BarbaraEggplant2084', 'CalliopeSpirit7482', 'ValeriaMustard0195', 'JoyVixen1835',
                     'FreedomMahogany7078', 'EdithAubergine6645', 'KristinaSpirit2901', 'PinarSepia1958',
                     'SierraPhantom4845', 'CelesteSiren8272', 'NaniTomato4299', 'TeodoraWind6992', 'LindaBlaze3255',
                     'LisaIvory0584', 'DesislavaPrinces9145', 'LakshmiRed0719', 'MarianaPrincess4972',
                     'LiisaReaper2364', 'SepidehGoddess7914', 'KatarzynaSlate8211', 'AntonijaFlame7495',
                     'MaryamPrincess5172', 'AntonijaPeach9615', 'BrielleSteel7988', 'SakuraAubergine0303',
                     'CassandraArcher9878', 'ScarlettOwl5162', 'DeirdreBlaze6147', 'ZoeKnight2563', 'IvanaKhaki1486',
                     'VioletWeaver3963', 'HannahArrow7204', 'TaliaPlum8687', 'MiaStrike9913', 'JoyGreen5163',
                     'XiuGuardian1912', 'UrsulaKnight5932', 'ChayaRed9036', 'MarieWolf5068', 'ReaganCornflower8824',
                     'DaeunPhantom6740', 'EilishGuardian1554', 'LyraValkyrie5809', 'ScoutHuntress1201',
                     'ElsaCrimson9920', 'ZoeBurgundy5173', 'JinahNinja3655', 'CassandraFuchsia0667', 'LilyPeach0023',
                     'KirraKnight9049', 'IvyOlive8909', 'LailaArrow8078', 'KatarzynaKnight3946', 'HelmiBlue2304',
                     'MihaelaSpell8820', 'PhoenixGoddess6265', 'AzureMoss1545', 'RebeccaPrincess8432', 'HuiKnight9525',
                     'NienkeCornflower4381', 'DeirdreMetallic3598', 'AkikoIvory8483', 'LailaRed2545', 'AzureTomato0202',
                     'SophiaTiger8296', 'GabrielaLilac8708', 'SvetlanaApricot9751', 'IreneHawk1324', 'LyraRider3214',
                     'KiraCrimson2400', 'NinaHuntress4765', 'NiaHunter2171', 'AnaisDye8068', 'NoorBurgundy5750',
                     'StefanaWolf5897', 'HopeWeaver4052', 'LucieBrown9962', 'TeodoraWind2519', 'ElinaWine1442',
                     'ZhenRust5807', 'MajaBrown5587', 'DeirdreCotta2512', 'EstherHawk3234', 'VictoryDancer7342',
                     'AnnekeTurquoise7695', 'AriaEggplant7904', 'BrunhildeSpirit9875', 'MahsaBurgundy9685',
                     'SkyWine8937', 'ZuriSpirit2175', 'AmiraBurgundy3584', 'EmeryDark9546', 'ElenaStrike4175',
                     'AlmaTerracotta6703', 'KirraMint4349', 'SeleneBlaze2712', 'SeoyeonWind5505', 'AikoMoss7178',
                     'AnitaCerise6731', 'KinsleyReaper0073', 'JulietSapphire3353', 'AndromedaGreen0345',
                     'MaryArctic3057', 'BeatriceDark9996', 'EmiliaReaper8058', 'MinjiOrchid9295', 'NiaBolt6344',
                     'PenelopeBolt5896', 'ZarliHawk0840', 'YumiViper8976', 'JinahKhaki9229', 'FernandaValkyrie3447',
                     'CaoimheSiren8692', 'HelenaRider5533', 'AislingGold0619', 'MarketaWeaver9708',
                     'ZhenPeriwinkle4799', 'JarrahFox4070', 'AnastasiaFang9551', 'NaomiAubergine4201',
                     'BrielleSpirit5191', 'MinaPhantom8463', 'GretaNinja0121', 'MargritMaroon0513',
                     'WarriorCornflowe2719', 'AutumnReaper1160', 'MabelTerra5443', 'SigneHawk4139', 'RebelTomato0189',
                     'YumiCobalt0228', 'KavyaMaiden9662', 'EilishSapphire5366', 'LeilaForest1848',
                     'EvelynAubergine5891', 'AkalaMetallic3035', 'ChloeGreen6385', 'AzadehTerracotta6002',
                     'LeilaniLilac2900', 'NataliaPrincess6958', 'AlmaGuardian5717', 'CamilleCrimson1900',
                     'CalliopeCopper0332', 'CaoimheSpell1814', 'PersephoneHunter5388', 'LeaKnight2121', 'EwaVixen4378',
                     'JuniperOchre6370', 'JoyVixen5570', 'KenyaPowder2371', 'WarriorMint1323', 'LaylaQueen6746',
                     'MiriamForest8069', 'FaithFox7343', 'CelesteMage7928', 'MarinaApricot7597', 'EvaHawk2947',
                     'IrinaTerracotta6929', 'ZaraOchre6439', 'FernandaOwl4405', 'PersephonePhanto7705',
                     'BrittaDusty7190', 'VictoriaNinja3187', 'MihaelaMaiden3343', 'MiriamCrimson9906', 'PetraBlade0968',
                     'PenelopeCornflow5400', 'MedeaTerra2410', 'ElinaGreen9942', 'SigneValkyrie7750',
                     'SelenePhantom3208', 'NiamhTeal7968', 'IrisTomato6741', 'EilishTangerine5117', 'MelikeSpell7539',
                     'SeleneTomato8828', 'UrsulaBlush8767', 'HarmonyPowder9767', 'CarmenSiren2465', 'ScoutMage9112',
                     'NasrinGuardian5250', 'BeatriceFox4713', 'MarleePurple1351', 'LyraPale5473', 'PenelopeArrow2344',
                     'KianaStrike3237', 'SannaViper9259', 'CerenPale5752', 'MarijaSpark0742', 'HelenPrincess7107',
                     'RhiannonHuntress3875', 'EmiliaVermilion5780', 'AleksandraReaper4014', 'VeraCotta9823',
                     'MayaMaiden2405', 'AinoMahogany7735', 'LinneaKhaki2651', 'BarbaraGray8229', 'GraceArctic6618',
                     'MarijaNinja5724', 'MayaWeaver6979', 'MakedaMaroon3720', 'VioletOrange7629', 'NeaCopper1288',
                     'EmeryTiger6533', 'DanielaSpell6343', 'OliviaSpell6196', 'ElenaFang9950', 'DaisyFlame4512',
                     'NovaSpell8189', 'PromiseTomato3263', 'RebelForge5606', 'HyejinMauve1269', 'LailaWitch0533',
                     'NeaYellow8354', 'PromiseSteel9037', 'BarboraTan7132', 'IreneFuchsia3642', 'ElifMint0856',
                     'AoifeFox9939', 'KatarzynaPurple3684', 'MahinaSapphire6868', 'EsraDye1748', 'AstridMaiden0466',
                     'LiElectric0523', 'MeiSiren4236', 'EdenArcher2524', 'NoorWine6795', 'KenyaMint9750',
                     'EvaTiger7072', 'MajaOwl1624', 'EmiPeriwinkle2564', 'VictoryOrange6077', 'EmeryTerra6859',
                     'NinaCantaloupe3836', 'AthenaSpark7939', 'RafaelaPrincess1465', 'AnjaliSpell6323',
                     'EwaVermilion7164', 'OfeliaArctic0043', 'SaritaSiren5179', 'HecateStrike0115',
                     'PatriciaCopper9752', 'TaliaBurnt4833', 'CarolinaTurquois9292', 'EsraBurnt2315', 'HecateBlade8250',
                     'JelenaReaper8376', 'PenelopeMustard0388', 'IoanaRoyal7171', 'LaniViper1829', 'SvetlanaDancer8204',
                     'LinneaPeriwinkle1776', 'ArtemisWeaver7917', 'JuliaBlade9879', 'SakuraBlush3960',
                     'RaniaCopper7918', 'HazelKhaki5906', 'RinFlame9039', 'BrunhildeWeaver9741', 'BarboraSapphire1327',
                     'KianaGoddess1550', 'EsraPrincess1669', 'EdenPurple3501', 'KatarzynaStrike4400',
                     'NienkeWeaver8612', 'JulietOlive7470', 'SamiraBurgundy9483', 'MarianaVixen7734',
                     'JanaPrincess6126', 'MarijaReaper4834', 'RebelMage8530', 'TeodoraTiger7617', 'AlexandraRed7760',
                     'AmberBlade9619', 'AislingRust2603', 'AriaMage8422', 'EvelynWind7449', 'ClaireValkyrie5355',
                     'ValeriaMint8000', 'EliskaPhantom8186', 'KatarzynaVixen6827', 'CirceCerulean7673',
                     'BrunhildeElectri5821', 'HelmiSlate4534', 'IndigoWitch5301', 'PhoenixSiren4437',
                     'RhiannonVixen4679', 'ElinaGuardian8529', 'NovaFang3990', 'SiennaViper8446', 'AliceMauve3547',
                     'KyliePowder5191', 'HildaNavy5350', 'AnikaNinja1816', 'PreetiFang5233', 'RebelFox8065',
                     'WillowViper6208', 'AdelheidCornflow8126', 'IngridSapphire7701', 'JoyCantaloupe6436',
                     'MargritHuntress0097', 'LilyKnight2785', 'MinaReaper8875', 'ValeriaTan9173', 'ZarliCornflower3377',
                     'VictoriaBlaze7238', 'MakedaCobalt4752', 'WarriorTangerine2990', 'JaneReaper8040',
                     'AuroraVixen9414', 'RebelBurnt5179', 'MedeaPrincess7953', 'StormFox5106', 'DeryaSpirit3541',
                     'SophiaBlue3512', 'YukiSalmon4587', 'LunaCornflower7846', 'SofieKnight6917', 'CamilaPurple2661',
                     'BrunhildeLilac6290', 'ReaganBolt2364', 'AzadehValkyrie7286', 'MeiJade5158', 'DaisyQueen3914',
                     'SigridTerracotta6782', 'HopePale7381', 'JelenaDusty1067', 'GabrielaScarlet0424', 'ZuriDark9125',
                     'DaisyTiger0654', 'MiriamKnight5601', 'HelmiFox2855', 'LilyPhantom5209', 'MilicaPlum5019',
                     'TeodoraForest9222', 'JuniperApricot2115', 'PinarTangerine5454', 'HarperNavy6502', 'GiuliaOwl9631',
                     'LalehHeart1709', 'TaliaMaiden3444', 'YoonahArcher4078', 'PenelopeNinja2584', 'CarolinaBlaze7835',
                     'AgnesArrow3181', 'EliskaPink8916', 'NeaBrown2591', 'LuanaViper4269', 'FemkeVixen4502',
                     'BrittaNavy3031', 'PenelopeAquamari9777', 'TerezaPink3436', 'SusanBolt2858', 'AntonijaApricot5064',
                     'MarleeSpell6666', 'DvaSalmon0446', 'NiamhGoldenrod8503', 'LeilaGoldenrod6048', 'LauraRed3040',
                     'PearlHawk7239', 'LakshmiTangerine4682', 'AmaraDye9698', 'MahinaMaroon4661', 'KenyaMaiden0428',
                     'OfeliaGray8984', 'SeoyeonWeaver8275', 'WeiTerracotta1624', 'LeaAubergine9119',
                     'AyseTurquoise3703', 'PearlEggplant8910', 'VeraPhantom1812', 'XiuSalmon1878', 'StefaniaWeaver1670',
                     'AkikoDusty5008', 'YanGold6367', 'AnitaBuff9211', 'PenelopeCotta6834', 'CaoimheFang4323',
                     'SierraSalmon9101', 'CircePlum9448', 'LiFuchsia0402', 'ClaraStrike9812', 'RinTangerine5263',
                     'DreamFox4950', 'AuroraCobalt5803', 'ZhenHunter7432', 'LucijaSlate1699', 'JanaAubergine7195',
                     'ElifRider3461', 'ReaganBolt5798', 'PreetiWitch7332', 'BeatriceForest1608', 'DvaCrimson8425',
                     'MartinaMage4289', 'LaylaArcher1670', 'SelenaHunter6837', 'KenyaCopper7210', 'AriaViper5434',
                     'FatimaWitch5297', 'IndigoDancer4668', 'FatimaHawk7902', 'EmmaGuardian9926', 'JaneForge2974',
                     'SiennaRider7285', 'WillowLilac2456', 'DianaArctic8466', 'AnikaHawk6769', 'JinahMustard3983',
                     'AriadneHunter6529', 'WillowTan4013', 'KinsleyMaiden7509', 'SophiaWind4583', 'JieunGuardian5321',
                     'FernandaPrincess9931', 'NasrinHeart1263', 'DeirdreHuntress8165', 'KenyaBolt5085',
                     'CalliopeKnight2541', 'AntonijaKnight3383', 'NoorBurnt6264', 'MarleeWitch5133', 'GertrudTeal9966',
                     'AnnaWeaver6341', 'GiuliaSpark7049', 'KaoriMage6792', 'HeidiCopper2132', 'TamsinFuchsia7363',
                     'JuliaFlame9488', 'MarijaFang9340', 'MaeveBrown7012', 'RoseBlade7040', 'DorothyValkyrie6597',
                     'SigneGuardian5053', 'HelgaFox3201', 'FemkeViper2744', 'LakshmiOrchid4707', 'NaniCerulean9264',
                     'PearlTiger0503', 'LeahWitch6662', 'LalehKnight5089', 'MariaPowder4242', 'GraceCotta4093',
                     'ArtemisWeaver2520', 'RebeccaSpirit6076', 'KenyaIvory1470', 'ValeriaBurnt7137',
                     'SeoyeonPowder8827', 'StefaniaArrow4969', 'LeaCantaloupe6839', 'MabelBuff3388', 'WarriorFlame3075',
                     'MilaTeal7287', 'DeryaQueen0471', 'ShirinPrincess2962', 'SageNavy6563'}

local RECEIVER_LIST = {'SigneQueen1835', 'MarketaSlate3315', 'AndromedaStrike1701', 'EmiliaHoney5131',
                       'SaritaSpell0007', 'AutumnPink2833', 'KavyaTerra0674', 'MaileBolt7730', 'JieunHawk7032',
                       'PhoenixDancer4609', 'JusticeGuardian3652', 'AdelheidDusty1088', 'XiuPhantom3800',
                       'CharlotteWind5153', 'JaneRed9254', 'NoraFox2533', 'VictoriaPurple3619', 'AyseStrike1330',
                       'LakshmiVermilion1470', 'KaoriElectric4349', 'HeraFlame4216', 'KatarinaStrike8643',
                       'KirraDark0970', 'AkalaSpirit4774', 'DianaBlade5359', 'ArtemisSiren0944', 'MilicaKhaki2366',
                       'AdelheidSpirit8256', 'YelenaPowder5533', 'UrsulaDusty6539', 'DvaTangerine7568',
                       'ClaudiaSiren2859', 'CelestePeach2311', 'LeilaWolf1174', 'NasrinMaiden7225', 'SelenaMage0832',
                       'AntoniaGray7119', 'NoongarArctic1105', 'AzureBurgundy7464', 'MarketaPeach7617',
                       'DeirdreReaper2931', 'AkikoHawk8424', 'TeodoraSepia9614', 'KirraArcher0447', 'DorothyPale8464',
                       'PatriciaReaper6504', 'GiuliaMauve9968', 'SakuraSpell9095', 'YoonahDusty7028', 'KaisaGoddess5262'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
