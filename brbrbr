-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'Romosargy625', 'Dalymimi1693', 'Ramdoddi66552', 'Jessikip468', 'Sitarmilar281', 'Ronnfabi639',
                     'Chaetnahar159', 'Foderplett0800', 'Robbatreu7540', 'Bakaschay088', 'Hartlsawdo77383',
                     'Loledenby217', 'Mcdoehicky42532', 'Skylasevey09969', 'Eliejimoh7303', 'Votawlucus9424',
                     'Bovypatts99739', 'Zaunleist706', 'Tondaerke7609', 'Quongarmin1878', 'Moolekroot908',
                     'Steerbrozo2904', 'Korczfaiq0150', 'Osokoda3902', 'Ravakiser7777', 'Noydboka122', 'Tharkapur0563',
                     'Reemsseppa9829', 'Siglebeder7011', 'Livietigre2198', 'Dyllaabele336', 'Katstipa6453',
                     'Eglifeuz43172', 'Puaburn85105', 'Eharaceo579', 'Jabarvidic26780', 'Surezpayte4349',
                     'Veishable541', 'Danakaeb264', 'Bacalemary027', 'Obayamoize840', 'Caulknami81761', 'Charjewel960',
                     'Fannisprow91563', 'Pushdevyn7019', 'Mostbusk2409', 'Ekonglevay776', 'Bendlhelyn15761',
                     'Stoleduin9627', 'Friaslyda139', 'Reclarufer0558', 'Junahurey51669', 'Jaylajakab33056',
                     'Shotocilka106', 'Aliyukates2302', 'Krcmafauth408', 'Badiluk5069', 'Sairakett114', 'Rulzngigi661',
                     'Deanahas0681', 'Parbsbasal60167', 'Ehishaar65121', 'Mathateson286', 'Bentzloft54761',
                     'Yemmbatla457', 'Chacoglove6943', 'Ezmeojard7684', 'Speardimov41697', 'Secoyllyr98451',
                     'Govstine40116', 'Muihorn3388', 'Szychkoji777', 'Engelcalel7673', 'Loginmahia64823',
                     'Coalemonir5718', 'Edmontaj08673', 'Lemmzull329', 'Funesleuy833', 'Haltgemar943', 'Letzehunt771',
                     'Gandinolau24155', 'Yoreknyo5168', 'Plymkudus8108', 'Stynfader14646', 'Ettsand5258',
                     'Boddubosa9316', 'Keresiames904', 'Ibsennyle647', 'Glassleia463', 'Fadelgilis158', 'Hanahauton085',
                     'Ettelskaer79449', 'Angerhagos8474', 'Hiserudell457', 'Payengeist262', 'Amizafra8793',
                     'Ayvahobrey38027', 'Humkenast9007', 'Okabeead3015', 'Mcnaylour77700', 'Cuinmoody312',
                     'Haentucci382', 'Acresakio3094', 'Nurultayco674', 'Rulloeaden738', 'Kyllochuey52749',
                     'Copsalina0311', 'Zayonkolta458', 'Rozengarey572', 'Bedaltimur00888', 'Kubekranks7118',
                     'Zhanelynam9987', 'Siyaaadhi119', 'Kukichulak591', 'Titusvesey1757', 'Hlacurby751',
                     'Motanscara6641', 'Biboortyl952', 'Wimspreo585', 'Stinafura704', 'Rylewefer1485', 'Okinottem4519',
                     'Renzfencl62079', 'Okunahevel11963', 'Soffekir1294', 'Jankejeu6215', 'Banesneet250',
                     'Thenpouk7579', 'Leridryer92318', 'Rohnshain570', 'Aussoffa27153', 'Varcozieff639',
                     'Luigiacio72585', 'Faltogeeck358', 'Sinkskouba42786', 'Foxguaba93938', 'Capasada01483',
                     'Erinazule509', 'Aavaaasia09185', 'Chaisalud9392', 'Fathelmar6308', 'Hilbyvetri966',
                     'Jangauer5407', 'Kaminahia167', 'Mcbayheth0703', 'Tarsicotey516', 'Stiloyosko05614',
                     'Lampilexon870', 'Omlidriner4372', 'Maueazama68584', 'Lallbaiz9637', 'Mickeluich56931',
                     'Devonkause6629', 'Lyngeizza8601', 'Bontuda0313', 'Mareeabac3421', 'Synalamph8762', 'Hitevogen260',
                     'Lijoitorie928', 'Egolfronni115', 'Houkdring73707', 'Otakearvay96050', 'Okitaheung09444',
                     'Rohlchatt62310', 'Kaseederse289', 'Alengafa7734', 'Demoecanar811', 'Lelloenke46521',
                     'Aingjossi8716', 'Safajure537', 'Nowertin036', 'Kofodtimon93787', 'Osanobawks14826',
                     'Janolabao95769', 'Kaupasamec1537', 'Swiesminck8720', 'Bennreali19567', 'Obasbeco7789',
                     'Brookreuhl5537', 'Borjemoise680', 'Arbornar1293', 'Cagerchhay81607', 'Shaycalso84600',
                     'Vahyarde98513', 'Hacheander566', 'Evicherdy1511', 'Diawrusev923', 'Ladasfaxon3073',
                     'Piqueasya167', 'Mraztolia60779', 'Reyatane81670', 'Goyenreano8351', 'Jouriladas111',
                     'Inoameads73164', 'Hammfasce966', 'Plampbroca062', 'Lavercurts484', 'Tarpykean5466',
                     'Hoopgerak337', 'Lavrenon683', 'Cajasket193', 'Rachtkagan555', 'Bondelawry9260', 'Rosicjemmy87601',
                     'Sleektolle7350', 'Merikurdy482', 'Miklastagi59993', 'Koletyes599', 'Mitaslean6850',
                     'Aureaczub470', 'Rieszreme5151', 'Rezaczales2506', 'Jouleaym54726', 'Howrytrame2558',
                     'Rivaklee558', 'Voristowne39496', 'Superpohle2430', 'Bafiapanno61117', 'Elbonousey76503',
                     'Lantogaull74022', 'Yaichbaatz660', 'Ruracredo58590', 'Savyaskove9407', 'Kuljucipro224',
                     'Vaiawiig1157', 'Kaliekenji718', 'Sassizivah936', 'Mowlaonur182', 'Hogepuch4851', 'Ehlisselvy1788',
                     'Forcksokul9012', 'Wirzkutch9360', 'Eloffstare398', 'Brollshek32130', 'Umbletosi1324',
                     'Craibandal2586', 'Kaimbalm417', 'Staiewujek4797', 'Pavezhaime7674', 'Kathekacy6091',
                     'Cicosolin85258', 'Kwakuborta34078', 'Autarkatis603', 'Choupdog35323', 'Caensusy17413',
                     'Nelcrace9499', 'Maulgad430', 'Munkotrone3616', 'Vlietbland13017', 'Kaefitte461', 'Tigernuru9915',
                     'Pacekcrego769', 'Yohejatin610', 'Tyronkata33369', 'Ngigikazik1647', 'Inerosuch541',
                     'Youngblish7601', 'Guysjovan429', 'Mondause068', 'Talaweins24938', 'Trogshabi8699',
                     'Prutzwyne83475', 'Ichelgades61446', 'Vleraquane6160', 'Koyakifer831', 'Hagelyurs49691',
                     'Bayrdreis8930', 'Furbyrehn525', 'Hougitz30350', 'Tsuhacurzi2712', 'Osmapless090',
                     'Fuquanease8920', 'Sibugdeare37408', 'Hnattorix694', 'Zippesaxe3856', 'Tamanmorfa28532',
                     'Maticbizek032', 'Parkssnook1175', 'Frushmucci689', 'Trennbrus65825', 'Muiztrane743',
                     'Lendalitt2090', 'Eisanbraam35376', 'Golarsiong7829', 'Bletztasso27790', 'Geyegouty930',
                     'Setersayma63125', 'Cozzalemmo912', 'Aniolbaler667', 'Camaskaan399', 'Syrahsauls87165',
                     'Trygghilts2728', 'Aimmerri327', 'Szuchwik7808', 'Vicoysanin888', 'Loueysidow01692', 'Wykahuft112',
                     'Jasengerz817', 'Songyraco67070', 'Boolegaede79503', 'Fontsdaunt4474', 'Pintaekart38909',
                     'Eagerdemny8292', 'Mehmhaitz8036', 'Boodykrop05397', 'Rischtabin0246', 'Amellbelen07421',
                     'Leaksdubar36108', 'Tyllngoy631', 'Burratott92743', 'Fobbmedel13781', 'Vassgalea016',
                     'Nuquekwesi491', 'Ecretlehi983', 'Munchdoil36064', 'Lowanknorr7405', 'Abubomazal45462',
                     'Peknyging128', 'Jilekwanza2010', 'Huzadoles309', 'Raussgrupe712', 'Carnowye6391', 'Waithjoab681',
                     'Nianfacer818', 'Titanrhamy7961', 'Amiotiwami867', 'Rolekyoula54758', 'Kesiakapas516',
                     'Sajistofa0595', 'Caitoledo853', 'Giniamato664', 'Quacholene4910', 'Genthubele37261',
                     'Kurthelize978', 'Leidedeacy172', 'Hoagebenis4717', 'Shutznyby53614', 'Kollabeato5115',
                     'Rettably561', 'Fodgebornt3666', 'Sheedkrush35474', 'Raseynious989', 'Kianifurth8302',
                     'Reathbilow58137', 'Gertboone8931', 'Wujekarlee41598', 'Lackefach780', 'Pirogsuhr42777',
                     'Moriejach65411', 'Wencyakim43199', 'Dabhihtun568', 'Pelowhonse320', 'Gauntdutan6343',
                     'Eikepughe9859', 'Ryoureins818', 'Reencedor835', 'Haedtdutel7811', 'Joletajeti626',
                     'Kicakbojan9270', 'Zadieminix04932', 'Bilakblate033', 'Duerkraaen8487', 'Shifayeow164',
                     'Kaubeanni69710', 'Awadashutz0588', 'Hounhser7945', 'Rassaudra5461', 'Budaykola694',
                     'Kellahoch550', 'Roorksarte546', 'Eigenloula52869', 'Mahykoke146', 'Ashareis427',
                     'Swammgirtz58293', 'Estusdafne1245', 'Damebores62208', 'Xenosbadu9308', 'Liskmerel3426',
                     'Tepdutil08062', 'Ewyyip11026', 'Calamferla93758', 'Earllheri99186', 'Wizeafsha445',
                     'Fadulpoint978', 'Weuveumar7979', 'Nernjovie48785', 'Mcraycubi0295', 'Lakoyanez8728',
                     'Krutganie576', 'Dezioprach39639', 'Shehauble2585', 'Keilybedoy077', 'Bariwaag5732',
                     'Veeranenno0458', 'Dayesoyler3881', 'Tzeobibik408', 'Nikiaamal5519', 'Rombszisa798',
                     'Lemesholl137', 'Sanzidause0885', 'Gildisch125', 'Tyczkich3380', 'Laumbknoy025', 'Shahchutz1771',
                     'Wassjem0738', 'Hienkhin7237', 'Ninfataura4622', 'Pupaguyn6197', 'Oeiboven357', 'Tulikdorr654',
                     'Shaifyke8723', 'Brummfaxon7133', 'Sazoniler695', 'Periaseol2173', 'Parraburm5010', 'Rhuelems3617',
                     'Buyerranne99448', 'Helenuda578', 'Zuzgakumer774', 'Plossrodey969', 'Aukerlynem1122',
                     'Wedenhaw96650', 'Kuperlola5485', 'Wurthlerew8144', 'Syreksiraj885', 'Fuestpaula036',
                     'Dottzmira77197', 'Nickleany8202', 'Roenamjed1056', 'Kealpriem84464', 'Jezikjafar3453',
                     'Subuchere22128', 'Beskeengum086', 'Tussgavin8454', 'Rebroback08548', 'Thienbacco91700',
                     'Babkafabi18123', 'Pihubrous60049', 'Barthdank6463', 'Niroleak892', 'Lacebabis08894',
                     'Wempafus415', 'Sajorfeild89134', 'Fleakzuzak6298', 'Frinoarp97899', 'Terzoshort7648',
                     'Parlesimco42932', 'Demlyoung68660', 'Romelnode131', 'Waghkluz9624', 'Leeexon01839',
                     'Frenskulak9324', 'Gopierobke825', 'Sursaskip912', 'Ruffafancy032', 'Vanasluich93751',
                     'Fusiksipp713', 'Kauleiser5906', 'Cupidbayou60404', 'Cadsuri910', 'Padrotadic34226',
                     'Hardgaja7148', 'Yudkelivvy994', 'Raayagess666', 'Saldofogg014', 'Pateeshoap68379', 'Kwekente536',
                     'Hamrahouge9729', 'Lehwelu93828', 'Attigdelon226', 'Ihrigdirkx380', 'Buydewig820',
                     'Geithbreil85964', 'Sparrboody0657', 'Teifijevan300', 'Beuckteo529', 'Tolfaabuhl797',
                     'Ankergroth629', 'Calixnann058', 'Juartniola188', 'Murakthimm8952', 'Hullsslape50733',
                     'Handtashen933', 'Samisahl309', 'Ramibehee9198', 'Stahakan79768', 'Mizziparra9813',
                     'Doiretison217', 'Skripagema859', 'Zilicadili610', 'Kesonchier109', 'Ravichute217',
                     'Manixbusha9164', 'Defoesegui0408', 'Harlbowe817', 'Boltdeise4020', 'Kloseborgh24334',
                     'Anidipompo0639', 'Isenguha8845', 'Nortzdupey06609', 'Ahilhamda2090', 'Korthloyo9072',
                     'Buddyunis55717', 'Lizonboada7257', 'Oaksorff39171', 'Fearsadili2512', 'Jumanahil527',
                     'Smelanuque479', 'Albuwynn878', 'Itteloliy9543', 'Crowbyker1053', 'Mortaroden31475',
                     'Siemsegi9116', 'Glynacup4287', 'Erhantulis8190', 'Esamnordt0493', 'Mainjudd22719',
                     'Aabidlovie324', 'Bankoxinyi181', 'Arltabsi5648', 'Aveerabitz65706', 'Esensolet34228',
                     'Roosemotel993', 'Radanimran08240', 'Arrisdamm425', 'Livearel759', 'Bunesluera1020',
                     'Teenasymon430', 'Duosrzasa6086', 'Gatchroque172', 'Uglumkuras9191', 'Wolkemacam06374',
                     'Jonvap5122', 'Apolomiehl8392', 'Biegbils74605', 'Omodtceri4981', 'Aterorell0364',
                     'Akanabrome73671', 'Lozalash7091', 'Laryborer67318', 'Fuhsobeng256', 'Geidlshein487',
                     'Renaemaus84738', 'Senanwiece9733', 'Mashaplowe713', 'Gaineohmie4242', 'Hobbamadia226',
                     'Drusygatus54803', 'Gavedarna4055', 'Todergrina10483', 'Daulthaars9737', 'Zunnosauza17033',
                     'Butrykakeh87921', 'Labonstile89283', 'Dealytoppi797', 'Albummitul4498', 'Thoenmylet079',
                     'Maronbayou1412', 'Baueaasen31058', 'Chigocrute32296', 'Badeaossi7648', 'Jetpyett25162',
                     'Kwongcueto29072', 'Yorksbaena46691', 'Rodermicko4874', 'Idatwork54028', 'Kasapitoh589',
                     'Imaratheye2565', 'Naidabusie42686', 'Letzdubow5910', 'Celicpuent937', 'Dahlekraal8633',
                     'Feldeyank4103', 'Topegelso633', 'Kreyeauch12794', 'Hadldardy263', 'Gedizummo6215', 'Bhatfight762',
                     'Cleesnjos462', 'Emlaycrass945', 'Currimayu33150', 'Gragokheir95075', 'Koshmacik42742',
                     'Lourjaeck19869', 'Mansealiev2805', 'Delbolebby479', 'Ringarmy05017', 'Mureltildi76670',
                     'Khouberny0853', 'Nkomolorin3861', 'Bringbiake1434', 'Cyndehaas11674', 'Joiceaavya79699',
                     'Fashtiao2730', 'Zubekshey67068', 'Ekehtuli609', 'Vassobazik558', 'Navelsyre194', 'Wornstipa6629',
                     'Bligeridge1770', 'Dungheri7631', 'Sejahosko021', 'Tobiasayar038', 'Oxtoncisse66241',
                     'Tsaodemba3225', 'Aramhavva248', 'Kubydoup568', 'Gyureedy294', 'Loverowey21438', 'Bossteela489',
                     'Omotogeary52402', 'Kuhlgarns6436', 'Blideosha684', 'Coltshorey04076', 'Paggiuziel0910',
                     'Klimkoncz2468', 'Theadobias895', 'Mundoteed259', 'Senatleao89378', 'Pineskhou68355',
                     'Ingocoupe289', 'Grabobaez40652', 'Harrezutz140', 'Kolliseres954', 'Ringeabou590', 'Entelnash587',
                     'Subebies136', 'Rhimdevan59954', 'Agneshoins81087', 'Sensalg6662', 'Boagjohan76829',
                     'Nitaboye8533', 'Hejnauxa58222', 'Bloemjalil972', 'Eudeyjosee963', 'Reckwrick0517',
                     'Sythamick46987', 'Rixoncamu136', 'Dimeroxas7631', 'Dokoannah904', 'Kagerweal82167',
                     'Buchsdroog783', 'Russunappa9351', 'Pruslallo007', 'Tojohalka130', 'Ongehilts432', 'Ravasvalor491',
                     'Leedskuria502', 'Orbeshao79396', 'Gashiikram8270', 'Conerkuth9290', 'Dallrasul64173',
                     'Totzarva3015', 'Curienahia22086', 'Shurefahr469', 'Nicajkhara728', 'Tritzfouss95899',
                     'Runnissy78054', 'Kaiiams5692', 'Hanelganse232', 'Ferlasmile4878', 'Hugeeamy890',
                     'Halkakatai03538', 'Cissekear178', 'Cornsletha37560', 'Botemetil203', 'Ossiereite826',
                     'Dereutuyen664', 'Biceryirka502', 'Bacychopp27478', 'Esenkhan7817', 'Cagehoway811', 'Wholfley2796',
                     'Kitchkolva160', 'Foltzlwin156', 'Reelsremba1445', 'Dubsmaday217', 'Toedtflss6015',
                     'Mantedaro91043', 'Haegeaydon0861', 'Fallaleder7060', 'Crompoppe78346', 'Ramzigoshi4135',
                     'Zoriozerck6457', 'Kannabilly821', 'Knellblint29842', 'Chieueble025', 'Rackedgil9658',
                     'Fautsidon78583', 'Blancrump0303', 'Ralkoroco633', 'Acarmctee4630', 'Esgarkarel0398',
                     'Koepfbeson334', 'Toebejogi886', 'Wordkaeck91222', 'Loyedsirat5868', 'Kopelrothe90046',
                     'Pariwent009', 'Gmuerjame5697', 'Taklefinni135', 'Kozacrin383', 'Bagbyoshay60770', 'Heynsmoix834',
                     'Farrpleak0991', 'Kvamkiera3863', 'Sanglnejat3153', 'Falaniang560', 'Truusresue79864',
                     'Wurtztylka29908', 'Hubafecci10938', 'Sirnagist111', 'Vinnybiasi195', 'Blasezanis1074',
                     'Idenkanke23997', 'Doutyobney569', 'Valusvlaun4897', 'Arnasails97162', 'Mahummues57875',
                     'Shairkenza15180', 'Madarbalo94422', 'Buyzemeni4635', 'Zellwachi76466', 'Lochvelde444',
                     'Nocekjui2904', 'Kariniliya092', 'Laisdeion8282', 'Tovituch0781', 'Orsonnaum771', 'Seauxmarkl508',
                     'Voglzerai552', 'Riefabano9370', 'Grabbing79305', 'Sophixenia120', 'Leedcofie41257',
                     'Giltzrocci924', 'Lamykacev331', 'Emipisha968', 'Reccakesey782', 'Hoilewitty848',
                     'Nierikeams88209', 'Lammresse9423', 'Dohmsbasl1148', 'Siawranea4479', 'Ryesdarbo7411',
                     'Jazzehler1592', 'Fouchvasas450', 'Xechandt85671', 'Vonerdeacy61622', 'Saimabeke3949',
                     'Borsepoach176', 'Samrakiley63312', 'Indyabenns04171', 'Diorakarll34474', 'Zinerayam564',
                     'Fademodeh5854', 'Saikpuk75656', 'Coolsezaan3681', 'Lotgrile0663', 'Jundsenez307',
                     'Popovnebo97443', 'Coreaheuck9354', 'Elrodlalka3645', 'Zenkemutlu7688', 'Navyalawa12042',
                     'Philokoty9652', 'Goutveles44617', 'Lutzfawad00654', 'Ladaybolon6856', 'Imanatrain628',
                     'Addaeaimi8420', 'Torieikola359', 'Krickrazik448', 'Reikamott390', 'Kedarjurg193', 'Kauppelmar176',
                     'Hovepeeks04021', 'Eaglemehek06207', 'Doornravin3423', 'Lekicrabel3142', 'Siderghil79017',
                     'Amohradke9050', 'Lechitzik0937', 'Brenauble65661', 'Reondings2596', 'Stremmakki644',
                     'Beadgoza95620', 'Dyndasagum3649', 'Gaskovault430', 'Auronitani41039', 'Limleshult877',
                     'Charmefdal3502', 'Kacikman729', 'Wirtzfare2911', 'Nalesduh954', 'Askenpurce710', 'Duongbueso0586',
                     'Zubabayze199', 'Romaach47923', 'Tatsjoa595', 'Aasimglimp63672', 'Geachhanny79079', 'Nerzeesah472',
                     'Corhnarmao9809', 'Steisortel1165', 'Oishiakoto312', 'Vescibalka011', 'Ithzaine770',
                     'Aftonveals6720', 'Steffkubic19236', 'Rylacader7441', 'Gorsthelmy1094', 'Steelzupko81264',
                     'Dichrabah8724', 'Beskeguia72596', 'Elstefia841', 'Nouhgrawe272', 'Naviskolko970', 'Szematro8187',
                     'Ravidtewes0903', 'Sveenocker868', 'Godynguers30341', 'Fordenorse001', 'Ndukaortel8459',
                     'Dhattreing535', 'Kokalrehak338', 'Sporsabass3826', 'Aqsahawuah705', 'Hoskobodoh5860',
                     'Verdadyann7769', 'Glovadwy74713', 'Alfarmarji64021', 'Hotchagha145', 'Wybledisco96897',
                     'Riachbeutz6729', 'Molabao900', 'Zapfaudia79112', 'Pueyoliew17491', 'Burnetiell0967',
                     'Ochsfanto5890', 'Blushkunz63329', 'Gamilsirna001', 'Tauntsine196', 'Broodrados463',
                     'Haxbysalta7488', 'Wideldomek7383', 'Sheukozal0278', 'Ulmenzeevy446', 'Pullafilus6545',
                     'Pexanuam244', 'Avalanizo5057', 'Nurrader648', 'Ambosrafay6306', 'Surattsue681', 'Raleyoskey8609',
                     'Bertynasby540', 'Swallmcabe6533', 'Surhgib90018', 'Nzedai6909', 'Bascomeggy681', 'Nikulanno2478',
                     'Haufjovin6999', 'Ralfnagan802', 'Paesearmon00865', 'Goudyneeld76272', 'Arajbryum95042',
                     'Rubelsuba68376', 'Thornakes237', 'Rotanreidy2809', 'Baudanton953', 'Ulmandayle025',
                     'Laveawaiz82754', 'Okinebane1263', 'Fowledonor485', 'Kleerozols54124', 'Mogeuhde114',
                     'Alvenrup411', 'Nunewalk078', 'Kukajloa39543', 'Baldojood767', 'Nesstry3398', 'Koskyswed68331',
                     'Ottowbegg14258', 'Tuernuse8339', 'Avnersoles3666', 'Wajerlexii96079', 'Jathorohus52956',
                     'Balmzepka3357', 'Moriemandy405', 'Haeauyer91366', 'Burespatsy916', 'Muhrhomme799',
                     'Basomjake41860', 'Vaskeroop9043', 'Rixodam452', 'Vitdane697', 'Facenhare305', 'Shudygerek47049',
                     'Dobleamari01189', 'Ludidoaks775', 'Hagleklez9119', 'Tigueabeer588', 'Sorbifoots9489',
                     'Czopweck807', 'Parsezhara575', 'Gribbbuhl82001', 'Leibegreil1282', 'Howayekas49196',
                     'Wymbsbive298', 'Koltroar850', 'Kiengbaid9351', 'Minokenn0495', 'Papelneck26220', 'Roxerter968',
                     'Ludoskaja01192', 'Gersbolds756', 'Boninfrate7378', 'Diyanili9368', 'Krisduber2820',
                     'Bairehama24476', 'Potoktopf60901', 'Diverdardy009', 'Kliesneela2177', 'Bauxbeitz0368',
                     'Dootault870', 'Yalelot1629', 'Fqamalu4732', 'Vimalsoest3589', 'Moyardrefs4802', 'Rifkywilen9874',
                     'Proudbray3975', 'Puschihle36263', 'Fakerroome3142', 'Agarcame59018', 'Mannichuol3095',
                     'Behpatko75933', 'Tisbyafman11694', 'Anzaiehle540', 'Reniegerdt584', 'Blachifrah65868',
                     'Sisulroutt9915', 'Hossekosla525', 'Hunkeivie935', 'Frenzmattu83123', 'Taimagger8883',
                     'Tinchpaul116', 'Miaoklyn3357', 'Inmanvico51601', 'Loilusaid70225', 'Bercytoppe70643',
                     'Bacipooni10376', 'Ziehmkubu62842', 'Sindtsmitt16209', 'Polmteifi13170', 'Yurekago974',
                     'Muhmclaps1794', 'Randocazee000', 'Mehmpicek1348', 'Janiavoit0027', 'Kacinnegin9723',
                     'Nolondalan916', 'Aymenauch8382', 'Cusicbiley173', 'Chanonigam6630', 'Zinescime5834',
                     'Therybuoy4992', 'Dreercapas4764', 'Rhameseils2349', 'Kappsfria05018', 'Lortzbirt97381',
                     'Toalawiant89339', 'Naingtokie879', 'Rengaclaro332', 'Buiceige63660', 'Ofilitanno18528',
                     'Fughinnes936', 'Fallgibby48350', 'Gussepati4874', 'Kamhiricky42822', 'Covaopfar9324',
                     'Jaglaisasi623', 'Loggerdie777', 'Liwsiledon153', 'Zuoerina094', 'Beetzsavit80266',
                     'Friarange72064', 'Fianosivil91582', 'Elbelalfi275', 'Devoeisatu8000', 'Kaskigolz9916',
                     'Ungarhqs308', 'Malaksiino05038', 'Amalannon1037', 'Enayaharm420', 'Nadjaraman152', 'Aytonjon3673',
                     'Hiedimurai2605', 'Lawenklang297', 'Elmansalsa195', 'Enohgade76717', 'Oramawisti6109',
                     'Derkewong8940', 'Gironsoyer25644', 'Murenbult680', 'Fayernible75747', 'Vinhcases1389',
                     'Omranduman8611', 'Dalinstuth11882', 'Oordlarge30665', 'Mildebyun209', 'Haggymeger8278',
                     'Dakesaslan4228', 'Schubpueyo0897', 'Deenykaip903', 'Edukuptz6686', 'Kandtamed11947',
                     'Biklebqb83782', 'Tolveamrin80634', 'Dauchryun13083', 'Mihosdacie3315', 'Coiadalli02087',
                     'Hetuapt4258', 'Plagaiseli2155', 'Neassnare20338', 'Temarench751', 'Rollibozik56300',
                     'Dolfisran7237', 'Ceskotorry50777', 'Cubiekahoe63959', 'Craskgaio834', 'Eneixlehat07463',
                     'Eleamely286', 'Santilong49642', 'Lattgroth4776', 'Buhlburly2447', 'Stacechiou957',
                     'Gurowobbe3379', 'Reetareeck4935', 'Finetgabos627', 'Tosoncovas063', 'Delmaboyse0792',
                     'Zerbatable65370', 'Dluhyyazza4256', 'Cujieich9554', 'Owinorullo247', 'Koranwirf1107',
                     'Mutaorn99595', 'Baurelea7609', 'Gulliiaea05122', 'Engerabas4516', 'Velistape463', 'Ciakbenin3324',
                     'Meheksuel3878', 'Abbotleven84949', 'Pannulosli8645', 'Dahletewey7870', 'Doosekruid923',
                     'Nieldtohme84661', 'Staatkobza670', 'Cinarcayla8816', 'Doakstones2829', 'Malbykogan466',
                     'Kernfava540', 'Khawvolpi4898', 'Hueyvoci7331', 'Zabiktysor54943', 'Wutzatter239', 'Wairsowry885',
                     'Boopfahl20551', 'Cymanyukna93301', 'Abeaale648', 'Celievon969', 'Dassyakow990', 'Kruljanov36365',
                     'Ekeyradev4882', 'Gosiksoso2457', 'Bruhnvizzi94967', 'Didimyton97441', 'Byesfermo81559',
                     'Remmyfoord35377', 'Touzefrech99775', 'Gilbovirgo347', 'Hadihiba0611', 'Osethhally718',
                     'Fieadyan46187', 'Emlynlekic0571', 'Brummletto76218', 'Troubflomo25075', 'Ostbyaerin839',
                     'Kaylewadas00690', 'Rinckkeiss2696', 'Serakbagin8854', 'Norsewalji47019', 'Elksbulau401',
                     'Wrasemikle8084', 'Novbisom97147', 'Foldijio3983', 'Lassikandy01200', 'Hougemungo05148',
                     'Fronfyle25332', 'Bacebiles89595', 'Nuurfurey89098', 'Soareami62994', 'Orwiglotta550',
                     'Buntest2211', 'Voteponze6750', 'Joppyjoves8987', 'Yagerbeets008', 'Kalkseary333',
                     'Wyresroen08429', 'Salsadouin00918', 'Aasnoyan59484', 'Leneyothon59787', 'Gabiafre962',
                     'Rosarbohol794', 'Amselyasay44386', 'Yvanortal591', 'Seipborup847', 'Houstarios11184',
                     'Chegefreni48163', 'Soskawiege947', 'Luxondynah6250', 'Olanobispo952', 'Vergeihde865',
                     'Koremilz0447', 'Gyoryvaden955', 'Beniccayde5926', 'Charklidge72004', 'Pargoagey488',
                     'Rielfomby767', 'Saifloebe666', 'Buffibad4155', 'Florpalla6021', 'Ruaritolla9135', 'Pepespory4496',
                     'Kunstwilli448', 'Giomislove730', 'Grimebusto0340', 'Sekarfilip02326', 'Richadulin23443',
                     'Hizarwelby971', 'Odelltuffs80382', 'Alvinerina272', 'Tippalois1845', 'Iznachean305',
                     'Achjaron36763', 'Padindetra671', 'Jasonsaray8950', 'Hudoktimpe594', 'Clinklodge652',
                     'Pujiajulca3953', 'Egganwiste0386', 'Laskafotis396', 'Rmahmaunu616', 'Stagelonee8000',
                     'Zaitzjiana5127', 'Widokret5572', 'Andowgroo46482', 'Watiligh974', 'Boikebahi5636',
                     'Dejanmajer43752', 'Vanasbrood544', 'Boiceyano2773', 'Atenatulu5278', 'Rihnwilz63281',
                     'Tanksarney253', 'Zukiceney5168', 'Sursazerpa9378', 'Snakenaqui38858', 'Kanelpiro14831',
                     'Grotchard1236', 'Avtararris962', 'Tepkoppe0473', 'Soinecon0142', 'Deboebacko76634',
                     'Klausrodr83686', 'Honsenduka669', 'Kottebundu007', 'Alokcurto66673', 'Sankasigl173',
                     'Topelrukia72521', 'Sayremetge32053', 'Jitenreins247', 'Huttsmergy4757', 'Kuthwehe291',
                     'Coryaheden8266', 'Tlapaaloi456', 'Ekeskust496', 'Dylesbadr131', 'Eliotwaske337', 'Huleskolk141',
                     'Aidepye218', 'Imerisergo733', 'Cammtoste88734', 'Somaijiten896', 'Tongapaino85616',
                     'Deienmonts414', 'Kiperlupe653', 'Ealummehus901', 'Echtalbro44833', 'Sagoozummo5469',
                     'Ginidano1777', 'Trevdidio07478', 'Rheydates8107', 'Eadergouse01797', 'Murenouye5521',
                     'Skeetpotak3639', 'Yongnila1014', 'Ojoahnen06764', 'Fainsween1553', 'Flannjobes1983',
                     'Horaksions0626', 'Bykovifra76358', 'Livvysayer8373', 'Oswinnatka5320', 'Sieffbarch97611',
                     'Guistkopca932', 'Keytesyon6194', 'Macamnarel186', 'Vakiltimes456', 'Mickoerum92358',
                     'Luriegals445', 'Bibbocabus9028', 'Rhealryon50154', 'Sabajpomes77024', 'Enverkoivu897',
                     'Tarsiasha5020', 'Alaamange2793', 'Guicoproe324', 'Giosafober427', 'Bahigetto1039', 'Seelcocci148',
                     'Jorsinez292', 'Papenreams971', 'Abidiwieto991', 'Pinarpank25156', 'Sevichok4620', 'Akardgeier386',
                     'Slottryou5616', 'Furcisedan20423', 'Recobkocak99726', 'Taboncuson362', 'Adaokalm98123',
                     'Rainzemla50873', 'Reyahtrop15256', 'Farhimatei3859', 'Binetkest6227', 'Eibclein272',
                     'Nohkeele9327', 'Choppoux07563', 'Luciojorie3936', 'Feagakeif4556', 'Bieblfini14516',
                     'Gussihuang3721', 'Lallybonse84569', 'Ndaomoren747', 'Joyertsan610'}
local RECEIVER_LIST = {'Hipkepoth5001', 'Selieokert8581', 'Fikenei18984', 'Loseyguzik7900', 'Zaltzemiko68607',
                       'Warbyre9554', 'Kholinna3570', 'Luthyrheta60452', 'Bacayparal640', 'Riscoengh95124',
                       'Nappsburr34502', 'Steplua37547', 'Ninowysasi7171', 'Roufbraha3915', 'Polekmers625',
                       'Mizarsinke5154', 'Harmsavyan785', 'Meggibeeks31080', 'Saybemylee51562', 'Neckaspri8940',
                       'Radlbeale555', 'Yantamolo886', 'Rohatgul7961', 'Folkgrah781', 'Rakblout1292', 'Iainmagee79739',
                       'Bumpsande60627', 'Hirzoehl2800', 'Onnaneeq797', 'Chavakayde05736', 'Pombocilla1193',
                       'Waaspire2382', 'Kocotfirch243', 'Imtazhuor268', 'Frioubabor919', 'Poppnacua6064', 'Dadadila505',
                       'Honnwoy083', 'Loerreno9344', 'Sofieyow59884', 'Karibraza883', 'Schoodagne745', 'Fojtsiri80036',
                       'Mozallovan98823', 'Lahopop4198', 'Sorbykatze66418', 'Mesezutz60318', 'Elisavirk7105',
                       'Fondadrope01301', 'Bluelglumm830', 'Durndoto15589', 'Emgestire2315', 'Arinaboryk6026',
                       'Corframee32687', 'Lowdstryk610', 'Saquiolean853', 'Frandgelok782', 'Sottwall1735',
                       'Wehleoza796', 'Peonykucik3437'}
-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ตัวแปรสำหรับ timeout การรอเริ่มเทรดหลังส่งคำขอหา receiver
local SENDER_REQUEST_TIMEOUT = 200 -- วินาที
local lastSentTargetName = nil
local lastSentTargetIsReceiver = false
local lastSentTime = 0

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันหาผู้เล่น sender ที่ว่าง (ค้นหาเฉพาะ sender)
local function FindAvailableSender()
    local result = nil
    local success, error = pcall(function()
        print("🔍 กำลังค้นหา sender ที่ว่าง...")

        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                        tradingValue = player.Settings.Trading.Value
                        isAvailable = (tradingValue == false)
                    else
                        isAvailable = true
                        tradingValue = "unknown"
                    end
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " .. tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print("❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบ sender ที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindAvailableSender: " .. tostring(error))
    end
    return result
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    -- Sender สามารถรับ trade request จาก sender อื่นได้
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Sender พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            -- รีเซ็ตสถานะการส่งคำขอค้าง
            lastSentTargetName = nil
            lastSentTargetIsReceiver = false
            lastSentTime = 0
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            -- ถ้าส่งหา receiver ค้างไว้นานเกินกำหนด ให้ลองหา sender ที่ว่างแทน
            if lastSentTargetIsReceiver and lastSentTime > 0 then
                local elapsed = tick() - lastSentTime
                if elapsed >= SENDER_REQUEST_TIMEOUT then
                    print("⚠️ รอเริ่มเทรดกับ receiver (" .. tostring(lastSentTargetName) .. ") นานเกิน " .. SENDER_REQUEST_TIMEOUT .. " วินาที กำลังหา sender แทน...")
                    local fallbackSender = FindAvailableSender()
                    if fallbackSender then
                        SendTradeRequest(fallbackSender.Name)
                        lastSentTargetName = fallbackSender.Name
                        lastSentTargetIsReceiver = false
                        lastSentTime = tick()
                        return 0
                    else
                        -- ปรับเวลาเพื่อหลีกเลี่ยงการ spam ตรวจซ้ำทันที
                        lastSentTime = tick()
                    end
                end
            end

            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
                -- บันทึกสถานะเป้าหมายล่าสุดที่ส่งคำขอ
                lastSentTargetName = validPartner.Name
                lastSentTargetIsReceiver = IsInList(validPartner.Name, RECEIVER_LIST)
                lastSentTime = tick()
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        -- เคลียร์สถานะการส่งคำขอค้างเมื่อเข้าสู่หน้าต่าง Trade จริง
        lastSentTargetName = nil
        lastSentTargetIsReceiver = false
        lastSentTime = 0
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- Coroutine ปิดหน้าต่าง CreatureInventoryFrame อัตโนมัติ (ทำงานเบื้องหลังตลอดเวลา)
local function InventoryCloserCoroutine()
    spawn(function()
        while true do
            local success, error = pcall(function()
                local playerGui = LocalPlayer and LocalPlayer.PlayerGui
                if not playerGui then return end

                local tradeHudGui = playerGui:FindFirstChild("TradeHUDGui")
                if not tradeHudGui then return end

                local bottomFrame = tradeHudGui:FindFirstChild("BottomFrame")
                if not bottomFrame then return end

                local creatureInventoryFrame = bottomFrame:FindFirstChild("CreatureInventoryFrame")
                if not creatureInventoryFrame then return end

                if creatureInventoryFrame.Visible == true then
                    local closeButton = creatureInventoryFrame:FindFirstChild("CloseButton")
                    local upperLabel = closeButton and closeButton:FindFirstChild("UpperLabel")
                    if upperLabel then
                        local safetyCounter = 0
                        while creatureInventoryFrame.Visible == true and safetyCounter < 30 do
                            Clicked_Ui(upperLabel)
                            task.wait(0.1)
                            Click_NOW()
                            task.wait(0.2)
                            safetyCounter = safetyCounter + 1
                        end
                    end
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน InventoryCloserCoroutine: " .. tostring(error))
            end
            wait(0.5)
        end
    end)
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- เริ่ม coroutine ปิด CreatureInventoryFrame อัตโนมัติ
        InventoryCloserCoroutine()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
