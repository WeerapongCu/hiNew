-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'SusanRust8939', 'BeatriceApricot8713', 'MarleeWolf0246', 'LeaLilac0551', 'KenyaMaiden4880',
                     'PearlPhantom9770', 'LilyHuntress3947', 'ZofiaReaper5066', 'SiobhanWeaver3915', 'HelgaArcher7898',
                     'MarijaBurgundy6327', 'LyraEggplant6617', 'DorothyWolf6993', 'CourageVixen5213',
                     'CamilaPhantom6167', 'MihaelaHeart1983', 'EmeraldCerise3263', 'ZaraBuff7479',
                     'EkaterinaArctic7227', 'LindaSpell6416', 'EunjiHuntress2627', 'LindaStrike9360', 'FarahFox3193',
                     'CirceSpirit2389', 'GraceFuchsia4903', 'MakedaNinja2835', 'StormSpirit3455', 'KylieSlate8606',
                     'JulietSpirit3278', 'ClaraFlame3301', 'AndromedaAubergi9881', 'NinaTurquoise9885',
                     'NienkeMagenta2949', 'JelenaOwl1965', 'HazelMagenta8425', 'AryaGuardian9585', 'JarrahReaper5044',
                     'MilicaMauve2288', 'AndreeaVermilion9852', 'WarriorForge2655', 'SooSiren9531',
                     'KristinaHuntress2645', 'NovaAquamarine5448', 'FemkeScarlet8242', 'NoorWitch1861',
                     'RoisinSpell3649', 'OrlaTiger7507', 'EdithMaroon1207', 'ZofiaPhantom2139', 'StellaKhaki3762',
                     'WeiNinja6007', 'KaiaPeriwinkle9581', 'AthenaTiger1977', 'NataliaSpirit2296', 'LaylaTiger0774',
                     'DaphneYellow1838', 'RadhaForge2688', 'TeodoraFang9466', 'SamiraTeal8743', 'CarolinaBlaze7919',
                     'HildaViper7543', 'FaithPrincess7905', 'AnjaGoddess6664', 'MargritHuntress5925',
                     'GertrudSpell8384', 'OliviaTeal7020', 'LucieDark4864', 'NoraQueen2103', 'LaylaLavender2596',
                     'JulietElectric5953', 'MinaTurquoise6093', 'AmberTan0764', 'AkikoMoss1006', 'CarmenBurnt5766',
                     'RinPhantom9199', 'LucieWitch3834', 'AnikaGold1622', 'CamilleGreen2695', 'SageGoddess6556',
                     'EmmaWind2259', 'SakuraForge2873', 'CalliopeDark0554', 'EliskaMoss6773', 'WillowNinja0502',
                     'OlgaReaper9940', 'KianaTeal2347', 'HecatePrincess9974', 'SvetlanaArctic0031', 'KaiaAubergine7762',
                     'JarrahFlame2465', 'KaisaAubergine7450', 'LakshmiBlade6100', 'HelenaRoyal5592', 'LeahPhantom1471',
                     'MahsaGoddess6917', 'LuciaWind1978', 'JovanaMaiden6404', 'JarrahFuchsia7005', 'WaratahHawk3903',
                     'FemkeGuardian5378', 'IvyHunter1500', 'YoonahDark6933', 'NoraSteel7144', 'StefaniaVixen9346',
                     'LotteStrike0487', 'NaomiSpark1139', 'SakuraPeriwinkle4827', 'UrsulaNavy1354', 'ElinaNavy0423',
                     'ElinaMahogany8731', 'LeilaniHawk1180', 'VanessaWitch3361', 'AlmaElectric8046',
                     'MariaCerulean1964', 'HildaMage2220', 'EsraBurgundy7363', 'AoifeHawk5493', 'UrsulaGoldenrod9466',
                     'ImaniVixen5880', 'NoraStrike7135', 'NoorFox2480', 'KianaSpark0980', 'AoifeMage6198',
                     'EmiBuff4190', 'JulianaViper8601', 'NaniArctic9798', 'AvaFuchsia4705', 'NaniChartreuse2088',
                     'NinaEggplant8984', 'NadiaWitch0165', 'LeaOchre5567', 'CamilaBurnt8462', 'IrinaViper7143',
                     'MelikeBurnt3712', 'RaniaSepia4134', 'NoorMaiden2276', 'FreyaCrimson3858', 'AnaPeach6522',
                     'MajaArctic3548', 'SiennaFlame5933', 'GiuliaGoddess0988', 'KaiaViper0047', 'MidoriFox5452',
                     'NiaWolf2707', 'CelesteSpirit6892', 'LeaAubergine8908', 'LeahNavy3473', 'HermioneArcher4978',
                     'BrielleTurquoise4488', 'AnnaGoddess3012', 'AkalaValkyrie2879', 'KristinaStrike4346',
                     'RiverPhantom2857', 'MagdalenaPeach4797', 'SelenaForge1579', 'MartinaMage4321', 'HazelMaiden9130',
                     'EmiGoddess2831', 'ClaudiaFlame1405', 'LakshmiDye5032', 'AutumnAquamarine8493', 'SaraOchre8989',
                     'GuadalupePhantom5360', 'HelenTomato5190', 'LaniGoddess4768', 'CiaraCerulean5596',
                     'PreetiGreen0780', 'CristinaValkyrie2798', 'GabrielaMaiden3971', 'PersephoneMagent3508',
                     'EsperanzaSpell4007', 'GertrudPlum3168', 'ArtemisOrange3385', 'AnaisLavender4684', 'OrlaPale3900',
                     'AmaraMahogany7390', 'NadiaYellow5417', 'MarianaValkyrie9922', 'WarriorDusty2271',
                     'AnjaliLilac1282', 'AnaHoney7024', 'SannaBolt2428', 'ElsaSapphire2716', 'EwaRoyal9339',
                     'LucijaArctic0348', 'NiamhMahogany5033', 'DaeunTeal0803', 'JiaTomato6672', 'MarleeGreen0114',
                     'SigneRoyal4535', 'LucieTeal5105', 'AnitaKnight2161', 'BraveKnight7439', 'KaoriTiger3629',
                     'MakedaBlade1912', 'LuciaBlue5179', 'NoorPrincess9776', 'AliceArrow3178', 'AislingDark6604',
                     'NinaVermilion2356', 'KavyaCobalt6970', 'VictoriaSteel0701', 'EmeryEggplant3789',
                     'ZarliPhantom0672', 'ChenTerracotta8869', 'MahsaSpell2742', 'MiaArrow3309', 'AikoLilac2626',
                     'HermioneFox2166', 'AkalaMoss6831', 'HelenKhaki6327', 'EmeraldLavender1386', 'DreamWitch8531',
                     'JuniperFox4848', 'PearlViper1499', 'SilviaTerra6731', 'MidoriVixen7597', 'JaneArctic9818',
                     'NovaKnight8537', 'ParvanehOlive2685', 'EsperanzaFuchsia6666', 'RubyFox8400', 'SeleneTeal6735',
                     'CoralDye9395', 'KatarzynaCrimson5894', 'ZarliBolt8720', 'RiverBlaze2866', 'JuniperTangerine4965',
                     'DaisyGold1932', 'DeepaMoss5536', 'AriaReaper4361', 'AmeliaWeaver9650', 'ElenaMage8788',
                     'MaryamDark2489', 'CristinaSapphire9180', 'AzureSpark7455', 'ParvanehFuchsia5758', 'KaiaSiren3534',
                     'SannaOchre3213', 'MariePhantom1521', 'KenyaSlate3382', 'ZhenHuntress7916', 'HanaSpirit2153',
                     'GertrudBurnt6401', 'SophiaRider4096', 'ChenRider0186', 'AnnaWitch7763', 'AkalaScarlet4503',
                     'NishaTiger1504', 'AvaOrchid2875', 'SkySpark0975', 'JelenaGoddess1407', 'CarmenFang4314',
                     'LucijaSpell9679', 'AzureMint6795', 'QuinnPale9309', 'DaeunCornflower4606', 'YanViper1882',
                     'AriadneRider5391', 'IrisDancer1701', 'NataliaOchre8334', 'YasminHeart9204', 'JulietArctic6818',
                     'ArtemisWind9030', 'AishaTan1832', 'JulietPrincess9005', 'VeraWitch6058', 'EstherFang3670',
                     'SophiaPrincess6922', 'CourageOrchid8219', 'ZhenKnight3849', 'WillowVixen5880', 'WillowNinja9430',
                     'ChenForge5967', 'AuroraMint6207', 'PearlForge9551', 'MarinaBolt3729', 'IrisKnight4097',
                     'LingFox6140', 'KaiaMint6496', 'MinaMage0229', 'NiloufarLavender4276', 'LunaGuardian1640',
                     'PreetiCobalt6976', 'LauraTiger6539', 'AnnaJade1919', 'ShirinCornflower7397', 'PearlMustard1108',
                     'MiaPlum1567', 'JanaGoddess5151', 'BrittaOwl4865', 'SierraWolf9686', 'JiaApricot0325',
                     'RinGray9439', 'SepidehWind5180', 'MagdalenaPink9424', 'AzureHeart7318', 'NiloufarWeaver1441',
                     'BarbaraHuntress2872', 'DvaDancer4068', 'EdithBolt2003', 'MaryamPink3544', 'VanessaRider6382',
                     'KatarinaFang8544', 'KaoriMagenta0240', 'HelenaWine3953', 'EmeryAquamarine2719', 'EunjiBurnt1921',
                     'IsabelaBlush5319', 'NiloufarPlum3771', 'MarleeDancer6105', 'AgnesDusty7173', 'FaithBlade1234',
                     'ElsaRoyal0670', 'VioletSapphire7839', 'JusticeAubergine6726', 'WeiViper1300', 'EsraDusty0383',
                     'AmberSlate4496', 'JanaTan9613', 'DaisySpell0809', 'FemkeRust7082', 'QuinnOwl1559', 'LiNinja1005',
                     'DorothyRider4669', 'ArtemisSpell3393', 'AkalaGray5216', 'KavyaCerise3128', 'VeraGuardian0202',
                     'StellaTan8530', 'MilaIvory5851', 'MahsaOwl9478', 'KavyaSpark1861', 'ParvanehOrange9643',
                     'CalliopeSiren1194', 'PriyaHeart6129', 'EunjiOchre9609', 'ChloeDancer5996', 'BrunhildeRider2015',
                     'NiloufarHunter8210', 'MarieAquamarine3270', 'ClaudiaTomato5997', 'JusticeHuntress6623',
                     'MoanaArctic3378', 'SierraElectric4043', 'MarijaGoddess0316', 'MarijaDye8525', 'JulianaOwl8164',
                     'XiuFox5374', 'JulietteWeaver0174', 'SepidehOrchid9397', 'MiaNavy2396', 'AndromedaAquamar6453',
                     'MaryamSpark2824', 'TeodoraOrchid5748', 'MeiRider5652', 'UrsulaDye3224', 'WarriorPlum3228',
                     'LisaBlade6754', 'SeleneValkyrie4361', 'AntoniaWeaver1204', 'AvaTerracotta0044', 'VioletSiren8989',
                     'EilishOrange6976', 'YanHawk3776', 'SophieHawk9952', 'IrinaFang4313', 'DorothyWeaver1007',
                     'AlexandraWind6015', 'NinaForge0386', 'BeatriceBlaze2717', 'ValentinaNavy5305',
                     'KavyaGuardian9206', 'HelenaTeal0566', 'HelenPhantom5209', 'PriyaDancer5389', 'IngridPurple6250',
                     'EmeraldPowder5273', 'PetraKnight5865', 'KylieSpell9672', 'IoanaBrown2885', 'SusanOrchid6618',
                     'MinjiBlaze8314', 'DanielaPurple4720', 'AryaKnight7332', 'AriaIvory3155', 'TeodoraMage2580',
                     'AutumnNavy7748', 'ScoutBuff2430', 'AlexandraRider9747', 'NinaHuntress5653', 'BrielleKnight9495',
                     'PetraValkyrie3539', 'LenaCantaloupe6744', 'MariePlum3838', 'AlinaFang6621', 'HalaWine7451',
                     'SusanHeart3353', 'LiWolf1809', 'AzadehBurgundy3096', 'AnastasiaSiren2499', 'StefanaArrow8844',
                     'CaoimheOwl6366', 'HeraHunter0112', 'NadiaRed7182', 'CristinaStrike1981', 'SophiaElectric9406',
                     'NoongarMagenta6802', 'HildaHuntress4775', 'ClaudiaLilac2799', 'RhiannonHawk9807',
                     'FrancescaSapphir9368', 'MayaGold3034', 'RinBrown1474', 'ShirinOwl7618', 'WillowCotta5119',
                     'ElsaHeart6645', 'EmiPink0071', 'YasminOwl3587', 'ZoeSpirit7478', 'NiloufarFang5935',
                     'HanaBlade8538', 'ReaganGoldenrod6350', 'AkikoNinja7935', 'SaraSpell8645', 'SelenaHuntress1034',
                     'OfeliaReaper2289', 'NiaKnight8921', 'ScoutBlade7709', 'ZarliPrincess1718', 'MeiArctic9716',
                     'KaiaBlaze2156', 'EkaterinaOrchid1364', 'GabrielaHawk6029', 'FemkeArcher2026', 'HelenBurgundy9664',
                     'UrsulaScarlet2384', 'JieunChartreuse8419', 'DottyPlum5233', 'LiMage0767', 'AugustaHeart4176',
                     'HannahGuardian5511', 'RubyCopper0260', 'YanWind7767', 'AndromedaRed9173', 'MidoriApricot0694',
                     'LeilaniDusty2669', 'MidoriPowder9432', 'AryaAquamarine2007', 'SepidehMage3791', 'OfeliaSpell9526',
                     'IrinaFang7412', 'SaoirseViper5776', 'LeahArctic6829', 'EkaterinaLilac3102', 'AmaraPale7288',
                     'RinQueen4905', 'SiennaVixen2720', 'AstridFang0638', 'AbigailSalmon0450', 'MatildaPrincess3399',
                     'RebelMoss9333', 'MaileWolf1595', 'DvaArrow3596', 'JarrahRoyal8664', 'AndromedaSpark0014',
                     'ShirinQueen7159', 'JoyHawk8492', 'WaratahPowder9163', 'IrisRust1781', 'EunjiCerise3693',
                     'SophiaKnight0385', 'ZhenChartreuse6456', 'StormEggplant8386', 'ZofiaHuntress6712',
                     'AleksandraSpell8681', 'DvaBurnt8549', 'LisaForest6047', 'CourageSalmon5341', 'GizemSpirit3101',
                     'DottyPink6182', 'MakedaCotta0986', 'ReaganWeaver2758', 'NoraHuntress9946', 'NaniMint9896',
                     'GuadalupeBolt4600', 'JoyDark1906', 'LilyFang4139', 'LilyFox2650', 'DvaOchre5970', 'EmiRust3443',
                     'DaisyIvory4788', 'MatildaHuntress6763', 'ZuriYellow8810', 'ClaudiaMaiden4985', 'XiuSpark6023',
                     'JusticeTan5456', 'MatildaBuff6811', 'IvyMage9811', 'AzadehChartreuse7649', 'RuthGray5485',
                     'IreneDancer8281', 'NovaGreen4152', 'EunjiKnight2446', 'JieunRoyal4744', 'IreneDancer2061',
                     'LuanaHoney4779', 'BrunhildeViper5504', 'AlmaKnight5394', 'VictoriaSpell0562', 'MajaMint2672',
                     'CaoimheHeart9151', 'MahinaArrow8711', 'JusticeGoddess5014', 'LuciaBlaze0197', 'IvyTomato4578',
                     'CamilaTomato1503', 'JulietteTiger5333', 'RafaelaMustard8319', 'ElizabethBlade5311',
                     'AinoVixen0208', 'EilishDusty4034', 'LunaOrange4014', 'KatarzynaApricot9641', 'ElifArrow6596',
                     'RubyFox3797', 'NoraTan9429', 'DvaCantaloupe0828', 'MariePrincess6900', 'NovaVermilion0033',
                     'ScoutLavender9081', 'WarriorTiger6642', 'JuniperValkyrie3655', 'ZuriArcher1270',
                     'AishaDancer4440', 'ZhenGoldenrod6209', 'LilySiren6411', 'CirceYellow7239', 'DvaScarlet1735',
                     'SeoyeonGoddess5548', 'AlmaMaiden3928', 'HeidiTan3931', 'AnjaliTan6232', 'PriyaArrow9549',
                     'VictoriaArcher2712', 'MayaNinja5139', 'LiCerise8171', 'AnaGoddess5152', 'ElinaTangerine5320',
                     'DeepaSpirit7191', 'SilviaNinja5870', 'JiaTerra3925', 'NienkeWeaver4888', 'GracePrincess5112',
                     'SaritaCantaloupe3468', 'DreamPurple9212', 'LeaKnight6855', 'NiamhTangerine5417', 'MaryPlum1284',
                     'DorothyPhantom1678', 'EvaGoldenrod7661', 'PinarWolf8598', 'AyseCobalt0879', 'StefaniaMustard1269',
                     'NaniArrow6711', 'FaithFox6575', 'HeraPhantom1443', 'AkalaScarlet2594', 'AikoBlush4026',
                     'JarrahBlaze8044', 'MabelPlum6363', 'PromiseQueen9298', 'FernandaTiger4781', 'AmaraMagenta7597',
                     'ValeriaTerracott6524', 'MaryPowder3122', 'KinsleyTurquoise3872', 'VictoryPlum9781',
                     'AutumnDancer9723', 'JovanaRider3651', 'TerezaRider9513', 'HelgaValkyrie6520', 'OliviaPlum9212',
                     'NoorPlum8221', 'MiaPrincess0378', 'MagdalenaNinja8534', 'MarleeCerulean3107',
                     'FrancescaSepia8962', 'OliviaStrike2913', 'DeepaGold5205', 'RosePeriwinkle2974', 'YanaraDusty1946',
                     'HelgaBlue3608', 'ShirinChartreuse8400', 'AinoCopper9929', 'SakuraViper8815', 'ZaraWind1945',
                     'BraveOwl8589', 'ZuriPlum7606', 'ReaganFox5798', 'TeodoraHunter6881', 'HazelHoney6265',
                     'SiobhanOrchid1897', 'ElsaTan1710', 'SannaApricot2612', 'YumiArcher8160', 'AntonijaKnight9723',
                     'BarboraSpell5670', 'IndigoGuardian0355', 'SaaraYellow8014', 'ElifRoyal1544', 'JovanaSpell2938',
                     'EdithCerise5230', 'JelenaTomato1727', 'AinoReaper3567', 'SakuraScarlet6609', 'CiaraLilac2763',
                     'HelenaHoney4352', 'CristinaPlum4881', 'CamilleScarlet8078', 'SigneMauve4559', 'FemkeHawk3888',
                     'YumiSpirit0588', 'EmeryMetallic3006', 'CarmenOlive4665', 'SarahKhaki8370', 'AzadehFlame5876',
                     'AriaLilac1855', 'MihaelaYellow9085', 'RinCopper2983', 'CassandraArctic6429', 'KatarzynaSpell9782',
                     'CerenFox3926', 'MahsaRust2792', 'LauraMagenta9047', 'BronwynViper5691', 'ElizabethVixen3327',
                     'ElizabethPurple2191', 'CalliopeApricot2736', 'DaeunSiren4895', 'NaomiOwl7329',
                     'EvaAquamarine0587', 'CalliopeHuntress6827', 'JiaReaper3670', 'HelenaBlaze4263',
                     'MelikeSapphire9017', 'AkalaAubergine4967', 'SusanGuardian4900', 'DaisyMage1137',
                     'PhoenixValkyrie1564', 'AoifeDye9263', 'CharlotteIvory5875', 'IsabellaDye5001', 'NovaMustard7777',
                     'PersephoneReaper3605', 'CourageTerra9749', 'KalenaQueen1064', 'StefanaRider4476', 'AryaDye9285',
                     'AoifeArrow7846', 'MarianaBurnt6993', 'JulietMahogany1104', 'MoanaPowder4432', 'AnitaGray3550',
                     'VioletMint0267', 'YukiYellow6572', 'AutumnFlame6963', 'MarijaValkyrie5607', 'HazelHuntress0465',
                     'OrlaNinja8626', 'SooRed8228', 'SepidehQueen7464', 'NeaGuardian3109', 'FemkeWitch4810',
                     'MariaGoddess7830', 'SophieMaroon3876', 'IngridHawk1113', 'RhiannonFox9369', 'MahsaPrincess6373',
                     'LeahHawk4862', 'MoanaHeart2617', 'MartinaNinja6401', 'PromiseArcher4788', 'EmeryWitch4699',
                     'DvaGoddess5104', 'RoseMage7460', 'MoanaMint1857', 'CourageArrow7827', 'ElenaArrow6850',
                     'MabelPrincess0541', 'NinaVermilion3002', 'NeaSiren6228', 'NishaWind5416', 'AinoGoddess3987',
                     'PersephoneWeaver9706', 'JaneRider0506', 'AleksandraHeart1849', 'BrunhildeAquamar7464',
                     'EliseSpell6449', 'MinjiHeart1899', 'SeoyeonDusty4220', 'MaryFlame6957', 'AnaisGoldenrod6574',
                     'LaylaMage6939', 'LotteHawk8630', 'NaniKnight3381', 'MaeveArcher3592', 'KenyaKnight1479',
                     'MelikeFang5282', 'PinarForge0310', 'NiloufarSpark3570', 'YanaraTiger1000', 'KiraPowder7322',
                     'ChloeHunter0803', 'HelgaDancer4870', 'AstridMagenta9292', 'SaaraSpirit0706', 'EwaHeart9949',
                     'AmelieMage3631', 'TatianaHawk9525', 'JiaHawk7698', 'ZaraStrike8952', 'EilishMetallic7104',
                     'IoanaArcher1118', 'JarrahArcher4189', 'AkikoViper6701', 'AndreeaNinja5107', 'SierraLavender2573',
                     'PinarLilac1830', 'AkalaWolf1600', 'ArtemisNavy5564', 'DaeunRider2085', 'SofieBlush0830',
                     'RebelSpell3242', 'JieunReaper7677', 'JasminePurple7627', 'ChloeVixen7963', 'ZoeFang0345',
                     'MarijaSpark3983', 'LalehCerise1778', 'AmaraRust2549', 'TamsinOchre5867', 'LindaHoney4794',
                     'MariePhantom8373', 'CalliopeChartreu1942', 'BraveGray6499', 'MinaJade5526', 'GuadalupeArrow1245',
                     'AntoniaWine8785', 'MiaHuntress9513', 'NaomiFang5890', 'AriadneKnight6791', 'HarperBlue4640',
                     'JieunRust7338', 'ChloeStrike3332', 'IsabelaGoddess0013', 'MihaelaMahogany3340', 'AoifeDancer5403',
                     'ClaraBolt8960', 'LotteGreen9346', 'MakedaCerise7303', 'MargaretHeart1783', 'MargaretMage4732',
                     'TeodoraGreen4459', 'MaryamForest7865', 'OlgaArrow3094', 'KaoriTan3712', 'IoanaSepia2668',
                     'RhiannonBlaze8351', 'SiennaRider2291', 'AntoniaHuntress9004', 'RhiannonMaroon1093',
                     'SaoirseOrchid9321', 'MarijaWeaver8650', 'CaoimheHeart8540', 'PhoenixTiger8596',
                     'RhiannonViper6123', 'EsperanzaKnight4951', 'GretaSapphire5066', 'MarijaMaiden0282',
                     'SiobhanOwl6680', 'LindaArcher8625', 'DaphneTiger2965', 'AoifeMustard4826', 'HeraBlade3122',
                     'NeaPeach6221', 'CerenOrchid0951', 'PreetiFox2344', 'EsperanzaNinja6289', 'NoraPrincess4134',
                     'SofiaGreen7333', 'MiriamDancer4555', 'MidoriBurnt0731', 'MahsaCerise0066', 'JiaFox0338',
                     'AmeliaTomato3961', 'YanBurgundy0108', 'PetraMaroon4427', 'NiloufarKnight9886', 'AkikoArcher4949',
                     'FreedomWind3656', 'LuciaBlue6362', 'DvaSteel5474', 'JiaWolf1263', 'YoonahOrchid9075',
                     'MarinaGoddess0862', 'KaisaHeart6964', 'CarmenOwl9425', 'RiverFlame9380', 'SannaTurquoise3796',
                     'SarahHeart3716', 'PearlHuntress5826', 'IvanaPrincess7592', 'LisaOwl8863', 'NishaLilac7194',
                     'AikoPeriwinkle8895', 'AnjaliArrow4379', 'StefanaValkyrie9499', 'GuadalupeChartre1908',
                     'NaomiMustard9405', 'LyraBlush7208', 'MiaHeart4622', 'MihaelaKnight5115', 'CerenMahogany3428',
                     'AlexandraArctic8901', 'HalaBrown0239', 'ZhenPurple4464', 'AnjaliBlush5618', 'OfeliaBuff0340',
                     'RachelFang9698', 'JelenaQueen7722', 'ArtemisFlame7296', 'SofiaNinja0820', 'LucijaSpark1946',
                     'EmeryFuchsia6900', 'KaisaPeriwinkle3890', 'KenyaSiren2497', 'JelenaSpell7079',
                     'LinneaCerulean7805', 'CharlotteYellow7938', 'LuanaCopper4828', 'JinahMage2318', 'DaisyNinja0291',
                     'FreyaGray9532', 'AnitaHuntress3416', 'HeraSepia5477', 'FaithRider0194', 'MaeveWitch2822',
                     'EdithApricot5774', 'EwaBlush3990', 'RebelBlaze7155', 'AnnaBlaze7149', 'ClaudiaFlame8679',
                     'MayaValkyrie4581', 'LilyTiger0532', 'MargritTurquoise2126', 'LisaElectric4255',
                     'AthenaPurple4095', 'MahinaSteel7278', 'SusanWind6313', 'UrsulaHawk7788', 'ElsaTurquoise3908',
                     'AleksandraKnight6880', 'HermioneArctic8594', 'SelenaHunter5146', 'ZarliLavender3563',
                     'AliceBlaze2874', 'PhoenixTeal5390', 'HalaOrchid6726', 'SkyAquamarine3648', 'MarleeHoney8195',
                     'ReaganMustard1995', 'FemkeArcher5865', 'RaniaArrow0060', 'NoraPrincess8298', 'DottyBurgundy9525',
                     'ReaganHuntress6008', 'LenaCantaloupe6198', 'GretaDusty0771', 'HalaHunter7309', 'ZuriPrincess2890',
                     'JulietteGray4836', 'AnaisSiren8640', 'AmaraTiger1136', 'SvetlanaWitch7316',
                     'XimenaCantaloupe2885', 'UrsulaRoyal7653', 'HecateFlame6026', 'MartinaSpirit6160',
                     'ClaireBlue2788', 'ZehraDusty7193', 'SophieGuardian6259', 'KristinaSpirit4992', 'SofieFang5001',
                     'JovanaPrincess1113', 'MahinaDye5544', 'HyejinBurnt4341', 'YanBuff7339', 'CaoimheArcher8852',
                     'LeilaniNinja2569', 'OrlaRider1979', 'SaritaCerise4306', 'EvaBlue4586', 'JoyCopper3134',
                     'AzadehJade0721', 'SakuraHawk7521', 'ChiaraTurquoise7429', 'AkalaWeaver0086', 'HalaHeart4145',
                     'MarinaGoldenrod9022', 'ShirinTerra6231', 'AmaraNavy1457', 'AmeliaMustard3835', 'AriaMetallic0148',
                     'IreneCrimson6054', 'EunjiFlame0283', 'DeryaKnight4198', 'IvySpell6288', 'MarinaHeart6913',
                     'SepidehTomato6649', 'EmeryKnight8695', 'MinaWind3978', 'ValeriaSapphire2947',
                     'BarboraMetallic9848', 'SigridCantaloupe6438', 'MidoriGray6455', 'AikoYellow4992',
                     'AnastasiaWitch7927', 'AikoKnight0798', 'KiraNinja4781', 'SofiaOwl3677', 'LinneaSiren0795',
                     'MarinaHunter0506', 'WarriorMahogany6240', 'SeoyeonApricot2015', 'MabelDancer4795',
                     'YanaraHeart8469', 'DvaSlate5500', 'DianaIvory3021', 'AkalaBlue9898', 'OlgaWolf9650',
                     'MarinaPurple9880', 'MeiCantaloupe4290', 'OlgaTeal7000', 'MarijaGreen8017', 'CalliopeChartreu6643',
                     'LindaForge8277', 'KaiaOrange2947', 'HazelTomato5779', 'KenyaOwl7483', 'DorothyValkyrie0368',
                     'EliseFlame8199', 'EunjiAubergine4108', 'BrittaDye8026', 'MiriamTerra7323', 'SaritaTeal1852',
                     'HanaHunter5639', 'IreneSteel2378', 'EsraBurnt8772', 'CarmenRider3337', 'HyejinMaroon5591',
                     'IndigoRust6441', 'SigridFang8376', 'FarahTomato6869', 'NeaStrike8698', 'SofieSpirit6104',
                     'YanaraArcher3646', 'AvaHuntress4791', 'JasmineMaiden4501', 'SkyWolf7110', 'EdenHawk2795',
                     'AnastasiaPhantom6186', 'LailaSpirit2747', 'JarrahBurnt3500', 'SakuraNinja3625', 'HazelNavy6031',
                     'LunaVermilion6984', 'MarijaFlame1901', 'LeahBlaze5188', 'LucijaBlaze0033', 'AstridAquamarine5260',
                     'CelesteGold6665', 'DaisyRoyal2756', 'NiamhArcher4435', 'CamilaBurgundy1816',
                     'BrielleEggplant1096', 'AinoMauve5293', 'MargritChartreus7254', 'SvetlanaMetallic6118',
                     'FaithTiger8369', 'ChayaPhantom1092', 'LindaGoddess1740', 'HanaHawk0408', 'AkalaSpell4162',
                     'WarriorQueen9407', 'HildaArrow4436', 'LyraBlade1375', 'NoongarWine7565', 'NoongarSiren3193',
                     'BraveArcher4866', 'MarketaBlaze5878', 'AlinaSpirit3851', 'EkaterinaWeaver9318', 'AmaraPowder6438',
                     'MinaAubergine6914', 'AkalaWind3458', 'EmeraldWolf5983', 'HuiKnight3151', 'NinaTangerine2357',
                     'OfeliaBlaze6253', 'JarrahMaroon2185', 'KealohaGreen1751', 'LeaTan5945', 'FrancescaNinja0838',
                     'YanaraWeaver4041', 'NiaBlade4417', 'MakedaPeriwinkle0073', 'AntoniaHunter0804',
                     'ElinaMahogany4080', 'HecateViper5597', 'LinneaWolf2848', 'BeatrizCopper3591', 'OfeliaApricot1066',
                     'AbigailSalmon5495', 'AnnaHeart3655', 'LisaPrincess9302', 'JieunReaper2130', 'MiaWitch6518',
                     'LaylaArcher7820', 'JuniperSalmon5852', 'AnnekeValkyrie6571', 'AugustaWind8506', 'MariyaGreen8621',
                     'MarianaValkyrie0252', 'JovanaCobalt8060', 'NeaHunter1283', 'LindaBlush1063', 'CelesteBlue3385',
                     'VictorySpell5124', 'AoifeHuntress8489', 'LiisaNinja9615', 'AbigailMaiden6851',
                     'AlicePrincess3061', 'IrinaForest6944', 'KianaBurgundy8381', 'IrisMetallic0620', 'UrsulaBrown3891',
                     'HelgaElectric3363', 'EliskaRoyal9500', 'MihaelaReaper6354', 'DeryaTurquoise0215',
                     'ValeriaNavy6719', 'AoifeOrange2235', 'MedeaRider2506', 'IoanaBlaze1493', 'SarahKnight1933',
                     'MilaPowder0217', 'CalliopeOwl7995', 'AzadehBlaze0505', 'MargritTangerine9489',
                     'SvetlanaNinja8080', 'LuanaDusty6795', 'JovanaArrow5722', 'TamsinSalmon5434', 'JulietteHawk1694',
                     'IndigoWolf5861', 'HermioneBolt2185', 'SvetlanaRider3605', 'SusanDark4811', 'DvaNinja7253',
                     'HalaArrow2576', 'PenelopeTeal5360', 'AislingReaper4707', 'CarmenAquamarine5990',
                     'MargritArctic8106', 'NoorSteel3001', 'DeirdreCerulean3443', 'SigridTerra3809', 'EvaMustard2385',
                     'SaraMaiden2389', 'MakedaKnight2540', 'FreyaBlade4016', 'NoongarCotta5986', 'AgnieszkaFang6108',
                     'MargritMage7076', 'MarketaLavender8553', 'DeepaMage5065', 'GretaSpell3152', 'MartinaFang9374',
                     'LingJade3039', 'RoseElectric6559', 'HarperDark8084', 'JovanaElectric8333', 'DeirdreOchre4385',
                     'ZofiaOwl5702', 'NaomiSpell7307', 'JuliaCopper6382', 'HannahForge8184', 'DeirdreOlive1294',
                     'ElsaOwl3786'}
local RECEIVER_LIST = {'KianaTerracotta1969', 'LuanaKnight8042', 'KaisaScarlet1067', 'DottyElectric4778',
                       'IoanaCobalt5467', 'LinneaMetallic9219', 'AkalaPhantom4401', 'RoisinForge6453',
                       'AlexandraSpirit5312', 'YukiWolf6435', 'LeilaSpirit9573', 'AmiraAubergine0415',
                       'DeepaHuntress7008', 'LeahWind5034', 'FemkeGreen0697', 'JulietteMaiden4550', 'SkyPurple8349',
                       'NiaSapphire5013', 'EunjiChartreuse2990', 'EliseSpirit0721', 'NasrinVixen6092',
                       'FrancescaCopper5400', 'DaphneMaiden2272', 'AriadneMustard8530', 'JaneBuff4095',
                       'RinGoddess7102', 'SaritaSpell6715', 'LalehRoyal1896', 'JiaTomato1473', 'GizemPink4624',
                       'BrittaQueen4231', 'JinahTan9427', 'NinaMauve1407', 'SamiraChartreuse9796', 'PearlWolf1611',
                       'WillowElectric6986', 'MagdalenaArcher9657', 'ElenaMaroon4718', 'BrittaOlive5173',
                       'VictoryGoldenrod2246', 'FreyaBlue4256', 'YoonahGoldenrod7345', 'RiverHeart9421',
                       'DaisyWeaver9040', 'GizemMint3674', 'AishaCrimson8660', 'MaryHoney0915', 'LeilaHunter9775',
                       'ElenaAquamarine2970', 'KealohaMauve4827'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
