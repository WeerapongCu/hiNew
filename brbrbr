-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'Mohibglodt6497', 'Hamojahns094', 'Reglihuai6895', 'Magicgarbo025', 'Dukgloss88701',
                     'Randoshadd6807', 'Ayonagey4127', 'Demiswoldu0730', 'Alwesramlo297', 'Purerolo184',
                     'Neliyagi99964', 'Liubhura706', 'Sessahiley988', 'Loudyosol244', 'Vronavivo04270', 'Illgsiann689',
                     'Kuhlesly8457', 'Wiantediva0921', 'Weigdalme5783', 'Duschlajoy975', 'Mikesmasie1004',
                     'Dreadhoepf024', 'Acaliosif81098', 'Tjongdien25862', 'Sehytavon130', 'Beirdzelle79558',
                     'Takertolan3828', 'Yossheiby77936', 'Makuafra4154', 'Panakizu847', 'Useygili4223',
                     'Arpkegirt40433', 'Huaivargo791', 'Taniathy7605', 'Rainesmiht96139', 'Twucarne970',
                     'Kaoudhuiet08622', 'Oxxhird6970', 'Roleykerk4193', 'Boteoszuch800', 'Glowadoes966', 'Danbyliff611',
                     'Freregout880', 'Foodyholum96420', 'Windymajka7265', 'Merklzyra44973', 'Nikropel3079',
                     'Kebercools5035', 'Thonstroy5848', 'Tiggprus5384', 'Swonsakry3419', 'Neveskantz8944',
                     'Ignatjenni98493', 'Schobcazar99138', 'Kuehlker55352', 'Nassrbasi71478', 'Swickquon1204',
                     'Auzatdukes47925', 'Damaslohse6389', 'Faaizlachu375', 'Fuelltraft1796', 'Wickeemmer0982',
                     'Crisimango93202', 'Yappzinke02487', 'Azraaizzi0074', 'Saargogna8187', 'Daudagure995',
                     'Euranazam569', 'Ameddarey7656', 'Paatperky57378', 'Lanigdance966', 'Bibaracek695',
                     'Leitluhles872', 'Dagongenes15563', 'Lardelk54704', 'Macacurth638', 'Knorrklee06257',
                     'Fingboim774', 'Sifrepeal86539', 'Linede994', 'Klaftlautz361', 'Metaras3993', 'Hilmiavila682',
                     'Huttkubin74722', 'Mouseirr4505', 'Zebmonde391', 'Gobahkats14701', 'Haynebanno4816',
                     'Crayrhom6077', 'Manzchupp673', 'Kretzsakyi834', 'Bovisdeany6913', 'Kaeapedri8818',
                     'Cihonkozak1082', 'Kruiswurm1254', 'Pleisnoel2639', 'Nyrecahn902', 'Lexerburon03549',
                     'Zarinmuaaz267', 'Machotache1352', 'Dubealucks45475', 'Viltzteman55576', 'Lappekobee97873',
                     'Gerawung8613', 'Nazonshaji5572', 'Maddasanko482', 'Wylyfiss2210', 'Mudgefrits5988',
                     'Nielltyran515', 'Frakeyakow614', 'Leggmatsu74279', 'Moyaocesur9687', 'Dazenbiel1133',
                     'Vidranutty862', 'Phomyik456', 'Chidikorp579', 'Winzyanik17517', 'Patalvelk180', 'Rohlkseele84309',
                     'Quitohoxit878', 'Polekcalle790', 'Yettsayoc0658', 'Knezkanyo888', 'Trubyabero1095',
                     'Rivalriede681', 'Suehsgorum5004', 'Finanduche7493', 'Hakanrondy2943', 'Siryhelen789',
                     'Disenribau18727', 'Borjebierd4784', 'Stoopsario035', 'Bylercerce6095', 'Brienbendy89587',
                     'Greilkaw534', 'Khimhuser8971', 'Hrybpokoj95656', 'Sulubawais45560', 'Harjomaake6785',
                     'Aspinabnet769', 'Wachssypek86644', 'Kielbgelso5566', 'Kaifgeise65738', 'Tuzzohsiao658',
                     'Mirabmor6710', 'Dubaysyal61960', 'Gianiduchi012', 'Zakidural5026', 'Kolarclore558',
                     'Clubszunun73062', 'Dahraun84942', 'Saxonblehm1236', 'Hoilesnoke8628', 'Ruwecryor26916',
                     'Yegalaila6505', 'Geantieng436', 'Zawlamp417', 'Bonotamir364', 'Parliehst8492', 'Katoasamu95690',
                     'Desysaini198', 'Mozercoine67830', 'Vigarklaff84225', 'Retkarabot8245', 'Sakhiwuu157',
                     'Fykecazun716', 'Latifseran681', 'Sherradin381', 'Heukopp35923', 'Fiestabare27829',
                     'Duriktat69213', 'Batoniheu388', 'Eddazader096', 'Ogutufagen137', 'Azermacy4802', 'Zeoliglean659',
                     'Klarklak308', 'Peskojorae54684', 'Surdisyslo9223', 'Edgyahern62232', 'Tauleselep21382',
                     'Agardtareq032', 'Staupxin12164', 'Mezykarlt634', 'Borsoshyr808', 'Chitkorr729', 'Heiketeune727',
                     'Sphonlopo98030', 'Comiselsik712', 'Hasekrhan315', 'Karrhmegia2136', 'Arwamelve7066',
                     'Njaumosk112', 'Dighciary086', 'Kloftseijo027', 'Neliavink023', 'Prochcobbs817', 'Raehlaebi124',
                     'Harooquin226', 'Gereglemak4071', 'Fuschliboy4316', 'Yeshshaba57929', 'Bhalkors9965',
                     'Loyerherma512', 'Niedprata10468', 'Daschruch936', 'Jacehiar0969', 'Ledaysesso33665',
                     'Molesprom07138', 'Drnekidan556', 'Mohnsaarna700', 'Agrazalfi98061', 'Vagtjee8507',
                     'Pelyoholub564', 'Sayenlymon755', 'Labaycurci68198', 'Taibaiorg585', 'Ioneflees29897',
                     'Yaldolutch413', 'Aloufthon4676', 'Shorbayda267', 'Jeunleura073', 'Kendasigl7873', 'Kliszahrt523',
                     'Doodyjudd262', 'Velozkozy735', 'Butzkue2160', 'Nimribaho668', 'Candycorts0457', 'Druckdavid94347',
                     'Loewremen06665', 'Azariconni635', 'Vlksaafi687', 'Ahalthivda0140', 'Elowkunda074', 'Neeijams5883',
                     'Noyloveh0050', 'Birgymats5977', 'Laderseif5068', 'Deluesmout3980', 'Yungrough92386',
                     'Sazoawalt01289', 'Tontiwomen199', 'Hanaeanhar902', 'Seifzeeb75643', 'Fuadstofa2137',
                     'Cyndethoms676', 'Zigobierd98315', 'Demizock94012', 'Clowpepi451', 'Wymabusek710',
                     'Shegadahen9414', 'Kneensoli821', 'Slyghanja9766', 'Atarkawa31393', 'Caumengle481',
                     'Vokalarva70308', 'Fotisacorn19465', 'Boogcepak9128', 'Duaajuett675', 'Wylerghent8702',
                     'Malenfahle01202', 'Courylarey12697', 'Inezzollo661', 'Mittleager14872', 'Nunobeja473',
                     'Neadokuda61049', 'Baseyzhou93417', 'Arguebrabb306', 'Shaibgeran74078', 'Ubinaayda7398',
                     'Bruhyam740', 'Mettyfiery442', 'Koperthi74090', 'Ehnisvoron68806', 'Tweteayush456',
                     'Ruperneeds539', 'Emantopia6268', 'Guskifurin808', 'Espstude014', 'Galtmeyle24609', 'Ornskozer961',
                     'Beebetome624', 'Sedeytorie9074', 'Bagisamin0168', 'Wennmagit40307', 'Serpasaavi487',
                     'Tetrogerdt4127', 'Rohaldolch97594', 'Smokeaytes8254', 'Htdgeza64385', 'Abairdacre73430',
                     'Rahiriale4603', 'Aqilpath155', 'Moorekuhn66878', 'Zubeksilmi26726', 'Hasseanjum997',
                     'Hylarhino515', 'Boadumurat4826', 'Yannarhan50026', 'Buraupagac942', 'Fodymalky9214',
                     'Zoltyminto141', 'Flosilepri1719', 'Neakwalts26728', 'Passigreta342', 'Elixvalin86592',
                     'Kirahmoure1751', 'Tostmalfa961', 'Kaiersreng33046', 'Nilanchik472', 'Swetaelody7114',
                     'Steoshou162', 'Billonayah63082', 'Mashaxley305', 'Seumedery5369', 'Gutinevo262', 'Kadorbain97117',
                     'Tayibgrems10945', 'Abuegnippe12255', 'Rinkdewar7043', 'Areebselko653', 'Uresmapp5151',
                     'Geisrinne5995', 'Lancyneie67868', 'Eldoneckis3575', 'Tayebodum7961', 'Perowmood8709',
                     'Pischcarek07678', 'Morbytheal9462', 'Sosnathabo360', 'Delatutaj00943', 'Boskeeike8050',
                     'Kearaiba371', 'Knaufkobes4035', 'Cabajplein77405', 'Cosioboel78173', 'Faglelagge0899',
                     'Gengeerny937', 'Wiesstarpy568', 'Hulswaste06701', 'Zintzboose3268', 'Hauridegel13042',
                     'Ruscabaken10008', 'Oganpelen6066', 'Mounamuras330', 'Beglekauwe831', 'Gyiannie237',
                     'Kindlyeend3302', 'Revermacik0480', 'Desonbarko0073', 'Fillalall6338', 'Faessotak485',
                     'Svedachuca528', 'Favorkeyte016', 'Kouglzedek5726', 'Cuffypauk55183', 'Trimfaile531',
                     'Zackskanoy315', 'Hajapapay42428', 'Ersoyowes67836', 'Greeparie2808', 'Dullehobbs128',
                     'Payeaubina5277', 'Ritzekolan67945', 'Aveerwarfa3109', 'Technytes11542', 'Feherflyn3662',
                     'Lairyhirsi507', 'Jamanpitz63333', 'Sabonsifre46347', 'Maszkgitty0231', 'Luledex192',
                     'Exumeikram519', 'Klarucci92130', 'Kopetfolsy36308', 'Antolbort84288', 'Nedabuman17105',
                     'Lamiscasi289', 'Swenyuna2166', 'Hiartyrus733', 'Naultsauk7442', 'Nodekoros255', 'Fusyom226',
                     'Hougattai5383', 'Wlachsheek2711', 'Ajusrobba204', 'Feighbubon6824', 'Dooptorr3119',
                     'Leylateah2275', 'Nusommotko283', 'Yerbychap7700', 'Moyetficks224', 'Limeamin81612', 'Zawmas835',
                     'Hirnraaen38569', 'Saekiexton4857', 'Kinntorma2020', 'Yasirowca471', 'Husicdark6294',
                     'Gossetauer34761', 'Meranleea0768', 'Earbydomec961', 'Beulpinks0015', 'Argusvispy9012',
                     'Tarttbila926', 'Alarikelly655', 'Zohnnutz47528', 'Artisgina101', 'Donahfay9909', 'Shorrner44167',
                     'Yandodata2315', 'Joonkaml1842', 'Tunikkaide79999', 'Inksredig7267', 'Duramusry830',
                     'Lariorui38371', 'Baroskomo33209', 'Aframgoes631', 'Wickbrune5548', 'Talhapass680', 'Nahibooz7506',
                     'Hasimpira1434', 'Haykovliem86241', 'Javarkrot302', 'Muharweeth6661', 'Mondsmany6739',
                     'Hippsmonot6639', 'Allorkille78277', 'Diakgalik5535', 'Mabeskaf3051', 'Ojaamadu1379',
                     'Brettdanz7864', 'Zunghonma016', 'Ocejobonny9938', 'Ryghaksu6973', 'Mumyronja19996',
                     'Melerclive277', 'Kuceramuso4640', 'Ispaspajor24087', 'Gagoimme17879', 'Lanaspeyer648',
                     'Klukakare1703', 'Sidhuhamey403', 'Amitplock4960', 'Braueoatts81592', 'Barndglode4631',
                     'Lurchmingo95396', 'Berndvocu48718', 'Rawalkirma31517', 'Funeskeson96747', 'Vovakfehr254',
                     'Honedrda9630', 'Geyevirdi56815', 'Tynondija56565', 'Wafifujan220', 'Peuravanga7100',
                     'Granephend2785', 'Lambejoos49037', 'Vuonoweyh759', 'Rohdestyve4386', 'Spetttowns3109',
                     'Mirometer82759', 'Speetzybia7770', 'Perchjacki366', 'Jonifan16295', 'Aldismuss26421',
                     'Howeyamobi200', 'Haggydevin7867', 'Ruthspaur0398', 'Amiechown7867', 'Baanimuon58439',
                     'Bobesemih612', 'Urishzacha9579', 'Lyciadatha1399', 'Kemptkirn86885', 'Nylaihrke066',
                     'Cohonalvey40921', 'Lagoaeyo05547', 'Cajasfarst873', 'Schoprhein0245', 'Iozzocrans38668',
                     'Coullklitz9438', 'Bruntedda9836', 'Farmsfrare736', 'Kiuzamil9638', 'Sontibiair40619',
                     'Beukeacer30593', 'Aatifmicko624', 'Tamraallor571', 'Dohmsfosha6152', 'Broudumon100',
                     'Peerstred4538', 'Hasanesaw63458', 'Oyossanes98643', 'Medelcamey4651', 'Reehkocaj5151',
                     'Haimzhane9655', 'Kluglawn872', 'Posisever891', 'Maneysiems59042', 'Larepump7050',
                     'Rheaalfeo76491', 'Fulkijff6566', 'Proemurty107', 'Lukesruan351', 'Hugierule328', 'Dueaboll9909',
                     'Aurakarro4943', 'Rinksbunao185', 'Tegelzevin1267', 'Freilniosi95119', 'Kreyeesmi33121',
                     'Baysvanek2572', 'Patiholem221', 'Zappimabra876', 'Heiliasrat4251', 'Kaszaaleia1408',
                     'Ekernrathi027', 'Selboslote60758', 'Orrechike1581', 'Vitotasch13684', 'Canneleh3664',
                     'Kesicmuino410', 'Ebuenaites249', 'Culycobo013', 'Hapesgier341', 'Launatang5094',
                     'Sabalzurin91750', 'Cloezagar07603', 'Jourysteff2268', 'Sekgoyen230', 'Kolygracy8937',
                     'Razgraza2532', 'Bilistoff79163', 'Finanebach39662', 'Rederdamil6616', 'Colaoziek8681',
                     'Montoilo30899', 'Madyyugan690', 'Paddygoth0072', 'Gillnarva9647', 'Wakihoude7938',
                     'Ibachyoro0002', 'Saaimapon8220', 'Borertonks61289', 'Pavikagoro8939', 'Kobeypaule739',
                     'Oliynate99145', 'Sterblest74245', 'Zuluvetor49456', 'Oedermosch106', 'Prughoyola728',
                     'Udehzhu408', 'Erthaedger4474', 'Wylamtoof31627', 'Mirohiten60860', 'Holupheeth804',
                     'Hespekmec08490', 'Otvoscurey56917', 'Kaseynet0366', 'Parrakatja212', 'Sanzadanby7739',
                     'Delayens49034', 'Essemimes905', 'Nesinguha602', 'Dubovheads1978', 'Yanisplahn26851',
                     'Caibonan554', 'Rugozim987', 'Jurcameleo242', 'Haerrnip5555', 'Gianolauch437', 'Teenmirta13805',
                     'Papajfaina6339', 'Wrothkjar71155', 'Deakridl8813', 'Goanskoty278', 'Yonahgleed814',
                     'Rudekkatje644', 'Mazzekoele74809', 'Eisssong41257', 'Myreecocom779', 'Sanghkox510',
                     'Procksiva56914', 'Kuhrhinde938', 'Eskerhaft350', 'Kimpnorko79305', 'Timkefai493',
                     'Astenmann85962', 'Ruhmhelka59170', 'Damlelato881', 'Poachber4703', 'Koracutley2067',
                     'Korrabocks5430', 'Wharymilke5941', 'Taalaadina7550', 'Ferlocoren681', 'Mensimayak935',
                     'Ziffchas034', 'Klesskozal36312', 'Anichromfo243', 'Rutsrugg0365', 'Hurdtbirge0941',
                     'Ismetberd0289', 'Hespeyando9367', 'Dyasnobre5354', 'Sumpshuo313', 'Conahbrey591',
                     'Dugrekaupu49526', 'Riccubel8374', 'Pincleang46433', 'Delmystoch10188', 'Kiesargon553',
                     'Banabouer196', 'Annnihan367', 'Regelkamae2669', 'Fedaknies5834', 'Leijajary233',
                     'Kutisprell21934', 'Acheecreo44753', 'Rahimtawny9793', 'Vibaralbe62696', 'Spottpolny3530',
                     'Rinkeullah394', 'Marcunikac94780', 'Exnerbega1442', 'Finnikamka78343', 'Lottstrala5703',
                     'Frostsekas6197', 'Umohseven384', 'Dealeiss9831', 'Bizektraux68597', 'Loreilahi4597',
                     'Gambyknee70002', 'Anzurkate671', 'Joelmoews50005', 'Plamroz56710', 'Bruhlchase7091',
                     'Ellepoet040', 'Meidalucy88848', 'Saizajes476', 'Solerviel3116', 'Wadasmajid49516',
                     'Nehezalnas055', 'Hilemano05198', 'Gaudiweldy82828', 'Ordaswale3246', 'Dediokorin7541',
                     'Moatzjopek184', 'Rorexijaz503', 'Ronsbald6910', 'Phiadavda0610', 'Sargohsiao2801',
                     'Depotneff7245', 'Jounghanif12125', 'Dziakrhyse5778', 'Rearyduga708', 'Forrynama3679',
                     'Phylnuria367', 'Ahsanstehn70461', 'Anoopfitts4027', 'Lynemchima4563', 'Srunsteib715',
                     'Hahnrenko194', 'Geyeneber0329', 'Kureypisco04963', 'Bendtatum943', 'Cencicansu00124',
                     'Ayedibad54548', 'Zemonchue513', 'Belawehba856', 'Duclorond833', 'Mezamoini189', 'Kortatully292',
                     'Minkoleah8826', 'Jakubknerr72865', 'Saideormes90948', 'Sanaebordy13037', 'Perlemolle788',
                     'Kerrydanna517', 'Wellsjamin1722', 'Madeanusom763', 'Sekersial649', 'Samaskahut7815',
                     'Sidorstudy9887', 'Cainsewy671', 'Akolasid0806', 'Fleurlebon4092', 'Blomkolk93638',
                     'Moixweith0325', 'Roggepalla76672', 'Duclomowl6512', 'Lengjarr95293', 'Cappakelau24364',
                     'Kossegrum408', 'Nerteyeliz8245', 'Jovijaks102', 'Gappgauld60267', 'Perlhiram1007',
                     'Zemkobixby6463', 'Monilerow53310', 'Quibaaraj02123', 'Dortayoske843', 'Ryaanbudds914',
                     'Cossepalan9906', 'Badjigretz4256', 'Alfeorays39409', 'Hamnclue38746', 'Kholablean14972',
                     'Inguiglen22446', 'Heangkiehn34866', 'Prinameale522', 'Osellwaner4232', 'Tsaumunk1301',
                     'Jabekicks4974', 'Muhldomby639', 'Fucaanno491', 'Lugosicart3678', 'Issamegle1520',
                     'Vontzremer9713', 'Goleskmett087', 'Mushihinna35141', 'Stromreyez0725', 'Loweogara821',
                     'Cuseoherak79024', 'Ermijacey73989', 'Czyszboal98451', 'Renzodikun9489', 'Wenkedaka775',
                     'Hyzypuppo49491', 'Winksnofs2719', 'Picotdjuna9864', 'Dakansnair0681', 'Bescharnow56410',
                     'Faltzmegan91938', 'Leducquier801', 'Pascoruyle08380', 'Motinrunte2633', 'Pelkypahwa92838',
                     'Ilyesbleem6059', 'Owuorvige752', 'Rickycarle72362', 'Leihamond081', 'Sookolaso22819',
                     'Dubeyafful7742', 'Vausebaar6943', 'Tomonyauk4611', 'Kannepapka2813', 'Juelohe480',
                     'Geickburum110', 'Dorsiorne7711', 'Sukelkeam777', 'Inskozuech89584', 'Baneberly45748',
                     'Asarmilas83269', 'Nazonginez95729', 'Pyferspude373', 'Themnusz291', 'Kmetzeljay1724',
                     'Niamcomer8652', 'Knustisoft3375', 'Zengmagno194', 'Nurayhord777', 'Mrawcornn32199',
                     'Ruweverma82356', 'Bekogobah449', 'Loveyvira954', 'Michtacia428', 'Boynetatge6305',
                     'Novinkneer2637', 'Rohmbelo99761', 'Pleetcobyn18666', 'Buddatann44083', 'Bekizumi022',
                     'Scheiittel611', 'Kouglteach380', 'Upahwhye411', 'Raffonuce056', 'Yodistyan8296', 'Rudharyan688',
                     'Rassonyre7583', 'Rizornosky23178', 'Gerrymcfoy53479', 'Deyondynda507', 'Beckedakan89770',
                     'Ribaonodar1000', 'Dinhmahay38886', 'Mauropratl976', 'Hasansalle429', 'Pestabaule4852',
                     'Trojebian25041', 'Denimkutlu54842', 'Treetorna499', 'Pheakusz30039', 'Fantimuray119',
                     'Paolobrumm366', 'Tredoarbon3693', 'Kurraibad7100', 'Baunedalal305', 'Toughvejil4788',
                     'Erbevah72745', 'Zulloyordy8105', 'Pirarviz13116', 'Dakshferra9559', 'Wlochpipp806', 'Laliksik995',
                     'Quaryzhuo921', 'Dakosanmol7402', 'Polecepas7956', 'Hurnileidy6245', 'Suitsaldi887',
                     'Sirkobelda94177', 'Washglori785', 'Harznejat457', 'Ikenhayaa27645', 'Tahumayak300',
                     'Kundabanty457', 'Gloeraese70338', 'Rehaldater61577', 'Timosivan0811', 'Coloppanka65451',
                     'Zippoforma40151', 'Meynfeary2872', 'Penkepahel3107', 'Weithkess59910', 'Azuawehri0336',
                     'Elzacheon118', 'Verthoit452', 'Plahszanke695', 'Nitemyrup8906', 'Knokeobry036', 'Listoenid97185',
                     'Vandearona4301', 'Follibby620', 'Nowerboma2387', 'Lessmayta274', 'Inosmaii941', 'Jiangdail459',
                     'Taamubisla00525', 'Hindyfrnka462', 'Masadoing510', 'Slosswolf133', 'Franebuder96993',
                     'Magengorla61083', 'Lovjih7681', 'Bovayimlay3706', 'Erberbill41101', 'Rzepasnead143',
                     'Pirkldanie44121', 'Toddvint788', 'Soardsanav785', 'Shireazab38039', 'Bitahkoffi882',
                     'Abaypecue7853', 'Sedatdizio786', 'Raynecara1844', 'Tarihosek990', 'Raylsnosek61854',
                     'Loyaduric40976', 'Snarrdupuy28459', 'Kindyhein408', 'Roseyorsag7426', 'Shideramic97980',
                     'Clockcorba070', 'Walkauken988', 'Mehaksiek42744', 'Hantzhsin102', 'Solkanwogu40699',
                     'Frammenas995', 'Dollyflirt4951', 'Akimaarvoy5032', 'Kalodiar9003', 'Roddakadas49922',
                     'Sampymeitl4136', 'Daftlolli597', 'Vianminko1345', 'Kodatwyles483', 'Shuckcaris533',
                     'Maundsale3747', 'Simoloter152', 'Basaarkin160', 'Pereylayer626', 'Megothamm7476',
                     'Touhybild66128', 'Vizepaur26073', 'Ulloachiao4899', 'Wagarfeary8209', 'Sutkogroup7420',
                     'Osiocupo6059', 'Jubbcroal2774', 'Werrysones497', 'Diersheang588', 'Stinnfrenz475',
                     'Geitzpfaff474', 'Rousdupon4255', 'Khloehed12495', 'Ukomckew171', 'Ivensisgro1668',
                     'Memissaito72289', 'Vidadollie58187', 'Cominkwek7674', 'Gaffhursh405', 'Niellpuig93377',
                     'Fazelozgur942', 'Roskyfizer209', 'Jasolina95414', 'Vopatavani0777', 'Gunnshegna941',
                     'Tolinmais6794', 'Samekjedd685', 'Clegghould6096', 'Byngjagat02007', 'Graeslava1330',
                     'Kyzerice4308', 'Melihseta464', 'Sendtsui03646', 'Sensesiuda3421', 'Bethaindy669', 'Farekkoger334',
                     'Safahtylus1310', 'Riggcirri6247', 'Maryhymer76433', 'Kacinlinet483', 'Klamswart4663',
                     'Ancasilar3295', 'Khemsedon03807', 'Aualatibbs8863', 'Zettlyoes5274', 'Missyattie6674',
                     'Aricaknips005', 'Cavochope7301', 'Colfheyob8245', 'Kaiusenric111', 'Heendries319',
                     'Fulcebahry51929', 'Kolveolup869', 'Beziooggs54171', 'Abdouwhyel971', 'Rogorawan23709',
                     'Meeresept87275', 'Olexasae271', 'Coojiana80118', 'Feliszabek2428', 'Hefticausa1723',
                     'Vailedevot551', 'Lasseeveld35803', 'Lencifleet97686', 'Yunfesto0161', 'Hovdecornn15508',
                     'Munohelou053', 'Remerwicks119', 'Kishathome6466', 'Teboderge018', 'Gamonshoe23440',
                     'Pirchbonds44664', 'Heyskahr560', 'Guraykicks083', 'Hupflouka59237', 'Geresinga913',
                     'Hohdelos5218', 'Parathoven44399', 'Falulueb4099', 'Asselagor8955', 'Levacfly687',
                     'Solumniyat72569', 'Breigsepp0487', 'Davanaurit27400', 'Dorchkovan91096', 'Ognoboche230',
                     'Kiteviehe53460', 'Buriaagwu224', 'Klinkhake99690', 'Welchgey881', 'Wurlweden04718',
                     'Kahenjehle9976', 'Shooptiao95378', 'Payearash829', 'Glowemachi0531', 'Hoeveamper83513',
                     'Allantable629', 'Abdinnorm38481', 'Loshsusca0716', 'Clahkubli301', 'Damusamao2770',
                     'Eureklubag7496', 'Bekodamon791', 'Guillnofer772', 'Eungkawa60497', 'Bowecolyn133', 'Yirgapapo584',
                     'Pessokatte8501', 'Kevodjoof658', 'Verchmaino046', 'Kwikbeitz4079', 'Greisveta759',
                     'Oguinrepta328', 'Pyonpuga3873', 'Portohegna80129', 'Zakstomer77463', 'Vieheler137',
                     'Stamtimko868', 'Flinniding33153', 'Sortomal755', 'Zeldefromm359', 'Toneysilas6166',
                     'Youkzahl50226', 'Goundkemal3436', 'Bessanewey053', 'Vimieick023', 'Lexyilar79699',
                     'Speeruriza984', 'Tolvebrush3163', 'Halasgolke381', 'Scarpshan69499', 'Ekersner6688',
                     'Tapkerehms8597', 'Papabidon4801', 'Lesonfollo239', 'Arlyjunot24771', 'Oyugiregg420',
                     'Canupsmyk373', 'Teeceopfer160', 'Romfonaher5214', 'Bedkesonge72074', 'Leraromag69395',
                     'Ormelatza454', 'Regasamah26814', 'Hagelweish550', 'Singhholes802', 'Duftybaute17409',
                     'Mairirodr86158', 'Caseyula75107', 'Haninvotaw9331', 'Nowglaub7649', 'Rurakmacal16554',
                     'Seatsdeio702', 'Cubiecarte65099', 'Rabiepoehl3529', 'Meiletapke7130', 'Elsylukic31342',
                     'Lucioaberg66764', 'Kathelily422', 'Kizereshel324', 'Paydarsi511', 'Eagarbalke24644',
                     'Barekose47100', 'Celikkaci2929', 'Erenaonaka391', 'Zallmahal8643', 'Ohamanorby2006',
                     'Irlequire9392', 'Alasweist01254', 'Kamarzagen5003', 'Nyxviani3836', 'Sadekclase04700',
                     'Masospade4819', 'Cicekesco30867', 'Kisorfermo8320', 'Konenehra586', 'Prufecht536',
                     'Fylessliz8736', 'Lasonoh25845', 'Pillomeric415', 'Autosiner00094', 'Basernavin908',
                     'Hadjilotto05745', 'Suprymoli397', 'Zygslife7878', 'Bellsnibbe102', 'Alkenhaase826',
                     'Chaelliso5775', 'Salembails9876', 'Affulenno571', 'Osianwedge518', 'Toewsmaxin3519',
                     'Indkraft67717', 'Arohismrt5986', 'Mentzgarro97474', 'Sufkaemina92599', 'Deaucepek16246',
                     'Goliatjay133', 'Tallegains76602', 'Gaununwin950', 'Kounsviqar0493', 'Lasakcarli445',
                     'Golkfigus378', 'Lulinerte094', 'Loosogrin11229', 'Aivacodd82963', 'Pultsrolo9276',
                     'Kohenpardy8578', 'Gindtluby66249', 'Amissmaat877', 'Ovenazrak60204', 'Popkooppe4879',
                     'Kleynmazzo7005', 'Voiethole49419', 'Bisekgeno00465', 'Cubietira54332', 'Loozeziehm01723',
                     'Bujanrohe5020', 'Moloknull7571', 'Dadonorat4624', 'Wittedudra196', 'Weigtabma06909',
                     'Kuhslussi067', 'Puakalm414', 'Paschubel4810', 'Alyzamatej380', 'Buccrovo285', 'Skopmclin280',
                     'Lassoisik858', 'Gobahpflum40740', 'Ugwuduvic32634', 'Douboady73091', 'Rogusumlah60972',
                     'Flaggugne27338', 'Robynvais5911', 'Lodlverla066', 'Hamiclory3534', 'Bondouways074',
                     'Bayetally24216', 'Judevoeks507', 'Leysrippy5492', 'Eundetor39117', 'Tweitlokey3177', 'Cielzim063',
                     'Frumreola57033', 'Odenszolli6916', 'Tuiipsen47823', 'Miakoh85168', 'Geibaca86337',
                     'Listaveas19493', 'Tregoharju848', 'Kostogenga8713', 'Sleadbluth70181', 'Augernolau6603',
                     'Tatelblash7119', 'Semmherak65245', 'Kathyhavin0432', 'Sobusumama8738', 'Nejiabode99365',
                     'Ghostyafai35038', 'Elkokruhm7742', 'Cirkavatne02646', 'Ullumthing801', 'Sialoriel647',
                     'Coadaingo156', 'Oshryliang3884', 'Sopppeno4004', 'Fogaodham065', 'Turyyoes97379', 'Tomimrily0531',
                     'Roeuntwite8386', 'Sunniepper5815', 'Shultbobb177', 'Newthpadlo2242', 'Ninkanema304',
                     'Swammpryer035', 'Livatari472', 'Crilejohl62609', 'Soperluton4759', 'Rivieayvar5271',
                     'Suskicroal27403', 'Mutecoull741', 'Galowegans74443', 'Ynezhasey284', 'Iblekylan905',
                     'Karraorbon63765', 'Zwiersirna687', 'Kraakgoelz715', 'Zirkcoada724', 'Hogerilten9193',
                     'Vardybuley592', 'Mladynerty053', 'Palenranz54376', 'Gatzmixen377', 'Kolaksedy736',
                     'Srsenhuiet499', 'Hugmiron566', 'Eckellafoy9716', 'Eangskjei91470', 'Slossehren5939',
                     'Sidunrocle53310', 'Prinetoa757', 'Kaankabba49453', 'Mossanarus188', 'Duhrfyten670',
                     'Klepshuset0406', 'Ennesdasho45356', 'Fetuinwe7376', 'Geanjaxx56797', 'Rafdiwan0517',
                     'Peacharemu985', 'Festmazac81604', 'Lagomeram1352', 'Eskewfallo4582', 'Feuzrubye2585',
                     'Jutteibert961', 'Powalbreno1598', 'Krisrafn1345', 'Tamirfoody58574', 'Giovekjaer7390',
                     'Kupkegayer5544', 'Sommocloar3771', 'Uttsilva36636', 'Ryllwojak973', 'Yaffeficca2267',
                     'Zurawzonts40952', 'Lahnacugno24163', 'Loviggegg93394', 'Albeedrope829', 'Tiokitka490',
                     'Colakfoyt969', 'Dowdsampy487', 'Babyric94644', 'Winnalinda45748', 'Lezersahra71111',
                     'Wiskhaste240', 'Devalahnaf0436', 'Kanosuta270', 'Menteyuasa8546', 'Boguepitta053',
                     'Irimeloe82276', 'Nnajikohs9909', 'Soodsolem0628', 'Palayshiek40992', 'Kimakclase58171',
                     'Canengiem990', 'Jonensait1708', 'Peeraseets892', 'Pironhome7924', 'Barshjoely521',
                     'Wendyshutz738', 'Aungkamp83515', 'Fahnyanny0229', 'Diemgermy4164', 'Bobenveley583',
                     'Noreforey92240', 'Addeokubra0920', 'Megalkies236', 'Gornjapak0288', 'Cikozhang08216',
                     'Moisagolba6687', 'Biasisong66783', 'Stollhegan869', 'Asalyeung27540', 'Bobbamehar19700',
                     'Salitjani204', 'Codydidar264', 'Oceanguile05524', 'Bablknosp823', 'Lorgmoyse6084',
                     'Popecdeke8139', 'Lachsuhel515', 'Gefendash70309', 'Laboebab7822', 'Chuopbulin479',
                     'Barsakeum1511', 'Germsia00169', 'Lijoiyukuo4745', 'Sitzecadoy8879', 'Harborive8838',
                     'Wykeljoely327', 'Gulditoya816', 'Kosiccrema06898', 'Stutesilby5451', 'Diessmoz738',
                     'Humesomori3541', 'Purviummar12110', 'Lamiatail639', 'Badinmele78870', 'Rogetfeurt699',
                     'Sionetusha91954', 'Addeknoff77227', 'Dobeyohmes50110', 'Pienruhe42375', 'Baetzamick44806',
                     'Kertzloka479', 'Duhakritz719', 'Kurrynassr1832', 'Ambrekebe633', 'Turysusco380',
                     'Kevanpoppa35945', 'Tuyetreal4070', 'Pavaruwe19852', 'Jaquadavy2648', 'Gagenrezac115',
                     'Drekaestay6474', 'Hoiege9537', 'Shyuelcan89956', 'Menbakitts5081', 'Tauntaniv6136',
                     'Eganswanat798', 'Iuchsdass96377', 'Zulmahalse5555', 'Lindaeakes08896', 'Quachshird854',
                     'Howgodon88015', 'Brahkorda79245', 'Zyskmarzi12162', 'Parrymunie65153'}
local RECEIVER_LIST = {'Taysjovan52282', 'Shotoklare3449', 'Lobasdoyer9245', 'Oakkhant41231', 'Tosohaus628',
                       'Arztwlach02787', 'Jennleila3339', 'Zartnovik553', 'Parsamuch49899', 'Doroskusic15555',
                       'Pleaksarah021', 'Stefgarin9079', 'Pavurviner09508', 'Retkabieg4461', 'Dejnosneen89680',
                       'Tzouwenig959', 'Rohfos3636', 'Cantuhoupt51019', 'Perlaherma959', 'Emletyabes309',
                       'Neyerdahne164', 'Gayaneisen966', 'Gilahkodey750', 'Dettemems2114', 'Shingalbey449',
                       'Siannblogg8242', 'Himslcouto57885', 'Wirzmavar23699', 'Roaurano0873', 'Ozcannipe6616',
                       'Sobhiplog84333', 'Harlialtum0040', 'Serkhen9076', 'Csabaflow310', 'Dedondupes125',
                       'Urradirig28468', 'Dedescooch549', 'Boeyhuq906', 'Dinisgabel6706', 'Atiajenko3332',
                       'Pensovah2338', 'Lacolugtu180', 'Boldcline501', 'Tamanashaf5195', 'Iketande69646',
                       'Moalafabry20094', 'Ipsennemet18487', 'Sodenkosta30707', 'Debbibive44113', 'Szuchhada51903',
                       'Edenstoop18739', 'Gerweawrey994', 'Turropyke75439', 'Odzawills309', 'Jamagay6936',
                       'Gochhalby5706', 'Devaymoina29087', 'Jaschtorn5508', 'Jupevozel9868', 'Wiessbacho767'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ตัวแปรสำหรับ timeout การรอเริ่มเทรดหลังส่งคำขอหา receiver
local SENDER_REQUEST_TIMEOUT = 200 -- วินาที
local lastSentTargetName = nil
local lastSentTargetIsReceiver = false
local lastSentTime = 0

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันหาผู้เล่น sender ที่ว่าง (ค้นหาเฉพาะ sender)
local function FindAvailableSender()
    local result = nil
    local success, error = pcall(function()
        print("🔍 กำลังค้นหา sender ที่ว่าง...")

        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                        tradingValue = player.Settings.Trading.Value
                        isAvailable = (tradingValue == false)
                    else
                        isAvailable = true
                        tradingValue = "unknown"
                    end
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " .. tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print("❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบ sender ที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindAvailableSender: " .. tostring(error))
    end
    return result
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    -- Sender สามารถรับ trade request จาก sender อื่นได้
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Sender พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            -- รีเซ็ตสถานะการส่งคำขอค้าง
            lastSentTargetName = nil
            lastSentTargetIsReceiver = false
            lastSentTime = 0
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            -- ถ้าส่งหา receiver ค้างไว้นานเกินกำหนด ให้ลองหา sender ที่ว่างแทน
            if lastSentTargetIsReceiver and lastSentTime > 0 then
                local elapsed = tick() - lastSentTime
                if elapsed >= SENDER_REQUEST_TIMEOUT then
                    print("⚠️ รอเริ่มเทรดกับ receiver (" .. tostring(lastSentTargetName) .. ") นานเกิน " .. SENDER_REQUEST_TIMEOUT .. " วินาที กำลังหา sender แทน...")
                    local fallbackSender = FindAvailableSender()
                    if fallbackSender then
                        SendTradeRequest(fallbackSender.Name)
                        lastSentTargetName = fallbackSender.Name
                        lastSentTargetIsReceiver = false
                        lastSentTime = tick()
                        return 0
                    else
                        -- ปรับเวลาเพื่อหลีกเลี่ยงการ spam ตรวจซ้ำทันที
                        lastSentTime = tick()
                    end
                end
            end

            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
                -- บันทึกสถานะเป้าหมายล่าสุดที่ส่งคำขอ
                lastSentTargetName = validPartner.Name
                lastSentTargetIsReceiver = IsInList(validPartner.Name, RECEIVER_LIST)
                lastSentTime = tick()
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        -- เคลียร์สถานะการส่งคำขอค้างเมื่อเข้าสู่หน้าต่าง Trade จริง
        lastSentTargetName = nil
        lastSentTargetIsReceiver = false
        lastSentTime = 0
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- Coroutine ปิดหน้าต่าง CreatureInventoryFrame อัตโนมัติ (ทำงานเบื้องหลังตลอดเวลา)
local function InventoryCloserCoroutine()
    spawn(function()
        while true do
            local success, error = pcall(function()
                local playerGui = LocalPlayer and LocalPlayer.PlayerGui
                if not playerGui then return end

                local tradeHudGui = playerGui:FindFirstChild("TradeHUDGui")
                if not tradeHudGui then return end

                local bottomFrame = tradeHudGui:FindFirstChild("BottomFrame")
                if not bottomFrame then return end

                local creatureInventoryFrame = bottomFrame:FindFirstChild("CreatureInventoryFrame")
                if not creatureInventoryFrame then return end

                if creatureInventoryFrame.Visible == true then
                    local closeButton = creatureInventoryFrame:FindFirstChild("CloseButton")
                    local upperLabel = closeButton and closeButton:FindFirstChild("UpperLabel")
                    if upperLabel then
                        local safetyCounter = 0
                        while creatureInventoryFrame.Visible == true and safetyCounter < 30 do
                            Clicked_Ui(upperLabel)
                            task.wait(0.1)
                            Click_NOW()
                            task.wait(0.2)
                            safetyCounter = safetyCounter + 1
                        end
                    end
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน InventoryCloserCoroutine: " .. tostring(error))
            end
            wait(0.5)
        end
    end)
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- เริ่ม coroutine ปิด CreatureInventoryFrame อัตโนมัติ
        InventoryCloserCoroutine()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
