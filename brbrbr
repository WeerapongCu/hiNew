-- ตัวแปรสำหรับรายชื่อผู้เล่น

local SENDER_LIST = {'LeahHawk8186', 'ChiaraBurgundy2738', 'JaneWitch1129', 'HeidiDancer5710', 'MaeveGuardian2301',
                     'EdithChartreuse9584', 'MiriamApricot3051', 'RebeccaArrow5663', 'RadhaGuardian2426',
                     'PromiseGuardian9360', 'WeiDark3313', 'DeryaGold0383', 'SebnemNavy4338', 'CelesteFox4311',
                     'JulietMint0791', 'MinjiFuchsia9316', 'LalehKhaki2585', 'LuanaFlame2325', 'EstherWitch6873',
                     'LinneaBolt5826', 'ElifTiger1050', 'HecateHunter9987', 'HelgaHeart8340', 'AutumnPhantom6211',
                     'AkalaVixen1306', 'NaomiForest4165', 'EkaterinaRider8700', 'OlgaElectric9278', 'ZarliPurple8591',
                     'SamiraOrange2144', 'RubyOlive9008', 'JulietteMint3826', 'SofiaPeach6976', 'CourageScarlet6113',
                     'DottyForest7360', 'RinHoney6349', 'RubyBlade1777', 'HeidiFuchsia7201', 'StefaniaForest9673',
                     'NasrinSiren9860', 'DaeunSpirit0205', 'PersephoneGoddes5291', 'DottyWitch0058',
                     'NoongarMahogany8820', 'JarrahOchre1474', 'ReaganSpell8418', 'MargritPink1063',
                     'SepidehWeaver9045', 'YelenaMage1205', 'UrsulaSpirit1937', 'ZhenSpark8746', 'DesislavaSpirit5825',
                     'AnnekeNinja8105', 'SilviaTeal8246', 'KalenaFang4032', 'YelenaKnight4294', 'MaileGold2165',
                     'MiriamGuardian9307', 'StefaniaVixen6780', 'EmmaViper3626', 'MidoriCantaloupe8826',
                     'RuthArcher0205', 'NishaFang8958', 'NaomiBlaze3655', 'AoifeFuchsia5864', 'MakedaHunter1317',
                     'ShirinCantaloupe6353', 'SophieForest5519', 'EunjiBolt4438', 'HopeMage9899', 'SigridSpark4210',
                     'LalehCopper8234', 'HelmiReaper1981', 'KavyaGuardian0663', 'LeahMustard7575', 'GertrudHeart4908',
                     'LiisaAubergine3265', 'DottyForge7955', 'BrunhildeKnight1543', 'RhiannonGold2889',
                     'AmeliaMint7149', 'NiaKnight0931', 'CoralSpell8093', 'JulianaPowder9759', 'BraveTurquoise9021',
                     'HarmonyBolt8485', 'MajaCrimson0121', 'SiobhanTomato7715', 'RoisinTiger4984', 'AnitaStrike6518',
                     'CourageWitch9939', 'SamiraReaper9287', 'MahsaIvory9391', 'NishaGray1992', 'BarboraOrchid9461',
                     'EmiCobalt7969', 'GizemArctic5361', 'MargaretArctic0173', 'NinaCobalt4963', 'AndromedaWitch0645',
                     'CoralGold0782', 'MilicaWeaver5276', 'SakuraArrow3985', 'MilicaTurquoise5517', 'MaileDark7320',
                     'AdelheidTomato4826', 'MaeveKnight7950', 'MahinaMaiden8174', 'HelmiWitch1112',
                     'ReaganSapphire9758', 'OlgaSlate2078', 'ZofiaFox2230', 'BraveKnight2328', 'AriaHunter5974',
                     'TeodoraVixen1983', 'XiuGuardian6648', 'MinjiYellow9889', 'ClaireTurquoise4029', 'JarrahHawk2708',
                     'XiuForest1106', 'ArtemisGuardian2834', 'HalaQueen5835', 'CiaraFang0314', 'DottyForge5639',
                     'HuiGoldenrod1833', 'FarahBurgundy9516', 'OfeliaKnight1869', 'NiamhForge2741', 'LingKhaki5715',
                     'KaiaTeal5664', 'AryaOchre8515', 'SakuraMage6365', 'PatriciaScarlet9670', 'WaratahPhantom9267',
                     'HelenFox5296', 'KiraWind1584', 'EmiliaForest6817', 'HelenaSpell7650', 'MiaBlaze7544',
                     'VioletHeart3248', 'NoraOrchid9227', 'ZofiaPowder6295', 'JiaMahogany1268', 'JarrahVixen5479',
                     'AnikaRider7301', 'LeaValkyrie2952', 'DeirdreWolf6849', 'EwaRed0105', 'AmberBrown2390',
                     'NiaMagenta3847', 'LunaFlame5761', 'EsraForest1471', 'HelmiHeart7051', 'RiverCornflower2827',
                     'CalliopeCantalou7124', 'AzureCotta7386', 'HannahStrike2381', 'KealohaSapphire6848',
                     'NishaGoddess5525', 'IrisHeart4572', 'StellaForge6007', 'NinaGuardian1249', 'ValeriaWeaver1582',
                     'StormWeaver9198', 'MarketaBlush1126', 'UrsulaFang5702', 'WeiMaiden6065', 'AuroraRed3741',
                     'MarleePale8540', 'PhoenixStrike0293', 'MoanaValkyrie9798', 'LeilaniWine2433', 'IrinaBlaze4499',
                     'HazelSepia8446', 'HanaOrange9819', 'SelenaBurnt9313', 'DottyAubergine5555', 'AnaisPrincess6419',
                     'RafaelaFlame5533', 'AyseFang0604', 'RiverForest4589', 'HelenVixen8745', 'EwaOrange9234',
                     'ShirinFang7289', 'WarriorPeriwinkl2119', 'AntoniaCotta5467', 'KenyaWitch6377',
                     'ChloeSapphire6348', 'IrinaTan3834', 'KatarinaOrchid7099', 'RebelHeart9171', 'ChayaApricot6446',
                     'NadiaGoddess4762', 'EvaKnight9227', 'FreyaGray9976', 'LauraGoddess6324', 'MaileSpark7759',
                     'IsabellaYellow9468', 'SaoirseNavy0352', 'YasminReaper5455', 'WeiFang2890', 'JaneForest2726',
                     'SusanHuntress0883', 'NasrinGold7007', 'EilishOchre6559', 'SamiraSpell4479', 'FernandaDusty7566',
                     'DorothyDancer6181', 'NoongarValkyrie8743', 'AriaWind4366', 'FarahViper2752', 'LeahHawk7773',
                     'AnitaPrincess1219', 'AmberKhaki4642', 'MargritMauve9831', 'NiamhReaper7932', 'NishaRed9821',
                     'SierraGuardian2657', 'AnjaRed4420', 'JieunQueen4877', 'LuanaOwl3478', 'IsabellaNinja8975',
                     'RebelSpirit8933', 'MinjiTan9425', 'PromiseSapphire2239', 'DaisyStrike4247', 'LyraArrow8041',
                     'AnitaOrange4468', 'IoanaSpell4014', 'GracePhantom5160', 'GiuliaWeaver3256', 'NasrinCerulean4297',
                     'AthenaYellow7538', 'KavyaBlade6369', 'BrunhildeRed7168', 'LyraWitch3467', 'SakuraWeaver6134',
                     'LunaDusty2309', 'LotteHeart7336', 'GertrudSpell0979', 'ZhenDusty5580', 'JuniperVixen9961',
                     'MaileGoldenrod1640', 'DaphneMustard6906', 'MarinaWind1714', 'DaeunGuardian7708', 'AkikoDye6583',
                     'KaiaApricot4472', 'EdithBlush5239', 'DesislavaOrange3581', 'JulietteApricot1766',
                     'RoisinGreen9122', 'LindaChartreuse3848', 'PearlBrown3588', 'ElinaWolf6069', 'ZuriHunter6437',
                     'MariyaFang0409', 'RinNinja9298', 'ChenHeart2103', 'HalaSpell2572', 'AriaKnight6998',
                     'JulietLavender6837', 'KalenaValkyrie6867', 'JuniperSpell3359', 'DreamFang5315', 'MidoriBlue7472',
                     'BarbaraPhantom6491', 'AikoFox1723', 'SamiraBlaze6098', 'QuinnGuardian3868', 'MinjiKnight3288',
                     'AlmaMaiden8637', 'EwaCantaloupe0477', 'EunjiBlade8982', 'AnikaWitch4407', 'EmiMaiden0535',
                     'IvanaBolt0490', 'EmeraldPale3893', 'EilishTan2362', 'KalenaGoddess9088', 'SophiaGold3167',
                     'LiApricot3988', 'XiuPhantom7278', 'CalliopeEggplant8978', 'PearlBuff1013', 'DreamWind3568',
                     'SaraFang0682', 'TerezaArcher6238', 'ElenaFang7387', 'TerezaMage2402', 'CelesteFang8595',
                     'MargaretWitch9724', 'GizemFuchsia4161', 'YasminOwl2724', 'EsraArrow5956', 'EsraRed8764',
                     'EstherSiren1111', 'KylieGray1908', 'SagePhantom6675', 'JinahSiren3392', 'QuinnDusty7820',
                     'LuanaTiger0549', 'AnjaVixen9090', 'OfeliaRed7706', 'HelenTeal5391', 'NeaOwl8273',
                     'GuadalupeRider5364', 'VictoryTomato6834', 'HanaSepia3337', 'MaileSteel8231', 'SiobhanFox3270',
                     'RachelEggplant7147', 'DoloresDancer2475', 'DanielaBolt8325', 'SiennaPrincess7534',
                     'ImaniGoldenrod8368', 'NaomiBlue6443', 'YumiPrincess7079', 'ZehraGold5289', 'YanDancer8276',
                     'IngridRoyal6824', 'MinjiKnight7796', 'NienkeViper3376', 'EvaLavender1168', 'DeryaRider8965',
                     'EliskaElectric4671', 'DeepaTiger9510', 'OrlaForge5204', 'KenyaKnight6518', 'FemkeTeal7458',
                     'MaeveSapphire7451', 'OlgaPhantom2961', 'AnjaOwl5093', 'PhoenixSlate8510', 'KavyaHoney4049',
                     'AnyaMoss6912', 'AyseCrimson5143', 'MaryamSapphire9794', 'IoanaBolt7161', 'DreamArrow6788',
                     'SvetlanaHawk0654', 'CassandraNavy4212', 'ParvanehPlum4246', 'KaisaKhaki7672', 'HeraHawk7552',
                     'MarinaWolf0408', 'JiaValkyrie7780', 'CourageTomato3760', 'XiuSpark3043', 'MaileKnight8700',
                     'KiraArcher4917', 'KavyaMahogany7035', 'CourageCotta5243', 'IngridChartreuse1215',
                     'IoanaBlaze8027', 'AzureElectric2956', 'RinWolf6177', 'IreneVermilion2379', 'MelikeApricot6154',
                     'AbigailMint5388', 'ShirinSlate3744', 'MahsaRed3310', 'PinarSepia0670', 'TeodoraWitch2270',
                     'MarijaQueen5483', 'WarriorMustard3244', 'PetraCobalt3500', 'EliseTurquoise0540',
                     'NasrinCobalt1970', 'LisaKnight8089', 'MariyaSpirit4742', 'XiuArrow0911', 'ZofiaMetallic9365',
                     'CirceWine8817', 'SigneElectric7586', 'KiraHoney4380', 'LyraSiren2292', 'LuciaMustard5648',
                     'CamilaTomato1079', 'JiaPeach2543', 'XimenaWitch5506', 'EvaBolt9608', 'HazelBlade5246',
                     'TamsinFox4671', 'LotteForest7490', 'KirraSlate3785', 'SofiaHeart1824', 'AdelheidYellow1705',
                     'MajaFuchsia3245', 'RebeccaKnight3691', 'SooSteel6602', 'PreetiBurnt5350', 'SepidehMahogany4175',
                     'DianaReaper6827', 'HarperCantaloupe7660', 'ElifMahogany7710', 'DanielaReaper1163', 'AliceOwl5314',
                     'LilyGray7224', 'RhiannonOrange4024', 'NeaPhantom5024', 'ChayaWolf1888', 'JulianaSapphire8995',
                     'YanaraFang5991', 'SaoirseCopper7512', 'NiloufarSteel2638', 'HopeArcher1689', 'WillowPhantom4599',
                     'YanVixen8795', 'JinahHawk4661', 'ValeriaReaper9778', 'JinahSalmon7311', 'JanaBlade9312',
                     'DottyBlade7783', 'HalaForge2698', 'YoonahHunter6988', 'LingTangerine5915', 'JanaWitch2040',
                     'MariaPhantom0976', 'RubyApricot2643', 'JiaDancer3320', 'ReaganDark3663', 'AriadneMage4295',
                     'AriadneQueen9236', 'EkaterinaBolt3081', 'KealohaNinja8638', 'TerezaValkyrie3599',
                     'IngridWeaver4062', 'AikoPeriwinkle9916', 'MahinaHeart3657', 'SigneSiren1820',
                     'BrittaPeriwinkle1215', 'GretaDye1688', 'AnaisSiren9824', 'WeiKnight2147', 'GertrudMage0246',
                     'AvaTerracotta6778', 'IrinaWolf1047', 'PatriciaHeart1696', 'BeatriceArctic2786',
                     'WarriorPrincess9407', 'MilicaOwl9374', 'AlinaPurple9688', 'YukiTiger3131', 'JaneHeart4505',
                     'CoralFlame1482', 'ChloeHawk0161', 'KatarzynaFang4553', 'SepidehKnight6810', 'StormRust8870',
                     'EsraBlade7416', 'AoifeGuardian8165', 'CelesteFox5339', 'CristinaFlame2021', 'RubyCerulean7147',
                     'SofieAquamarine5068', 'SaraApricot9660', 'RuthHeart1824', 'HazelGreen8622', 'SamiraFang0345',
                     'SkyTeal2367', 'FreedomChartreus3774', 'PhoenixDye2960', 'ElinaStrike8527', 'MartinaForest3977',
                     'MaryApricot9234', 'ScoutKnight7923', 'EvaAquamarine7748', 'AriaVixen9877', 'MabelMetallic3046',
                     'PearlRider1495', 'BarboraYellow3688', 'NataliaArctic8446', 'EsperanzaCopper4667', 'HeraGold6847',
                     'EvaSpirit7278', 'GraceBurgundy2624', 'AlexandraHoney4893', 'HeidiMaiden0909', 'BraveFlame2320',
                     'AndromedaCantalo7734', 'ZhenSpell0146', 'LiBolt3579', 'RubyTomato4623', 'MeiFox0260',
                     'PreetiBurgundy8130', 'AnnaBlush7029', 'DorothySteel8100', 'ElenaSpell5805', 'GraceApricot9428',
                     'YoonahDark8002', 'RaniaTiger5761', 'HildaStrike8135', 'AnnaWine4156', 'SusanSpirit8476',
                     'AugustaArrow4861', 'DottyOrange7553', 'RubyBlade5540', 'AmiraMaroon8621', 'CaoimheBlaze5317',
                     'JieunElectric1823', 'AmeliaSpirit3737', 'EilishOrchid4808', 'KenyaCerulean0993', 'KaiaRider7293',
                     'ReaganGoddess3596', 'MajaBlaze1595', 'ClaraHoney8737', 'LotteFlame1490', 'OliviaPurple1690',
                     'AnaisTerracotta0951', 'HanaBlaze2445', 'YumiPowder1246', 'AnitaMage9654', 'JulietFuchsia6897',
                     'MinaValkyrie1902', 'BarboraHuntress8875', 'DeryaRoyal3645', 'TerezaGoldenrod6645',
                     'KealohaBlaze8607', 'AkalaPurple3404', 'RhiannonDye9387', 'BarboraHunter1400', 'SiobhanFlame5713',
                     'IndigoDancer7854', 'CirceDark6241', 'SierraNinja0295', 'BrunhildeMahogan4372', 'AinoOwl4588',
                     'AleksandraArrow3681', 'CelesteSpark8415', 'CelesteOchre0758', 'ElsaKhaki0336',
                     'MarianaSpirit4123', 'HopeGuardian1396', 'MaryViper9153', 'CarmenCotta6639', 'KealohaIvory5676',
                     'JanaBolt3939', 'CharlotteLilac3942', 'AutumnYellow1612', 'ChenRider6763', 'LakshmiSpirit3015',
                     'KaterinaArrow7679', 'MarinaMahogany4325', 'KinsleyViper1414', 'HelgaGray1887', 'AstridNavy3968',
                     'KiraWitch9374', 'MatildaHawk2981', 'SkyVermilion3299', 'HazelSpark6891', 'ChenOrange1721',
                     'PromiseTan8052', 'ValentinaBolt2867', 'MaeveGuardian2472', 'LauraFang5219', 'KiraElectric3453',
                     'JinahFox0550', 'ValeriaFang0582', 'AoifeSpark3601', 'LuanaQueen5344', 'LauraDancer6289',
                     'AkalaTomato5519', 'SofieNinja3808', 'CiaraBlush9788', 'AzureGuardian8956', 'JiaYellow0271',
                     'AuroraWeaver0966', 'ZoeNinja7029', 'BronwynEggplant1142', 'HildaScarlet6998', 'ClaudiaGray5842',
                     'AugustaTan0328', 'MarianaHawk2113', 'SiobhanSpell7828', 'PinarHawk2662', 'BrunhildeArcher9196',
                     'OlgaFox9220', 'KirraGoldenrod2918', 'SiobhanGoddess8757', 'HopeFlame9778', 'CiaraGreen1119',
                     'SierraAquamarine5155', 'AnitaOlive9701', 'AliceArctic1457', 'SebnemPrincess9925',
                     'KianaNinja7276', 'GretaPlum7813', 'MariaWine1956', 'AmberEggplant8764', 'YelenaTangerine3933',
                     'EilishFang1786', 'JinahIvory1116', 'YanHunter2707', 'PromiseSiren4556', 'LunaGreen3697',
                     'RuthGold0266', 'LeaTurquoise8288', 'SophieMauve4818', 'AmberValkyrie5191', 'SaoirsePrincess2209',
                     'AnastasiaSpell3989', 'AlinaPhantom9272', 'LakshmiRed9052', 'TeodoraSapphire6204',
                     'AnastasiaOrchid3413', 'BrielleWitch0623', 'AliceWind0745', 'ZofiaFang2525', 'HanaGoddess8231',
                     'GiuliaPowder3791', 'ZarliTan6120', 'RebelCantaloupe5608', 'LeilaBlade2884', 'AuroraGoldenrod2832',
                     'GuadalupeGold4707', 'MaeveWind1148', 'AriaCerise2275', 'LyraDark5698', 'HelenaHoney3277',
                     'EkaterinaPowder7011', 'DianaBlue0017', 'IsabellaMoss4473', 'SilviaWeaver3645', 'KavyaBurnt2865',
                     'IsabelaBlade6932', 'StefanaHuntress3636', 'DeepaViper8868', 'DvaOlive6254', 'HecateArrow2717',
                     'HalaVermilion5626', 'LingViper9373', 'ZuriTomato7036', 'MargaretWeaver3835', 'MaileMoss0532',
                     'QuinnSepia9606', 'CirceFlame5279', 'JarrahMint6275', 'MaryVermilion6741', 'RhiannonScarlet2431',
                     'HyejinFox1247', 'SagePeriwinkle7737', 'SaritaArcher7382', 'ElenaHunter5205', 'NovaBolt7047',
                     'MilaHuntress6127', 'AinoSpirit8002', 'PinarHoney1350', 'DoloresPhantom7259', 'VeraFlame1209',
                     'AmberViper0157', 'BrielleWind2709', 'DaphneOrange3843', 'AnjaReaper4867', 'SeoyeonBlaze3800',
                     'SofieStrike7360', 'SigneDusty8110', 'SiennaRust9733', 'LailaGold1338', 'LindaSteel6923',
                     'KristinaScarlet6525', 'ParvanehGreen5061', 'BrielleSpirit7805', 'SaoirseCobalt5355',
                     'AyseMage2111', 'AutumnSalmon4187', 'LiValkyrie9761', 'LeahKhaki1439', 'ImaniTeal3791',
                     'MaeveSiren3325', 'JelenaHoney3031', 'AnnaMetallic0771', 'IoanaMauve7118', 'AnitaValkyrie1699',
                     'FreedomCerise3984', 'AyseMage7087', 'DottyTangerine1389', 'KavyaGuardian4704', 'AnaisSpirit0246',
                     'AlmaDancer2398', 'SageBolt8649', 'PatriciaStrike6893', 'EsraGuardian2205', 'ZuriJade3978',
                     'SarahSiren6162', 'AnjaFlame6990', 'DreamMaiden6453', 'HildaOchre4460', 'RuthCornflower6135',
                     'SakuraHunter4684', 'MaeveArcher1865', 'PersephoneBlaze9707', 'PriyaYellow1485', 'AmaraBlade8878',
                     'MoanaGuardian2855', 'HarmonyDye0204', 'YoonahBlade2418', 'HeraTomato3323', 'IreneHawk0034',
                     'MilaFang0517', 'ClaraRider8796', 'CiaraRed9600', 'ArtemisAubergine0380', 'AnitaWolf7601',
                     'HeidiPlum3220', 'MelikeReaper7030', 'IrenePrincess1443', 'HeidiVermilion7983',
                     'RhiannonCerise7340', 'NoraCantaloupe4869', 'DorothyRider5498', 'YoonahPhantom7352',
                     'ScarlettFang2201', 'ElsaWitch9325', 'DoloresTangerine8459', 'EsraPurple6815', 'HeidiYellow1111',
                     'MinaLilac8807', 'AliceFlame2251', 'SilviaBlaze0889', 'MidoriPale2796', 'IrinaHawk5028',
                     'KylieOrange4667', 'ParvanehOwl5967', 'MabelKnight2057', 'ZoeHeart5989', 'WaratahSiren5511',
                     'AzureFox5780', 'CelesteValkyrie6167', 'AnjaHeart3434', 'AstridHeart8031', 'LaniQueen3496',
                     'ScoutFuchsia9556', 'FernandaBurnt9485', 'NienkeOwl9847', 'EwaPlum6394', 'KalenaKhaki2472',
                     'HeidiTeal7120', 'GretaAquamarine5794', 'AnjaliDancer6352', 'IrisNinja3883', 'BrunhildeMaroon7588',
                     'BeatricePhantom2885', 'HelgaGray4307', 'GizemPeriwinkle2744', 'ClaudiaScarlet0379',
                     'HelgaOwl4741', 'TerezaDark8844', 'SophieFang9894', 'AndreeaNavy0359', 'AzadehQueen6718',
                     'ChloeVixen9977', 'AislingSpell7980', 'MinaDark6121', 'NoongarHuntress1696', 'AnnekeArrow7541',
                     'KiraRoyal3813', 'AnjaDye3223', 'ShirinMahogany9685', 'MilicaHawk5797', 'SepidehFuchsia3506',
                     'YoonahBurnt5413', 'EsraLilac8384', 'MedeaFlame8606', 'AnjaHoney0933', 'LiisaTiger8987',
                     'EvelynHunter7555', 'MinjiMagenta0158', 'GizemPeach5797', 'HyejinFlame6872', 'KalenaBolt6071',
                     'MaryMoss9402', 'HeidiScarlet3924', 'PreetiRust4826', 'SelenaTangerine8522', 'KiraTan7363',
                     'DianaOrchid2209', 'RuthForge1608', 'FaithOrchid8756', 'AdelheidOrange6892', 'UrsulaTeal6584',
                     'FaithMustard6231', 'IvyDark3880', 'AoifeTan6301', 'MiaQueen9200', 'AnaisMagenta3931',
                     'HildaVermilion5867', 'VictoryPink9526', 'HelenaRust1238', 'DeirdreTiger0971',
                     'EkaterinaMaiden3969', 'KaterinaCrimson3219', 'OrlaVixen0095', 'DaeunRider3957',
                     'DaphnePhantom0243', 'MinjiMahogany1864', 'MaeveTiger7329', 'MinaNavy7780', 'HanaEggplant1378',
                     'RoisinValkyrie4061', 'KaoriTomato8422', 'HecateSpell0798', 'AnjaliGray5325', 'LiisaMaiden1061',
                     'ImaniMint8524', 'JoyTeal2709', 'ShirinWolf6470', 'SaaraPeach8985', 'NasrinSapphire4698',
                     'KavyaHawk8949', 'MatildaRed9648', 'EmeryPale1166', 'NinaOrchid8695', 'PreetiKnight6103',
                     'YelenaCerise7760', 'ScarlettRoyal6013', 'MinjiBurnt5713', 'JoyScarlet0484', 'MoanaMaiden0735',
                     'LaylaAubergine4974', 'TamsinGoddess6230', 'AriaViper2096', 'AvaMoss9311', 'ClaireJade3904',
                     'CoralMauve8228', 'MeiSpell4346', 'RebelPrincess7189', 'PreetiNinja1085', 'ValentinaMustard7572',
                     'MilicaTerra7643', 'IoanaBlade5120', 'OlgaWitch9065', 'CourageBlue9830', 'HarmonyBlaze3353',
                     'AugustaTeal5348', 'TaliaMaiden0150', 'WillowNavy4711', 'JaneCopper4762', 'JasmineSalmon5857',
                     'IreneYellow8783', 'WillowWeaver5565', 'CalliopeValkyrie2890', 'StormSteel8424',
                     'CarolinaBlue7137', 'AlexandraBurgund6873', 'EdithForge1563', 'LindaCerise8811', 'SagePale3089',
                     'AndreeaIvory6680', 'BarbaraOlive5976', 'IndigoFang1610', 'EliseGoddess9440', 'JulianaWitch2255',
                     'LinneaPink3173', 'PinarWine3549', 'LotteMetallic3802', 'MoanaGray1224', 'XimenaHuntress9015',
                     'VictoriaEggplant9555', 'TeodoraCornflowe9718', 'AndreeaGoddess6817', 'SophiaWolf0298',
                     'AthenaYellow8948', 'KealohaArcher2993', 'HyejinArcher5111', 'MinjiQueen7644', 'DoloresStrike6065',
                     'OrlaBurgundy2947', 'MiaPlum4288', 'EmeraldGuardian8869', 'RoseSepia2390', 'AnikaViper1616',
                     'SakuraViper7323', 'KalenaDancer4234', 'MarijaFang1640', 'AkalaGold6005', 'MaryGoddess2921',
                     'KaterinaWeaver6868', 'MarieHeart6000', 'HazelFlame9793', 'JuliaWeaver0850', 'EsperanzaRed2001',
                     'BeatriceMustard4162', 'LeilaniDusty8402', 'AinoEggplant8280', 'JusticeForge4024',
                     'MaileWeaver6872', 'HyejinCerulean8121', 'HuiMaiden1208', 'HuiSepia4173', 'HeidiOrange9590',
                     'BrunhildePowder8293', 'PriyaYellow1488', 'IsabellaNinja9690', 'JelenaEggplant8671', 'RoseDye0079',
                     'KirraGoddess0301', 'SebnemRider6861', 'SarahRust4295', 'JusticeOwl3315', 'LeilaniNavy9737',
                     'JusticeOrange3577', 'AinoReaper1078', 'ImaniQueen8011', 'AndromedaChartre6108',
                     'HermioneKhaki2411', 'AnnekeCerise2234', 'MahinaPhantom5461', 'MilicaAquamarine8714',
                     'AnyaTangerine7197', 'KaiaDye3856', 'SierraMage3962', 'LeahRed6375', 'PatriciaMaiden4862',
                     'SarahPhantom6205', 'EmeryReaper1684', 'AoifeAquamarine8927', 'MeiArrow1054', 'KalenaMagenta7747',
                     'FemkeTerracotta9164', 'LindaHawk4824', 'HermionePeach1429', 'AnikaBlush3411', 'XimenaHawk6696',
                     'NoorAquamarine8555', 'RoisinMint0819', 'AutumnMauve8966', 'ChloeTiger7160', 'MayaPhantom9091',
                     'GabrielaSpirit8143', 'YelenaStrike7716', 'EdithApricot9566', 'JarrahSpark9964',
                     'SilviaValkyrie5210', 'KaterinaDancer6696', 'DaeunFox2287', 'MinjiOwl1796', 'MajaWeaver4019',
                     'ValeriaKnight1868', 'MaryamNavy7625', 'DeryaHoney5421', 'HyejinArcher4081', 'PreetiSepia3677',
                     'HanaWeaver9293', 'SepidehMauve0568', 'BronwynBlaze0622', 'AntonijaMahogany6855', 'JoyPhantom5942',
                     'SiennaWeaver6106', 'FreedomHuntress4693', 'MaileViper6934', 'MarianaGoddess5123',
                     'PetraTurquoise8518', 'TaliaDancer6076', 'AikoBurnt8985', 'AlmaSpirit8152', 'CelesteForest0915',
                     'EvaBurnt4192', 'GraceHunter5179', 'NaomiSiren9375', 'IndigoNinja7674', 'SilviaPurple1321',
                     'OlgaHeart9767', 'ClaireHunter5276', 'AnikaBlush6678', 'KaoriOwl1539', 'KianaYellow6861',
                     'AgnieszkaBlade5896', 'AutumnGoldenrod9968', 'IndigoVermilion1629', 'KavyaVixen3252',
                     'AysePhantom2379', 'DorothyYellow1508', 'DorothyVermilion1546', 'LaylaKhaki5534', 'AnyaBurnt6920',
                     'RoisinSapphire4518', 'AkikoCrimson3033', 'BrittaVixen5996', 'SusanTomato4716', 'GizemBlade7980',
                     'AndromedaHunter0145', 'LuanaBlue1449', 'PromiseFlame2149', 'AuroraViper0560', 'AstridPale4712',
                     'KealohaSpark1472', 'ZhenOlive0229', 'ParvanehTerracot4981', 'FreedomScarlet0349',
                     'RaniaGreen9515', 'MajaDusty1957', 'DeryaTiger5918', 'CerenRed8514', 'AriadneReaper6909',
                     'AnyaDancer9772', 'ChiaraTan2689', 'CiaraPrincess4667', 'RoseOlive6450', 'NiaMustard3093',
                     'YoonahCopper1890', 'KirraYellow0017', 'DeepaFang9472', 'AmiraWine9323', 'JaneBuff5228',
                     'LisaHeart7289', 'AuroraFang5025', 'NiaFuchsia3486', 'ElsaNavy4544', 'CiaraBurnt6229',
                     'HannahWolf2752', 'ShirinDusty4549', 'AoifeArcher3708', 'LiReaper7380', 'EwaArctic2554',
                     'SeoyeonMetallic0725', 'SaaraMetallic0412', 'AutumnOrchid5055', 'PriyaRider9235',
                     'IngridGuardian5966', 'RinWind1077', 'AntonijaTiger3782', 'MagdalenaHoney8355', 'AnnekeSpark4820',
                     'FatimaBurgundy9494', 'MaeveForest3854', 'AugustaRed6967', 'YasminHuntress3811',
                     'MarinaMaiden9522', 'LucieHuntress2002', 'AkalaSalmon5679', 'CamilleOlive3140', 'SepidehSlate5577',
                     'AnnekeMustard9512', 'JasmineFlame0427', 'PreetiMage8814', 'RubyOwl3456', 'AthenaCopper1101',
                     'TamsinPeriwinkle3690', 'ImaniNinja7685', 'SierraFuchsia5136', 'NadiaKnight3402', 'OfeliaHawk9821',
                     'OliviaNinja0350', 'MabelYellow2436', 'JuliaPeach7630', 'KianaViper6456', 'MarleeNinja9744',
                     'RoisinChartreuse2231', 'ChloeFox5947', 'WaratahScarlet3159', 'AnastasiaDancer1531',
                     'ArtemisMagenta1764', 'QuinnOlive7732', 'KaisaPink2871', 'PromisePrincess6496',
                     'CoralTurquoise6753', 'KylieCopper7630', 'StellaSpark1571', 'JiaMustard8426', 'IvyPhantom9432',
                     'OrlaPhantom7657', 'ShirinViper1370', 'GertrudNavy3395', 'EdenSlate1039', 'AgnieszkaStrike7093',
                     'MajaLilac7071', 'ImaniCornflower2720', 'RoisinPowder4393', 'SeoyeonArcher9528', 'MarijaGreen0691',
                     'JusticeWine5247', 'GabrielaYellow1569', 'IvanaArcher4690', 'CourageHunter0047',
                     'MargritSpell8219', 'TerezaArrow5168', 'YelenaMustard9892', 'DeepaSiren5085', 'IrisLilac2083',
                     'ZuriOwl0062', 'MahsaMagenta5264', 'AkikoNinja4890', 'ParvanehForest2020', 'HecateWine0143',
                     'LingDusty6953', 'PersephoneSpark1839', 'JuliaEggplant5974', 'OliviaWitch1653', 'ElifOlive9223',
                     'SelenaBlade4818', 'SebnemRoyal6855', 'AishaJade2489', 'KavyaBolt9693', 'YelenaTan2475',
                     'LingMagenta9660', 'AnikaSpell7628', 'IvyMauve1363', 'NasrinElectric8115', 'BarboraHeart1901',
                     'VictoriaPink9725', 'YukiKnight7964', 'LaniYellow8297', 'YoonahMaiden5859', 'HelgaBuff7758',
                     'HannahOrchid3318', 'RubySpell5353', 'SaritaFang9280', 'KalenaSapphire4477', 'MaileCantaloupe8769',
                     'OfeliaRust0294', 'NadiaSiren1598', 'MeiKnight7933', 'SakuraOlive9535', 'CiaraArrow2057',
                     'KatarinaArrow0604', 'DeepaDark5330', 'OliviaQueen2723', 'JelenaHeart3835', 'ElenaPhantom9722',
                     'ElsaDark0045', 'ClaudiaGreen2701', 'LinneaBolt1549', 'SvetlanaGuardian3217',
                     'KristinaMahogany1818', 'BarboraBolt9053', 'AmaraDye6091', 'AinoMetallic7779',
                     'KatarzynaTangeri4566', 'AriadneWeaver3947', 'GertrudSapphire7512', 'MarieReaper3080',
                     'AntonijaMaroon6053', 'KatarinaPurple4344', 'DorothyPeach0687', 'MayaTiger9684', 'HeidiSpell9501',
                     'KealohaGuardian3846', 'MahinaReaper6601', 'ClaudiaGoldenrod1748', 'ParvanehSiren5521',
                     'BronwynFuchsia9086', 'MeiTerra3799', 'IrisSpirit5288', 'DaphneSalmon5115', 'AgnieszkaWolf3974',
                     'AuroraSalmon0117', 'AyseHunter4094', 'MahinaSpark5353', 'JusticeElectric7936', 'YoonahOrchid2510',
                     'ZarliWeaver0133', 'LiWind1094', 'KaterinaBlade4525', 'LucijaPrincess2046', 'RiverWitch2330',
                     'CelesteWeaver9930', 'AishaFox1998', 'IreneBlaze6846', 'IvanaWeaver1412', 'PromiseNavy2963',
                     'PatriciaYellow1655', 'TaliaForge0577', 'NataliaOrange2079', 'EdenTurquoise6402', 'JiaReaper0351',
                     'AndreeaWine1845', 'FemkeMaiden0513', 'GraceHuntress2524', 'ZoeKnight2224', 'RinNinja7128',
                     'BraveSpell8851', 'EmiCantaloupe1956', 'MinaFang7736', 'KiraPurple1506', 'ZehraSalmon1971',
                     'SigneRed7543', 'SeleneTerracotta9696', 'AnikaIvory0987', 'MaeveHawk8801'}
local RECEIVER_LIST = {'JieunAquamarine1938', 'MilaSpell7146', 'MaryGoddess1148', 'MahsaDancer6912',
                       'PhoenixGoldenrod6114', 'YumiVixen3967', 'SofieGreen2828', 'ReaganBolt6694', 'DanielaBurnt2993',
                       'FemkeSteel7143', 'LenaMetallic4238', 'StefaniaReaper3371', 'HopeFuchsia6814',
                       'VioletCerise8519', 'GertrudCobalt6802', 'LiSpirit3348', 'VictoryArrow9773', 'AgnesWine3677',
                       'HecateOrange6503', 'OrlaBlush9172', 'SofieStrike4596', 'GiuliaViper2757', 'IoanaFlame1070',
                       'MabelBlaze7688', 'YanaraPhantom6684', 'SepidehWitch1099', 'HanaOwl5062', 'TamsinApricot7076',
                       'NoorSpell5699', 'LaylaSpell6531', 'LinneaPurple0555', 'YukiTurquoise6843', 'StormSteel1615',
                       'KiraArrow4654', 'LailaAubergine7647', 'SelenaPurple7532', 'MeiValkyrie6321', 'EmiliaPale8615',
                       'NataliaFlame2948', 'GraceVermilion3279', 'ClaireBurnt7618', 'AishaPhantom9812',
                       'HarmonyTan4705', 'JiaValkyrie1776', 'SofiaBolt4250', 'AzureSiren3769', 'CarolinaVixen8441',
                       'AvaOwl4460', 'DoloresCopper1648', 'LuciePeach3605', 'SiennaPowder9703', 'KirraReaper5221',
                       'AnyaMaiden7797', 'JulietSpark7637', 'AmberStrike5722', 'LisaPink6846'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
