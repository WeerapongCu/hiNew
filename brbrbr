-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'SarahMint2619', 'JieunOlive5877', 'LakshmiArrow4985', 'ZehraPink5749', 'QuinnSpell7103',
                     'KaoriPhantom1126', 'DaeunNinja0124', 'MarleeNinja3485', 'NienkeSteel5028', 'PromiseMaiden2891',
                     'KinsleyIvory9562', 'AzureMetallic8095', 'XimenaBlush7864', 'DeirdreTiger3702', 'JinahSpirit1670',
                     'NienkeDancer0332', 'BeatricePeach4914', 'PersephonePrince3631', 'AyseWitch9893', 'JieunHawk2914',
                     'EsraSpark2516', 'MeiYellow3977', 'KalenaKnight2302', 'DanielaWeaver9336', 'LailaSpell4012',
                     'JasmineMage9536', 'EliskaForge3718', 'WeiValkyrie0785', 'SelenaBlade4818', 'KatarinaIvory8252',
                     'HarmonyQueen4718', 'IrinaHawk5028', 'RuthTomato7834', 'ChenHeart7288', 'HelgaGray1887',
                     'UrsulaSpark4901', 'HecateWine5219', 'FreyaApricot0743', 'HermioneBlade1185', 'BraveWind4650',
                     'CircePowder7770', 'DreamReaper1091', 'ReaganRoyal6681', 'AriadnePlum3678', 'SarahHunter7450',
                     'NasrinForest1479', 'BarbaraVixen8565', 'LailaMage2031', 'RubyTeal5130', 'SigridWine0920',
                     'SageHuntress3968', 'MatildaBlue2922', 'SiobhanSpell5483', 'AnnaArrow6831', 'MedeaMetallic3238',
                     'NeaYellow6667', 'AuroraMaiden1599', 'ElizabethRust5513', 'HecateCopper3163', 'ZhenYellow2940',
                     'LingFox4719', 'MiaGoldenrod0967', 'MinjiMage8771', 'NasrinCornflower5928', 'AstridCerulean8110',
                     'MariaPink9331', 'MilicaFang0694', 'EsperanzaCerise0366', 'AriaMahogany1054',
                     'BarbaraPrincess4619', 'JulietteStrike0568', 'LalehReaper1098', 'RafaelaSpell5613',
                     'OliviaBolt0857', 'MarieHoney9515', 'IngridWeaver4062', 'ImaniBuff7369', 'RaniaGuardian6945',
                     'SophiaPhantom1054', 'ClaireTurquoise4029', 'KaoriScarlet2993', 'AoifeWitch7383', 'LingBlade3116',
                     'ElsaHawk4623', 'SofieGoddess8167', 'EvaApricot3613', 'HarmonyIvory1727', 'RebelNavy2070',
                     'OlgaValkyrie2986', 'AishaAubergine4954', 'PearlHunter9436', 'AinoJade5447', 'IoanaBlaze4781',
                     'RadhaBlade7841', 'JovanaPhantom1936', 'OlgaGold8725', 'IsabelaTan4054', 'ScarlettKnight4158',
                     'AliceHuntress4474', 'NoongarKnight5734', 'CarolinaScarlet7068', 'BeatrizSteel5727',
                     'SofieAquamarine5068', 'AvaOrange1609', 'AislingMagenta5127', 'LaniSpell2330', 'AishaBlaze2826',
                     'AlexandraFang0524', 'GizemPowder7889', 'HalaDancer9774', 'DeryaFuchsia7075', 'NovaBlue2907',
                     'AnastasiaKnight4219', 'ScoutArctic9519', 'MabelGray4744', 'NeaSpirit4050', 'KaterinaHoney5038',
                     'HyejinDark4555', 'TatianaNavy3389', 'ArtemisTurquoise4010', 'AriadneYellow2162', 'LaylaMint6764',
                     'EsperanzaMahogan2366', 'RiverPale1839', 'NiaHunter0283', 'SooBurnt9037', 'AnnekeViper7276',
                     'PhoenixDusty3746', 'ElsaMaroon1970', 'ZarliSiren1556', 'LeahReaper5321', 'SkySpirit3242',
                     'MelikeTurquoise6724', 'TamsinCornflower8169', 'GiuliaHawk7582', 'JasminePurple7336',
                     'AnaisWolf8991', 'CristinaSpirit0028', 'KristinaBlue2896', 'FarahDancer1329', 'CiaraRider4846',
                     'SaritaFang9280', 'CassandraValkyri8555', 'EdithGoddess1168', 'ZhenKnight6028', 'NoongarMauve0899',
                     'LalehJade7170', 'MelikeHunter5589', 'WillowPrincess2008', 'CassandraSpirit8721', 'NiaWitch5206',
                     'BeatriceSlate4567', 'RubyOrange2108', 'HalaCotta1035', 'ElinaOwl1838', 'CoralBlaze0179',
                     'GabrielaMustard7927', 'ReaganKhaki0130', 'PatriciaVixen2715', 'SarahViper0532', 'OfeliaSpark4711',
                     'LaylaWolf7592', 'KatarinaElectric7437', 'MeiGuardian6060', 'MaeveRed7315', 'PinarPurple0597',
                     'RafaelaBolt3805', 'NiloufarHuntress0037', 'KiraCerise8275', 'AmiraHuntress0302', 'ChayaNinja4904',
                     'YelenaWeaver1404', 'CourageGreen7068', 'KirraPurple4480', 'ZehraBolt4275', 'CaoimheCerulean9880',
                     'YasminWind9662', 'EsperanzaBlade8628', 'ShirinVixen5851', 'DeirdrePurple3443', 'GizemBuff8694',
                     'MiriamKhaki3586', 'NovaSiren1191', 'EliseWolf5712', 'MoanaGuardian0931', 'CaoimhePurple3630',
                     'YasminSiren2986', 'EliseSpark1918', 'MarketaGoddess2584', 'AmiraGreen5673', 'YoonahReaper8557',
                     'TeodoraDusty2675', 'ElizabethMetalli5174', 'MarketaHoney0646', 'SannaPurple5711',
                     'FaithValkyrie6397', 'LeahHawk7773', 'ChloeWind5798', 'EvaGoddess9724', 'ElinaBlush6819',
                     'StellaVermilion9116', 'MariyaPrincess4228', 'HildaLavender5883', 'ElifBrown7215',
                     'ArtemisOrchid2915', 'MahinaCantaloupe9739', 'LiTerra8590', 'AuroraTerracotta1040',
                     'AlinaHoney3520', 'SigridPeach8829', 'MidoriRoyal5414', 'KristinaDark1022', 'EwaCobalt0954',
                     'AliceCrimson2497', 'SepidehWine7634', 'ValeriaGoldenrod8193', 'EkaterinaBolt3081',
                     'AuroraCornflower4497', 'MiriamArcher5891', 'KatarinaArrow1918', 'MiaPurple8712',
                     'TerezaSiren5147', 'JuniperVermilion2531', 'RebeccaCobalt8696', 'LunaOrchid1938',
                     'IrinaPrincess9926', 'StefaniaPlum4866', 'MartinaRider4532', 'ElifWolf2370', 'HuiWitch1054',
                     'MahinaNavy9096', 'RiverWitch2236', 'AnnaApricot9596', 'AkalaMage4485', 'StormAquamarine9214',
                     'EunjiNavy5878', 'SigridQueen5912', 'MeiDark2264', 'CharlotteBlade9329', 'DaisyCopper2876',
                     'SiobhanRed1544', 'HarperMauve2873', 'MiaPrincess3248', 'AlmaTeal8615', 'SebnemYellow8339',
                     'BraveTerra2542', 'AndromedaCopper5703', 'HildaOwl3818', 'ClaraTerracotta9293', 'FaithForest0374',
                     'AutumnElectric3774', 'LilyFox7086', 'AoifeQueen6982', 'DaisyMint9623', 'CarmenCerulean9374',
                     'IreneHuntress8094', 'ShirinKhaki5544', 'VictoryMoss0118', 'NadiaDancer2143', 'MilaMaiden7957',
                     'EsraSteel3158', 'LunaVixen6657', 'AmeliaPale5688', 'AmeliaOwl6779', 'NoraWolf0884',
                     'LailaDancer9185', 'MoanaVixen7454', 'NiloufarBlue6499', 'MinjiOlive9407', 'MabelHawk9809',
                     'AmiraKhaki4339', 'CiaraGoddess4890', 'HermioneMaroon5899', 'FrancescaDusty6752',
                     'NoongarArcher5991', 'SelenePeach5496', 'CiaraFang8212', 'HyejinTangerine5146', 'ChloeWolf2160',
                     'KiraReaper6879', 'MahsaDancer6912', 'OfeliaWolf9643', 'SamiraBurgundy5009', 'PriyaOrange8030',
                     'ElinaIvory0524', 'SaraAquamarine5652', 'LaylaScarlet3643', 'BronwynDancer9763',
                     'CharlotteBlade7777', 'CassandraValkyri3119', 'PetraMauve9770', 'DaeunRider3957',
                     'CaoimhePowder9987', 'JuniperAubergine8987', 'MarijaCobalt6869', 'LotteFuchsia6906',
                     'ZehraOchre0729', 'NoongarQueen7047', 'JusticeWine2470', 'VeraDusty7335', 'MarleeSpirit8472',
                     'NienkeViper3376', 'DaisyOrchid3437', 'PenelopeDusty6030', 'ClaraPrincess8078',
                     'SierraGoldenrod0867', 'LaniForge5492', 'AugustaHawk4960', 'SilviaDusty2116', 'BrittaOwl2116',
                     'EkaterinaLilac1434', 'BrunhildeVixen6368', 'ParvanehSpell0124', 'RafaelaForest4012',
                     'JinahSepia4106', 'JelenaPrincess6277', 'KatarinaHawk8755', 'EvaForge2189', 'IsabellaReaper4512',
                     'SophieValkyrie2961', 'NaomiTomato9760', 'MaileKnight9698', 'CassandraJade8907',
                     'CassandraWolf0996', 'CarmenCerise1056', 'RebeccaGoddess8061', 'HeidiCrimson6083',
                     'MatildaBlade4516', 'LakshmiScarlet8506', 'DaeunDark3689', 'YelenaWind9654', 'TeodoraViper7551',
                     'AuroraBlaze6298', 'FatimaMage0737', 'SooWind0975', 'AlexandraHawk9148', 'ZofiaHuntress4677',
                     'AgnieszkaVixen8144', 'SageCerise9431', 'RebeccaGuardian8801', 'WarriorAquamarin8658',
                     'CamilleStrike0801', 'PinarBlaze8490', 'LiGuardian6408', 'ZarliMahogany9332', 'BrittaWolf8286',
                     'ParvanehTerracot4981', 'AgnesEggplant2771', 'KaiaYellow0874', 'PinarPeach5961', 'CarmenHeart4941',
                     'MaeveFox0106', 'KylieGoddess6645', 'ClaudiaGuardian1569', 'VictoriaSpirit6655', 'QuinnArrow7750',
                     'MaeveSapphire7451', 'PenelopeArcher7291', 'GretaTurquoise3016', 'OliviaPurple7925',
                     'IsabelaSpirit0159', 'SelenaSlate8934', 'AnaisOwl3247', 'BrunhildeWolf5015', 'EdenGuardian4000',
                     'ZaraArrow2840', 'LuciaMahogany1688', 'HannahCopper3887', 'MilaMaroon2764', 'CourageWind9042',
                     'LuciaTan9443', 'MabelMetallic3046', 'GizemTan7735', 'JelenaForest4324', 'SaritaGold4122',
                     'AmiraLilac9750', 'NaomiPale4757', 'SigneEggplant0554', 'CristinaReaper9944', 'PromiseSalmon5772',
                     'SaraNinja5610', 'LingStrike6558', 'MinaRider5632', 'DaisyStrike4247', 'ReaganPhantom3465',
                     'ZhenTerracotta6547', 'AinoWind3436', 'MarketaBlush1126', 'CelesteTiger6032', 'PenelopeTerra2876',
                     'StellaTiger5206', 'MarieBurnt1828', 'TeodoraSepia3495', 'KirraBlade7252', 'SofieGoddess7215',
                     'AlinaDark4784', 'MaryFang5340', 'AmeliaPale6475', 'LotteRider6459', 'LotteHunter9765',
                     'CoralPlum2881', 'StefanaWind7744', 'BrittaBolt5169', 'RuthViper0583', 'LalehKnight2045',
                     'LeilaniBlaze9168', 'AgnieszkaSpirit1944', 'ClaudiaSpell3391', 'HildaWeaver1071', 'PinarVixen0417',
                     'KalenaMustard2501', 'AkikoTerra9107', 'MedeaRoyal6212', 'KaiaBlaze9764', 'WaratahBlush2881',
                     'AnaisRed2061', 'MajaCornflower2590', 'NienkeDancer5327', 'XiuEggplant6686', 'NaniMaroon5369',
                     'EmeraldRust4679', 'NasrinMage5261', 'AnjaliHawk8725', 'LiisaSteel1930', 'AnnekeSpell8968',
                     'PetraCobalt5951', 'NeaPurple2861', 'StefaniaRoyal4862', 'ValeriaBlaze6328', 'KatarzynaVixen1789',
                     'GretaIvory1640', 'HannahScarlet6329', 'IrisPowder0760', 'MabelPrincess9503', 'OrlaCerulean6224',
                     'StormEggplant1788', 'AyseArcher1097', 'IndigoGuardian3946', 'CirceReaper2232', 'KiraPrincess0330',
                     'MaeveLavender5305', 'EilishValkyrie0066', 'MidoriMaiden6082', 'ImaniSpell7563', 'NoraWolf3288',
                     'MajaCrimson0121', 'PearlTiger1363', 'NataliaArctic8446', 'FernandaWolf9745', 'BarboraMustard4381',
                     'MiaMage8236', 'EsraBlade7416', 'AkikoFang4425', 'MargaretDye4597', 'GizemSiren1684',
                     'LunaPowder0844', 'AdelheidGoddess9198', 'AmiraPale6569', 'EsraStrike3989', 'LiWolf7288',
                     'CalliopeWitch4807', 'TerezaSiren5611', 'BrielleFang7406', 'AnaisMage8197', 'RebeccaWolf5876',
                     'StefaniaTiger2390', 'HopeWind3743', 'PetraViper7239', 'ChenGuardian7276', 'PriyaLavender7595',
                     'ZofiaViper7984', 'ChayaApricot6446', 'IoanaDancer6979', 'DreamScarlet9650', 'ZhenCerulean1623',
                     'AndromedaReaper2604', 'ZehraWind8818', 'NishaGoddess1523', 'JinahFox0550', 'RafaelaValkyrie5854',
                     'ValentinaGoldenr6467', 'AnastasiaHuntres2356', 'SannaOrange8372', 'DottyPrincess3183',
                     'MarinaReaper9333', 'SigneRoyal3074', 'DaeunWine0599', 'MarleeSpirit1748', 'MariyaMustard1636',
                     'MariyaMetallic2700', 'MinjiQueen8042', 'HermioneKnight6170', 'YanGreen5037', 'NoorArcher9686',
                     'AkalaCerise5783', 'NaniViper3552', 'YumiMagenta3606', 'AntonijaTiger8918', 'WillowSpell0546',
                     'TatianaSpell6469', 'PromiseNavy3392', 'LyraTan0133', 'KaisaWolf1518', 'CassandraDark6350',
                     'DorothyFlame7762', 'CarolinaHoney3896', 'BeatrizYellow3373', 'NadiaVixen8826', 'HelgaPlum8102',
                     'MarinaYellow5395', 'SannaCantaloupe9209', 'GizemMagenta5385', 'EvaStrike7180', 'StellaSteel7827',
                     'KianaDusty3822', 'AryaSteel1257', 'LisaKnight3812', 'StormValkyrie6811', 'NoorMaroon6730',
                     'SilviaGreen1959', 'SeleneGuardian2844', 'MarinaSepia6108', 'LaylaWitch7295', 'OfeliaStrike9059',
                     'FarahFuchsia7333', 'AvaDusty5147', 'KaisaTiger0678', 'ClaudiaScarlet0379', 'FemkeOwl6546',
                     'AnnekeOlive8914', 'DeryaPhantom5371', 'MarketaHuntress8209', 'IngridOrchid5785',
                     'BronwynBuff5560', 'MarianaBolt8272', 'NasrinYellow3860', 'VeraElectric2960', 'DottyForest7360',
                     'PenelopeWitch4707', 'NataliaRed9537', 'JarrahKnight4228', 'WeiKhaki1427', 'MaileHunter0355',
                     'FemkeNinja0858', 'DreamBurgundy6358', 'IsabellaBlade0399', 'LalehIvory0798', 'SeoyeonHeart9311',
                     'TaliaMint6944', 'TamsinVermilion9576', 'FaithAubergine7328', 'TerezaForge2362',
                     'WeiCantaloupe8547', 'JulietReaper1349', 'SageYellow8407', 'MelikeWeaver3230', 'TamsinStrike4976',
                     'KalenaRider0503', 'RachelApricot2801', 'OrlaHuntress4414', 'HermioneGoddess5018',
                     'EsperanzaDancer8631', 'AnjaliFlame8820', 'MaryamDye5006', 'DianaReaper6827', 'AoifeDark7657',
                     'AnnaGoddess1970', 'ElenaForge3013', 'VictoryForge3883', 'MariyaCotta1687', 'EdithBuff8250',
                     'MilaRoyal8269', 'AmelieReaper9941', 'DaeunSepia1491', 'AstridMauve3116', 'PersephoneKnight0539',
                     'MarijaTurquoise3852', 'JovanaQueen2252', 'CarmenStrike9396', 'AthenaMetallic5343',
                     'WeiHunter8703', 'GabrielaYellow1569', 'SamiraMagenta3319', 'AlmaLavender0295', 'AthenaSalmon6684',
                     'AinoDusty2884', 'AuroraDancer0280', 'LucieTeal8600', 'CamilaLilac8517', 'VioletKnight8066',
                     'AyseRust9633', 'KiraArrow2724', 'DvaNavy5842', 'StormArcher1059', 'EvelynValkyrie9597',
                     'AntoniaTomato8753', 'DreamMaiden8330', 'AmelieLilac4951', 'AlinaVixen3434', 'NinaOrchid8695',
                     'JulietCrimson5591', 'SepidehBolt3900', 'LucijaBurgundy4426', 'NienkePhantom7567', 'ZarliWind0382',
                     'RuthMahogany4907', 'NaniAubergine6433', 'StormHoney9352', 'ElsaPeriwinkle3237', 'HelmiRider8554',
                     'MakedaBolt7592', 'IrisDancer2870', 'IreneArrow7619', 'ScarlettPhantom7229', 'JarrahSpark9964',
                     'LyraSiren2292', 'SiobhanGuardian5184', 'MinaArrow8203', 'FreedomVixen7627', 'NinaSpell7694',
                     'HarmonySteel9705', 'AinoOchre9370', 'AstridHuntress9093', 'BronwynAquamarin7758',
                     'GraceVermilion3872', 'MiriamFlame8205', 'AkalaValkyrie7058', 'SusanSpell7022', 'PetraJade2200',
                     'MoanaLilac4968', 'YelenaBlade3875', 'FaithGold9081', 'LiisaHunter4897', 'LaniBlaze9111',
                     'LunaAquamarine3828', 'CiaraForge3444', 'AthenaWeaver2198', 'SigneGoddess3719', 'SaaraReaper8030',
                     'JarrahYellow2479', 'EkaterinaDancer5332', 'WeiDye4612', 'KianaBlaze3074', 'ChiaraPlum9197',
                     'GraceMagenta8775', 'ValeriaSiren7445', 'KaoriReaper2911', 'SilviaRider3820', 'JulianaViper1119',
                     'AnastasiaYellow7466', 'GraceKhaki1558', 'FreedomBurgundy9914', 'LingTurquoise5273',
                     'ChiaraOwl9217', 'StefanaPink1406', 'MagdalenaGoddess0112', 'ScoutMauve5106', 'CiaraMaroon9492',
                     'CirceHunter1394', 'IsabelaPrincess7700', 'OrlaLavender4349', 'JusticeForge5052',
                     'AndreeaSteel1769', 'ClaudiaWolf7978', 'MariePurple2198', 'MoanaBolt7070', 'DaeunSiren6982',
                     'LakshmiPowder6609', 'LailaGoddess4613', 'SofiaMauve7748', 'IsabellaNinja9690', 'AnikaSpirit0545',
                     'SophiaGuardian9151', 'CoralOrchid8847', 'GretaWolf6398', 'AuroraMagenta3977', 'DanielaWine1725',
                     'AriadneRider1036', 'MahsaVixen6167', 'MayaKhaki6345', 'JulietSpirit8469', 'KaiaWeaver1449',
                     'KinsleyPurple1675', 'HelgaMage2423', 'VanessaOwl5440', 'NeaScarlet6790', 'SamiraCornflower2669',
                     'HelenTeal5391', 'ElifBlaze5215', 'MaeveWeaver7881', 'JulietReaper8520', 'OliviaQueen2723',
                     'LinneaWitch0287', 'RebelMint0032', 'SilviaApricot0536', 'EliseReaper0223', 'JoySlate9824',
                     'AlinaElectric9085', 'KaterinaPlum4444', 'LeaForge6998', 'CelesteBlaze7113', 'PreetiGreen4900',
                     'GizemBlaze8026', 'YukiBlade6251', 'FreedomPale5262', 'MedeaBrown3003', 'ScarlettBurnt3110',
                     'AlexandraBuff5820', 'AvaHuntress9065', 'BronwynSteel1047', 'IndigoKnight8122', 'MarySteel1433',
                     'DaphneOchre6875', 'MaryamMage9444', 'ElizabethHawk5114', 'NataliaSapphire2928',
                     'SigridAubergine1845', 'EilishKnight3953', 'WarriorFuchsia7206', 'AkikoWeaver1516',
                     'MahinaHawk8800', 'HeidiMaiden2818', 'ClaraTiger5720', 'ClaraIvory7492', 'HanaHeart3814',
                     'NoongarVixen2277', 'AthenaBurgundy4300', 'ValeriaGoldenrod2049', 'HermioneTan5935',
                     'EvelynWolf2026', 'LaylaPale9904', 'EsperanzaDancer3815', 'PetraVixen9500', 'MakedaTurquoise8793',
                     'NeaLavender6239', 'AzureForge5125', 'EwaWolf3570', 'LucijaArctic0019', 'ParvanehDancer3336',
                     'AleksandraWine9896', 'CiaraRust2288', 'LingSalmon5324', 'LaniMaiden1784', 'LeilaniNavy9737',
                     'AzadehGoddess1031', 'MabelPhantom8836', 'AutumnGold4396', 'StefanaTan0052', 'JoyCornflower4922',
                     'RhiannonKnight1827', 'RubyGray2950', 'AriadneGoldenrod2336', 'EstherSiren1506', 'SannaMage2781',
                     'AnnekeDye7062', 'RoseReaper9509', 'LinneaGoddess2065', 'CassandraScarlet8046', 'SooOchre1605',
                     'WeiOrchid7188', 'JoyGreen8994', 'LenaOlive3691', 'ChiaraBolt3617', 'ValeriaArctic4264',
                     'LilyRed1447', 'KalenaHawk4911', 'SaraPeriwinkle4895', 'MarketaGoddess6844', 'DvaBlaze9236',
                     'PenelopePrincess4983', 'VictoryViper3283', 'MakedaTerracotta5307', 'SaraForest6748',
                     'LyraScarlet6476', 'MarleeHeart9636', 'BarboraPlum0807', 'LauraBlaze5128', 'KatarzynaHawk1510',
                     'JulietSlate6575', 'AlexandraPurple1151', 'HeraHuntress6468', 'SannaRoyal4282',
                     'ElizabethMage3244', 'DeepaVixen5014', 'DesislavaNinja0676', 'SebnemPale4329', 'ElinaDancer1436',
                     'SiobhanGreen3315', 'AriadneCornflowe8898', 'AislingGuardian7088', 'TatianaFang8527',
                     'ChenScarlet2719', 'CarmenBolt3108', 'PreetiBurgundy1919', 'KirraOchre5970', 'ClaudiaTan2063',
                     'KatarzynaSpell9830', 'JusticeHeart8931', 'AryaFuchsia9901', 'MajaMauve0876', 'HildaMahogany6912',
                     'JieunHuntress1928', 'AndromedaYellow4345', 'EmmaPowder4493', 'ParvanehArcher3242',
                     'KaiaSapphire9547', 'MaileKhaki6058', 'BarboraCopper6415', 'FatimaLilac8725', 'ParvanehRed4303',
                     'MidoriSapphire9129', 'LeilaniHunter6319', 'PreetiBurnt0654', 'DesislavaBurnt5728',
                     'FreedomForge2437', 'MilicaNinja3263', 'MinaStrike0704', 'RafaelaSapphire3628', 'MinjiPeach7896',
                     'KenyaFlame8554', 'IndigoCornflower2647', 'GizemForge3563', 'AkikoHunter9146', 'ChloeStrike9571',
                     'SkyCotta4679', 'LindaFang6718', 'LenaIvory1879', 'AntoniaBlaze7850', 'LingFang1974',
                     'ParvanehPlum4246', 'WarriorApricot3006', 'NovaOwl1880', 'BraveMahogany4316', 'RhiannonNinja1080',
                     'JasmineLilac2709', 'HeidiFlame9402', 'ZaraPeriwinkle7279', 'MedeaKhaki4057', 'MargritTiger2999',
                     'IngridPeriwinkle4466', 'HarmonyViper0624', 'CirceDye8426', 'ChayaMaroon0033', 'RubyGold1535',
                     'RosePlum2789', 'ZoeFang7081', 'HecateKhaki0520', 'QuinnAubergine1727', 'GabrielaReaper5129',
                     'EilishTiger3422', 'ZuriWeaver2793', 'MilaYellow8204', 'ImaniMustard1733', 'TatianaYellow0583',
                     'EsraWine9812', 'SofieCopper5624', 'NataliaArcher9034', 'HannahHuntress3170', 'JinahKhaki7327',
                     'JulietRust7621', 'ZehraBurgundy0601', 'OliviaPrincess4844', 'HelenaWine7165',
                     'MargritCantaloup6930', 'IvanaDusty2052', 'AriaViper2096', 'AbigailBolt8276', 'AislingWind0742',
                     'HeidiGold0416', 'RebelForge3376', 'MabelMage6098', 'IngridCobalt4053', 'KalenaTurquoise8383',
                     'OrlaHawk2363', 'AislingPrincess9198', 'RebelViper9095', 'AoifeCornflower0614',
                     'EsraAquamarine9920', 'ElinaGray8035', 'AthenaKnight5064', 'HopePowder1070', 'WaratahKnight6049',
                     'CamilaPurple5021', 'DanielaFang1219', 'LunaPeriwinkle9021', 'FrancescaPurple1965',
                     'MahsaGold0081', 'YanSpell4271', 'NasrinForest1028', 'ElifSiren2849', 'DeepaForge9020',
                     'YanaraElectric8436', 'LeilaniTiger6023', 'JiaForge1683', 'ZehraMaroon5018', 'MarleeSpell4860',
                     'IoanaReaper9919', 'StellaTurquoise4028', 'RebelNavy7524', 'MinjiKnight2552', 'CarmenLavender7836',
                     'SooLilac4066', 'MaevePhantom1373', 'LyraKhaki7737', 'LaylaWind2295', 'MargaretBlade3932',
                     'ZaraTurquoise4400', 'VioletBlade3680', 'ViolaPeriwinkle4549', 'OfeliaQueen6302', 'AnyaWine4589',
                     'CristinaFang8945', 'BarbaraDancer6999', 'KealohaKhaki1824', 'MargaretPale6131',
                     'CaoimheBrown1950', 'LiTerra1402', 'LuanaPowder1920', 'JulietScarlet4681', 'ShirinRoyal1923',
                     'GertrudGold7833', 'ClaireMetallic7013', 'DottyFuchsia9580', 'SophiaBlush6013', 'BrittaHeart2499',
                     'BrittaNinja7329', 'ChloeRider1551', 'AnjaSpell4505', 'EilishBlade6614', 'SebnemSteel3169',
                     'NishaBlade6275', 'DianaSpirit3180', 'VanessaArctic8051', 'JanaHoney5661', 'LauraBlaze7648',
                     'ArtemisGuardian7457', 'QuinnMagenta9355', 'CaoimheValkyrie3584', 'HarperHunter3673',
                     'MargritMetallic0785', 'QuinnMage4436', 'PhoenixAubergine2064', 'KristinaFang7708',
                     'SierraPink1335', 'FatimaBlue5738', 'KinsleyHunter2812', 'RachelMustard6492',
                     'GuadalupeMetalli7475', 'MiaPink8164', 'KalenaBlade3506', 'DaeunGoddess9156', 'DaisyFox7299',
                     'GiuliaTiger3790', 'ValentinaMustard7475', 'AzureMagenta9459', 'StellaSlate1276', 'XiuHawk1626',
                     'SaaraStrike4468', 'CalliopeVermilio5114', 'RoisinTerracotta0500', 'HelgaQueen9016',
                     'HuiElectric4968', 'RebelSpark0189', 'LaylaDancer3089', 'OliviaElectric5012', 'EstherViper5028',
                     'RoisinChartreuse2231', 'BronwynValkyrie0257', 'PatriciaEggplant9410', 'RinRoyal7561',
                     'PatriciaSpark9720', 'AriadneBurgundy0793', 'NataliaPlum6264', 'EkaterinaFox9945', 'PetraMage9812',
                     'VanessaRoyal1839', 'EstherTiger3007', 'DreamViper8879', 'DaeunEggplant2231', 'AkikoBolt3042',
                     'DreamSapphire9532', 'LeaMage1781', 'ClaudiaOrange6439', 'YanCrimson3900', 'SigneMage7904',
                     'NishaMetallic5434', 'HecateSiren2324', 'PearlOlive9537', 'ZarliHoney6662', 'NaniStrike1774',
                     'ScarlettDye5407', 'OlgaGoddess9505', 'AdelheidPhantom5801', 'ChenPrincess9720', 'HelenOchre7450',
                     'KiraKnight6759', 'AmaraTangerine9479', 'StormVermilion3265', 'CassandraTangeri1390',
                     'SkyBuff3456', 'ImaniWeaver8077', 'LeaVermilion4581', 'ImaniHuntress0302', 'AikoElectric5736',
                     'MaeveFlame2461', 'KaiaVixen4577', 'MargritAubergine4356', 'HannahBlaze8643', 'AoifeForge6472',
                     'MiaJade5844', 'JarrahBlush5275', 'SophieArcher5789', 'MedeaTerra5365', 'BeatriceStrike9723',
                     'SkyBlade7275', 'KenyaNinja7015', 'IrinaGoddess7238', 'YukiViper9742', 'CaoimheViper0980',
                     'GiuliaFuchsia9229', 'ElifPeach1865', 'HuiBlade2967', 'HeidiWine4102', 'BraveFlame2320',
                     'MoanaRider9670', 'KealohaSapphire8578', 'VictoryFuchsia1585', 'ZehraBlaze8778',
                     'SannaAubergine1747', 'NasrinValkyrie1562', 'MajaDusty0840', 'RiverKhaki8490', 'KaiaSpirit1217',
                     'MarieOlive1027', 'MakedaTerracotta3993', 'SierraSpirit7730', 'MayaOchre8425',
                     'NiloufarGoddess3313', 'NoongarOrange6261', 'HanaGray2449', 'CarolinaHawk0630', 'HuiOlive4099',
                     'StellaTan0948', 'HeraMustard3788', 'HelgaVixen3325', 'PatriciaSlate2278', 'GuadalupeWind5558',
                     'DaisyWine6111', 'RuthWitch1339', 'LauraSiren4036', 'DvaCobalt5540', 'AnitaRed0742',
                     'YanaraApricot4408', 'NishaMoss2296', 'WeiPrincess2896', 'FernandaValkyrie5698', 'IrisSpirit1019',
                     'MarijaRider3766', 'JuliaWeaver5362', 'KatarzynaCerise4868', 'AzadehGuardian0608',
                     'EmeryQueen4624', 'MarijaMint0814', 'DeepaWine1830', 'MakedaWeaver9803', 'SofiaGoldenrod9144',
                     'BeatrizSpell1516', 'KenyaValkyrie3396', 'KinsleyMahogany7802', 'RachelDancer9837',
                     'CirceMagenta6933', 'EliskaIvory4108', 'SofiaWind1851', 'KatarinaWeaver0132', 'HuiVixen1421',
                     'RoseWind3581', 'EsperanzaNavy2699', 'LaniWeaver4545', 'HalaMaroon6289', 'BronwynSiren5404',
                     'CaoimheGold3588', 'ParvanehBolt9648', 'MoanaSpirit3391', 'NinaViper7789', 'AriaSpell4047',
                     'AnaVixen7114', 'MelikeMauve3154', 'PenelopeGuardian9850', 'CassandraHunter3578',
                     'FreedomSpell6982', 'OrlaGoddess1550', 'LenaBurnt2872', 'ViolaHunter1399', 'MargaretDye7753',
                     'FrancescaScarlet9775', 'OlgaFox7745', 'LauraVermilion1891', 'EmeraldForge2918', 'CamilleHawk6491',
                     'ChloeSpark4860', 'WeiWine4936', 'ImaniArrow3844', 'YanAquamarine1385', 'AntoniaMint4798',
                     'XiuArctic9245', 'JarrahMaiden6622', 'VeraHawk0813', 'CamilaDye7758', 'YanaraMage6843',
                     'KenyaKhaki1113', 'IreneMaiden2058', 'AnaisBuff3337', 'KaoriWitch3361', 'JovanaTiger7135',
                     'KalenaVixen1489', 'EkaterinaWitch6185', 'AnnekePeriwinkle2389', 'HildaOwl4876',
                     'LalehTangerine1965', 'LailaFang5071', 'EmeryJade9781', 'KatarzynaSpell8938', 'LeilaniLilac5037',
                     'BraveGuardian5094', 'XiuBlush7469', 'SepidehWind5933', 'MaryGoddess1148', 'KaiaTeal5664',
                     'ElsaNinja0206', 'KirraGold0161', 'LindaViper7974', 'TamsinHuntress4307', 'SilviaWind9984',
                     'MayaEggplant3310', 'BrittaTomato3889', 'PinarPeach1531', 'AthenaDancer9433', 'KiraPale0361',
                     'CarolinaBlush4969', 'LilyVixen5116', 'GiuliaForge2387', 'MinaSpell4229', 'AnikaMetallic3667',
                     'StormNinja8068', 'LilyHunter8641', 'JusticeGray8637', 'JulietteForge4418', 'CelestePurple7664',
                     'KatarinaArcher8379', 'GracePeach0579', 'MedeaReaper4789', 'AnnaStrike0914', 'AnitaMage8393',
                     'VictoriaTiger1313', 'OlgaArctic8671', 'NoongarMauve8557', 'HecateVixen9480', 'HuiPeriwinkle5577',
                     'SigridSalmon7221', 'JelenaPrincess8911', 'MinaSpirit8706', 'MaeveMoss4983', 'GizemGold5432',
                     'DorothyViper9226', 'AislingGold4131', 'YanNavy3113', 'NaniSiren9394', 'VictoriaCantalou6281',
                     'EstherGoldenrod5282'}
local RECEIVER_LIST = {'SebnemYellow0900', 'JuniperOlive8974', 'AoifeFuchsia5864', 'MinjiMahogany1864', 'EvaOwl6433',
                       'ZuriWind4400', 'GizemHeart3120', 'YelenaMustard4234', 'JarrahSteel4114', 'SakuraRoyal8036',
                       'DreamMint4391', 'RaniaBlush0896', 'WillowValkyrie9500', 'PromiseViper2293', 'TeodoraReaper8907',
                       'RiverWeaver1220', 'MatildaRider9238', 'LeahNavy7923', 'EunjiWolf9440', 'AstridRider4367',
                       'GizemMaiden0092', 'IvanaCornflower7546', 'LindaSpell1967', 'RiverMaroon9353',
                       'StefaniaFuchsia2826', 'AzureOrange9495', 'AntonijaCobalt3859', 'AnnaSpark2343',
                       'CamilaSapphire3794', 'KaisaOlive1771', 'ImaniHeart8136', 'HelmiBolt5435', 'GretaWind9234',
                       'MatildaCobalt8709', 'SageWolf3995', 'AmiraDye7816', 'ViolaPeriwinkle6802', 'AoifeMetallic3410',
                       'LingSpell7945', 'CourageMaiden5006', 'DottyTerracotta1084', 'AnikaTan3025',
                       'HopeTerracotta5489', 'HarmonyOrchid4187', 'LaniAubergine6243', 'ClaraSlate7012',
                       'LinneaViper8224', 'MariaViper2759', 'LuanaStrike9316', 'ZhenQueen4005', 'ZoeFlame8412',
                       'MahsaRust7656', 'HopeAubergine3199', 'SooSlate1278'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับการตรวจสอบ path
local pathConfirmed = false
local pathCheckAttempts = 0
local MAX_PATH_CHECK_ATTEMPTS = 3

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

-- ฟังก์ชันตรวจสอบและยืนยัน path
local function CheckAndConfirmPath()
    if pathConfirmed then
        return true
    end
    
    pathCheckAttempts = pathCheckAttempts + 1
    
    print("=" * 60)
    print("🔍 ตรวจสอบ Path และการตั้งค่า")
    print("=" * 60)
    
    -- แสดงข้อมูลผู้เล่นปัจจุบัน
    print("👤 ผู้เล่นปัจจุบัน: " .. LocalPlayer.Name)
    print("🎮 Game ID: " .. game.PlaceId)
    print("🌐 Server ID: " .. game.JobId)
    
    -- แสดงรายชื่อในรายการ
    print("\n📋 รายชื่อ Sender:")
    for i, name in ipairs(SENDER_LIST) do
        print("   " .. i .. ". " .. name)
    end
    
    print("\n📋 รายชื่อ Receiver:")
    for i, name in ipairs(RECEIVER_LIST) do
        print("   " .. i .. ". " .. name)
    end
    
    -- ตรวจสอบว่าผู้เล่นอยู่ในรายชื่อหรือไม่
    local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
    local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)
    
    if isSender then
        print("\n✅ คุณอยู่ในรายชื่อ SENDER")
    elseif isReceiver then
        print("\n✅ คุณอยู่ในรายชื่อ RECEIVER")
    else
        print("\n❌ คุณไม่ได้อยู่ในรายชื่อใดๆ!")
        print("⚠️  สคริปต์จะไม่ทำงาน")
        return false
    end
    
    -- แสดงตำแหน่งที่จะวาร์ปไป
    print("\n📍 ตำแหน่งที่จะวาร์ปไป:")
    print("   X: -2132.24")
    print("   Y: 490.66")
    print("   Z: 1106.83")
    
    -- แสดงข้อมูล coins ปัจจุบัน
    local coinsValue = LocalPlayer.Data and LocalPlayer.Data.Coins and LocalPlayer.Data.Coins.Value or "ไม่สามารถเข้าถึงได้"
    print("\n💰 Coins ปัจจุบัน: " .. tostring(coinsValue))
    
    print("\n" .. "=" * 60)
    
    -- ถ้าเป็นครั้งแรก ให้รอการยืนยัน
    if pathCheckAttempts == 1 then
        print("❓ คุณต้องการดำเนินการต่อในตำแหน่งนี้หรือไม่?")
        print("💡 กด Enter เพื่อยืนยัน หรือรอ 10 วินาทีเพื่อยกเลิก")
        
        -- รอการยืนยัน 10 วินาที
        local startTime = tick()
        local confirmed = false
        
        while tick() - startTime < 10 do
            if tick() - startTime >= 5 and not confirmed then
                print("⏰ เหลือเวลาอีก " .. string.format("%.0f", 10 - (tick() - startTime)) .. " วินาที...")
            end
            wait(1)
        end
        
        if not confirmed then
            print("⏰ เวลาหมดแล้ว ยกเลิกการดำเนินการ")
            return false
        end
    end
    
    -- ถ้าเป็นครั้งที่ 2 หรือ 3 ให้รอสั้นๆ
    if pathCheckAttempts >= 2 then
        print("⏳ รอ " .. (5 - pathCheckAttempts) .. " วินาที...")
        wait(5 - pathCheckAttempts)
    end
    
    pathConfirmed = true
    print("✅ ยืนยันแล้ว! ดำเนินการต่อ...")
    return true
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue ..
                      " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        -- ตรวจสอบ path อีกครั้งก่อนดำเนินการ
        if not pathConfirmed then
            print("⚠️ ยังไม่ได้ยืนยัน path กรุณารอสักครู่...")
            return nil
        end

        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue ..
                      " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        -- ตรวจสอบ path อีกครั้งก่อนดำเนินการ
        if not pathConfirmed then
            print("⚠️ ยังไม่ได้ยืนยัน path กรุณารอสักครู่...")
            return false
        end
        
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        -- ตรวจสอบ path อีกครั้งก่อนดำเนินการ
        if not pathConfirmed then
            print("⚠️ ยังไม่ได้ยืนยัน path กรุณารอสักครู่...")
            return false
        end
        
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue ..
                          " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue ..
                      " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue ..
                          " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end

            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")
        
        -- ตรวจสอบและยืนยัน path ก่อน
        if not CheckAndConfirmPath() then
            print("❌ ไม่ได้รับการยืนยัน path ออกจากสคริปต์")
            return
        end

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
