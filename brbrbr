-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'Moweralley284', 'Latusiolo37730', 'Wehrneddo43162', 'Cammibesa55018', 'Tiegsleich3110',
                     'Mansgreci344', 'Asherfait904', 'Kramsibaad646', 'Coleynhin88597', 'Leathmimm091',
                     'Clashrogge08184', 'Crawlallo968', 'Graefdiano2111', 'Doinoseko0765', 'Hananhuso1320',
                     'Girtyirmak2014', 'Evronshirl798', 'Shuffimara9145', 'Haglsanvi386', 'Sappeneyer01206',
                     'Diyaever4627', 'Ovedrehme4887', 'Monkoamet796', 'Xx_ADDISONOMEGAMINER', 'N0ahHer036',
                     'CharlottePanda33', 'R0gueRaven88', 'XxLunaV3nomxX2017', 'Xx_SCARL3TTDRIFTRID3',
                     'Blad3CrystalUltra', 'XxQueenPowerEpicxX20', 'Ic3S0nicNight2004', 'TurboBaconHaz3',
                     'XxPandaRiftTurboxX', 'SHADOW_Sky29', 'XxVictoriaBlizzardSt', 'SHADOW_Dancer63', 'Luna_M00n2020',
                     'AquaTurboTiger53', 'BrooklynPulse28', 'FrostFir3King', 'XxMagicHer0xX2014',
                     'Om3gaCrystalVoid2008', 'Lion_FUSION60', 'H3nryAlpha2015', 'StreamLightBeast2007',
                     'XxPlayz_HeroxX2017', 'AuroraRocketRift95', 'ArrowQueen202189', 'Xx_OliverG0ldenEagle',
                     'Str3amTig3r14YT', 'B3ar_L3g3nd99', 'C0deMystic71', 'Julian_Fury91', 'XxBrooklyn_SonicxX97',
                     'ElijahSparkWolf', 'PANDA_Dawn2004YT', 'XxHero_MysticxX29', 'AceDancerFrost', 'H3roDrift2021',
                     'DanielStealthHyper', 'SonicStarryWolf89', 'Alpha_Inf3rno201819', 'RiftChillFuryYT',
                     'NeonOmegaSkater', 'Stealth_Neon54', 'BaconSkyBuild3r2010', 'Z3ro_Arrow2011', 'W0lfLucky2013',
                     'Xx_NightGhostThund3r', 'Sonic_Jelly200525', 'LightNightFlick', 'SaberSkyEch0',
                     'XxDuckShadowFusionxX', 'Br00klynGlitchHer0', 'BrooklynVoid27', 'XxC0dePixelatedxX_YT',
                     'ZoomMaxOm3ga2006', 'ChloeStarSilver', 'LI0N_Dark2017', 'AsherCrystal14', 'MiaZ00mBlast',
                     'HunterCircuitByte12', 'XxLucasStormMasterxX', 'StormStealth22', 'AquaC00ki356', 'SophiaEchoFury',
                     'Aur0raBlizzardM00n', 'Eagle_Builder81', 'ChaseMinerBuilder201', 'JellyHunterFury2019',
                     'Craz3B3astSpark', 'JellyDancer17', 'LuckyJ3llyLi0n', 'WillowPandaByte2015', 'XxRileyJellyxX2003',
                     'XxEpicKingRocketxX', 'VortexByte81', 'Inf3rno_LION93', 'Bac0nDrift2007', 'Ph03nix_Dark2004',
                     'Ethan_Ultra200594', 'PrimalKnight98', 'ScarlettClawStorm', 'LI0N_Glitch2017', 'XxRiley_CodexX39',
                     'IceBearPhoenix', 'BeastPowerStream', 'Xx_DancerCircuitNeon', 'Cobeymaxam0622', 'Megowhuppe418',
                     'Viaudmckey16987', 'Tovarzenor052', 'Jossiyopp9634', 'Tankogala49188', 'Hashijaco99475',
                     'Yukikudwa547', 'Bassoterp6109', 'Bearecheuk931', 'Requeair26175', 'Taasevalme471',
                     'Sawkoquyen376', 'Gamppelie51791', 'Yarmear06961', 'Resiorhey89555', 'Haassnogal1932',
                     'Ourthaid6763', 'Akapokudej0799', 'Ilerwygal4668', 'Lagasoll804', 'Thremayen770',
                     'Solidzamer65433', 'Boserasrat1030', 'Dahioneel782', 'Attabondo7627', 'Kjomescout027',
                     'Berkasager230', 'Zyanaemaan3874', 'Yaghiacs1935', 'Faraiuzun995', 'Baidhugel1545',
                     'Baabguray6649', 'Selicstipa13137', 'Ehlimules3443', 'Rakoschiya735', 'Dedefecci7120',
                     'Gardeeidt44245', 'Setiweick590', 'Pinelrama94952', 'Pandyragg55199', 'Ziskvidic1784',
                     'Felizarlo93916', 'Silinlosi9655', 'Hagafojut7075', 'Starzsvr383', 'Kicakdurm2776',
                     'Smarrsnow96324', 'PaisleyHeroBlade2021', 'GhostInfernoFury', 'ViperFuryZap18', 'RocketIce202126',
                     'ChillPrimalClaw20051', 'XxJax0n_NinjaxX89', 'EmmaEagl32008', 'Craft_PULSE33',
                     'NinjaV3nomL3g3nd37', 'Li0nStarWraith', 'XxAubreyOrbitHyperxX', 'XxHeroBaneGlitchxX20',
                     'Abigail_Venom35', 'V0idPandaBl0ckYT', 'PLAYZ_Turbo90', 'SparklyLightNe0n2004',
                     'XxDark_HyperxX2012', 'XxMagicAc3LightxX', 'Xx_GraceStormySilver', 'XxAddisonVenomxX2006',
                     'XxJames_FURYXX2020', 'RiftGamer200244', 'S0nicHer02006', 'XxKnight_EpicxX2020', 'V3nomN3on36',
                     'Cyber_Frost2019YT', 'Drag0nBlade88', 'SparkShadow63', 'EliEagleCraft2008_YT', 'Ac3GalaxyMax2008',
                     'EagleWolfBuilder2020', 'XxSky_KNIGHTXX17', 'Sparkly_Ech02005', 'UltraZoomPanda',
                     'LucasPh03nixMystic', 'P0wer_Turb0202258', 'ZapChaosCircuit', 'Xx_SamuelGoldenLegen',
                     'HawkSkyZ3r0', 'Chill_AQUA200713', 'XxCookie_DriftxX2002', 'BearUltra49', 'WillowSonicArrow65',
                     'XxBeastN0vaPixelxX', 'BearSilverRogue35', 'T0xicGiga2004', 'MysticRocket75', 'KingFoxTig3r',
                     'Thund3rZap16', 'JamesCraftHunter2014', 'PH0ENIX_Sparkly28', 'PulseStealthLi0nYT', 'Haze_Zap82',
                     'XxDanc3rFir3EchoxX', 'JulianV3n0m2017', 'Ech0RiftPanda', 'AsherSaber83', 'XxSlime_ChillxX2003',
                     'DragonInfernoMoon201', 'DuckM00n20', 'Ech0Eagl32006', 'SebastianZeroPrism20', 'P0werBac0n2018',
                     'Miner_Gh0st201126', 'SophiaGlitchPro', 'Chl0eLuckyTurb02007', 'XxTiger_QueenxX2012',
                     'KingIceCyber201415', 'Dark_Circuit33YT', 'HunterCraftBear27', 'WillowDrift17',
                     'JulianCookieLava92', 'AvaPixelCrystal55', 'RocketIce37', 'XxJaydenInfern0Night',
                     'PixelBlizzardWraith8', 'Ow3nPr098', 'DancerKnightOrbit200', 'Rider_SLIME52',
                     'XxBrooklynChillRiftx', 'SparkEch0S0nic2003', 'InfernoIce89', 'TurboVip3r201048',
                     'XxEzraRiftSparkxX', 'JackShadowMoon2014', 'Zer0Z00m200786', 'Ahlesprock15799', 'Seardkin1365',
                     'Lonandubil24987', 'Boutskaman0457', 'Pryerbibee071', 'Zhusiami1953', 'Apanafeil264',
                     'Smarhiro3151', 'Hilsnuma755', 'Breonkury2355', 'Zaghikador4614', 'Chaislaule2892',
                     'Rogetmenz13163', 'Amantlison426', 'Naplibal55596', 'Guppydex50932', 'Gandyshuma165',
                     'Nojuslyday63476', 'Targlooi148', 'Naglaimes0810', 'Howdpaleo1902', 'Matiaspady2371',
                     'Pigeelisk60124', 'Holeslady6671', 'Kevercolie2341', 'Marchandoh42300', 'Silosgripp815',
                     'Weixkodat2200', 'Cittibirky17585', 'Sopkokobb573', 'Lammimik688', 'Cahakemmye5386',
                     'Nnadilindl22183', 'Elbonirick895', 'Abeerhurte2772', 'Weltichiou591', 'Phanshey041',
                     'Betercores3912', 'Stephpuka153', 'Srourynoa290', 'Barckoxlaj5797', 'Pancowyman27967',
                     'MichaelZ00mW0lf', 'Ice_Drift2017', 'XxMinerCyberxX200367', 'C00ki3_Om3ga62', 'FrostChaos79',
                     'FireGolden59', 'BeastJellyBlaze38', 'Stormy_Jelly53', 'V0rtex_Builder2017', 'PulseCrystal200654',
                     'XxWraithV0idCyberxX', 'Scarl3ttOm3gaPrism', 'Ban3Pix3lPro2004', 'BlastPh0enix37',
                     'XxHeroEchoStarryxX', 'Z00mTiger62', 'St0rmy_Lucky38', 'XxWolfNinjaxXYT', 'GraceNinja60',
                     'ChaseToxic201758', 'XxBlazeLegendCraftxX', 'ScarlettGolden97', 'CrazeCraftMystic',
                     'XxSkater_GoldenxX200', 'XxJack_UltraxX71', 'SlimeGhostMystic', 'PandaChaos19',
                     'SamuelCookieBuilder2', 'XxBr00klynnBan3Build', 'JaydenZapGlitch99', 'LaylaBuilderHer0',
                     'XxSparkStormyCraftxX', 'StarryRavenFlame', 'EpicHyperBane', 'ElijahLuckySab3r',
                     'XxStreamUltraxX91', 'Jam3sPho3nixTurbo201', 'ChillNinjaGlitch20', 'Pix3l_Mystic53',
                     'Michael_Omega201262Y', 'XxZap_DRIFTXX2007', 'XxWraith_PandaxX2023', 'DragonJ3llyStorm',
                     'RileySparklyFlick', 'Ash3rBan342', 'OmegaFlickSpark', 'Cyb3r_Drift99', 'StormMax86',
                     'XxQueenPixelNinjaxX4', 'Dani3lPow3rTig3r', 'XxHazelViperSonicxX2', 'CookieStormDancer_YT',
                     'Legend_Zero86', 'SparklySparkLava', 'Craz3_Panda2015', 'HazeMaxCircuit2011', 'Inf3rnoIc355',
                     'BlastGhostChaseYT', 'B3ar_NIGHT69', 'Mast3rFlashS0nicYT', 'OliverVenomPhoenix20',
                     'PrimalArr0wStealth', 'TurboVenom2021_YT', 'BaneFireBacon2018', 'AvaProRider',
                     'LightSparklyPanda201', 'SkaterNovaZoom2019', 'Pow3rDark2023YT', 'Ghost_ALPHA68',
                     'WilliamGold3nVip3r20', 'Haz3FusionChaos', 'Spark_J3lly2018', 'CarterTurboFusion200',
                     'Raven_Shadow17', 'VenomTigerGhost2015', 'Byte_Duck70', 'HunterDuck73YT', 'Craz3FusionMin3r2008',
                     'SparklyChase200960', 'DuckTigerTurbo2024', 'C00kieBlizzard2019', 'OliverWraithNightYT',
                     'JackChaseZoom', 'SparklyDarkVenom37', 'CrazeTurboNight2005', 'XxFox_KnightxXYT', 'Muterbahen3991',
                     'Macerbaray62229', 'Cuvagoble21768', 'Talvycone47044', 'Dayersniff023', 'Gucemerkl736',
                     'Chalabalot8805', 'Rebazhumi8521', 'Tungfoto534', 'Hixonsaeki6875', 'Kaeacaspe1133', 'Khunbule480',
                     'Engetcesur020', 'Scuramarze180', 'Redlecomo72542', 'Theyawayne961', 'Dedajosner55334',
                     'Hakimjamar533', 'Calizluger5505', 'Kyhnalbin58787', 'Lankperro731', 'Semkosine5019',
                     'Coinsspiry27270', 'Piatzpovey4990', 'Johnmerka7011', 'Wnukpealo9845', 'Feyssuran04720',
                     'Aldaboze5342', 'Tualabruh4166', 'Deurnaly250', 'Lovethemry072', 'Nasauhrik4113', 'Lahnejanda738',
                     'Sporysaenz488', 'Zdontrama8427', 'Genekokx0073', 'Luppsorah0123', 'Daseedge173', 'Corinkilly6737',
                     'Lewindecos8032', 'Dalanlubow562', 'Homaihara14581', 'Kellirhion7530', 'Oxleyczaja481',
                     'Kotiseagar5562', 'Maudeagli417', 'Rannaasid101', 'Bayacurio71799', 'CraftPixelChill2023',
                     'StarryBlockRocket200', 'Brooklyn_Omega201343', 'SavannahChillSlime', 'WolfJelly89',
                     'XxRocketKnightxX25', 'S0nicW0lfHawk58', 'Ultra_V0id84', 'MasterFlashBlast', 'KnightByteAce2023',
                     'LionToxic27', 'BaconJellyFlash2003', 'HarperUltraToxic', 'JackDarkVortex', 'AlexanderG0lden57',
                     'JACKS0NBYTETHUNDER_Y', 'PrimalPrismSkater201', 'JulianSaber201082', 'ShadowMagicEpic',
                     'SparkH3r0201112', 'Fr0stLava202292', 'XxDark_HeroxX33', 'BlazeToxic201317', 'PrismByt3Ban3',
                     'Slime_Light92', 'Br00klyn_V0rtex59', 'XxNovaClawxX2008', 'AriaWraithBear2015',
                     'Fr0stStr3amZ3r02024', 'BaconBan3Primal', 'OwenOmega25_YT', 'XxFlashNinjaxX2020',
                     'ChillFlam3Rid3r', 'CircuitGhost201885', 'XxJaxonIcexX40_YT', 'ZoomBear99', 'StreamFoxDrift',
                     'RiftVenom45', 'XxL0ganEpicxX2014', 'GAMER_Chill42', 'BaneFusionCyber', 'JackDarkCraze',
                     'DarkUltraIce35', 'ShadowVenomByte2009', 'GHOST_Craft51YT', 'StealthUltraBlaze201',
                     'XxStormSkyxX92', 'XxPowerStormyIcexX', 'Oliver_Turbo83', 'JulianGamer2024YT',
                     'XxDragonSlimeFrostxX', 'Ninja_Sab3r61', 'WillowFlickSonic2022', 'LOGAN_Slime67YT',
                     'GigaNe0nAqua49', 'DanielNinjaVortex', 'MaxFury201877', 'Dark_CIRCUIT2013YT', 'V3nomFrostN3on2010',
                     'Eli_Blast65YT', 'AquaChill57', 'Xx_HAZ3LL3G3NDGLITCH', 'JellyInferno201546', 'Saber_Hero20',
                     'AceBearG0lden', 'HazelArr0wCraze', 'OW3N_Flam384', 'HyperHeroStar2011', 'XxMate0PandaxX202241',
                     'Galaxy_B3ar90', 'XX_BrooklynPixelNeon', 'NightCooki3Knight', 'XxMaxRavenFlashxX',
                     'XxSlime_OmegaxX2012', 'Queen_Storm24', 'Al3xand3rRiftC0d3', 'MysticVoidBlaze36', 'Sab3rArr0w52',
                     'XxLaylaSparkAquaxX', 'JamesZoomLight', 'WyattIc3Haz3', 'Thund3rRogu3Ban32003', 'LightPandaHyper',
                     'EllieBear202276', 'OliverS0nic41', 'Micha3l_Turbo201140', 'WilliamDriftNight',
                     'XxQueenRiftGlitchxX2', 'Fir3_Crystal2014', 'NovaAceSonic', 'XxTigerPixelTurboxX', 'ZapHyp3r2011',
                     'Master_Gamer201219', 'Claw_Bane51', 'BearVortexFlame2024', 'Mast3rLava77', 'SaberHeroArrow2009',
                     'EliGalaxyBlizzard27', 'XXL0GAN_Shad0wxX2005', 'AbigailT0xicP0wer', 'LaylaHyperEagle2012',
                     'LightFlickMaster2013', 'EzraAquaCooki3', 'XxEzraC00ki3xX54', 'SonicB3ar2022',
                     'Xx_CharlottePlayzRav', 'Pr0_P0wer71', 'HawkFrostCode23', 'FireSparkOmega64', 'Moon_INFERNO2014YT',
                     'Void_Ace86', 'Xx_DancerDuckPh0enix', 'XxVoidCrystalRiftxX', 'AbigailFuryGlitch202',
                     'Chlo3GlitchBlast84', 'Blaz3Block201298', 'JellyLightBlaze', 'Jackson_Max47', 'Str3amN3on2003',
                     'XxH3nry_HawkxX17', 'BeastFireN0va', 'SparklySlimeStar14', 'RileyBlockFusion2017',
                     'BuilderKnightCraze_Y', 'BeastArrowMagicYT', 'XxAddisonDarkxX17', 'DarkQueenFlame201961',
                     'Pixel_Sky51', 'DuckSkyRift2010', 'LukeStormyLegend', 'XxLion_AcexX2008', 'AsherNinja51',
                     'Block_ROGUE35', 'WillowEchoCyber2020', 'XxBaneInfernoToxicxX', 'MichaelCircuitTiger8',
                     'ClawBaconPrism2004', 'HannahR0gue2004YT', 'ZapZ00m2018', 'XxPro_NightxX10', 'XxMat3oDriftxX35',
                     'Sebastian_Cyber25', 'ArrowStormy93', 'LiamWolfDawn', 'Micha3l_Sky23', 'Slim3Haz3Hyp3r',
                     'AidenDancer65', 'DawnSilverBeast', 'SkaterZer0Tiger20127', 'WilliamSkaterOmega',
                     'Bl0ckCrystalArr0w', 'DawnUltra16', 'XxBeastPrimalDuckxX7', 'BearThunderStar2010',
                     'XxB3arFir3xX96', 'GoldenPrismHawk', 'Hannah_Miner60', 'Ow3n_Starry47', 'FlickPixelFox',
                     'WyattN0va64', 'Hyp3rBan327', 'LukeSilverGlitch2004', 'XxEchoToxicCyb3rxX', 'NovaTurboHyp3r2004',
                     'KingRavenHaze2023', 'DuckChas3Vort3x2022', 'LunaPixelCraft', 'CarterKingBlast',
                     'StealthHawkPandaYT', 'Br00klynEpicVip3r201', 'ZoomBacon202430', 'LukeOrbitFusionYT',
                     'XxBuilderFurySilverx', 'ElijahChaos202143', 'XxEzra_AlphaxX52', 'NoahByt3Ghost', 'DanielWraith98',
                     'Nikicphun2319', 'Lomeoopray67584', 'Baruaarbor162', 'Routepade04659', 'Foundleet17930',
                     'Kempsbori556', 'Nealsklamm738', 'Raffypohle696', 'Grisshk577', 'Lewanqais969', 'Mekaribis0173',
                     'Luttepivik963', 'Pihanissy89515', 'Zarkonacht44010', 'Momaszady3581', 'Chikadeeg1922',
                     'Isicbemo60050', 'Sutakmeske903', 'Muhmemin563', 'Bernjunie72525', 'Donineinig5999',
                     'Bozerlesar21431', 'Terivetor5554', 'Jirkaiken639', 'Saulsnavya924', 'Rasiabipes948',
                     'Laildokko58189', 'Kyzatardi5689', 'Mincyelks319', 'Isbelleif443', 'Kobimogk17923',
                     'Elbleajero25623', 'Mickagorab336', 'Mitlogetch091', 'Villelonn647', 'Nafusraum12136',
                     'Fainabnr52656', 'Porchsanic9851', 'Boeyiyer090', 'Roakheck96721', 'Streubenet27093',
                     'Raurilgen0780', 'Surlsmahat3446', 'Elddendy89181', 'Geersmonez184', 'Algeegiomi2504',
                     'Halahlyon90103', 'Karbopuk551', 'BlazeHero200322', 'XxMasterLegendxX35_Y', 'AsherThunderInferno',
                     'StormyLegend32', 'BearF0xCrystal', 'WraithZeroEcho2016', 'OliverFr0st78', 'L0ganDancer37',
                     'XxWraith_ProxX2014', 'Will0wV0idLava', 'XxWillowCookiexX2005', 'DarkEch0V0id2004',
                     'Byt3St3althLucky', 'HeroTurboChase2015', 'SilverQueenChase2007', 'Zo3Blast202174',
                     'L0ganMasterLucky', 'WolfCyberSlime', 'Ne0nDrag0nR0cket2017', 'NoraByte200977',
                     'XxLogan_ShadowxX2010', 'PlayzKing200860', 'Li0nIceRift2022', 'JaxonZ3roSky',
                     'XXBUILD3R_StormyxX58', 'XxWraithMagicxX48', 'Thunder_Phoenix18', 'EchoRoguePixel',
                     'XxRocketHyperAquaxX', 'L3G3ND_King2024', 'EpicBlad3Alpha73', 'FlickMagic62',
                     'GabrielUltraBuilder2', 'KayleeMiner76', 'Ash3rBlockTurbo', 'XXCYBER_ClawxX73',
                     'XxPowerCookiexX55', 'XxVictoriaByteLionxX', 'BlastBlockClaw2021', 'FuryBlockByt3',
                     'ToxicJellyTurbo', 'Xx_BuilderHyperGh0st', 'Munioroz0999', 'Yotamkeser64563', 'Meuxpyers68942',
                     'Jevnestirn75760', 'Dubeshumel83354', 'Rianehusen34796', 'Kuestboken4375', 'Khoukeva700',
                     'Holupkluck9813', 'Fainaglumm531', 'Gilbyrork1132', 'Auyonuno8107', 'Kobbetkacz1316',
                     'Toveyiee84713', 'Fynespaver5208', 'Motlfinno306', 'Raguituran007', 'Davessheng626',
                     'Buistdorch1429', 'Mehnapker12863', 'Kehvicta9200', 'Jasabisel84839', 'Maanbemus37516',
                     'Cagnableh844', 'Texaskroes23706', 'Papajdaez591', 'Veirswilds72128', 'Hagiezikas84245',
                     'Nokesfusco7547', 'Ekeyadna9212', 'Gloebecho077', 'Rizekgrepo7002', 'Oppiesadee800',
                     'Aideasnis536', 'Klochkaval579', 'Caiseedgar95502', 'Lexercabus6790', 'Arvanklesh111',
                     'Cornugengo98790', 'Yelinlalka955', 'Pearsebe988', 'Lewybury9547', 'Motetatti6534',
                     'S0nicHyperGiga2017', 'CarterLi0n98', 'XxMagicCircuitNeonxX', 'JellyFusi0nCraft',
                     'PixelatedLava71', 'XXLOGAN_GoldenxX53', 'MysticFoxStealth', 'Noah_Pulse78',
                     'XxAceCookieGhostxX20', 'NinjaZeroLight28', 'Pix3lat3d_Craft20104', 'Pr0Her0Flick70',
                     'XX_St0rmyLegendFlash', 'MagicN3onRock3t64', 'ShadowBuild3r83', 'EzraBlastNinja', 'ZapBaconSilv3r',
                     'CrystalSparkOm3ga', 'ZapHunt3r2014', 'HunterGamerGoldenYT', 'RiftFlickV0id2005',
                     'KnightSaberLava2022', 'XxPrismBuilderxX2003', 'XxOliviaSparklyxX_YT', 'GalaxyClawEch0',
                     'RocketClawBuilder', 'BrooklynnToxicPro_YT', 'ThunderSaberAce', 'XxHenryStreamLavaxX',
                     'BuilderByteOmega2009', 'LuckyNe0nSt0rmy2017', 'OrbitZ00mViper2023', 'OrbitGhost70',
                     'XxBacon_RiftxX11', 'FlameOrbitSky2007', 'StarZoomFox45', 'SkaterBuilder30YT', 'HazePowerAlphaYT',
                     'BrooklynnChas3YT', 'AbigailMagicKnight20', 'ARROW_Lucky99', 'UltraCyb3rH3ro2008',
                     'HannahBac0nBlaze', 'Z03S0nic21', 'Giga_Jelly36', 'Charlott3Thund3rBlaz', 'BlastZero202048',
                     'SkaterBac0nPh0enix', 'XxMysticPrimalxX82YT', 'XxPaisleyZoomPrismxX', 'XxPrimal_EchoxX2018',
                     'B3arAlpha61', 'XxGraceBuilderxX43', 'GlitchGiga201079', 'AidenPrismV0id', 'XxAidenLuckyNe0nxX',
                     'Flame_RogueYT', 'FlickLionWraith', 'XxRileySonicxX2015', 'WilliamCha0sBl0ck', 'JELLY_Legend46',
                     'XxToxicPow3rSparklyx', 'XxCod3DuckPix3lxX', 'HazeHyperHawk92', 'WillowSkyOrbitYT',
                     'SlimeSonicSaber', 'KayleeRocketInferno', 'ShadowV3nom77', 'Silv3rGhostStarry', 'Jam3sSonic2009',
                     'DUCK_Blast47', 'H3roVip3rUltra', 'FrostHawkStream', 'ChaosLegendChase', 'Isaac_Lion28',
                     'DawnFoxZero32', 'Am3liaMoonBlastYT', 'XxBr00klynn_RiderxX4', 'Xx_Skat3rOm3gaDragon',
                     'LunaDuckPhoenix', 'PulseDawnBlade201575', 'XxGoldenBlizzardKing', 'T0xicZer0Glitch65',
                     'Fr0st_MYSTIC2007', 'Micha3lCraz3Playz', 'Ban3R0ck3tYT', 'Cart3rMoonCod32003', 'JackWraithZap2016',
                     'Chl03C0d3Blast2008', 'Xx_Scarl3ttBlockCraz', 'Build3rBlaz382YT', 'XXNOAH_SparkxX2005',
                     'Stream_Chill22', 'SaberSkaterPixel2023', 'SebastianRiderHyper', 'HazeQueen45',
                     'LaylaUltraHawk2013', 'XxCraz3_Skat3rxX2022', 'JackCode202333', 'ChaosHawkWolf2015',
                     'MichaelProLegend2011', 'DawnBlast202018', 'LavaCod3Skat3r', 'StarGigaAc3', 'StormyDark200442',
                     'LavaChase20', 'OmegaNinjaGalaxy42', 'LionWolf97YT', 'LionDriftLava', 'Haz3FrostBuild3r',
                     'CARTER_Drag0n55', 'GraceAcePower2015', 'Glitch_Galaxy201758', 'XxCharlotteDawnChill',
                     'KingFlick30', 'T0xicF0xV0id', 'BlizzardPower21', 'ThunderStarKnight19', 'Ninja_Lava201042',
                     'Bokenmiggo571', 'Dubonevick60573', 'Deiondyals89024', 'Sewakhayde98967', 'Mahdilamph1728',
                     'Besereble8495', 'Rookarnos9276', 'Nurdaga8106', 'Reskausko294', 'Hurllamo785', 'Axtdyett960',
                     'Sacksbumps1110', 'Baroifroid270', 'Lozofauss1688', 'Aimagocke26035', 'Melihianis86905',
                     'Uyemasagle1715', 'Kiahraser9994', 'Uramarga1474', 'Petakborja66346', 'Diorabowie3333',
                     'Behmeochoa637', 'Dahirduodu28001', 'Olafbootz08127', 'Vilabokar946', 'Kotektobal478',
                     'Boireflash87259', 'Audaslowin56630', 'Krummfobb6573', 'Ganunbrost531', 'Heldkarli625',
                     'Asibaris3193', 'Abdooller79377', 'XxBeastToxicxX25', 'S3bastianUltraLight6', 'PandaBl0ckSparkly',
                     'XxJ3llySparklyxX2011', 'Mas0nLight44', 'Sky_C0DE56', 'ToxicFuryFlame', 'PlayzLava75',
                     'Vort3x_Chas32014', 'BrooklynSlime41', 'SonicSkater41', 'ByteNovaCrystal', 'ZoomVoidPower200818',
                     'ShadowZoom91', 'IsabellaS0nic2006', 'CodeCookie37', 'XxJaxon_HeroxX28', 'AidenEpicNight2019',
                     'XxChillFrostFlashxX', 'MoonBlizzardByte', 'BaneRocketBlock', 'DawnP0wer68', 'FlashRogu382',
                     'XxEllieZapxX22', 'ZoomDanc3rYT', 'IsabellaLightFox2021', 'RogueCrazePixelated',
                     'LavaDawnThund3r2020', 'AidenGhostLight20153', 'ViperPrism2004_YT', 'StormyDanc3rRock3t',
                     'FlickVoid90', 'SavannahStreamZ00m20', 'Phoenix_Viper77', 'GhostMaxV3nomYT',
                     'Inf3rnoVort3xDark201', 'StreamEagleBane', 'M00nBlade19', 'XxVictoriaJellyxX55', 'MiaP0werCraze',
                     'XxRav3nSlim3xX41', 'XxAceSkyFlamexX', 'Moon_Cyber42', 'Luntzaidt0428', 'Llaveroof662',
                     'Swetsrenae69838', 'Saxeynolde8340', 'Recaruehr2935', 'Dyrudgut032', 'Tuperdutra359', 'Zetseon491',
                     'Doumaches901', 'Lellobaul1467', 'Darohman0118', 'Hazaltoy546', 'Keagyelset211', 'Pillrosso5340',
                     'Mizengolle304', 'Krohasalu6282', 'Sabreetty501', 'Mostbruk83424', 'Weeseseet99240', 'Reifred4817',
                     'Seybnerte153', 'Laziodacre608', 'Mohonleho169', 'Cacygaume0407', 'Herbberte220', 'Vahsusie4156',
                     'Riestieu03249', 'Harryogan031', 'Orttloron3047', 'Wasifkahla6177', 'Helfbinge6341',
                     'Jeuncurll9774', 'Eivapiya140', 'Njaididi48274', 'Surralosey541', 'Kosecyray739', 'Vianprez204',
                     'Knaushamka01897', 'Lahuemckay8587', 'Leidsyta35511', 'Jubieshega242', 'Dasojack2330',
                     'Freetarze204', 'XXGLITCH_BeastxX99', 'JackVoidViper39', 'DriftPh0enixChill',
                     'Xx_TurboFlickThunder', 'JulianSkat3r50YT', 'N0vaR0cket2003', 'Julian_Silver2003', 'UltraHawk95',
                     'FlameRiderStream49', 'Cart3rPuls3Qu33n56_Y', 'DawnPixelMiner2014', 'FoxRiderStealthYT',
                     'XxSparkBladexX201053', 'IsaacZapKnight2003', 'PrimalCircuitRift', 'XxEpicGlitchPixelate',
                     'BAC0N_Lava2005', 'XxStorm_RID3RXX76', 'CHASEGALAXYNEON49_YT', 'INFERN0_Beast2004',
                     'GabrielDarkAce57', 'Shad0w_Ninja2011', 'LightSt0rmy41', 'Miner_N0va2012', 'KingChillPlayz46',
                     'StealthNova2010_YT', 'XxInfernoHawkxX20099', 'Isab3llaAc3King2012Y', 'EchoCooki332',
                     'XxCircuit_PixelxX95', 'F0x_FLICK73', 'Ice_Arrow16', 'Tig3rBlock55', 'Skat3rShadowTurbo_YT',
                     'Xx_St3althV3nomBlizz', 'PandaZero52', 'JellyBuilderEch02008', 'DuckInfern0Shad0w',
                     'BuilderMiner202050', 'L3g3ndPho3nixPuls3', 'EvelynByteEpic2007', 'Ic3PrimalDragon',
                     'LavaDanc3rRogu3', 'SonicBlad3V3nom2014', 'M00nC00ki3200225', 'EzraFrost17',
                     'SavannahEpicRaven200', 'TurboToxicB3ar', 'LoganIceKnight2008', 'ThunderBeast201627',
                     'QUEEN_Wraith201448', 'Xx_VortexSonicSkater', 'KingSilver201560', 'XxPulseByteFlashxX',
                     'XxDragonFlickxX60', 'DragonFlickBear', 'ShadowRiftHaze_YT', 'Ice_Turb02010', 'RocketFlameSaber',
                     'XxStormyTigerMagicxX', 'XxPulseBlazeCircuitx', 'DancerOrbitStormy201', 'Skat3rFusion44YT',
                     'XxHyperToxicxX42_YT', 'GalaxyGamerAqua2004', 'CrazeChase2008', 'AddisonLionOrbit',
                     'LoganCrazeKing31', 'ViperLava34', 'XxJackSonicxX59', 'OmegaMinerShadow2022',
                     'XxNoah_MasterxX2013', 'PowerChillBlizzard', 'Xx_AuroraLuckyBuilde', 'XxPaisleyStarShadowx',
                     'Glitch_C0de2022', 'XxBearCraftxX93', 'XXTOXIC_LavaxX24', 'XxGrays0n_HunterxX14',
                     'LavaDanc3rB3ast23', 'AddisonHawkAce', 'PaisleySkaterFrost22', 'XxAlpha_GlitchxX2007',
                     'ShadowTurboChaos2015', 'WraithGalaxyWolf2005', 'Vict0riaSkyPlayz', 'XxKayl33Ph03nixxX200',
                     'AbigailP0wer2016', 'FusionGhostClaw17', 'XxEllaLionGalaxyxX', 'LiamPhoenixPower',
                     'CookieDragonFlick50', 'Pow3r_Echo81', 'XxDancerSilverxX43', 'PulseDark28', 'EchoGlitchRift2020',
                     'Ban3Om3gaRift2024', 'James_Builder68', 'XxFrostCrystalAlphax', 'SavannahTig3r87',
                     'SparklyEagl340', 'Blaz3Star2016', 'BaneStealth21', 'C0deSaber31', 'AubreyFire95YT',
                     'XxQu33nPix3lOm3gaxX', 'XxPrimal_PowerxX2008', 'MinerBlazeEcho2024', 'LightMagicDark2012_Y',
                     'XxElla_UltraxX2018', 'DragonPanda62YT', 'LavaMysticDragon2004', 'Power_Ultra41',
                     'CyberMinerAqua_YT'}
local RECEIVER_LIST = {'Noartym775', 'Lerisatur12704', 'AuroraMoon41', 'HunterSkater2003YT', 'HENRY_Flame38',
                       'Bane_Sonic2017', 'Darjiduka28839', 'Cielrable1406', 'EmmaPrismGlitch54', 'XX_CircuitBlastFusio',
                       'SlimeDriftLegend2008', 'CrazeRavenEch0', 'Badintaome81313', 'Rabotchyle9611',
                       'ByteChillFire2016', 'Haze_Dawn59', 'FlameOrbitGlitch21', 'N0raViper2022', 'Krailrenko5196',
                       'Szmytkalb7223', 'Ayanawyss315', 'Aur0raStarBeast', 'HawkP0werClaw2006', 'XxN3onBlastxX21',
                       'Ethan_Duck2008', 'Xx_NightPrimalCrysta', 'UltraSparkPanda2004', 'Bacon_Hunter201523',
                       'Otvosdimon948', 'Boerspuni7995', 'AbigailAceByte2006', 'DawnDrag0nV0rtex', 'Titopless102',
                       'Lanyijaz2416', 'Z3RO_Max2005', 'XxGh0stShad0wFuryxX', 'Rocket_Rider2017',
                       'XxScarlettClawFlamex', 'Knight_ST0RMY96YT', 'Z00m_Ace2006', 'Sclarprogl84735', 'Ruhspivar2473',
                       'Ace_Frost202076', 'MaxLightDark_YT', 'Rafewohlt9627', 'Komoirah34583', 'XxBuilderArrowCodexX',
                       'StarryOmega2007YT', 'Build3rB3arEpic', 'ShadowMin3r2016', 'Zer0BuilderPh0enix',
                       'OmegaBlade202331'}


-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ตัวแปรสำหรับ timeout การรอเริ่มเทรดหลังส่งคำขอหา receiver
local SENDER_REQUEST_TIMEOUT = 200 -- วินาที
local lastSentTargetName = nil
local lastSentTargetIsReceiver = false
local lastSentTime = 0

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันหาผู้เล่น sender ที่ว่าง (ค้นหาเฉพาะ sender)
local function FindAvailableSender()
    local result = nil
    local success, error = pcall(function()
        print("🔍 กำลังค้นหา sender ที่ว่าง...")

        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                        tradingValue = player.Settings.Trading.Value
                        isAvailable = (tradingValue == false)
                    else
                        isAvailable = true
                        tradingValue = "unknown"
                    end
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " .. tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print("❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบ sender ที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindAvailableSender: " .. tostring(error))
    end
    return result
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    local tradeGuiSafe = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
    if not (tradeGuiSafe and tradeGuiSafe.Enabled) then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    -- Sender สามารถรับ trade request จาก sender อื่นได้
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Sender พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local mobileFrame = requestsFrame:FindFirstChild('Mobile')
        if mobileFrame then
            for _, child in pairs(mobileFrame:GetChildren()) do
                if string.find(child.Name, "^Trade") then
                    local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                    if IsInList(senderName, SENDER_LIST) then
                        print("✅ Receiver พบ trade request แบบ Mobile จาก " .. senderName .. " กำลัง accept...")

                        -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                        lastTradeRequestTime = tick()

                        Clicked_Ui(child.AcceptButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                        return true
                    else
                        print("❌ Trade request แบบ Mobile จาก " .. senderName ..
                                  " ไม่ตรงกับรายชื่อ กำลัง decline...")
                        Clicked_Ui(child.DeclineButton.UpperLabel)
                        task.wait(.1)
                        Click_NOW()
                    end
                end
            end
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request แบบ Other จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            -- รีเซ็ตสถานะการส่งคำขอค้าง
            lastSentTargetName = nil
            lastSentTargetIsReceiver = false
            lastSentTime = 0
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            -- ถ้าส่งหา receiver ค้างไว้นานเกินกำหนด ให้ลองหา sender ที่ว่างแทน
            if lastSentTargetIsReceiver and lastSentTime > 0 then
                local elapsed = tick() - lastSentTime
                if elapsed >= SENDER_REQUEST_TIMEOUT then
                    print("⚠️ รอเริ่มเทรดกับ receiver (" .. tostring(lastSentTargetName) .. ") นานเกิน " .. SENDER_REQUEST_TIMEOUT .. " วินาที กำลังหา sender แทน...")
                    local fallbackSender = FindAvailableSender()
                    if fallbackSender then
                        SendTradeRequest(fallbackSender.Name)
                        lastSentTargetName = fallbackSender.Name
                        lastSentTargetIsReceiver = false
                        lastSentTime = tick()
                        return 0
                    else
                        -- ปรับเวลาเพื่อหลีกเลี่ยงการ spam ตรวจซ้ำทันที
                        lastSentTime = tick()
                    end
                end
            end

            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
                -- บันทึกสถานะเป้าหมายล่าสุดที่ส่งคำขอ
                lastSentTargetName = validPartner.Name
                lastSentTargetIsReceiver = IsInList(validPartner.Name, RECEIVER_LIST)
                lastSentTime = tick()
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        -- เคลียร์สถานะการส่งคำขอค้างเมื่อเข้าสู่หน้าต่าง Trade จริง
        lastSentTargetName = nil
        lastSentTargetIsReceiver = false
        lastSentTime = 0
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- Coroutine ปิดหน้าต่าง CreatureInventoryFrame อัตโนมัติ (ทำงานเบื้องหลังตลอดเวลา)
local function InventoryCloserCoroutine()
    spawn(function()
        while true do
            local success, error = pcall(function()
                local playerGui = LocalPlayer and LocalPlayer.PlayerGui
                if not playerGui then return end

                local tradeHudGui = playerGui:FindFirstChild("TradeHUDGui")
                if not tradeHudGui then return end

                local bottomFrame = tradeHudGui:FindFirstChild("BottomFrame")
                if not bottomFrame then return end

                local creatureInventoryFrame = bottomFrame:FindFirstChild("CreatureInventoryFrame")
                if not creatureInventoryFrame then return end

                if creatureInventoryFrame.Visible == true then
                    local closeButton = creatureInventoryFrame:FindFirstChild("CloseButton")
                    local upperLabel = closeButton and closeButton:FindFirstChild("UpperLabel")
                    if upperLabel then
                        local safetyCounter = 0
                        while creatureInventoryFrame.Visible == true and safetyCounter < 30 do
                            Clicked_Ui(upperLabel)
                            task.wait(0.1)
                            Click_NOW()
                            task.wait(0.2)
                            safetyCounter = safetyCounter + 1
                        end
                    end
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน InventoryCloserCoroutine: " .. tostring(error))
            end
            wait(0.5)
        end
    end)
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- เริ่ม coroutine ปิด CreatureInventoryFrame อัตโนมัติ
        InventoryCloserCoroutine()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
