-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'DanielStarry41', 'Slime_MAX49', 'Daniel_Chaos201614', 'XxOmegaPandaxX54', 'KnightPho3nix89',
                     'Xx_BYTEPRISMBLIZZARD', 'Daniel_Pixel200621', 'Builder_Dawn39', 'ElijahTiger29', 'OfuthareRest',
                     'XxBlastIceCraftxX', 'XxOlivia_Build3rxX92', 'Xx_R0cketGlitchSt0rm', 'KayleeHazeRift',
                     'HawkArr0wDrift', 'FlameOrbitFusion', 'PixelatedOmega_YT', 'AddisonEagleQueen', 'AmeliaMinerNova',
                     'XxGabri3lQu33nxX_YT', 'DawnCrystal56_YT', 'XxCodeWolfxX71', 'Mateo_Pixel201131', 'RiderPanda88',
                     'AceZ00m75', 'AUBREYBANE2012_YT', 'OwenQueenStealth2009', 'GoldenCode202273', 'EchoLionFrost45',
                     'B3ar_Drift2005', 'WilliamPulsePanda', 'MichaelShad0wCha0s', 'SavannahEchoTig3r',
                     'Will0wPlayzLight', 'XxGrac3Byt3xX54', 'HenryMystic37', 'XxSparkOrbitxX64', 'NovaGhostFusion',
                     'Stream_Pulse202033', 'XX_CookieLuckyDancer', 'PixelatedKingLegend2', 'ZaydenC00kie20',
                     'MagicStormPulse', 'OrbitQueenDancer', 'imorsiteDsat', 'OmegaGigaBlizzard32', 'XxSkyIcexX92',
                     'ChaosFusion13', 'LukeV0id41', 'FrostMax202246', 'HeroHawkSparklyYT', 'Drift_CHA0S2009',
                     'XxViperHawkxX2024', 'CraftKingMaster', 'CarterPr0Drift', 'StormyMysticSpark201',
                     'XxLoganWolfxX2016', 'Ella_Zap72', 'FlameSparkly201642', 'RiftChillSilver2008', 'Alexander_Epic39',
                     'Victoria_Circuit88', 'JellyCrazeGiga', 'ViperStarryBear', 'Grac3Craz3H3ro', 'LukeEagle200469',
                     'Xx_JacksonGlitchRide', 'SaberBlast17', 'Logan_ROGUE2014', 'Blaz3HawkFusion', 'BaconCyberGalaxy',
                     'Craz3MysticRogu32024', 'XxWraith_PixelxX2012', 'Ultra_Flash20', 'VenomWraith45', 'JaxonClaw48',
                     'Rav3n_Qu33n2015', 'Bac0nSparklyPr0', 'Charl0tt3Z00m2005', 'Al3xand3rFrostMin3r',
                     'WillowHunter200463YT', 'T0xicVen0mOrbit', 'Will0wFusi0n68', 'SonicCrystal30',
                     'DarkStarryLegend2006', 'RogueHeroCode31', 'EnoutheRinor', 'Ash3rQu33n201960', 'PounoraiSsin',
                     'ArrowCookieVenomYT', 'TigerCraftMystic60', 'Bac0nSkater99', 'Xx_Mate0CircuitStarr',
                     'LiamStream202286', 'CraftRiderHawk', 'InfernoToxicZoom', 'Cha0sSt0rm2012', 'HenryPlayzInferno65',
                     'JamesSparkly201552', 'Xx_CrystalKnightKing', 'Silver_FURY72', 'Kayl33_Hawk2004', 'AidenNe0nAce',
                     'S3bastianHyp3r49', 'Cod3Max29', 'AuroraNightPixel2007', 'DancerFuryNova2003', 'Jam3sNinjaCrystal',
                     'OrbitMasterBl0ck2024', 'Jayden_Rider202218', 'MysticZoomPow3r2016', 'BlazeJellyClaw2015',
                     'JACK_St0rmy98', 'XxJaxonFlamexX2022', 'HyperMoonZap33', 'LiamC0deKnight', 'XxHenryPrimalCookiex',
                     'XxLuckyRiftxX2014_YT', 'OrbitCookieBane', 'NussofeRatho', 'StarryMagicKnight', 'Levi_Cyber65',
                     'SophiaSparklyKnight', 'EsusesteNofo', 'BANEPULSESPARK_YT', 'FusionAquaVoid_YT', 'XxScarlettZapxX',
                     'OliviaWraithTiger', 'Mason_Fire32', 'Ezra_Rocket77', 'GoldenRiftEcho', 'PrimalSlimePhoenix47',
                     'DitrariNdaio', 'Danc3rCircuit55', 'WraithPowerInferno20', 'CircuitOmegaWraith',
                     'Fusi0nHunterMiner200', 'GraysonFrost200524', 'EzraSt3althIc32008', 'XxJaydenBanexX2005',
                     'XxWolfStealthRocketx', 'Br00klynnDrift2005', 'XxStarryPowerxX20113', 'Bacon_Nova202027',
                     'FlickVortex', 'H3nry_Stormy61', 'Craz3Pow3rCraft2013', 'SamuelBl0ckS0nic', 'SaberV0rtexR0gue',
                     'Primal_Dancer94', 'S0nic_BLAZE2017', 'Silv3rFir32014', 'AlphaPixel201356', 'LUNABUILD3R2024_YT',
                     'MoonRift65', 'ChaseToxicRogue', 'GraysonBlad32015_YT', 'CarterPixelatedByte', 'EronentuSust',
                     'Nova_Sonic2022', 'BlizzardZ3roSkat3r', 'XxEllie_DancerxX2004', 'FireZ00mPixel', 'ioundofaRest',
                     'JackFr0stSlime', 'XxWraithEchoxX2020_Y', 'AlphaPanda87', 'PrimalStormLava2005',
                     'AriaZer0Her02017', 'Hunt3rL3g3ndSparkly', 'Am3liaDrag0n2016', 'XxLuk3FlashxX2013',
                     'GigaCodeCraft', 'WilliamRock3tVip3r', 'KayleeZap200564', 'Jelly_Tiger29', 'LucasSt0rmy201950',
                     'XxChaseSparkxX2009', 'OliverChaosWolf', 'PaisleyBeast50', 'StealthCrystalDawn77',
                     'FusionProVip3r2024', 'AbigailRav3nB3ast', 'MinerPixelHyper20032', 'XxWillowUltraxX45',
                     'NoraCrystalByt3', 'Str3am_Craft92', 'VortexHunterPanda', 'CHILL_Lava16', 'XxN0va_BAN3XX',
                     'GlitchDawnOrbit', 'LeviZoomAce20', 'AsherFr0stPixelated', 'Chl03Pix3l62', 'Jayd3n_Ban32003',
                     'PlayzCraze88YT', 'HeroVortexStealth200', 'AquaCode44', 'ChloePixelVoid52', 'Code_Rocket91',
                     'EmmaStealthFlick', 'NoahDancer2009', 'XxEvelynTurboxX69', 'Byte_Flame31', 'XxVictoriaFuryBytexX',
                     'Eagl3Dawn44', 'NoahStarFox39', 'XxPaisleyArrowxX2004', 'AvaSparklyTurbo', 'Qu33nB3astStarry',
                     'WillowBlizzard201313', 'XxJaxonBlastClawxX', 'Light_Chill13', 'Gold3nFlick', 'Nova_Zap15',
                     'ingenteShung', 'DawnPlayz201946', 'AriaSilver62', 'XxHarperAlphaRiftxX7', 'GigaLavaBlade',
                     'OmichaniTear', 'NoahRid3r39', 'XxOrbitTurboRiftxX', 'Sab3rZ00m55', 'Shad0wCrazePh0enix20',
                     'ChillSaber2021', 'EchoDrift55YT', 'St0rmTigerPixelated', 'CrystalFusi0nAqua',
                     'TurboPrismArrow20142', 'Thund3rFlash2013', 'GalaxyBlad385', 'XxJaxonFireTigerxX20',
                     'PowerBaconNova', 'Aid3nPrismRock3t2016', 'Silver_Jelly200876', 'Rocket_Cookie201680',
                     'LionDuckBear201388', 'TurboPow3rZ3ro201672', 'HunterRocketSlime202', 'OliviaVoidHyper2008',
                     'ChillStarCrystal', 'BaconDark201239', 'MasterZap47', 'Flash_WRAITH56', 'PrismDark93',
                     'KnightTurboInferno', 'Ow3nZoom77', 'ChillFox65', 'MoonLion41', 'XxHyper_PrimalxX98',
                     'NinjaRocketPhoenix', 'AddisonDancerEagle20', 'PlayzCraftDrift', 'CRAZ3_St0rm2018',
                     'Dani3lFuryMast3r', 'XxHenryTurboxX201319', 'Ev3lynS0nic2011', 'Z3roStarry34', 'PrimalGh0st2005',
                     'Al3xand3rCod372', 'S0phiaFir3King', 'EpicDarkIce', 'OliviaZap201883', 'iedengoNgase',
                     'XxGrace_BaconxX57', 'Owen_Dark2015YT', 'Eagl3LuckyMoon', 'EchoMagic2017_YT', 'Aur0raUltraCircuit',
                     'Fir3StormyEpic', 'InfernoBacon2018', 'Ech0WraithPanda', 'XxAddison_LavaxX2011',
                     'DuckS0nicTiger2016', 'OliverDragonSkater', 'MysticHeroBlast2024', 'EditheriNgon',
                     'XxStealthDarkxX2002', 'XxOliverInfern0xX52', 'WolfHero80', 'L3viSpark2014', 'EagleClaw72',
                     'HunterHazeVoidYT', 'Hyp3rLucky18', 'MasonAquaByte43', 'SavannahTigerRaven20', 'Blade_VOID201563',
                     'HyperSt0rmy2023', 'LaylaSparklyDuck', 'J3lly_MYSTIC89', 'XxAubreyBaconFusionx', 'EagleBladeNova',
                     'Haze_Panda201625', 'XxBlock_MoonxX2012', 'FlashB3ast2012', 'XxLuckyM00nxX2015', 'JACK_Fire2002',
                     'Om3gaMin3rSky', 'ByteVoid83', 'Craft_Gam3r2024', 'XxOrbitN0vaxX2024', 'XxBane_S0nicxX25',
                     'HazeCookie2019YT', 'Pixel_Neon201122', 'EchoSkaterPrimal25', 'NiserendeRen',
                     'GoldenPandaDancer85', 'XxFuryCyberxX86', 'DancerPulseDuck20033', 'XxEllaPixelZer0xX',
                     'XxChlo3Cooki3Rock3tx', 'WilliamFlameAlpha57', 'EzraDuckS0nic22', 'FlameCraftDancer29',
                     'EvelynBearDrift2019', 'VurseantoRso', 'Will0wWraithS0nic', 'HeroSlimeBane2017', 'DARK_Drift83',
                     'KnightGold3n2021', 'PixelSkater2018_YT', 'RavenPulse200984', 'NeonZoomFlame',
                     'XxPhoenixDragonWrait', 'EsentiteNtit', 'Xx_PandaTurboThunder', 'ArrowGigaBlad32021',
                     'HazeKnightSt0rmy', 'Wolf_SAB3R2003', 'Stream_Ice2023', 'Kaylee_Ghost13', 'RileyTurbo46',
                     'TOXIC_Legend201316', 'Ph0enixSky201716', 'Legend_Nova19', 'HunterArrowPower2014',
                     'XxHyperKingxX2015', 'St0rmyOmega53', 'CraftDrift87', 'XxOmegaLegendxX28_YT', 'AidenDriftOmega',
                     'UstiseneRong', 'EllieGhostTiger2010', 'CodeMysticNight', 'VictoriaZapAlphaYT', 'EllaFlash56',
                     'AricoroFresh', 'OrofeneRinte', 'KnightFoxHawk', 'XxFireUltraxX2007', 'LionZ3roChas32004',
                     'XxLi0nEaglexX63', 'DuckWraith2020YT', 'LightSt0rmFlame2016', 'XxAlphaRocketxX60',
                     'JaxonStealthCraze201', 'DuckCyberFlash2018', 'ToroutouTori', 'EridempaiTow',
                     'XxPhoenixUltraStormy', 'SkyEagl368', 'Isab3llaRift201718', 'Xx_STORMINF3RNOBLOCK',
                     'AquaMoonHawk90', 'Ac3_Galaxy30', 'Sebastian_CRAFT20046', 'DriftByte10', 'HunterLuckyBlizzard2',
                     'AlexanderVortexGamer', 'Aqua_CYBER49', 'LiamGalaxy201376', 'BlizzardZ3ro201012_Y',
                     'RogueOrbitPanda2019', 'MysticPlayzToxic2016', 'Asher_Sky201081', 'XxAuroraCodeStormxX',
                     'EagleBl0ckFury2021', 'JaydenStar201673', 'Legend_Slime88', 'Pix3lRav3nStar', 'Riley_KNIGHT200671',
                     'LavaSonicNight', 'GiiintoNtese', 'IsaacZapInferno69', 'SebastianHer072', 'GraysonPhoenixClaw',
                     'Ban3Fox200450', 'SkyHunt3rWolf', 'ElijahVoidHyp3r', 'Chaos_Builder2015', 'CircuitTurbo2008YT',
                     'GraceBlizzardPro', 'EliDragon202256', 'Arr0wC0de87', 'St3althPho3nix2014', 'PhoenixNovaCraze',
                     'AvaStarryMystic', 'XxEllaBac0nBearxX200', 'B3astTig3r85', 'OfrenedeDide', 'Build3rFir3Ninja2011',
                     'SophiaLionJelly22', 'NoraOm3ga2003', 'RogueSilverShadow', 'Vort3x_Craft2017',
                     'Fury_Thunder200267', 'Star_Magic200989', 'ElijahDawnJelly', 'AquaPhoenixKnight',
                     'Blad3TurboMoon41', 'XX_AlexanderDriftBla', 'KingZapGlitch', 'BLIZZARD_Blaze2008',
                     'Xx_Paisl3yChaosFlam3', 'Ven0mFlame2020', 'XxNinja_EchoxX79', 'KingPrimalGh0st',
                     'BrooklynHeroStorm', 'OliviaBlaze15', 'Moon_Arrow2009', 'Block_QU33N2013', 'J3lly_Craz32023',
                     'PandaZapDrift2022', 'LegendHaze57', 'AriaFir3202142YT', 'XXELLA_BanexX2021', 'Rift_C0DE2020',
                     'BearPrismThunder', 'MinerVenom201432_YT', 'Xx_KayleeChillV0rtex', 'EsendeseSend',
                     'JamesFusion201534', 'Vortex_Prism2024', 'Xx_StealthLightDrago', 'CrazeSky60', 'OrbitGlitch54_YT',
                     'XxJax0nPr0xX2024', 'JacksonEagleByte', 'EdithiteRere', 'ZapVenom2004', 'ZoeRider35',
                     'CookieOrbit51', 'Ph0enixFr0st52', 'LukeJellyAqua', 'NoraThunder57', 'LightStorm200994YT',
                     'SedoffaRaiie', 'AbigailTiger2008_YT', 'XxAidenFuryNinjaxX', 'XxFrostSaberxX2015',
                     'R0cket_Bac0n83', 'Addis0n_Galaxy36', 'SophiaKing202444', 'Pro_Eagle32', 'XxDawnBearxX95',
                     'Charlott3ChillGalaxy', 'Pix3lAlphaSonic2015', 'EmmaSilverSparkYT', 'XxCircuit_Ech0xX2022',
                     'XxMichaelNinjaCraftx', 'Mate0LavaNinja', 'LaylaHazeRaven201227', 'SesoundaTone',
                     'SonicSkyMax2005', 'NightSaberQueen2018', 'Ev3lyn_Night2024', 'ProV3nomAqua2021',
                     'WilliamLavaLion', 'ErsoundiTere', 'Chlo3BlastAlpha', 'RiderLionCraft', 'LunaGalaxySparkly58',
                     'Mas0n_Drag0n41', 'XxBaneCodexX2019', 'XxBuilder_MaxxX10', 'Jelly_Pro2009', 'AidenThunderStormy20',
                     'XxJaydenSparkxX2022', 'ZoomNeonVoid', 'LeviDancer201978', 'C0deCraftDrift2011',
                     'LegendHero201039', 'XxStormVortexLuckyxX', 'NintingiNgen', 'XxDawnKingxX45', 'Chl0e_LIGHT2007YT',
                     'EvelynKnight73', 'ZoomBanePrimal2020', 'PixelIce31', 'BrooklynZeroDrift', 'CharlotteGolden92',
                     'Ban3Qu33n39', 'LiamBaneZoom201842', 'OliviaRid3rFlam32010', 'DanielR0cket2016',
                     'LavaPho3nixBuild3r', 'B3ast_Chill45', 'NoahBearDancer2022', 'XxDanc3rDragonSonicx',
                     'Queen_Rider44', 'OliviaKnight23', 'Haz3lSt3alth45', 'DawnStealth88', 'Inf3rnoByt376',
                     'XxStorm_BuilderxXYT', 'ShadowOrbitCookie', 'BearDrag0nYT', 'Victoria_St3alth17',
                     'C00kiePanda2010', 'Master_Fury2009', 'HeroZoomSonic', 'HunterPlayzRift2013', 'SonicStormyFox2019',
                     'UiyantoNendu', 'XxSaberShadowxX2014', 'HazelRiderEagle98', 'Rid3rVoid2009', 'XxHyp3rB3arxX2013',
                     'Gam3r_Cyb3r2021', 'IsabellaFlickMagic', 'Chl0eBac0nFr0st', 'L3viCraftHyp3r_YT',
                     'XxMysticHeroxX51', 'AlphaBlad3Blaz3', 'Eagle_Ghost69', 'BaneDancerGh0st', 'ToxicDawnNova201492',
                     'MasterSparklyQueen', 'LeviRocketWraith', 'XxZoomFrostxX2019', 'CrazeGlitchAqua',
                     'XxMinerRavenxX2024', 'Slim3Cod3Toxic', 'S3bastianHyp3r44', 'S0NIC_V0rtex2019', 'LavaMinerVenom',
                     'AbigailLion60', 'WolfL3g3ndDanc3r', 'BeastThunder201570', 'OliviaHaz32008', 'CraftFoxOrbit',
                     'JacksonStarryGhost', 'Spark_Blade66', 'XxAlphaNeonxX2020YT', 'NeantustuRas', 'CrystalBlastHero91',
                     'XxPh0enixDawnxX2019', 'RiftFlameTurb0YT', 'XxAubreyGoldenPrismx', 'CookieCrystalWolf200',
                     'XxEliSparkxX33_YT', 'CraftNovaPlayz', 'Om3gaUltraM00n', 'GabrielLegendByte', 'WilliamKingFusion',
                     'WraithG0lden68', 'BaconKingAqua', 'N0raV0id84', 'Ic3Drift2008YT', 'T0xic_Gh0st2019',
                     'ArsousioRsut', 'HannahKingPulse2011', 'XxGraceBuilderxX92', 'LavaCraftOrbit', 'XxHaze_ACEXX2017',
                     'Ow3nPix3l2003', 'CircuitRavenSpark', 'XxKnightFrostxX55', 'BaneUltra54', 'Ow3nBaconToxic45',
                     'Bane_Bac0n2019', 'EdoresiToror', 'IceDriftZero', 'GlitchStealthBane202', 'LukeChaseEch0',
                     'AvaLegendMiner2007', 'MichaelZapBlizzard', 'XxPowerBladeEpicxX', 'JaxonStreamAce82',
                     'XxLiamPix3lxX2011_YT', 'Jayd3nProPow3r', 'POWER_Rogue74YT', 'EdendisouTer', 'UteroroNores',
                     'ChillV0id98', 'LightFlam32003', 'AmeliaByteFury', 'XxAuroraChillxX70', 'Charlotte_GALAXY42',
                     'EssondoNdint', 'DarkRiftDragon200444', 'TurboAlphaSkater2020', 'LunaEchoUltra',
                     'Xx_SparklyChillPix3l', 'XxHeroCyberxX99', 'Charl0tteSparkBear', 'VenomQueenMoon', 'Emma_Arrow93',
                     'EngendeNdien', 'VictoriaIc330', 'Carter_ECHO200797', 'AmeliaBearSpark_YT', 'XxEchoFlashxX53',
                     'XxBaconFrostxX2016', 'XxRogueDuckNinjaxX20', 'GhostFrostStar2017', 'Samu3lMoonInf3rno',
                     'ToxicNightCode', 'W0lfFuryByte2015', 'Hunt3r_Frost38', 'SlimeDuck81', 'XXMASON_Om3gaxX20025',
                     'Xx_MichaelSparklyC00', 'PulseS0nicHunter2009', 'OngonerouRer', 'EmisintoRyan', 'Toxic_Silver82',
                     'Blizzard_Pix3l2019', 'XxScarlettAlphaxX30', 'XxCyberRavenVenomxX', 'AterendeDend',
                     'PrismN0va200842', 'AUBR3YZOOMHUNT3R_YT', 'CircuitDuckEagle73', 'ZaydenGigaClaw',
                     'ChaosEpicTig3r2012', 'TURBO_H3ro26', 'MesangeRases', 'LightC0de2017', 'King_Flick2002',
                     'UsidraseDito', 'Brooklynn_FOX27', 'XxLaylaIcexX201124', 'ErengateNgas', 'NeonStormy73',
                     'ThunderViperInferno', 'GigaCraz3Turbo', 'NendanguStan', 'HyperVoid200679', 'Xx_FusionCrystalSkat',
                     'EvelynCrazeChill67', 'AuroraDanc3r2016', 'XxChlo3_SparklyxX200', 'MysticC0de2009YT',
                     'Br00klynnSlime201247', 'Cod3Void98', 'Blaze_Chase202377YT', 'icoroureNtou', 'LaylaS0nicDark10',
                     'GRACE_Block2005', 'StarGhostTig3r45', 'AlexanderDrift76', 'BaconHazeVoid2002', 'Giga_Light2020',
                     'Ninja_R0gue23', 'LionFireKnight2024', 'XxBlad3MysticR0gu3xX', 'XxHunterBearxX2016_Y',
                     'StarryGolden2010YT', 'GraysonJellyWraith', 'HeroSkaterOmega51', 'ShadowBuild3rB3ar',
                     'Danc3rC0d32004', 'SparkArr0wDuck', 'Kaylee_ROGUE71', 'XxGabri3lToxicxX_YT', 'XxAbigailMaxxX73',
                     'Glitch_S0NIC2012', 'Flame_Orbit2020', 'Ow3nVort3x2007', 'Scarl3ttCooki3', 'TesicedeStou',
                     'XxV0rtexDrag0nxXYT', 'Samu3lPix3lTurbo', 'SparklyBan3Block', 'JulianGlitchHaze',
                     'WillowToxicTig3r2013', 'NightFrostBlast2002', 'Will0wThund3rYT', 'SavannahStarryMin3r',
                     'JaxonVortexFlash2014', 'HawkSaberAlpha', 'XxSavannahEchoxX28', 'ChillAlphaStealth202',
                     'OliverMasterBear2003', 'ElijahUltraRider', 'AlphaGlitchPulse', 'LuckyGalaxy202454',
                     'L0ganDanc3rGam3r27', 'Zoe_Omega72', 'DriftEch0St0rmy', 'XxSamu3lPrimalDarkxX',
                     'BrooklynBaconFire29', 'Dragon_PIXELATED11', 'BearCrazeLion200844', 'AquaCraft200953',
                     'XxEthanZoomFoxxX', 'Miner_Echo61', 'William_Sparkly56', 'WilliamDrag0n2023',
                     'ShadowHyperThunder72', 'BROOKLYNN_Epic11', 'EzraStar200954', 'Jacks0nTigerW0lf',
                     'Vip3rBuild3rArrow', 'XxEvelynKingxX2015', 'EliMasterFlame2023', 'Asher_Flick2003',
                     'XxAddisonNightxX2010', 'JackSparklyPrimal201', 'Blizzard_Rift201855', 'SkaterOrbitFlame',
                     'HeroQueen84', 'Saber_Turbo2021', 'XxLionBlockxX2020', 'DragonChas3Z3ro72', 'StarryM00n2023_YT',
                     'Min3rRogu369', 'PrimalBeastBane', 'Grace_Crystal36', 'ZoeShadow201164', 'SAVANNAH_Mystic2007Y',
                     'XxCod3FrostGam3rxX20', 'Zayd3nSlim3Chaos', 'LAYLA_Panda21YT', 'ictengeSaris',
                     'XxSt0rmyHunterxX2010', 'XxTurboBlastSparkxX', 'EzraCha0s2018', 'JellyChaos2016_YT',
                     'SonicSlim3Knight', 'StreamZeroFury31', 'Toxic_Skater99', 'AsherDark18', 'R0cket_OrbitYT',
                     'LukeGh0stCrystal', 'SavannahBuild3rBlad3', 'BuilderByteRocket', 'XxJellyS0nicAquaxX',
                     'XxLightStarryxX20', 'BuilderFusi0nLegend', 'Addis0nFr0stMystic', 'Dancer_Wolf74',
                     'XxRocketRoguexX2002', 'Scarl3ttAqua_YT', 'NoraStarrySonic', 'CharlotteSkaterRogue',
                     'IsaacThund3r2023', 'EmmaZ00m2021', 'DriftBacon2016', 'EllaBeastKing', 'RiderMoonFusion2021',
                     'PaisleyVortexMiner20', 'StarryEpicSaber', 'OwenFireCookie', 'FireJelly30', 'OwenWraithMystic2024',
                     'BlastDuckOrbitYT', 'AmeliaDancerOrbit201', 'AubreyLi0nDrag0n64', 'LightMagic2007_YT',
                     'XxEmmaPowerxX201365', 'STARRY_Rav3n26', 'StarryM00nBlad32002', 'IceByteLight2018',
                     'AsherOmegaZer0', 'HawkPlayz62', 'ElijahZ00mFusi0n', 'WillowSparklyBear', 'MiaMysticPanda2022YT',
                     'Charlott3Sky44', 'XxHeroBytexX202250', 'Ow3n_Claw2022', 'EllieRift81', 'P0werCraze85',
                     'RocketSonic93', 'PandaAce79', 'HawkPrismRaven', 'GigaPowerRift2002', 'EmmaHawkPulse200212',
                     'Giga_Viper66', 'NenomashouNe', 'HannahOrbitFlame54', 'Li0nEch0200747', 'XxIsabellaHeroCircui',
                     'PrimalDarkNeon', 'EllieAquaIce74', 'JAX0N_V0rtex47', 'Rav3nPuls3Silv3r', 'Flam3ToxicZ3ro',
                     'XxC0d3R0ck3txX2011', 'C0d3Gam3r2016_YT', 'Cyber_LUCKY200787', 'XxWolfBaneMysticxX',
                     'AlphaDanc3rDrift2014', 'Glitch_LI0N12', 'ProFlashDanc3r2007', 'ChaseStarSpark',
                     'S0phiaR0gueR0cket', 'Grace_Phoenix28', 'Wolf_PULSE59', 'HazelCrystalClaw2004', 'BlastBear2023_YT',
                     'CraftMinerZoom10', 'XxSamuelVenomxX47', 'AvaGlitchHer02014', 'XxBlockDancerxX2003',
                     'Chas3_Storm2004', 'EzraCha0sNinja2007', 'C00kieFire2010', 'MiaT0xicOrbit16', 'XxGhost_Pix3lxX93',
                     'HenryV0rtex202144', 'Craze_Orbit200545', 'LionFusionPulse56', 'XxHunter_SonicxX2007',
                     'J3llyGold3nSt3alth', 'ProFlashDanc3r2007', 'JamesIce35', 'XxPix3lMoonFusionxX',
                     'Addison_Chas32017', 'XxSamuelVenomxX47', 'EllaViperFire200686', 'AlexanderCircuitDawn',
                     'Om3ga_Night70', 'OrbitDragon50_YT', 'Samuel_EPIC77', 'St0rmC00ki3200923', 'AquaTurbo2009',
                     'MiaMysticPanda2022YT', 'XxLegendLionKingxX', 'LightMagic2007_YT', 'OwenWraithMystic2024',
                     'XxEmmaStr3amBan3xX', 'Ow3n_Claw2022', 'XxGhost_Pix3lxX93', 'LUCKY_Moon2013', 'EllieAquaIce74',
                     'NightMysticHyper', 'FireJelly30', 'Cyber_LUCKY200787', 'XxHannahProAlphaxX20',
                     'HazelCrystalClaw2004', 'HannahOrbitFlame54', 'Ic3N3onRid3r', 'MateoPrism2009YT',
                     'CookieArrowDancer', 'Toxic_Skater99', 'ZapPixelated201024YT', 'AuroraPrismBuild3r',
                     'Pix3lat3d_Ac32006', 'EllaBeastKing', 'CrazeBlockEpic', 'Willow_Blizzard2021Y', 'Aid3nPrism35',
                     'XxRock3tNightPix3lxX', 'LukeGh0stCrystal', 'XxEmmaPowerxX201365', 'IsaacThund3r2023',
                     'DancerSpark45', 'Savannah_Z3ro201858', 'FrostTurboCooki3', 'St0rmChase76', 'AmeliaDancerOrbit201',
                     'XxC0d3R0ck3txX2011', 'RocketSonic93', 'J3llyChillLucky', 'Charlott3Sky44', 'NoahCodeVortex',
                     'Li0nEch0200747', 'EmmaZ00m2021', 'HawkPlayz62', 'G0ldenFlash2014', 'MiaT0xicOrbit16',
                     'SkyZ3roB3ast', 'AsherDark18', 'XxBlockDancerxX2003', 'STAR_Max2003', 'XxFuryNinjaInfern0xX',
                     'PandaAce79', 'ChloeStarStarry', 'PrismPrimalOmega42', 'ElijahZ00mFusi0n', 'PaisleyVortexMiner20',
                     'XxChloeWraithxX2011', 'AlexanderHyperBlock8', 'Mason_SKAT3R21', 'Am3liaSpark2024',
                     'ShadowCyberGhost2015', 'NoraStarrySonic', 'ArrowHyp3rBuild3r', 'LoganByteAce',
                     'JackArrowStarry2014', 'XxRocketRoguexX2002', 'LavaHunterStealth201', 'C0d3Gam3r2016_YT',
                     'JAX0N_V0rtex47', 'S0phiaR0gueR0cket', 'BlastDuckOrbitYT', 'Tiger_Prism15', 'WraithRift201181',
                     'RileyPr0Infern02022Y', 'BlastPhoenixCraze202', 'Craze_Orbit200545', 'BearSparklyRider',
                     'XxDawnCraftLegendxX', 'OrbitQueenPulse42', 'PIX3L_Cod383', 'ClawSlim32009', 'Chas3_Storm2004',
                     'BuilderByteRocket', 'BlastBear2023_YT', 'CHILL_Pixelated2023', 'HawkPrismRaven',
                     'JackPrismFrost26', 'AlphaFox200287', 'StarryM00nBlad32002', 'EpicByteFrost202070',
                     'CircuitNova2017YT', 'PandaPhoenixFlash75', 'IceByteLight2018', 'Kayl33Slim3200577',
                     'GraceGlitch201362', 'T0xicOmegaGalaxy2010', 'V3nomNovaBlizzard', 'HazelBac0n2011',
                     'Blad3LightStar', 'AubreyLi0nDrag0n64', 'RiderMoonFusion2021', 'CraftMinerZoom10', 'Dancer_Wolf74',
                     'EvelynFlameBeast2018', 'ZeroChase201532', 'SkyEagle200951', 'JackBlastEagl3', 'EliFoxSlime',
                     'DriftBacon2016', 'LionFusionPulse56', 'AddisonPixelMaster', 'XxLightStarryxX20',
                     'FlashBeastPixel36', 'Xx_IsaacInfernoCraze', 'RocketStarBlaze_YT', 'LavaB3arDuck2007',
                     'Xx_EvelynGamerCircui', 'FireStormy2021YT', 'EzraCha0sNinja2007', 'XxWolfBaneMysticxX',
                     'Xx_JamesSilverSparkl', 'XxHunter_SonicxX2007', 'EllieRift81', 'XxAriaMagicEpicxX200',
                     'WolfHeroShadow28', 'XxGlitchOrbitFusi0nx', 'SophiaOmegaDragonYT', 'StarBan3Craft',
                     'CharlotteSkaterRogue', 'WillowSparklyBear', 'RiftNinjaStormyYT', 'HyperMagic201165',
                     'SEBASTIAN_Beast91', 'SonicSlim3Knight', 'CraftBaneHaze', 'V0idOm3ga202161', 'PrimalDarkNeon',
                     'Flam3ToxicZ3ro', 'XxHeroBytexX202250', 'ThunderCircuit49', 'ChaseStarSpark',
                     'XxIsabellaHeroCircui', 'HenryV0rtex202144', 'MaxTurboHawk', 'NORA_Fury73', 'OwenFireCookie',
                     'STARRY_Rav3n26', 'StreamZeroFury31', 'XxKayl33Silv3rxX72', 'MysticFlam370', 'Blizzard_HAZE2004',
                     'Fir3Skat3r2018', 'AsherOmegaZer0', 'BrooklynnPrimal20207', 'XxCircuitW0lfBlastxX',
                     'Rav3nPuls3Silv3r', 'ElijahDrag0nShad0w', 'AvaAc3Flam3', 'Blaz3Flam3Craft', 'EmmaHawkPulse200212',
                     'Xx_FrostPrimalBuilde', 'L3viAc3Craz3', 'XxBuilder_DriftxX45', 'ElijahBaneBear2006',
                     'AvaGlitchHer02014', 'ARIA_Ace201575', 'PIXELBYTECODE_YT', 'R0cket_OrbitYT',
                     'XX_L3g3ndBuild3rBan3', 'P0werCraze85', 'XxElliePr0EpicxX', 'Harp3rNight2023',
                     'Charl0tteBl0ck2008', 'XxEvelyn_WraithxX33', 'Giga_Viper66', 'OrbitStormy99', 'SaberIceStormy',
                     'MysticSparklyPix3l', 'Fir3Lucky98', 'C00ki3Sab3rRav3n', 'SparklyStarryV0rtex',
                     'GhostRiderBlizzard', 'KAYLEE_Block98', 'Xx_SparkThunderQueen', 'XxJellyS0nicAquaxX',
                     'Paisl3yTig3rFury', 'C00kieFire2010', 'Wolf_PULSE59', 'XxPixelPhoenixxX77', 'GigaPowerRift2002',
                     'XxDarkCodeCrystalxX', 'AlphaDanc3rDrift2014', 'Z3roNightHyp3r', 'Panda_Pr015', 'AbigailCyber23',
                     'Glitch_LI0N12', 'Qu33nCyb3rStarryYT', 'Grace_Phoenix28', 'Chloe_BEASTYT', 'Blast_PHO3NIX2010YT',
                     'HarperDrag0nG0lden20', 'Scarl3ttAqua_YT', 'RileyZapSonic57', 'XxBan3ToxicPrismxX'}

local RECEIVER_LIST = {'CircuitPixelVenom', 'IceMoonPixel', 'XxKingBac0nxX_YT', 'EpicSt3althAqua', 'OfuthareRest',
                       'idindidraNdo', 'Xx_H3roPix3lat3dDanc', 'GamerRavenMaster2005', 'SamuelZer0Blaze2018',
                       'IsaacPulse202082', 'St3althPandaGold3n11', 'KayleeStormy93', 'OliviaBlizzard48',
                       'Zap_Queen2003YT', 'SophiaSparkly201255', 'V3n0mSparkly43YT', 'WilliamSaberLegend20',
                       'AL3XAND3R_Ban3200447', 'Mat3oN3onBan3', 'Arr0wC0dePh0enix', 'XxElijah_SonicxX2013',
                       'XxNinjaT0xicOrbitxX', 'B3astZ3roFlam392', 'AidenChill90', 'XxZap_IcexX79', 'XxAubrey_ClawxXYT',
                       'StarMagic201497', 'EchoPrismFury2005', 'AbigailPlayz43', 'XxLuna_KNIGHTXX2008',
                       'ByteDuck200942', 'Br00klynDrift99', 'Gam3rSonic87', 'XxNinjaBearxX2021', 'Charl0tteLavaHaze',
                       'StreamPrimalNightYT', 'OliviaSilv3r2006_YT', 'ByteArrowBlizzard201', 'NinjaLuckyCha0s2017',
                       'SlimeEcho60', 'ZoeGamerVortex200346', 'BaneBearDancer', 'SAMUEL_Circuit202274',
                       'GoldenVoidStar13', 'WillowSilver79', 'XxLuk3Blad3xXYT', 'XxSonicRiderxX89', 'Blizzard_Pulse86'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
