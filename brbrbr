-- ตัวแปรสำหรับรายชื่อผู้เล่น
local SENDER_LIST = {'WarriorQueen7262', 'AkikoDancer8492', 'HelgaTomato5867', 'LyraCornflower6411', 'TaliaTomato9915',
                     'HyejinOlive1434', 'AnitaTurquoise1850', 'PatriciaFox6411', 'FemkeOrchid7419', 'EdithWitch2836',
                     'MihaelaWeaver4849', 'ArtemisDancer7058', 'EdenKnight5473', 'AishaBolt7971', 'KavyaWitch1706',
                     'IsabellaGoddess3869', 'ValeriaViper4286', 'AntonijaBuff9723', 'AmberCantaloupe5637',
                     'YumiReaper8351', 'AzureWind9689', 'JulianaYellow5923', 'AishaHoney1093', 'NeaSpell7708',
                     'AlmaKhaki0521', 'HarperWolf0272', 'JiaFlame5696', 'StefaniaPrincess9520', 'EsraMage7942',
                     'HannahValkyrie5243', 'EsperanzaAubergi3381', 'MilaSiren0696', 'HopeAubergine2785',
                     'AnjaliMage1835', 'JusticeArcher3922', 'HanaMetallic4333', 'FernandaEggplant3839',
                     'MelikeGoddess8722', 'AvaMaroon9845', 'IsabelaJade6699', 'JanaPurple1415', 'LailaCornflower2106',
                     'NiamhSapphire4882', 'TeodoraGoddess4436', 'AlmaFang3994', 'ChiaraGuardian0865',
                     'ElizabethOrange6667', 'AnaisNavy4603', 'ClaudiaValkyrie4282', 'HannahTerracotta8437',
                     'HeraBolt6324', 'HildaRust3533', 'LakshmiSpark4887', 'AmaraWeaver6116', 'SvetlanaHoney9208',
                     'EvelynElectric9066', 'DvaLilac8560', 'MoanaKnight4614', 'EmerySiren3247', 'SeleneWind7631',
                     'AzureArrow7628', 'ImaniBurnt2424', 'AthenaViper6982', 'MiaAubergine9957', 'DesislavaBlade9577',
                     'KenyaSpirit2991', 'SilviaPale5806', 'ParvanehMaiden4810', 'LiEggplant7647', 'MagdalenaWeaver1858',
                     'NadiaPowder7509', 'LakshmiBurnt5747', 'LinneaSiren4630', 'ZhenGreen1086', 'XiuArcher7922',
                     'DaeunGuardian1205', 'MinjiOrchid3005', 'RebelLilac9242', 'CarmenWeaver3384', 'LuciaSpirit7833',
                     'NadiaHeart2429', 'LiBrown8195', 'SkyMaiden8837', 'MabelCerise4166', 'ScarlettKnight5609',
                     'MariaNinja3943', 'AlexandraMustard8106', 'EwaWine5291', 'MariaSteel9046', 'DorothyOrange7772',
                     'SaraSiren1677', 'NoorPlum9253', 'SepidehKnight8195', 'NaniArrow4992', 'NasrinDye1228',
                     'EmiCopper2292', 'CamilleMoss6894', 'GiuliaTurquoise3010', 'FreedomNinja1704', 'DaphneOwl0977',
                     'LucieOwl1789', 'LotteWolf5062', 'CarolinaGreen6369', 'AnastasiaPurple9614', 'EilishGoldenrod4230',
                     'SeleneKnight8234', 'OliviaTeal4427', 'NiaNavy9182', 'IndigoSiren4787', 'BarboraHeart5336',
                     'SelenaSiren6193', 'GabrielaHeart9263', 'CourageCerulean4479', 'LiisaYellow3914', 'AmberSpell0106',
                     'NoongarSalmon8303', 'RebeccaWeaver2528', 'GertrudBlade1114', 'KenyaSiren3595', 'PearlCobalt4759',
                     'JulietteRust6895', 'LinneaOrange4888', 'AutumnMoss2248', 'TerezaEggplant0168',
                     'ChiaraGoddess9863', 'FreedomSpell7455', 'CourageOwl6308', 'ValeriaVixen3632', 'AbigailFlame8167',
                     'ClaudiaWitch3139', 'LenaStrike1817', 'RoisinSpirit8316', 'AndreeaOwl9187', 'SaraBlade4569',
                     'LingBlush3086', 'MoanaForest0152', 'DoloresSalmon9902', 'SkyHawk6871', 'IngridSpirit6541',
                     'CelesteMaiden7787', 'JusticeBlue5770', 'MargritGreen8238', 'ZoeMaroon2373', 'SusanBolt9800',
                     'ArtemisCerulean5633', 'ElizabethPale4549', 'NiloufarWitch2679', 'CourageTiger4017',
                     'ZuriHeart6018', 'LeilaniBlaze7891', 'TaliaTan3683', 'NaomiMint3605', 'QuinnOwl1671',
                     'NoraPeriwinkle4211', 'YelenaWeaver0870', 'LuciaDark5083', 'GertrudPale8721', 'CelesteFlame2125',
                     'HildaStrike7992', 'LiGray4125', 'SaoirseSpirit7667', 'MarinaWeaver0859', 'NoongarArcher7187',
                     'MaryamPurple6981', 'LotteBolt4876', 'MeiPhantom0904', 'MartinaSpark2787', 'MarinaQueen1440',
                     'WaratahOchre3457', 'LeahGuardian4646', 'KenyaSiren9052', 'FaithElectric9288', 'EsraJade4881',
                     'RubyDancer7548', 'AntoniaBlade7993', 'HildaPhantom6895', 'KianaArctic8155',
                     'ValentinaPhantom0831', 'FreyaVixen0210', 'ImaniLavender1533', 'NoongarFang2929',
                     'AdelheidValkyrie7397', 'ChayaCrimson7140', 'IoanaStrike8843', 'MeiArrow4408',
                     'EstherVermilion1253', 'JarrahMage2743', 'KirraFox4193', 'FreedomMoss0692', 'RafaelaTeal4788',
                     'RhiannonHoney0403', 'HazelBlade3897', 'CircePrincess2242', 'ArtemisKnight7459', 'AoifeHeart0090',
                     'LalehFang2453', 'LakshmiTiger7655', 'SeoyeonArctic0388', 'ZofiaRed2354', 'NasrinTerra2882',
                     'MargaretBlush5657', 'JovanaWeaver8365', 'HuiVixen2563', 'CoralHawk5303', 'ElsaMint1210',
                     'AryaReaper9896', 'TerezaTurquoise4694', 'LiTiger5038', 'IngridCerulean2509', 'KristinaSpark7356',
                     'YasminYellow4848', 'SageMaiden5521', 'LilyHawk8688', 'AnjaSepia5403', 'AriaBurgundy2301',
                     'LingDancer5241', 'AthenaPink1420', 'ScoutMustard6437', 'LakshmiRoyal4133', 'MiaBlush6944',
                     'NadiaTan6859', 'AnjaliNinja6116', 'JieunMage1093', 'SusanSpark9319', 'LinneaCerulean7528',
                     'NataliaWolf2264', 'DottyEggplant8975', 'NinaRider4507', 'OfeliaLavender5416', 'EmiOwl3131',
                     'MagdalenaAquamar9952', 'HopeBlade0323', 'EwaFox5870', 'LiTangerine4449', 'CassandraArrow6301',
                     'AutumnMagenta9640', 'PetraTerra8716', 'LauraGoddess4285', 'SaoirseCobalt6827', 'LucijaSpell6296',
                     'EmeraldOwl5132', 'NoorDusty3889', 'NinaSpark6697', 'JasmineHunter4491', 'MaryamSiren2694',
                     'YumiSlate7269', 'KaoriViper9520', 'CassandraValkyri0871', 'AlexandraReaper2529', 'LisaBuff6582',
                     'JuliettePhantom7293', 'HannahPrincess2746', 'NiloufarOwl0578', 'NovaCantaloupe6811',
                     'DanielaFlame4850', 'RiverBrown4880', 'LailaSteel4566', 'WarriorHeart2586', 'CaoimheSiren1946',
                     'KiraPrincess6220', 'EmiFox1711', 'IrinaBlue2328', 'AnnaBolt7771', 'VictoriaCobalt1290',
                     'YanKnight1981', 'MilaQueen5072', 'NoraGoddess9046', 'AnaisPeach9715', 'JovanaPhantom4782',
                     'HelenPlum2962', 'YukiWitch9378', 'DoloresLilac9803', 'MahinaMaiden3997', 'DeirdrePrincess5125',
                     'RubyWitch2384', 'SophieSiren5922', 'AkalaBolt2620', 'OlgaReaper3653', 'ZarliStrike0431',
                     'AthenaBlue1866', 'JanaKhaki8180', 'CristinaDark2199', 'FreyaBlush0219', 'ImaniPhantom5253',
                     'TerezaValkyrie6065', 'ValeriaElectric0829', 'MariyaForge0723', 'AthenaBurnt5241',
                     'FreyaCrimson0986', 'NataliaRider5949', 'IrenePurple3363', 'CalliopeHuntress0040', 'DaisyPale5750',
                     'IvanaCopper7324', 'NiaTiger5920', 'LindaDark9086', 'ViolaTiger5490', 'FemkeRider3187',
                     'JoyLilac0287', 'IndigoCotta9303', 'ArtemisTiger2333', 'LotteTan1569', 'IoanaSpell3061',
                     'SkyLavender2558', 'HannahVixen7864', 'IvanaWind3006', 'HelenaMint9753', 'AlinaAubergine2486',
                     'AoifeRust2220', 'ZuriSpirit3887', 'YelenaBlade7784', 'CarolinaTerra5921', 'IoanaGoddess2035',
                     'KristinaFlame5213', 'RadhaGoddess9431', 'SkyTeal0382', 'CirceFuchsia4982', 'NiamhHawk5610',
                     'IngridGuardian2677', 'SarahDancer0690', 'LunaForest0708', 'JinahOwl4843', 'HuiTurquoise3682',
                     'CourageLilac9744', 'ParvanehSpark8271', 'HelenMaiden9739', 'AkalaTerracotta2207', 'LuanaMage8509',
                     'RoseTiger5379', 'AoifeAubergine9909', 'HarmonySepia2316', 'TerezaSteel6637', 'HazelWind1678',
                     'CalliopeFang4720', 'ClaireSalmon8963', 'ValentinaPrinces4271', 'MedeaDancer2556',
                     'OliviaHawk7427', 'BronwynRider7213', 'MartinaSpell6982', 'CharlotteNinja2556', 'GretaTan5470',
                     'MelikeGoddess1988', 'AvaStrike9092', 'NoraGoddess1129', 'DaphneDark1816', 'AriadneValkyrie0540',
                     'JovanaGold4037', 'CamilaOwl3393', 'ImaniOrchid4421', 'PetraMahogany5648', 'AishaDark0334',
                     'MahsaSpell3036', 'MiaOlive2732', 'KaoriRust9666', 'AutumnBolt4714', 'LilyHawk5942',
                     'CamilaOrchid0330', 'ZhenSpark7863', 'KenyaTeal9827', 'CoralBlue7629', 'KealohaQueen0367',
                     'KaiaMauve4168', 'HyejinFuchsia6793', 'AlexandraHeart7054', 'HarperNavy9341', 'ClaireOwl8435',
                     'HarmonyChartreus6095', 'RebelBuff6690', 'FarahFang2368', 'SvetlanaTeal7958', 'ElifMahogany0764',
                     'CassandraBolt3298', 'HeidiReaper1662', 'ValeriaCantaloup0588', 'CassandraDusty6748',
                     'YelenaPink7342', 'MidoriFlame9583', 'DanielaBurgundy5079', 'FarahPrincess1878', 'ClaraFlame5146',
                     'YukiVixen4693', 'EsperanzaKhaki3214', 'DottySpell5245', 'BrittaAquamarine6973',
                     'RaniaMetallic6144', 'JieunSpell0490', 'JusticeTurquoise3949', 'AstridDancer3644', 'AmaraPale7659',
                     'SelenePowder8700', 'AmiraFlame4919', 'MarinaViper5868', 'GretaTomato5110', 'KiraTiger4718',
                     'NeaArcher8424', 'PromisePeach3376', 'LeilaBlaze0997', 'LakshmiHunter0668', 'JusticeVermilion7560',
                     'DanielaViper8877', 'OrlaBlaze7703', 'AkikoOrchid1975', 'HarperSpark5375', 'LucieOrchid1491',
                     'AlexandraReaper8616', 'VioletCotta7613', 'AkikoTeal2683', 'FaithMoss2361', 'LucieAquamarine3772',
                     'SophieTiger0768', 'PearlArcher4754', 'JieunReaper5882', 'ElenaNinja9285', 'XiuPhantom0971',
                     'RhiannonGuardian9536', 'YumiGoldenrod8552', 'MelikeFuchsia9882', 'StefaniaSapphire7287',
                     'JiaMint5177', 'HannahHawk2376', 'MatildaEggplant4747', 'MabelIvory4022', 'MelikeTiger3371',
                     'GertrudFox3116', 'NasrinTurquoise5770', 'FreedomMoss6744', 'StellaPurple4083', 'AmaraBlue5898',
                     'AlmaViper6224', 'HanaTan9619', 'ZaraViper4585', 'KianaFlame4691', 'MinaForge8622', 'IvyWitch3481',
                     'CassandraHuntres7280', 'DeepaCornflower7466', 'MarketaSlate5690', 'CourageLilac9231',
                     'CristinaBurgundy3842', 'BronwynSiren7764', 'FarahGray6041', 'AnnaRust6879', 'RhiannonSpell5956',
                     'PetraHoney6166', 'LauraHawk0992', 'AdelheidArrow1493', 'BrunhildeSlate2409', 'HermioneForest4930',
                     'AikoQueen3636', 'ChayaCantaloupe4891', 'JuliaHoney7572', 'WillowMaiden8174', 'LeaDye8716',
                     'MariaBurnt2543', 'JusticeTiger1061', 'NinaMaiden7815', 'SeoyeonSteel2897', 'SaoirseNavy9540',
                     'MabelGray3634', 'ChiaraMustard5733', 'LailaWind6446', 'NataliaHunter8103', 'AryaBuff8323',
                     'KaoriTan6640', 'ZofiaSapphire6669', 'SierraCrimson1536', 'LindaTeal7814', 'HazelVermilion4473',
                     'KaiaKhaki4880', 'SepidehDark8033', 'ClaraMaiden0495', 'IvyTan1362', 'JinahWolf5164',
                     'RiverMint0237', 'PriyaGoddess9174', 'AlexandraBolt5751', 'ElenaMahogany5874', 'AntoniaBlade8217',
                     'JiaSpell8747', 'MarleeForge6417', 'RadhaHawk5240', 'MargritMaiden4468', 'LaniCornflower9011',
                     'EmiRoyal4168', 'XiuLavender8822', 'LenaMaroon1684', 'BarbaraSpell9985', 'TeodoraWolf2912',
                     'MiriamCopper4966', 'JieunBolt8762', 'HarperOwl7795', 'DorothyBlush3771', 'LuanaBuff2630',
                     'AgnesPhantom0869', 'BarboraOwl5074', 'FreyaPhantom2227', 'ArtemisLavender6626',
                     'DeryaPhantom9627', 'RaniaSpirit8137', 'AnjaliCornflower9948', 'HelenaSteel9917',
                     'IvanaKnight8316', 'AoifeBlaze5854', 'AnnekeArrow2847', 'PhoenixTomato6571', 'HalaForge0169',
                     'UrsulaTangerine4968', 'SaaraSpell5261', 'FreyaGray7480', 'CassandraEggplan8317', 'HeraHeart8084',
                     'ZoeLilac3567', 'MiriamPale6244', 'ElifFlame0855', 'ValeriaMage4197', 'MarieFang7411',
                     'EwaJade1703', 'AnyaReaper8582', 'ValentinaForest7731', 'ChiaraBurgundy1477', 'AutumnTan4077',
                     'SusanSpell6505', 'GizemPhantom2384', 'CiaraDusty5554', 'FrancescaStrike7914', 'TamsinForge2990',
                     'SepidehGoddess5544', 'ClaraSpell6161', 'YumiRed4986', 'AuroraCerise4284', 'MarinaSapphire3758',
                     'ElinaFlame5016', 'AikoBolt0938', 'NoraHoney7946', 'AlmaArctic8860', 'LindaHeart7384',
                     'AnjaSteel3401', 'EdithGuardian9856', 'RiverVermilion5139', 'HannahStrike8461', 'AriaOwl9596',
                     'FatimaPlum6873', 'KealohaGoldenrod8527', 'SeoyeonHeart8931', 'LunaTiger3819', 'EliseMint1138',
                     'YumiCopper5869', 'JarrahWind5254', 'DeryaKnight0562', 'SvetlanaWitch5060', 'LottePrincess2302',
                     'RoseTan2600', 'HeraGuardian1361', 'MayaGreen8404', 'ValentinaPeach5829', 'HelenaWolf8801',
                     'YumiCobalt0256', 'RaniaWind3289', 'HermioneGold4411', 'RhiannonBolt6061', 'AutumnHunter3050',
                     'PersephoneHunter3324', 'LucijaCornflower3325', 'NiloufarOlive8053', 'YumiPurple8153',
                     'JuniperPeach1598', 'MihaelaReaper8430', 'ArtemisRoyal8623', 'RafaelaViper5028',
                     'StefanaApricot1876', 'NaomiArctic8478', 'HuiValkyrie1475', 'CoralTeal2350', 'AntoniaNinja4614',
                     'MakedaLilac7408', 'BronwynAubergine6363', 'AnaisGoddess1794', 'JoyFox8829', 'MargritRed6475',
                     'LyraBolt8237', 'SigneMaiden6642', 'LyraHeart3556', 'SelenaPale3466', 'ChloeBurgundy5455',
                     'EmeryRed3706', 'JuliaPale9711', 'RachelPrincess4460', 'NiloufarTiger8466', 'EmmaWine3469',
                     'AlinaPrincess8582', 'NataliaTeal9117', 'HanaFang4551', 'ElsaMaroon7285', 'AnjaliSiren5128',
                     'KatarzynaValkyri7964', 'JovanaBlade0505', 'IvyFuchsia3388', 'SooTiger2777', 'SaraIvory4008',
                     'MiaPlum6320', 'DottyHeart3330', 'CaoimheWitch0379', 'OlgaVixen8052', 'AzadehTerra3085',
                     'ClaraMustard9642', 'TamsinVixen4505', 'SaraRider0300', 'MarleeArcher2130', 'EmerySalmon3748',
                     'KealohaReaper3648', 'LyraLavender6493', 'PersephoneArrow2239', 'GracePlum3451', 'JiaSteel9598',
                     'ZehraNavy5358', 'SelenaBlade6209', 'LiisaPink3801', 'DaisyFlame8341', 'JieunHawk8497',
                     'MahsaHuntress9309', 'IsabellaMustard8458', 'DvaOrchid8475', 'KalenaWitch0881',
                     'LinneaHuntress2587', 'NienkeMaroon2675', 'ScarlettNinja1983', 'JovanaRoyal7335',
                     'CelesteCrimson0731', 'SilviaFang6730', 'HannahWitch2981', 'AoifeLilac5050', 'ClaireNinja3671',
                     'AislingBlaze6599', 'KaiaHeart7067', 'EmeraldStrike1491', 'YukiIvory5954', 'CirceTerra3281',
                     'ChenWolf7847', 'RhiannonGoldenro7275', 'AoifePhantom9217', 'AnitaBlue4098', 'EmeraldVixen9343',
                     'RadhaHawk1238', 'MilaSpirit8557', 'EdenBlaze1717', 'SarahArrow5451', 'HecateSapphire2567',
                     'MarijaHuntress0552', 'KaiaSiren1237', 'SelenaHoney1607', 'LauraForge6197', 'AkalaValkyrie5334',
                     'DaeunLavender6599', 'CarmenSapphire9454', 'LingElectric8889', 'GretaMage2801', 'LeilaDancer7941',
                     'HalaGoddess7124', 'ArtemisTan3117', 'DottyQueen0059', 'ElenaGuardian8789', 'BrielleElectric8469',
                     'KylieSiren8570', 'SepidehPink0805', 'SeoyeonSpell0626', 'AzureGray9673', 'ElizabethTiger4945',
                     'MahinaHeart1340', 'CarmenPeriwinkle6804', 'ZoeSepia2168', 'AnjaliWitch8569', 'MelikeWolf3822',
                     'RuthScarlet5829', 'JinahHawk2496', 'CassandraTerra8081', 'KirraSpirit9718', 'DreamCantaloupe0162',
                     'XimenaBolt5747', 'RhiannonWolf9760', 'VioletSpirit7761', 'MidoriFang9275', 'HarmonyHuntress0398',
                     'TeodoraWine8489', 'DorothyBurnt3811', 'KaoriWine4329', 'YoonahBlue2600', 'NishaTerracotta8742',
                     'MaryamWolf3578', 'ScoutCobalt6822', 'SaoirseHunter1989', 'AnnekeSpell8047', 'ElizabethReaper9979',
                     'FreyaFuchsia7271', 'NiaStrike4309', 'AlmaBurnt2574', 'JinahSteel2415', 'ZarliBurnt2372',
                     'GertrudHeart6492', 'JasmineRoyal5321', 'DvaLavender5237', 'MahsaSpell2373', 'ZehraPlum3583',
                     'HelgaSiren2949', 'JulietLavender6908', 'AriaFuchsia1167', 'AislingCantaloup9064',
                     'MaeveStrike2169', 'SepidehWitch8955', 'LiSpell3478', 'YoonahMagenta1985', 'MedeaArcher6920',
                     'MaryBlue1781', 'MilicaHawk8977', 'EsperanzaPurple1527', 'ChiaraApricot1219', 'AriadneIvory1881',
                     'HelmiCerulean0297', 'YanBlush5236', 'YumiGray9992', 'AliceCopper2066', 'KirraPeriwinkle9162',
                     'IrisLavender7360', 'EvelynViper5053', 'HalaSpirit8156', 'SageRed4927', 'BeatriceSapphire2298',
                     'ChenCornflower4399', 'TamsinHunter3992', 'TamsinWind3428', 'SophiaViper4406', 'ElifViper4434',
                     'HildaBlade1945', 'AmelieStrike7183', 'WarriorBlush4953', 'LeahSapphire9083', 'MedeaBurnt3462',
                     'LuanaBolt9521', 'SusanGoddess6451', 'SaritaSalmon9624', 'EilishGoddess7678', 'XimenaVixen2622',
                     'TamsinOchre9495', 'JelenaFang9184', 'MinjiDye4196', 'EilishPurple5856', 'DesislavaGreen8362',
                     'XiuForge2982', 'XiuTomato3251', 'DvaPale1651', 'SiennaGuardian7638', 'KatarzynaPowder0135',
                     'AlmaCobalt1287', 'IngridRider5624', 'SamiraSpell5391', 'MelikeMahogany3175', 'ArtemisSpell9265',
                     'AnaHawk0334', 'BeatriceMage7834', 'HecateMage7406', 'BrunhildeSapphir9186', 'MihaelaPeach0057',
                     'NiamhGuardian7059', 'MariyaPale2536', 'RoseRoyal2586', 'ZehraArrow3598', 'AntoniaTan8397',
                     'NoraHuntress4818', 'AliceArcher9279', 'AoifeGuardian8867', 'AlinaOrange5073',
                     'HannahPrincess8740', 'ChayaFang6467', 'NaomiWeaver1601', 'MarianaIvory3658', 'QuinnGuardian1443',
                     'AnjaliAubergine3288', 'PhoenixKnight9333', 'ClaireSpell3915', 'DeirdreWine9714',
                     'EvelynTiger0039', 'ClaireArcher6244', 'LuciaWind0742', 'IrisSpirit4816', 'ZoeWind5606',
                     'ValeriaFlame6224', 'SooSiren7927', 'EvaArrow7229', 'JulietGuardian3675', 'AnaArrow8769',
                     'JelenaFuchsia9188', 'StormWeaver0553', 'NienkeCantaloupe1536', 'EdithVermilion8884',
                     'MabelViper0318', 'LailaDusty7518', 'SaoirseMaiden3582', 'PetraChartreuse5162', 'SamiraBolt6309',
                     'NovaSiren2738', 'BarbaraIvory9505', 'DorothyFlame7752', 'RebelQueen0343', 'AndreeaRider5121',
                     'DeepaPrincess4635', 'FrancescaScarlet1632', 'AlicePale9872', 'YelenaKnight5822',
                     'MargritGuardian7555', 'SebnemDusty4541', 'AinoFlame3486', 'EstherWitch6564', 'ZuriValkyrie5579',
                     'SooYellow9415', 'LeilaniScarlet8222', 'KavyaViper9650', 'SeoyeonPlum2722', 'KaisaFox1841',
                     'CaoimheHunter7199', 'AryaStrike4481', 'PromiseHoney8487', 'KiraMoss4197', 'RebelMaiden1600',
                     'MinaNavy1011', 'EliskaSiren0118', 'UrsulaOlive9676', 'SkyDark3897', 'DaeunMauve4161',
                     'AoifeOrange2889', 'DaphnePeriwinkle4450', 'SebnemBolt4248', 'NiamhBlush5140', 'MiaFang2119',
                     'ValeriaFang9318', 'EunjiHeart7580', 'AbigailElectric0519', 'SusanPhantom2451',
                     'CalliopeIvory3687', 'KenyaPlum4520', 'LotteForge9453', 'IoanaQueen0511', 'NiaNinja0760',
                     'KatarinaReaper4300', 'KaisaHawk6934', 'SigridNinja1688', 'DaisyWind3596', 'ArtemisEggplant5723',
                     'MihaelaWitch0232', 'PearlMoss7624', 'KirraHeart3573', 'LaylaMage7942', 'KaiaSapphire9796',
                     'DaeunTan8668', 'BarboraScarlet4633', 'OrlaMage4091', 'ElinaAquamarine0625', 'AinoRoyal5385',
                     'DaphneGold3405', 'RadhaPhantom9940', 'HelenReaper9530', 'MarleeTurquoise9282', 'SkyForge5412',
                     'ChiaraSteel5134', 'SophiaOwl8590', 'LeilaKnight0569', 'DianaNavy4612', 'HannahBlaze3275',
                     'KalenaOrchid8423', 'HarperMaroon8835', 'HanaMahogany3013', 'FatimaGoddess9022',
                     'CaoimheFlame9342', 'MiriamStrike1805', 'JuniperFang1317', 'KavyaPeach8634', 'EvelynLilac0515',
                     'KaoriHeart0630', 'DoloresTerra0352', 'NaniWind9176', 'WarriorPeach5743', 'SaaraHuntress5473',
                     'AmeliaMetallic1669', 'MaeveJade1895', 'LyraArcher5925', 'AndromedaRider4904', 'JusticeArrow8735',
                     'MarinaGuardian3083', 'MahsaSpark2193', 'AnyaScarlet5029', 'IvanaSpirit2670', 'DeirdreBlaze8210',
                     'SusanBlaze7028', 'MahinaOwl2780', 'ScarlettGray1304', 'JulietMage5371', 'AriaOwl4541',
                     'BeatrizSpell6361', 'AvaPale4606', 'SofiaMaiden0323', 'PenelopeTerracot9221', 'NovaGuardian9448',
                     'KaiaViper1638', 'GretaNinja9430', 'FemkeSteel0839', 'ElizabethOlive4697', 'CamilaHuntress8914',
                     'DaeunReaper5871', 'HarperBuff5707', 'AlexandraGoldenr1311', 'PreetiBlade5923', 'IsabelaBlade1369',
                     'JaneForge0561', 'YukiNavy7605', 'AzureQueen2921', 'SusanMage1628', 'SannaReaper1327',
                     'NataliaHeart6632', 'IoanaRoyal6600', 'SamiraGuardian3576', 'SvetlanaMage8433', 'JulianaMage8400',
                     'CourageDark4862', 'NaniGuardian7365', 'AnikaRider0376', 'AnyaApricot6077', 'MarketaLavender0639',
                     'ZhenFuchsia1116', 'ZarliNinja9188', 'BrunhildeAquamar5086', 'CarolinaSpark8562', 'KaisaSteel9986',
                     'HazelFang8307', 'MeiRider4347', 'SepidehQueen4074', 'MajaElectric4256', 'PetraReaper1905',
                     'SaraHoney9027', 'HyejinSiren6298', 'CourageWine8300', 'HopeForge8823', 'MinaValkyrie1656',
                     'CalliopeTerracot7422', 'IoanaDancer8969', 'BronwynWeaver9832', 'LyraSpark5853', 'PinarOrange9380',
                     'KatarinaFuchsia9486', 'LenaHawk0040', 'NoraDancer4704', 'AoifeCantaloupe3951', 'YelenaWitch2732',
                     'DorothyFlame0240', 'AislingCrimson5360', 'MidoriCerise4480', 'CelesteScarlet8036',
                     'MayaDusty0718', 'HanaCerulean6280', 'EdenArrow6750', 'ParvanehPeriwink1535', 'PatriciaWolf6981',
                     'SiennaKnight0290', 'EdenBlaze1476', 'HannahPurple6889', 'EvaPhantom9534', 'YelenaBlade3271',
                     'NovaEggplant8127', 'RhiannonWind4894', 'LakshmiWitch2689', 'SigridRust5152', 'CiaraHeart4036',
                     'FernandaDusty9380', 'LaylaCerise0457', 'XimenaWine8304', 'HarmonyMage8104', 'KaoriScarlet4079',
                     'KealohaMagenta2707', 'KenyaBlade2698', 'IvyTerracotta3222', 'AgnesBlush2893', 'AnnaArcher8322',
                     'GiuliaElectric6720', 'LinneaSalmon0259', 'ZehraSpark4285', 'MarySlate9122', 'NovaPrincess9107',
                     'JelenaFang0457', 'MinjiSalmon0386', 'MaryFlame2016', 'VictoryWind6207', 'NinaPrincess6673',
                     'SusanOrange9011', 'NishaPowder9696', 'GizemPhantom6956', 'EdithFox0014', 'MaevePrincess8572',
                     'JulietVermilion9893', 'LakshmiWitch7007', 'KirraTiger8761', 'AnaisOrange7001',
                     'EliseTangerine5825', 'SigneFang5274', 'TamsinRed9741', 'LailaReaper0201', 'FatimaGreen3870',
                     'ElifApricot0102', 'GiuliaMage7903', 'BrielleStrike6456', 'PenelopeMoss3404', 'PetraWolf8025',
                     'IvyWind0304', 'AnjaliIvory0449', 'NaomiScarlet6211', 'AryaMahogany6755', 'StefanaHawk7710',
                     'KirraDark4293', 'AlexandraBlade1387', 'SusanTomato7213', 'VioletTerra9024', 'BronwynQueen5638',
                     'EstherMahogany1807', 'MahinaKnight2905', 'KaoriHunter5034', 'SarahPhantom5404', 'NadiaWeaver7809',
                     'JinahQueen6820', 'ChayaGuardian1514', 'CalliopeOwl6282', 'DaphnePeriwinkle6987', 'AnaGold8678',
                     'YukiRoyal4030', 'JieunBurgundy7610', 'EliseSalmon3965', 'BraveReaper2912', 'StefanaForest5567',
                     'BarbaraViper7415', 'PhoenixCopper7941', 'LakshmiWolf9122', 'CharlotteTeal9041', 'MarleeSpell9338',
                     'JieunGuardian2240', 'AnaDancer6174', 'MinjiRed4480', 'VeraViper3578', 'SakuraWitch8671',
                     'AndromedaOwl8558', 'SkyWolf8727', 'HeraIvory3788', 'SiobhanVermilion9482', 'RoisinHeart0726',
                     'AndromedaArcher6998', 'RaniaWolf3763', 'SannaAquamarine8765', 'MelikeMage7240',
                     'MahsaMagenta3924', 'SophiaCopper1114', 'JulianaMage8153', 'AlexandraBolt6478',
                     'JuliettePrincess0147', 'SakuraPhantom4921', 'AuroraSalmon1997', 'CharlotteHuntres0960',
                     'FrancescaSpirit7142', 'HarmonyCornflowe9106', 'QuinnVixen8167', 'HazelDancer8446',
                     'LeilaPale5349', 'DaisyStrike7069', 'MarinaSapphire8906', 'StellaDye2012', 'GiuliaRust5637',
                     'UrsulaBlade5079', 'DottySpell4800', 'AbigailOwl3382', 'AzureBlue3171', 'HeraPeach0321',
                     'AnnekePowder4431', 'MilicaPowder5398', 'HalaTerracotta5114', 'PromiseBlaze1575', 'MarleeMoss7775',
                     'EvelynTiger8622', 'ZoeTerra2895', 'HelmiArrow6170', 'UrsulaOchre6040', 'DottyCerise5131',
                     'AriaPrincess9395', 'AoifeForge2289', 'ElsaBlaze0396', 'RebeccaBrown4649', 'KristinaMustard7622',
                     'EmiOlive4110', 'BrielleEggplant4042', 'AnnaDancer3932', 'HeraSepia7922', 'EilishArctic4915',
                     'MariyaHuntress6811', 'KealohaOlive4522', 'KaisaBolt2187', 'RaniaRider8473',
                     'ScarlettAquamari4575', 'DeryaTerracotta6922', 'JieunSpirit7400', 'LindaAubergine1578',
                     'LindaNinja4473', 'LilyApricot2239', 'HildaTan1227', 'SierraHuntress2956', 'AmaraTiger4518',
                     'DottyBlue4954', 'GiuliaHoney3405', 'HanaBlaze5677', 'ElinaMetallic1045', 'CristinaStrike8434',
                     'RiverWeaver8821', 'MakedaSpirit3003', 'DesislavaStrike8122', 'LotteHoney6093', 'RachelForge9957',
                     'SeoyeonMoss9612', 'MajaOrange7249', 'AstridMagenta4123', 'EsperanzaStrike8160',
                     'NataliaArcher5998', 'ElinaTerracotta8042', 'NishaWeaver8958', 'GizemDancer1064',
                     'ZehraTurquoise2390', 'LotteSpark4770', 'KianaDancer1470', 'MarieSlate9064', 'WarriorMaiden9098',
                     'SakuraFlame2237', 'BraveBlue4668', 'RaniaSpark9302', 'EkaterinaRed4702', 'PetraArctic4549',
                     'EmiTomato6382', 'LindaRed7075', 'KealohaNavy3848', 'PinarFox7154', 'EstherSpell7956',
                     'AnyaSapphire6772', 'SannaTiger2479', 'EunjiStrike1967', 'FreedomBurnt1720', 'FatimaForest0243',
                     'DeirdreCerise9668', 'JarrahArrow5551', 'CiaraDancer6209', 'MiriamPowder3113', 'EmmaTurquoise0050',
                     'TeodoraBlade3108', 'SageChartreuse5858', 'PreetiMage4152', 'JaneLilac6178', 'MarleeBrown1355',
                     'OrlaSiren9257', 'NishaGray8318', 'NasrinMahogany7908', 'XimenaMahogany4450', 'AriadneMustard4896',
                     'BrunhildeCornflo5518', 'JulietJade3271', 'DvaFlame6965', 'NiaMint0774', 'DaeunNinja5019',
                     'LailaSapphire7364', 'LotteWitch0452', 'JieunRed4412', 'BronwynReaper7226', 'LindaTurquoise3729',
                     'MilaWeaver8440', 'YoonahFuchsia8027', 'LucijaStrike3885', 'MelikeWeaver6971', 'TeodoraFlame8529',
                     'HannahPlum1281', 'KalenaSpirit5940', 'NasrinSiren8645', 'RiverBlue3938', 'ZehraChartreuse7644',
                     'EdenForge3860', 'AlinaHoney4181', 'ElsaWine0854', 'AnaArctic5234'}
local RECEIVER_LIST = {'HannahStrike1335', 'ElizabethTan4078', 'TerezaPrincess3904', 'TatianaPowder0796',
                       'MidoriGuardian0676', 'ScoutHunter6205', 'LeaCrimson4616', 'KatarinaPrincess6017',
                       'QuinnRider9521', 'HildaBlush4455', 'BronwynFlame2781', 'AnjaliMoss8831', 'FernandaOwl4860',
                       'QuinnMage7341', 'ElsaAquamarine1492', 'AlicePlum4149', 'PreetiSpell0049', 'IsabellaSpirit7077',
                       'PinarHuntress6099', 'NaniSiren4103', 'AlmaCobalt8441', 'GiuliaMage7743', 'MahinaHuntress9020',
                       'AmberRust2122', 'AmeliaGold1612', 'LakshmiIvory2526', 'SigneTiger2148', 'RaniaGray4206',
                       'ElizabethSalmon9385', 'AliceSpirit9852', 'FrancescaReaper0309', 'LucijaBlade8511',
                       'HopeHunter4784', 'AinoSpark7262', 'MidoriViper7584', 'RaniaDancer9378', 'KavyaGuardian8295',
                       'MiriamReaper9519', 'GizemGoddess9011', 'UrsulaSteel6353', 'SaritaPeach0306', 'ElenaMage5675',
                       'CaoimheCornflowe5024', 'EmeryWeaver3714', 'GabrielaTan3332', 'EdithDusty6795',
                       'IvyVermilion5822', 'ImaniCrimson8920', 'YelenaHuntress5749', 'CerenTomato2447',
                       'PromiseValkyrie6379', 'SaoirseReaper3191', 'AislingCopper1422', 'SiennaSpell5109'}

-- ตัวแปรสำหรับการทำงาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- ตัวแปรสำหรับ tracking
local currentStep = 0
local currentStepReceiver = 0 -- ตัวแปรแยกสำหรับ receiver mode
local isTrading = false
local tradePartner = nil

-- ตัวแปรสำหรับตรวจสอบสถานะการเพิ่มไอเทม
local shroomAdded = false
local tokenAdded = false
local creatureAdded = false

-- ตัวแปรควบคุมการเรียก remote (ป้องกันการเรียกซ้อน)
local isRemoteBusy = false
local lastRemoteCallTime = 0

-- ตัวแปรสำหรับ state-based tracking (เพิ่มใหม่)
local receiverCreatureStartTime = 0
local receiverCreatureRequested = false
local receiverAcceptStartTime = 0
local receiverAcceptRequested = false

-- ตัวแปรสำหรับ receiver timeout (เพิ่มใหม่)
local lastTradeRequestTime = tick()
local RECEIVER_TIMEOUT = 300 -- 5 นาที (300 วินาที)

-- ตัวแปรสำหรับ sender state-based tracking
local senderShroomStartTime = 0
local senderShroomRequested = false
local senderTokenStartTime = 0
local senderTokenRequested = false
local senderCreatureStartTime = 0
local senderCreatureRequested = false
local senderAcceptStartTime = 0
local senderAcceptRequested = false

-- ตัวแปรป้องกันการทำงานพร้อมกัน
local isSenderMainActive = false
local isSenderReceiverActive = false

-- ฟังก์ชันช่วยเหลือ
local function IsInList(name, list)
    for _, listName in ipairs(list) do
        if name == listName then
            return true
        end
    end
    return false
end

local function Clicked_Ui(path)
    local success, error = pcall(function()
        GuiService.SelectedObject = path
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการเลือก UI: " .. tostring(error))
    end
end

local function Click_NOW()
    local success, error = pcall(function()
        VirtualInputManager:SendKeyEvent(true, 13, false, game)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, 13, false, game)
        task.wait(2)
        Clicked_Ui(nil)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกดปุ่ม: " .. tostring(error))
    end
end

-- ฟังก์ชันวาร์ปไปยังตำแหน่งที่กำหนด
local function WarpToLocation()
    local success, error = pcall(function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-2132.24, 490.66, 1106.83)))
            print("✅ วาร์ปไปยังตำแหน่งที่กำหนดแล้ว")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการวาร์ป: " .. tostring(error))
    end
end

-- ฟังก์ชันหาคู่เทรดที่ว่าง
local function FindValidReceiver()
    local result = nil
    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            return nil
        end
        
        print("🔍 กำลังค้นหาคู่เทรดที่ว่าง...")

        -- ค้นหา receiver ที่ว่าง
        local validReceivers = {}
        local getPlayersSuccess = pcall(function()
            for _, player in pairs(Players:GetPlayers()) do
                if IsInList(player.Name, RECEIVER_LIST) then
                    local isAvailable = false
                    local tradingValue = nil
                    local checkSuccess = pcall(function()
                        if player and player:FindFirstChild("Settings") and player.Settings:FindFirstChild("Trading") then
                            tradingValue = player.Settings.Trading.Value
                            isAvailable = (tradingValue == false)
                        else
                            isAvailable = true
                            tradingValue = "unknown"
                        end
                    end)

                    if not checkSuccess then
                        print(
                            "⚠️ เกิดข้อผิดพลาดในการเช็คสถานะ " ..
                                player.Name .. " สมมติว่าว่าง...")
                        isAvailable = true
                        tradingValue = "error"
                    end

                    if isAvailable then
                        print("✅ พบ receiver ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                                  tostring(tradingValue) .. ")")
                        table.insert(validReceivers, player)
                    else
                        print("❌ Receiver " .. player.Name ..
                                  " กำลังเทรดอยู่ (Trading.Value = " .. tostring(tradingValue) ..
                                  ")")
                    end
                end
            end
        end)

        if not getPlayersSuccess then
            print(
                "❌ เกิดข้อผิดพลาดในการดึงรายชื่อผู้เล่น")
            return nil
        end

        -- ถ้ามี receiver ว่าง ให้เลือกหนึ่งคน
        if #validReceivers > 0 then
            local selected = validReceivers[math.random(1, #validReceivers)]
            print("🎯 เลือก receiver: " .. selected.Name)
            result = selected
            return
        end

        -- ถ้าไม่มี receiver ว่าง ให้ค้นหา sender อื่นที่ว่าง
        print("ไม่มี receiver ว่าง กำลังค้นหา sender อื่น...")
        local validSenders = {}
        for _, player in pairs(Players:GetPlayers()) do
            if IsInList(player.Name, SENDER_LIST) and player.Name ~= LocalPlayer.Name then
                local isAvailable = false
                local tradingValue = nil
                pcall(function()
                    tradingValue = player.Settings.Trading.Value
                    isAvailable = (tradingValue == false)
                end)

                if isAvailable then
                    print("✅ พบ sender ที่ว่าง: " .. player.Name .. " (Trading.Value = " ..
                              tostring(tradingValue) .. ")")
                    table.insert(validSenders, player)
                else
                    print(
                        "❌ Sender " .. player.Name .. " กำลังเทรดอยู่ (Trading.Value = " ..
                            tostring(tradingValue) .. ")")
                end
            end
        end

        if #validSenders > 0 then
            local selected = validSenders[math.random(1, #validSenders)]
            print("🎯 เลือก sender เพื่อเทรดด้วย: " .. selected.Name)
            result = selected
            return
        end

        print("❌ ไม่พบคู่เทรดที่ว่าง")
    end)
    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน FindValidReceiver: " ..
                 tostring(error))
    end
    return result
end

-- ฟังก์ชันส่ง trade request
local function SendTradeRequest(receiverName)
    local success, error = pcall(function()
        local args = {"SendRequest", game:GetService("Players"):WaitForChild(receiverName)}
        game:GetService("Players").LocalPlayer:WaitForChild("Remotes"):WaitForChild("TradeRequestRemote"):FireServer(
            unpack(args))
        print("📤 ส่ง trade request ไปยัง " .. receiverName)
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการส่ง trade request: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน add shroom
local function AddShroom()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    local success, error = pcall(function()
        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่สามารถเพิ่ม shroom ได้")
            return false
        end
        
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub("@", "")
        local localPlayerName = LocalPlayer.Name

        local amount = coinsValue - 20
        if amount > 500000 then
            amount = 500000
        end
        if amount < 0 then
            amount = 0
        end

        local args = {"AddTradeItem", {
            Overwrite = true,
            ItemType = "Currency",
            Name = "Shooms",
            Amount = amount
        }}

        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ถูกปิดระหว่าง AddShroom, reset currentStep")
            currentStep = 0
            return false
        end

        local remote1Name = localPlayerName .. "-" .. opponentName .. "TradeRemote"
        local remote1 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote1Name)
        if not remote1 then
            print("❌ ไม่พบ remote1: " .. tostring(remote1Name))
            currentStep = 0
            return false
        end
        remote1:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote1...")
        wait(3)

        local remote2Name = opponentName .. "-" .. localPlayerName .. "TradeRemote"
        local remote2 = ReplicatedStorage:FindFirstChild("Remotes") and
                            ReplicatedStorage.Remotes:FindFirstChild(remote2Name)
        if not remote2 then
            print("❌ ไม่พบ remote2: " .. tostring(remote2Name))
            currentStep = 0
            return false
        end
        remote2:InvokeServer(unpack(args))
        print("⏳ รอ 3 วินาทีหลังใช้ remote2...")
        wait(3)

        print("✅ เพิ่ม " .. amount .. " Shrooms ในการเทรดกับ " .. opponentName)
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddShroom: " ..
                 tostring(error))
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add token
local function AddToken()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local tokenList = {'ChangeCreatureColorsToken', 'CreatureReviveToken', 'FullGrowToken', 'PartialGrowToken',
                       'FreeSpinToken', 'RandomStoredCreatureToken'}

    local success, error = pcall(function()
        local tradeGui = LocalPlayer.PlayerGui.TradeGui
        local containerFrame = tradeGui.ContainerFrame
        local theirsFrame = containerFrame.Theirs
        local displayNameLabel = theirsFrame.DisplayNameLabel
        local userNameLabel = displayNameLabel.UserNameLabel
        local opponentName = userNameLabel.Text

        opponentName = opponentName:gsub('@', '')
        local localPlayerName = LocalPlayer.Name

        -- ตั้งค่า remote กำลังใช้งาน
        isRemoteBusy = true

        for i, tokenName in ipairs(tokenList) do
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("❌ TradeGui ถูกปิดระหว่าง AddToken, reset currentStep")
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Tokens',
                Name = tokenName,
                Amount = 150
            }}

            local remoteName = localPlayerName .. '-' .. opponentName .. 'TradeRemote'
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print("📤 กำลังเพิ่ม " .. tokenName .. " (" .. i .. "/" .. #tokenList .. ")...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn(
                    "❌ เกิดข้อผิดพลาดในการเรียก remote สำหรับ " ..
                        tokenName .. ": " .. tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            end

            print('✅ เพิ่ม ' .. tokenName .. ' ในการเทรดกับ ' .. opponentName)

            -- รอ 3 วินาทีหลังใช้ remote
            print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ " .. tokenName ..
                      "...")
            wait(3)
        end

        -- ปลดล็อค remote
        isRemoteBusy = false
        print('✅ เพิ่ม token ทั้งหมดเสร็จสิ้น')
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชัน AddToken: " ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature สำหรับ Receiver แบบปลอดภัย
local function AddCreatureReceiver()
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                    currentStepReceiver = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStepReceiver = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStepReceiver = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            local remotes = ReplicatedStorage:FindFirstChild('Remotes')
            if not remotes then
                print('❌ ไม่พบ Remotes folder')
                currentStepReceiver = 0
                return false
            end

            local remote = remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStepReceiver = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreatureReceiver, reset currentStep')
                currentStepReceiver = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStepReceiver = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStepReceiver = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreatureReceiver: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStepReceiver = 0
        return false
    end

    return true
end

-- ฟังก์ชัน add creature
local function AddCreature(isReceiver)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        print("❌ TradeGui ไม่เปิดใช้งาน")
        return false
    end

    -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
    if isRemoteBusy then
        print("⚠️ Remote กำลังใช้งานอยู่ รอสักครู่...")
        return false
    end

    local success, error = pcall(function()
        local Unlocks = LocalPlayer.Data and LocalPlayer.Data.Unlocks
        local creatureName = nil

        if LocalPlayer and LocalPlayer.Data and LocalPlayer.Data.Unlocks then
            for _, child in pairs(Unlocks:GetChildren()) do
                if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                    print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                    currentStep = 0
                    return false
                end
                if child:IsA('ValueBase') and tonumber(child.Value) and tonumber(child.Value) > 0 then
                    if child.Name ~= "Vin'rou" and child.Name ~= 'Eulopii' then
                        creatureName = child.Name
                        break
                    end
                end
            end

            if not creatureName then
                warn('❌ ไม่พบ creature ที่ตรงเงื่อนไข')
                currentStep = 0
                return false
            end

            local theirLabel = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild('TradeGui') and
                                   LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel

            if not theirLabel or not theirLabel.Text then
                warn('❌ ไม่พบชื่อฝ่ายตรงข้าม')
                currentStep = 0
                return false
            end

            local otherPlayerName = theirLabel.Text
            if string.sub(otherPlayerName, 1, 1) == '@' then
                otherPlayerName = string.sub(otherPlayerName, 2)
            end

            local remoteName
            if isReceiver then
                remoteName = otherPlayerName .. '-' .. LocalPlayer.Name .. 'TradeRemote'
            else
                remoteName = LocalPlayer.Name .. '-' .. otherPlayerName .. 'TradeRemote'
            end
            local remote = ReplicatedStorage:FindFirstChild('Remotes') and
                               ReplicatedStorage.Remotes:FindFirstChild(remoteName)
            if not remote then
                print('❌ ไม่พบ remote: ' .. tostring(remoteName))
                currentStep = 0
                return false
            end

            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print('❌ TradeGui ถูกปิดระหว่าง AddCreature, reset currentStep')
                currentStep = 0
                return false
            end

            -- ตรวจสอบเวลาที่ผ่านไปตั้งแต่ remote call ล่าสุด
            local timeSinceLastCall = tick() - lastRemoteCallTime
            if timeSinceLastCall < 3 then
                local waitTime = 3 - timeSinceLastCall
                print("⏳ รอ " .. string.format("%.1f", waitTime) ..
                          " วินาทีก่อนเรียก remote สำหรับ creature...")
                wait(waitTime)
            end

            -- ตั้งค่า remote กำลังใช้งาน
            isRemoteBusy = true
            lastRemoteCallTime = tick()

            local args = {'AddTradeItem', {
                Overwrite = true,
                ItemType = 'Creatures',
                Name = creatureName,
                Amount = 1
            }}

            print("📤 กำลังเพิ่ม creature: " .. creatureName .. "...")

            local remoteSuccess, remoteError = pcall(function()
                remote:InvokeServer(unpack(args))
            end)

            if not remoteSuccess then
                warn('❌ เกิดข้อผิดพลาดในการเรียก Remote: ' ..
                         tostring(remoteError))
                isRemoteBusy = false
                currentStep = 0
                return false
            else
                print('✅ เพิ่ม creature สำเร็จ!')
                lastRemoteCallTime = tick()

                -- รอ 3 วินาทีหลังใช้ remote
                print("⏳ รอ 3 วินาทีหลังใช้ remote สำหรับ creature...")
                wait(3)

                -- ปลดล็อค remote
                isRemoteBusy = false
                return true
            end
        else
            print('❌ ไม่สามารถเข้าถึง Data.Unlocks ได้')
            currentStep = 0
            return false
        end
    end)

    if not success then
        warn('❌ เกิดข้อผิดพลาดในฟังก์ชัน AddCreature: ' ..
                 tostring(error))
        isRemoteBusy = false
        currentStep = 0
        return false
    end

    return true
end

-- ฟังก์ชันกด accept สำหรับ Receiver แบบปลอดภัย
local function ClickAcceptReceiver()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
        if not tradeGui then
            print("❌ ไม่พบ TradeGui")
            return false
        end

        local containerFrame = tradeGui:FindFirstChild("ContainerFrame")
        if not containerFrame then
            print("❌ ไม่พบ ContainerFrame")
            return false
        end

        local acceptButton = containerFrame:FindFirstChild("AcceptButton")
        if not acceptButton then
            print("❌ ไม่พบ AcceptButton")
            return false
        end

        local upperLabel = acceptButton:FindFirstChild("UpperLabel")
        if not upperLabel then
            print("❌ ไม่พบ UpperLabel")
            return false
        end

        Clicked_Ui(upperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด accept
local function ClickAccept()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            print("❌ TradeGui ไม่เปิดใช้งาน")
            return false
        end

        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
        if isRemoteBusy then
            print(
                "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้!")
            return false
        end

        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.AcceptButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("✅ กด accept แล้ว")
        return true
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด accept: " .. tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชันกด cancel
local function ClickCancel()
    local success, error = pcall(function()
        Clicked_Ui(LocalPlayer.PlayerGui.TradeGui.ContainerFrame.CancelButton.UpperLabel)
        task.wait(.1)
        Click_NOW()
        print("❌ ยกเลิกการเทรด")
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในการกด cancel: " .. tostring(error))
    end
end

-- ฟังก์ชันเช็คชื่อคู่เทรด
local function CheckTradePartner()
    local success, error = pcall(function()
        if not LocalPlayer.PlayerGui.TradeGui.Enabled then
            return false
        end

        local theirLabel = LocalPlayer.PlayerGui.TradeGui.ContainerFrame.Theirs.DisplayNameLabel.UserNameLabel
        if not theirLabel or not theirLabel.Text then
            return false
        end

        local opponentName = theirLabel.Text:gsub("@", "")

        -- เช็คว่าชื่อตรงกับในรายชื่อหรือไม่
        if IsInList(opponentName, RECEIVER_LIST) or IsInList(opponentName, SENDER_LIST) then
            print("✅ ชื่อคู่เทรดถูกต้อง: " .. opponentName)
            return true
        else
            print("❌ ชื่อคู่เทรดไม่ตรงกับรายชื่อ: " ..
                      opponentName)
            ClickCancel()
            return false
        end
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการเช็คชื่อคู่เทรด: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Sender
local function AcceptTradeRequestForSender()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                -- Sender สามารถรับ trade request จาก sender อื่นได้
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Sender พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Sender: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver แบบปลอดภัย
local function AcceptTradeRequestReceiver()
    local success, error = pcall(function()
        local requestsGui = LocalPlayer.PlayerGui:FindFirstChild('RequestsGui')
        if not requestsGui then
            return false
        end

        local requestsFrame = requestsGui:FindFirstChild('RequestsFrame')
        if not requestsFrame then
            return false
        end

        local otherFrame = requestsFrame:FindFirstChild('Other')
        if not otherFrame then
            return false
        end

        for _, child in pairs(otherFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน accept trade request สำหรับ Receiver
local function AcceptTradeRequest()
    local success, error = pcall(function()
        local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
        if not requestsFrame then
            return false
        end

        for _, child in pairs(requestsFrame:GetChildren()) do
            if string.find(child.Name, "^Trade") then
                local senderName = child.Name:sub(6) -- ตัด "Trade" ออก
                if IsInList(senderName, SENDER_LIST) then
                    print("✅ Receiver พบ trade request จาก " .. senderName .. " กำลัง accept...")

                    -- อัปเดตเวลาสุดท้ายที่ได้รับ trade request (เพิ่มใหม่)
                    lastTradeRequestTime = tick()

                    Clicked_Ui(child.AcceptButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                    return true
                else
                    print("❌ Trade request จาก " .. senderName ..
                              " ไม่ตรงกับรายชื่อ กำลัง decline...")
                    Clicked_Ui(child.DeclineButton.UpperLabel)
                    task.wait(.1)
                    Click_NOW()
                end
            end
        end

        return false
    end)

    if not success then
        warn(
            "❌ เกิดข้อผิดพลาดในการ accept trade request สำหรับ Receiver: " ..
                tostring(error))
        return false
    end

    return true
end

-- ฟังก์ชัน Coroutine สำหรับ Sender ที่รับ trade request
local function SenderReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) SenderReceiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                -- รอ trade request
                AcceptTradeRequestForSender()

                -- ตรวจสอบ timeout สำหรับ Sender ที่ทำงานแบบ Receiver (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Sender (Receiver mode) ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print(
                            "⏰ Sender (Receiver mode) รอ trade request... เหลือเวลาอีก " ..
                                string.format("%.0f", timeRemaining) ..
                                " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                isSenderReceiverActive = false
                wait(2)
            else
                -- กำลังเทรดอยู่ (เมื่อเป็น receiver)
                -- ตรวจสอบว่ามี trade request หรือไม่
                local hasTradeRequest = false
                local requestsFrame = LocalPlayer.PlayerGui.RequestsGui.RequestsFrame.Other
                if requestsFrame then
                    for _, child in pairs(requestsFrame:GetChildren()) do
                        if string.find(child.Name, "^Trade") then
                            hasTradeRequest = true
                            break
                        end
                    end
                end

                -- ถ้ามี trade request ให้ override main sender
                if hasTradeRequest then
                    print("📩 พบ trade request กำลัง override Main Sender...")
                    isSenderMainActive = false
                end

                -- ตรวจสอบว่า main sender loop กำลังทำงานอยู่หรือไม่
                if isSenderMainActive then
                    print(
                        "⏸️ Main Sender กำลังทำงานอยู่ SenderReceiver รอสักครู่...")
                    wait(1)
                    return
                end

                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        isSenderReceiverActive = true
                        currentStepReceiver = 1
                        print(
                            "🚀 Sender เริ่มขั้นตอนที่ 1: Add Creature (โหมด Receiver)")
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 เริ่ม Add Creature...")
                            -- เริ่มทำ AddCreature แบบไม่รอผลลัพธ์
                            spawn(function()
                                AddCreature(true)
                            end)
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()
                            print("⏳ รอให้ Add Creature เสร็จ...")
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 5 then
                            currentStepReceiver = 2
                            print(
                                "   Sender เริ่มขั้นตอนที่ 2: Click Accept (โหมด Receiver)")
                        else
                            print("⏳ รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking
                    if not receiverAcceptRequested then
                        print("🚀 เริ่ม Click Accept...")
                        -- เริ่มทำ ClickAccept แบบไม่รอผลลัพธ์
                        spawn(function()
                            ClickAccept()
                        end)
                        receiverAcceptRequested = true
                        receiverAcceptStartTime = tick()
                        print("⏳ รอให้ Click Accept เสร็จ...")
                    else
                        -- ตรวจสอบว่าผ่านไป 3 วินาทีแล้วหรือยัง
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 3 then
                            currentStepReceiver = 0
                            print("✅ Sender เทรดเสร็จสิ้น (โหมด Receiver)")
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                            isSenderReceiverActive = false
                        else
                            print("⏳ รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 3 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน SenderReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            isSenderReceiverActive = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

function TradeStepHandlerSender(step)
    if not LocalPlayer.PlayerGui.TradeGui.Enabled then
        -- ยังไม่ได้เทรด
        if step ~= 0 then
            print(
                "Trade ถูกยกเลิกหรือจบกลางคัน กำลัง reset step...")
            -- รีเซ็ตสถานะการเพิ่มไอเทม
            shroomAdded = false
            tokenAdded = false
            creatureAdded = false
            -- รีเซ็ตสถานะ sender tracking
            senderShroomStartTime = 0
            senderShroomRequested = false
            senderTokenStartTime = 0
            senderTokenRequested = false
            senderCreatureStartTime = 0
            senderCreatureRequested = false
            senderAcceptStartTime = 0
            senderAcceptRequested = false
            isSenderMainActive = false
            step = 0
        end

        -- ตรวจสอบว่า SenderReceiver กำลังทำงานอยู่หรือไม่
        if isSenderReceiverActive then
            print(
                "⏸️ SenderReceiver กำลังทำงานอยู่ Main Sender รอสักครู่...")
            return 0
        end

        -- ตรวจสอบ coins ก่อน
        local coinsValue = LocalPlayer.Data.Coins.Value
        if coinsValue <= 20 then
            print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) ไม่ทำการเทรด")
            -- ถ้า coins ไม่เพียงพอ ให้ปลดล็อค main sender และรอ
            isSenderMainActive = false
            wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
        else
            local validPartner = FindValidReceiver()
            if validPartner then
                SendTradeRequest(validPartner.Name)
            else
                -- ถ้าไม่มี partner ให้ปลดล็อค main sender
                isSenderMainActive = false
            end
        end
        return 0 -- reset step
    else
        -- กำลังเทรดอยู่
        if step == 0 then
            if CheckTradePartner() then
                print("🚀 เริ่มขั้นตอนที่ 1: Add Shroom")
                -- รีเซ็ตสถานะการเพิ่มไอเทมเมื่อเริ่มเทรดใหม่
                shroomAdded = false
                tokenAdded = false
                creatureAdded = false
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                return 1
            end
        elseif step == 1 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddShroom, reset step")
                return 0
            end
            -- Add Shroom - ใช้ state-based tracking
            if not senderShroomRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 1
                else
                    print("🚀 เริ่ม Add Shroom...")
                    senderShroomRequested = true
                    senderShroomStartTime = tick()
                    isSenderMainActive = true -- ตั้ง active เมื่อเริ่มเทรดจริง
                    -- เรียก AddShroom แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Shroom เสร็จ...")
                    local shroomSuccess = AddShroom()
                    if shroomSuccess then
                        shroomAdded = true
                        print("✅ Add Shroom เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 2: Add Token")
                        return 2
                    else
                        print("❌ Add Shroom ล้มเหลว")
                        senderShroomRequested = false
                        isSenderMainActive = false
                        return 0
                    end
                end
            else
                -- ถ้า shroom ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderShroomStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Shroom ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                    shroomAdded = true
                    return 2
                else
                    print("⏳ รอ Add Shroom เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 1
                end
            end
        elseif step == 2 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddToken, reset step")
                return 0
            end
            -- Add Token - ใช้ state-based tracking
            if not senderTokenRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 2
                else
                    print("🚀 เริ่ม Add Token...")
                    senderTokenRequested = true
                    senderTokenStartTime = tick()
                    -- เรียก AddToken แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Token เสร็จ...")
                    local tokenSuccess = AddToken()
                    if tokenSuccess then
                        tokenAdded = true
                        print("✅ Add Token เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 3: Add Creature")
                        return 3
                    else
                        print("❌ Add Token ล้มเหลว")
                        senderTokenRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า token ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderTokenStartTime
                if elapsedTime >= 30 then
                    print(
                        "⚠️ Add Token ใช้เวลานานเกินไป กำลังข้ามไป step 3")
                    tokenAdded = true
                    return 3
                else
                    print("⏳ รอ Add Token เสร็จ... (" .. string.format("%.1f", 30 - elapsedTime) ..
                              " วินาที)")
                    return 2
                end
            end
        elseif step == 3 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง AddCreature, reset step")
                return 0
            end
            -- Add Creature - ใช้ state-based tracking
            if not senderCreatureRequested then
                -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                if isRemoteBusy then
                    print("⏳ Remote กำลังใช้งานอยู่ รอสักครู่...")
                    return 3
                else
                    print("🚀 เริ่ม Add Creature...")
                    senderCreatureRequested = true
                    senderCreatureStartTime = tick()
                    -- เรียก AddCreature แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Add Creature เสร็จ...")
                    local creatureSuccess = AddCreature(false)
                    if creatureSuccess then
                        creatureAdded = true
                        print("✅ Add Creature เสร็จสิ้น")
                        print("🚀 เริ่มขั้นตอนที่ 4: Click Accept")
                        return 4
                    else
                        print("❌ Add Creature ล้มเหลว")
                        senderCreatureRequested = false
                        return 0
                    end
                end
            else
                -- ถ้า creature ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderCreatureStartTime
                if elapsedTime >= 10 then
                    print(
                        "⚠️ Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 4")
                    creatureAdded = true
                    return 4
                else
                    print("⏳ รอ Add Creature เสร็จ... (" .. string.format("%.1f", 10 - elapsedTime) ..
                              " วินาที)")
                    return 3
                end
            end
        elseif step == 4 then
            if not LocalPlayer.PlayerGui.TradeGui.Enabled then
                print("TradeGui ถูกปิดระหว่าง ClickAccept, reset step")
                return 0
            end
            -- Click Accept - ใช้ state-based tracking
            if not senderAcceptRequested then
                -- ตรวจสอบว่าทุกขั้นตอนเสร็จสิ้นแล้ว
                if shroomAdded and tokenAdded and creatureAdded then
                    print("🔍 ตรวจสอบสถานะ: Shroom=" .. tostring(shroomAdded) .. ", Token=" ..
                              tostring(tokenAdded) .. ", Creature=" .. tostring(creatureAdded))

                    -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                    if isRemoteBusy then
                        print(
                            "⚠️ Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                        return 4 -- ยังคงอยู่ใน step 4
                    end
                    print("🚀 เริ่ม Click Accept...")
                    senderAcceptRequested = true
                    senderAcceptStartTime = tick()
                    -- เรียก ClickAccept แบบ synchronous และหยุด loop
                    print("⏸️ หยุด loop เพื่อรอ Click Accept เสร็จ...")
                    local acceptSuccess = ClickAccept()
                    if acceptSuccess then
                        print("✅ เทรดเสร็จสิ้น")
                        -- รีเซ็ตสถานะการเพิ่มไอเทม
                        shroomAdded = false
                        tokenAdded = false
                        creatureAdded = false
                        -- รีเซ็ตสถานะ sender tracking
                        senderShroomStartTime = 0
                        senderShroomRequested = false
                        senderTokenStartTime = 0
                        senderTokenRequested = false
                        senderCreatureStartTime = 0
                        senderCreatureRequested = false
                        senderAcceptStartTime = 0
                        senderAcceptRequested = false
                        isSenderMainActive = false
                        return 0
                    else
                        print("❌ Click Accept ล้มเหลว")
                        senderAcceptRequested = false
                        return 0
                    end
                else
                    print(
                        "⚠️ ยังมีขั้นตอนที่ยังไม่เสร็จ: Shroom=" ..
                            tostring(shroomAdded) .. ", Token=" .. tostring(tokenAdded) .. ", Creature=" ..
                            tostring(creatureAdded))
                    -- กลับไปทำขั้นตอนที่ยังไม่เสร็จ
                    if not shroomAdded then
                        print("🔄 กลับไปทำ Add Shroom")
                        return 1
                    elseif not tokenAdded then
                        print("🔄 กลับไปทำ Add Token")
                        return 2
                    elseif not creatureAdded then
                        print("🔄 กลับไปทำ Add Creature")
                        return 3
                    end
                end
            else
                -- ถ้า accept ยังไม่เสร็จ แต่เวลาผ่านไปมากเกินไป
                local elapsedTime = tick() - senderAcceptStartTime
                if elapsedTime >= 5 then
                    print(
                        "⚠️ Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                    print("✅ เทรดเสร็จสิ้น")
                    -- รีเซ็ตสถานะการเพิ่มไอเทม
                    shroomAdded = false
                    tokenAdded = false
                    creatureAdded = false
                    -- รีเซ็ตสถานะ sender tracking
                    senderShroomStartTime = 0
                    senderShroomRequested = false
                    senderTokenStartTime = 0
                    senderTokenRequested = false
                    senderCreatureStartTime = 0
                    senderCreatureRequested = false
                    senderAcceptStartTime = 0
                    senderAcceptRequested = false
                    isSenderMainActive = false
                    return 0
                else
                    print("⏳ รอ Click Accept เสร็จ... (" .. string.format("%.1f", 5 - elapsedTime) ..
                              " วินาที)")
                    return 4
                end
            end
        end
    end
    return step
end

-- เรียกใช้งานแบบ timer (ทุก 1 วินาที)
local function StartSenderStepLoop()
    spawn(function()
        while true do
            local success, err = pcall(function()
                local previousStep = currentStep
                currentStep = TradeStepHandlerSender(currentStep)

                -- ถ้า step เปลี่ยน แสดงว่าขั้นตอนเสร็จแล้ว
                if previousStep ~= currentStep then
                    print("🔄 ขั้นตอนเปลี่ยนจาก " .. previousStep ..
                              " เป็น " .. currentStep)
                end
            end)
            if not success then
                warn("❌ เกิดข้อผิดพลาดใน TradeStepHandlerSender: " .. tostring(err))
                currentStep = 0
                -- รีเซ็ตสถานะ sender tracking
                senderShroomStartTime = 0
                senderShroomRequested = false
                senderTokenStartTime = 0
                senderTokenRequested = false
                senderCreatureStartTime = 0
                senderCreatureRequested = false
                senderAcceptStartTime = 0
                senderAcceptRequested = false
                isSenderMainActive = false
            end

            -- รอ 1 วินาทีแล้ววนใหม่
            wait(1)
        end
    end)
end

-- Coroutine สำหรับ Receiver แบบปลอดภัย
local function ReceiverCoroutine()
    while true do
        local success, error = pcall(function()
            -- ตรวจสอบ coins ก่อน
            local coinsValue = LocalPlayer.Data.Coins.Value
            if coinsValue <= 20 then
                print("💰 Coins ไม่เพียงพอ (" .. coinsValue .. " <= 20) Receiver ไม่ทำงาน")
                wait(10) -- รอ 10 วินาทีก่อนตรวจสอบใหม่
                return
            end
            
            -- ตรวจสอบ TradeGui อย่างปลอดภัย
            local tradeGuiEnabled = false
            local tradeGui = LocalPlayer.PlayerGui:FindFirstChild("TradeGui")
            if tradeGui then
                tradeGuiEnabled = tradeGui.Enabled
            end

            if not tradeGuiEnabled then
                -- รอ trade request
                AcceptTradeRequestReceiver()

                -- ตรวจสอบ timeout (เพิ่มใหม่)
                local timeSinceLastRequest = tick() - lastTradeRequestTime
                local timeRemaining = RECEIVER_TIMEOUT - timeSinceLastRequest

                if timeSinceLastRequest >= RECEIVER_TIMEOUT then
                    print("⚠️ Receiver ไม่ได้รับ trade request นาน " ..
                              string.format("%.1f", timeSinceLastRequest) .. " วินาที (เกิน " ..
                              RECEIVER_TIMEOUT .. " วินาที)")
                    print(
                        "🔄 กำลังเปลี่ยนเซิร์ฟเวอร์เพื่อหาคู่เทรดใหม่...")

                    local success, error = pcall(function()
                        local TeleportService = game:GetService("TeleportService")
                        TeleportService:Teleport(14119723130)
                    end)

                    if not success then
                        warn(
                            "❌ เกิดข้อผิดพลาดในการเปลี่ยนเซิร์ฟเวอร์: " ..
                                tostring(error))
                        print("🚪 กำลังออกจากเกม...")
                        game:Shutdown()
                    end
                    return
                else
                    -- แสดงสถานะเวลาที่เหลือทุก 30 วินาที
                    if math.floor(timeSinceLastRequest) % 30 == 0 or timeRemaining <= 60 then
                        print("⏰ Receiver รอ trade request... เหลือเวลาอีก " ..
                                  string.format("%.0f", timeRemaining) ..
                                  " วินาทีก่อนเปลี่ยนเซิร์ฟเวอร์")
                    end
                end

                -- รีเซ็ตสถานะเมื่อไม่ได้เทรด
                receiverCreatureStartTime = 0
                receiverCreatureRequested = false
                receiverAcceptStartTime = 0
                receiverAcceptRequested = false
                currentStepReceiver = 0
                wait(2)
            else
                -- กำลังเทรดอยู่
                if currentStepReceiver == 0 then
                    -- เช็คชื่อคู่เทรดก่อน
                    if CheckTradePartner() then
                        currentStepReceiver = 1
                        print("🚀 Receiver เริ่มขั้นตอนที่ 1: Add Creature")
                        -- รีเซ็ตสถานะก่อนเริ่มใหม่
                        receiverCreatureStartTime = 0
                        receiverCreatureRequested = false
                        receiverAcceptStartTime = 0
                        receiverAcceptRequested = false
                    else
                        wait(1)
                    end
                elseif currentStepReceiver == 1 then
                    -- Add Creature - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverCreatureRequested then
                        -- ตรวจสอบว่า remote กำลังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⏳ Receiver: Remote กำลังใช้งานอยู่ รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Add Creature...")
                            receiverCreatureRequested = true
                            receiverCreatureStartTime = tick()

                            -- เรียก AddCreatureReceiver แบบ synchronous พร้อม error handling
                            local creatureSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                creatureSuccess = AddCreatureReceiver()
                            end)

                            if attemptSuccess and creatureSuccess then
                                print("✅ Receiver Add Creature เสร็จสิ้น")
                                currentStepReceiver = 2
                                print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                            else
                                warn("❌ Receiver Add Creature ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverCreatureRequested = false
                                receiverCreatureStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 10 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverCreatureStartTime
                        if elapsedTime >= 10 then
                            print(
                                "⚠️ Receiver Add Creature ใช้เวลานานเกินไป กำลังข้ามไป step 2")
                            currentStepReceiver = 2
                            print("🚀 Receiver เริ่มขั้นตอนที่ 2: Click Accept")
                        else
                            print("⏳ Receiver รอ Add Creature เสร็จ... (" ..
                                      string.format("%.1f", 10 - elapsedTime) .. " วินาที)")
                        end
                    end
                elseif currentStepReceiver == 2 then
                    -- Click Accept - ใช้ state-based tracking แบบปรับปรุง
                    if not receiverAcceptRequested then
                        -- ตรวจสอบว่า remote ยังใช้งานอยู่หรือไม่
                        if isRemoteBusy then
                            print(
                                "⚠️ Receiver: Remote ยังใช้งานอยู่ ไม่สามารถกด accept ได้! รอสักครู่...")
                            wait(1)
                        else
                            print("🚀 Receiver เริ่ม Click Accept...")
                            receiverAcceptRequested = true
                            receiverAcceptStartTime = tick()

                            -- เรียก ClickAcceptReceiver แบบ synchronous พร้อม error handling
                            local acceptSuccess = false
                            local attemptSuccess, attemptError = pcall(function()
                                acceptSuccess = ClickAcceptReceiver()
                            end)

                            if attemptSuccess and acceptSuccess then
                                print("✅ Receiver เทรดเสร็จสิ้น")
                                currentStepReceiver = 0
                                -- รีเซ็ตสถานะ
                                receiverCreatureStartTime = 0
                                receiverCreatureRequested = false
                                receiverAcceptStartTime = 0
                                receiverAcceptRequested = false
                            else
                                warn("❌ Receiver Click Accept ล้มเหลว: " .. tostring(attemptError))
                                -- รีเซ็ตเพื่อลองใหม่
                                receiverAcceptRequested = false
                                receiverAcceptStartTime = 0
                                wait(2) -- รอก่อนลองใหม่
                            end
                        end
                    else
                        -- ตรวจสอบว่าผ่านไป 5 วินาทีแล้วหรือยัง (เพิ่มเวลา)
                        local elapsedTime = tick() - receiverAcceptStartTime
                        if elapsedTime >= 5 then
                            print(
                                "⚠️ Receiver Click Accept ใช้เวลานานเกินไป กำลังจบเทรด")
                            print("✅ Receiver เทรดเสร็จสิ้น")
                            currentStepReceiver = 0
                            -- รีเซ็ตสถานะ
                            receiverCreatureStartTime = 0
                            receiverCreatureRequested = false
                            receiverAcceptStartTime = 0
                            receiverAcceptRequested = false
                        else
                            print("⏳ Receiver รอ Click Accept เสร็จ... (" ..
                                      string.format("%.1f", 5 - elapsedTime) .. " วินาที)")
                        end
                    end
                end
                wait(1)
            end
        end)

        if not success then
            warn("❌ เกิดข้อผิดพลาดใน ReceiverCoroutine: " .. tostring(error))
            currentStepReceiver = 0
            -- รีเซ็ตสถานะ
            receiverCreatureStartTime = 0
            receiverCreatureRequested = false
            receiverAcceptStartTime = 0
            receiverAcceptRequested = false
            wait(5) -- รอ 5 วินาทีก่อนลองใหม่
        end
    end
end

-- ฟังก์ชันหลัก
local function Main()
    local success, error = pcall(function()
        print("🎮 เริ่มต้นสคริปต์ Trade")

        -- วาร์ปไปยังตำแหน่งที่กำหนด
        WarpToLocation()

        -- ตรวจสอบว่าเป็น Sender หรือ Receiver
        local isSender = IsInList(LocalPlayer.Name, SENDER_LIST)
        local isReceiver = IsInList(LocalPlayer.Name, RECEIVER_LIST)

        if isSender then
            print("👤 ทำงานในโหมด Sender")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ sender (สำหรับโหมด receiver) (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            StartSenderStepLoop()
            -- เพิ่มการทำงานแบบ Receiver สำหรับ Sender
            coroutine.wrap(SenderReceiverCoroutine)()
        elseif isReceiver then
            print("👤 ทำงานในโหมด Receiver")
            -- รีเซ็ตเวลาเริ่มต้นสำหรับ receiver (เพิ่มใหม่)
            lastTradeRequestTime = tick()
            coroutine.wrap(ReceiverCoroutine)()
        else
            print("❌ ชื่อผู้เล่นไม่ตรงกับรายชื่อใดๆ")
        end
    end)

    if not success then
        warn("❌ เกิดข้อผิดพลาดในฟังก์ชันหลัก: " ..
                 tostring(error))
        -- ลองรันใหม่หลังจาก 10 วินาที
        wait(10)
        Main()
    end
end

-- เริ่มต้นสคริปต์
Main()
